<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>core/ngx_times.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>core/ngx_times.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L46">cached_err_log_time</a></li>
<li><a href="#L42">cached_gmtoff</a></li>
<li><a href="#L52">cached_http_log_iso8601</a></li>
<li><a href="#L50">cached_http_log_time</a></li>
<li><a href="#L48">cached_http_time</a></li>
<li><a href="#L54">cached_syslog_time</a></li>
<li><a href="#L45">cached_time</a></li>
<li><a href="#L59">months</a></li>
<li><a href="#L28">ngx_cached_err_log_time</a></li>
<li><a href="#L31">ngx_cached_http_log_iso8601</a></li>
<li><a href="#L30">ngx_cached_http_log_time</a></li>
<li><a href="#L29">ngx_cached_http_time</a></li>
<li><a href="#L32">ngx_cached_syslog_time</a></li>
<li><a href="#L27">ngx_cached_time</a></li>
<li><a href="#L26">ngx_current_msec</a></li>
<li><a href="#L24">ngx_time_lock</a></li>
<li><a href="#L23">slot</a></li>
<li><a href="#L58">week</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L300">ngx_gmtime</a></li>
<li><a href="#L273">ngx_http_cookie_time</a></li>
<li><a href="#L255">ngx_http_time</a></li>
<li><a href="#L393">ngx_next_time</a></li>
<li><a href="#L63">ngx_time_init</a></li>
<li><a href="#L195">ngx_time_sigsafe_update</a></li>
<li><a href="#L78">ngx_time_update</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L21">NGX_TIME_SLOTS</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * The time may be updated by signal handler or by several threads.<br/></li>
<li></span><span class="Comment"> * The time update operations are rare and require to hold the <a href="#L24" title="core/ngx_times.c:24">ngx_time_lock</a>.<br/></li>
<li></span><span class="Comment"> * The time read operations are frequent, so they are lock-free and get time<br/></li>
<li></span><span class="Comment"> * values and strings from the current <a href="#L23" title="core/ngx_times.c:23">slot</a>.&nbsp; Thus thread may get the corrupted<br/></li>
<li></span><span class="Comment"> * values only if it is preempted while copying and then it is not scheduled<br/></li>
<li></span><span class="Comment"> * to run more than <a href="#L21" title="core/ngx_times.c:21">NGX_TIME_SLOTS</a> seconds.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><a id="L21">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_TIME_SLOTS</span>&nbsp;&nbsp; </span><span class="Constant">64<br/></li>
<li></span><br/></li>
<li><a id="L23">&#x200c;</a><span class="Type">static</span> <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="linkable">slot</span>;<br/></li>
<li><a id="L24">&#x200c;</a><span class="Type">static</span> <a href="../os/unix/ngx_atomic.h.html#L25" title="os/unix/ngx_atomic.h:25">ngx_atomic_t</a>&nbsp; &nbsp; &nbsp; <span class="linkable">ngx_time_lock</span>;<br/></li>
<li><br/></li>
<li><a id="L26">&#x200c;</a><span class="Type">volatile</span> <a href="../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; <span class="linkable">ngx_current_msec</span>;<br/></li>
<li><a id="L27">&#x200c;</a><span class="Type">volatile</span> <a href="ngx_times.h.html#L20" title="core/ngx_times.h:20">ngx_time_t</a>&nbsp; &nbsp;&nbsp; *<span class="linkable">ngx_cached_time</span>;<br/></li>
<li><a id="L28">&#x200c;</a><span class="Type">volatile</span> <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp;&nbsp; <span class="linkable">ngx_cached_err_log_time</span>;<br/></li>
<li><a id="L29">&#x200c;</a><span class="Type">volatile</span> <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp;&nbsp; <span class="linkable">ngx_cached_http_time</span>;<br/></li>
<li><a id="L30">&#x200c;</a><span class="Type">volatile</span> <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp;&nbsp; <span class="linkable">ngx_cached_http_log_time</span>;<br/></li>
<li><a id="L31">&#x200c;</a><span class="Type">volatile</span> <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp;&nbsp; <span class="linkable">ngx_cached_http_log_iso8601</span>;<br/></li>
<li><a id="L32">&#x200c;</a><span class="Type">volatile</span> <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp;&nbsp; <span class="linkable">ngx_cached_syslog_time</span>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if !(NGX_WIN32)<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * localtime() and localtime_r() are not Async-Signal-Safe functions, therefore,<br/></li>
<li></span><span class="Comment"> * they must not be called by a signal handler, so we use the cached<br/></li>
<li></span><span class="Comment"> * GMT offset value. Fortunately the value is changed only two times a year.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><a id="L42">&#x200c;</a><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="linkable">cached_gmtoff</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><a id="L45">&#x200c;</a><span class="Type">static</span> <a href="ngx_times.h.html#L20" title="core/ngx_times.h:20">ngx_time_t</a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="linkable">cached_time</span>[<a href="#L21" title="core/ngx_times.c:21">NGX_TIME_SLOTS</a>];<br/></li>
<li><a id="L46">&#x200c;</a><span class="Type">static</span> u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="linkable">cached_err_log_time</span>[<a href="#L21" title="core/ngx_times.c:21">NGX_TIME_SLOTS</a>]<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<span class="Statement">sizeof</span>(<span class="Constant">&quot;1970/09/28 12:00:00&quot;</span>)];<br/></li>
<li><a id="L48">&#x200c;</a><span class="Type">static</span> u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="linkable">cached_http_time</span>[<a href="#L21" title="core/ngx_times.c:21">NGX_TIME_SLOTS</a>]<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<span class="Statement">sizeof</span>(<span class="Constant">&quot;Mon, 28 Sep 1970 06:00:00 GMT&quot;</span>)];<br/></li>
<li><a id="L50">&#x200c;</a><span class="Type">static</span> u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="linkable">cached_http_log_time</span>[<a href="#L21" title="core/ngx_times.c:21">NGX_TIME_SLOTS</a>]<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<span class="Statement">sizeof</span>(<span class="Constant">&quot;28/Sep/1970:12:00:00 +0600&quot;</span>)];<br/></li>
<li><a id="L52">&#x200c;</a><span class="Type">static</span> u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="linkable">cached_http_log_iso8601</span>[<a href="#L21" title="core/ngx_times.c:21">NGX_TIME_SLOTS</a>]<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<span class="Statement">sizeof</span>(<span class="Constant">&quot;1970-09-28T12:00:00+06:00&quot;</span>)];<br/></li>
<li><a id="L54">&#x200c;</a><span class="Type">static</span> u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="linkable">cached_syslog_time</span>[<a href="#L21" title="core/ngx_times.c:21">NGX_TIME_SLOTS</a>]<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<span class="Statement">sizeof</span>(<span class="Constant">&quot;Sep 28 12:00:00&quot;</span>)];<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L58">&#x200c;</a><span class="Type">static</span> <span class="Type">char</span>&nbsp; *<span class="linkable">week</span>[] = { <span class="Constant">&quot;Sun&quot;</span>, <span class="Constant">&quot;Mon&quot;</span>, <span class="Constant">&quot;Tue&quot;</span>, <span class="Constant">&quot;Wed&quot;</span>, <span class="Constant">&quot;Thu&quot;</span>, <span class="Constant">&quot;Fri&quot;</span>, <span class="Constant">&quot;Sat&quot;</span> };<br/></li>
<li><a id="L59">&#x200c;</a><span class="Type">static</span> <span class="Type">char</span>&nbsp; *<span class="linkable">months</span>[] = { <span class="Constant">&quot;Jan&quot;</span>, <span class="Constant">&quot;Feb&quot;</span>, <span class="Constant">&quot;Mar&quot;</span>, <span class="Constant">&quot;Apr&quot;</span>, <span class="Constant">&quot;May&quot;</span>, <span class="Constant">&quot;Jun&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;Jul&quot;</span>, <span class="Constant">&quot;Aug&quot;</span>, <span class="Constant">&quot;Sep&quot;</span>, <span class="Constant">&quot;Oct&quot;</span>, <span class="Constant">&quot;Nov&quot;</span>, <span class="Constant">&quot;Dec&quot;</span> };<br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L63">&#x200c;</a></span><span class="linkable">ngx_time_init</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="core/ngx_times.c:28">ngx_cached_err_log_time</a>.len = <span class="Statement">sizeof</span>(<span class="Constant">&quot;1970/09/28 12:00:00&quot;</span>) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="core/ngx_times.c:29">ngx_cached_http_time</a>.len = <span class="Statement">sizeof</span>(<span class="Constant">&quot;Mon, 28 Sep 1970 06:00:00 GMT&quot;</span>) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L30" title="core/ngx_times.c:30">ngx_cached_http_log_time</a>.len = <span class="Statement">sizeof</span>(<span class="Constant">&quot;28/Sep/1970:12:00:00 +0600&quot;</span>) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L31" title="core/ngx_times.c:31">ngx_cached_http_log_iso8601</a>.len = <span class="Statement">sizeof</span>(<span class="Constant">&quot;1970-09-28T12:00:00+06:00&quot;</span>) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="core/ngx_times.c:32">ngx_cached_syslog_time</a>.len = <span class="Statement">sizeof</span>(<span class="Constant">&quot;Sep 28 12:00:00&quot;</span>) - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L27" title="core/ngx_times.c:27">ngx_cached_time</a> = &amp;<a href="#L45" title="core/ngx_times.c:45">cached_time</a>[<span class="Constant">0</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="core/ngx_times.c:78">ngx_time_update</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L78">&#x200c;</a></span><span class="linkable">ngx_time_update</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p0, *p1, *p2, *p3, *p4;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_time.h.html#L19" title="os/unix/ngx_time.h:19">ngx_tm_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm, gmt;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; sec;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp;&nbsp; msec;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_times.h.html#L20" title="core/ngx_times.h:20">ngx_time_t</a>&nbsp; &nbsp; &nbsp; *tp;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> timeval&nbsp;&nbsp; tv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../os/unix/ngx_atomic.h.html#L309" title="os/unix/ngx_atomic.h:309">ngx_trylock</a>(&amp;<a href="#L24" title="core/ngx_times.c:24">ngx_time_lock</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_time.h.html#L61" title="os/unix/ngx_time.h:61">ngx_gettimeofday</a>(&amp;tv);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sec = tv.tv_sec;<br/></li>
<li>&nbsp; &nbsp; msec = tv.tv_usec / <span class="Constant">1000</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L26" title="core/ngx_times.c:26">ngx_current_msec</a> = (<a href="../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>) sec * <span class="Constant">1000</span> + msec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tp = &amp;<a href="#L45" title="core/ngx_times.c:45">cached_time</a>[<a href="#L23" title="core/ngx_times.c:23">slot</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (tp-&gt;sec == sec) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tp-&gt;msec = msec;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_atomic.h.html#L310" title="os/unix/ngx_atomic.h:310">ngx_unlock</a>(&amp;<a href="#L24" title="core/ngx_times.c:24">ngx_time_lock</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L23" title="core/ngx_times.c:23">slot</a> == <a href="#L21" title="core/ngx_times.c:21">NGX_TIME_SLOTS</a> - <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L23" title="core/ngx_times.c:23">slot</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L23" title="core/ngx_times.c:23">slot</a>++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tp = &amp;<a href="#L45" title="core/ngx_times.c:45">cached_time</a>[<a href="#L23" title="core/ngx_times.c:23">slot</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tp-&gt;sec = sec;<br/></li>
<li>&nbsp; &nbsp; tp-&gt;msec = msec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L300" title="core/ngx_times.c:300">ngx_gmtime</a>(sec, &amp;gmt);<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p0 = &amp;<a href="#L48" title="core/ngx_times.c:48">cached_http_time</a>[<a href="#L23" title="core/ngx_times.c:23">slot</a>][<span class="Constant">0</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(p0, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">, </span><span class="Special">%02d</span><span class="Constant"> </span><span class="Special">%s</span><span class="Constant"> </span><span class="Special">%4d</span><span class="Constant"> </span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant"> GMT&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L58" title="core/ngx_times.c:58">week</a>[gmt.<a href="../os/unix/ngx_time.h.html#L27" title="os/unix/ngx_time.h:27">ngx_tm_wday</a>], gmt.<a href="../os/unix/ngx_time.h.html#L24" title="os/unix/ngx_time.h:24">ngx_tm_mday</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L59" title="core/ngx_times.c:59">months</a>[gmt.<a href="../os/unix/ngx_time.h.html#L25" title="os/unix/ngx_time.h:25">ngx_tm_mon</a> - <span class="Constant">1</span>], gmt.<a href="../os/unix/ngx_time.h.html#L26" title="os/unix/ngx_time.h:26">ngx_tm_year</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; gmt.<a href="../os/unix/ngx_time.h.html#L23" title="os/unix/ngx_time.h:23">ngx_tm_hour</a>, gmt.<a href="../os/unix/ngx_time.h.html#L22" title="os/unix/ngx_time.h:22">ngx_tm_min</a>, gmt.<a href="../os/unix/ngx_time.h.html#L21" title="os/unix/ngx_time.h:21">ngx_tm_sec</a>);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_GETTIMEZONE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; tp-&gt;gmtoff = ngx_gettimezone();<br/></li>
<li>&nbsp; &nbsp; <a href="#L300" title="core/ngx_times.c:300">ngx_gmtime</a>(sec + tp-&gt;gmtoff * <span class="Constant">60</span>, &amp;tm);<br/></li>
<li><br/></li>
<li><span class="PreProc">#elif (NGX_HAVE_GMTOFF)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_time.c.html#L57" title="os/unix/ngx_time.c:57">ngx_localtime</a>(sec, &amp;tm);<br/></li>
<li>&nbsp; &nbsp; <a href="#L42" title="core/ngx_times.c:42">cached_gmtoff</a> = (<a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>) (tm.<a href="../os/unix/ngx_time.h.html#L40" title="os/unix/ngx_time.h:40">ngx_tm_gmtoff</a> / <span class="Constant">60</span>);<br/></li>
<li>&nbsp; &nbsp; tp-&gt;gmtoff = <a href="#L42" title="core/ngx_times.c:42">cached_gmtoff</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_time.c.html#L57" title="os/unix/ngx_time.c:57">ngx_localtime</a>(sec, &amp;tm);<br/></li>
<li>&nbsp; &nbsp; <a href="#L42" title="core/ngx_times.c:42">cached_gmtoff</a> = <a href="../os/unix/ngx_time.h.html#L47" title="os/unix/ngx_time.h:47">ngx_timezone</a>(tm.<a href="../os/unix/ngx_time.h.html#L28" title="os/unix/ngx_time.h:28">ngx_tm_isdst</a>);<br/></li>
<li>&nbsp; &nbsp; tp-&gt;gmtoff = <a href="#L42" title="core/ngx_times.c:42">cached_gmtoff</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p1 = &amp;<a href="#L46" title="core/ngx_times.c:46">cached_err_log_time</a>[<a href="#L23" title="core/ngx_times.c:23">slot</a>][<span class="Constant">0</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(p1, <span class="Constant">&quot;</span><span class="Special">%4d</span><span class="Constant">/</span><span class="Special">%02d</span><span class="Constant">/</span><span class="Special">%02d</span><span class="Constant"> </span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L26" title="os/unix/ngx_time.h:26">ngx_tm_year</a>, tm.<a href="../os/unix/ngx_time.h.html#L25" title="os/unix/ngx_time.h:25">ngx_tm_mon</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L24" title="os/unix/ngx_time.h:24">ngx_tm_mday</a>, tm.<a href="../os/unix/ngx_time.h.html#L23" title="os/unix/ngx_time.h:23">ngx_tm_hour</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L22" title="os/unix/ngx_time.h:22">ngx_tm_min</a>, tm.<a href="../os/unix/ngx_time.h.html#L21" title="os/unix/ngx_time.h:21">ngx_tm_sec</a>);<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p2 = &amp;<a href="#L50" title="core/ngx_times.c:50">cached_http_log_time</a>[<a href="#L23" title="core/ngx_times.c:23">slot</a>][<span class="Constant">0</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(p2, <span class="Constant">&quot;</span><span class="Special">%02d</span><span class="Constant">/</span><span class="Special">%s</span><span class="Constant">/</span><span class="Special">%d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant"> </span><span class="Special">%c%02d%02d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L24" title="os/unix/ngx_time.h:24">ngx_tm_mday</a>, <a href="#L59" title="core/ngx_times.c:59">months</a>[tm.<a href="../os/unix/ngx_time.h.html#L25" title="os/unix/ngx_time.h:25">ngx_tm_mon</a> - <span class="Constant">1</span>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L26" title="os/unix/ngx_time.h:26">ngx_tm_year</a>, tm.<a href="../os/unix/ngx_time.h.html#L23" title="os/unix/ngx_time.h:23">ngx_tm_hour</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L22" title="os/unix/ngx_time.h:22">ngx_tm_min</a>, tm.<a href="../os/unix/ngx_time.h.html#L21" title="os/unix/ngx_time.h:21">ngx_tm_sec</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tp-&gt;gmtoff &lt; <span class="Constant">0</span> ? <span class="Constant">'-'</span> : <span class="Constant">'+'</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_core.h.html#L89" title="core/ngx_core.h:89">ngx_abs</a>(tp-&gt;gmtoff / <span class="Constant">60</span>), <a href="ngx_core.h.html#L89" title="core/ngx_core.h:89">ngx_abs</a>(tp-&gt;gmtoff % <span class="Constant">60</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p3 = &amp;<a href="#L52" title="core/ngx_times.c:52">cached_http_log_iso8601</a>[<a href="#L23" title="core/ngx_times.c:23">slot</a>][<span class="Constant">0</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(p3, <span class="Constant">&quot;</span><span class="Special">%4d</span><span class="Constant">-</span><span class="Special">%02d</span><span class="Constant">-</span><span class="Special">%02d</span><span class="Constant">T</span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d%c%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L26" title="os/unix/ngx_time.h:26">ngx_tm_year</a>, tm.<a href="../os/unix/ngx_time.h.html#L25" title="os/unix/ngx_time.h:25">ngx_tm_mon</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L24" title="os/unix/ngx_time.h:24">ngx_tm_mday</a>, tm.<a href="../os/unix/ngx_time.h.html#L23" title="os/unix/ngx_time.h:23">ngx_tm_hour</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L22" title="os/unix/ngx_time.h:22">ngx_tm_min</a>, tm.<a href="../os/unix/ngx_time.h.html#L21" title="os/unix/ngx_time.h:21">ngx_tm_sec</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tp-&gt;gmtoff &lt; <span class="Constant">0</span> ? <span class="Constant">'-'</span> : <span class="Constant">'+'</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_core.h.html#L89" title="core/ngx_core.h:89">ngx_abs</a>(tp-&gt;gmtoff / <span class="Constant">60</span>), <a href="ngx_core.h.html#L89" title="core/ngx_core.h:89">ngx_abs</a>(tp-&gt;gmtoff % <span class="Constant">60</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p4 = &amp;<a href="#L54" title="core/ngx_times.c:54">cached_syslog_time</a>[<a href="#L23" title="core/ngx_times.c:23">slot</a>][<span class="Constant">0</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(p4, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant"> </span><span class="Special">%2d</span><span class="Constant"> </span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L59" title="core/ngx_times.c:59">months</a>[tm.<a href="../os/unix/ngx_time.h.html#L25" title="os/unix/ngx_time.h:25">ngx_tm_mon</a> - <span class="Constant">1</span>], tm.<a href="../os/unix/ngx_time.h.html#L24" title="os/unix/ngx_time.h:24">ngx_tm_mday</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L23" title="os/unix/ngx_time.h:23">ngx_tm_hour</a>, tm.<a href="../os/unix/ngx_time.h.html#L22" title="os/unix/ngx_time.h:22">ngx_tm_min</a>, tm.<a href="../os/unix/ngx_time.h.html#L21" title="os/unix/ngx_time.h:21">ngx_tm_sec</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_gcc_atomic_amd64.h.html#L80" title="os/unix/ngx_gcc_atomic_amd64.h:80">ngx_memory_barrier</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L27" title="core/ngx_times.c:27">ngx_cached_time</a> = tp;<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="core/ngx_times.c:29">ngx_cached_http_time</a>.data = p0;<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="core/ngx_times.c:28">ngx_cached_err_log_time</a>.data = p1;<br/></li>
<li>&nbsp; &nbsp; <a href="#L30" title="core/ngx_times.c:30">ngx_cached_http_log_time</a>.data = p2;<br/></li>
<li>&nbsp; &nbsp; <a href="#L31" title="core/ngx_times.c:31">ngx_cached_http_log_iso8601</a>.data = p3;<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="core/ngx_times.c:32">ngx_cached_syslog_time</a>.data = p4;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_atomic.h.html#L310" title="os/unix/ngx_atomic.h:310">ngx_unlock</a>(&amp;<a href="#L24" title="core/ngx_times.c:24">ngx_time_lock</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if !(NGX_WIN32)<br/></li>
<li></span><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L195">&#x200c;</a></span><span class="linkable">ngx_time_sigsafe_update</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p, *p2;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_time.h.html#L19" title="os/unix/ngx_time.h:19">ngx_tm_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; sec;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_times.h.html#L20" title="core/ngx_times.h:20">ngx_time_t</a>&nbsp; &nbsp; &nbsp; *tp;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> timeval&nbsp;&nbsp; tv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../os/unix/ngx_atomic.h.html#L309" title="os/unix/ngx_atomic.h:309">ngx_trylock</a>(&amp;<a href="#L24" title="core/ngx_times.c:24">ngx_time_lock</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_time.h.html#L61" title="os/unix/ngx_time.h:61">ngx_gettimeofday</a>(&amp;tv);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sec = tv.tv_sec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tp = &amp;<a href="#L45" title="core/ngx_times.c:45">cached_time</a>[<a href="#L23" title="core/ngx_times.c:23">slot</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (tp-&gt;sec == sec) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_atomic.h.html#L310" title="os/unix/ngx_atomic.h:310">ngx_unlock</a>(&amp;<a href="#L24" title="core/ngx_times.c:24">ngx_time_lock</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L23" title="core/ngx_times.c:23">slot</a> == <a href="#L21" title="core/ngx_times.c:21">NGX_TIME_SLOTS</a> - <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L23" title="core/ngx_times.c:23">slot</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L23" title="core/ngx_times.c:23">slot</a>++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tp = &amp;<a href="#L45" title="core/ngx_times.c:45">cached_time</a>[<a href="#L23" title="core/ngx_times.c:23">slot</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tp-&gt;sec = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L300" title="core/ngx_times.c:300">ngx_gmtime</a>(sec + <a href="#L42" title="core/ngx_times.c:42">cached_gmtoff</a> * <span class="Constant">60</span>, &amp;tm);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = &amp;<a href="#L46" title="core/ngx_times.c:46">cached_err_log_time</a>[<a href="#L23" title="core/ngx_times.c:23">slot</a>][<span class="Constant">0</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(p, <span class="Constant">&quot;</span><span class="Special">%4d</span><span class="Constant">/</span><span class="Special">%02d</span><span class="Constant">/</span><span class="Special">%02d</span><span class="Constant"> </span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L26" title="os/unix/ngx_time.h:26">ngx_tm_year</a>, tm.<a href="../os/unix/ngx_time.h.html#L25" title="os/unix/ngx_time.h:25">ngx_tm_mon</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L24" title="os/unix/ngx_time.h:24">ngx_tm_mday</a>, tm.<a href="../os/unix/ngx_time.h.html#L23" title="os/unix/ngx_time.h:23">ngx_tm_hour</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L22" title="os/unix/ngx_time.h:22">ngx_tm_min</a>, tm.<a href="../os/unix/ngx_time.h.html#L21" title="os/unix/ngx_time.h:21">ngx_tm_sec</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p2 = &amp;<a href="#L54" title="core/ngx_times.c:54">cached_syslog_time</a>[<a href="#L23" title="core/ngx_times.c:23">slot</a>][<span class="Constant">0</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(p2, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant"> </span><span class="Special">%2d</span><span class="Constant"> </span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L59" title="core/ngx_times.c:59">months</a>[tm.<a href="../os/unix/ngx_time.h.html#L25" title="os/unix/ngx_time.h:25">ngx_tm_mon</a> - <span class="Constant">1</span>], tm.<a href="../os/unix/ngx_time.h.html#L24" title="os/unix/ngx_time.h:24">ngx_tm_mday</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L23" title="os/unix/ngx_time.h:23">ngx_tm_hour</a>, tm.<a href="../os/unix/ngx_time.h.html#L22" title="os/unix/ngx_time.h:22">ngx_tm_min</a>, tm.<a href="../os/unix/ngx_time.h.html#L21" title="os/unix/ngx_time.h:21">ngx_tm_sec</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_gcc_atomic_amd64.h.html#L80" title="os/unix/ngx_gcc_atomic_amd64.h:80">ngx_memory_barrier</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="core/ngx_times.c:28">ngx_cached_err_log_time</a>.data = p;<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="core/ngx_times.c:32">ngx_cached_syslog_time</a>.data = p2;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_atomic.h.html#L310" title="os/unix/ngx_atomic.h:310">ngx_unlock</a>(&amp;<a href="#L24" title="core/ngx_times.c:24">ngx_time_lock</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li>u_char *<br/></li>
<li><a id="L255">&#x200c;</a><span class="linkable">ngx_http_time</span>(u_char *buf, <span class="Type">time_t</span> t)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_time.h.html#L19" title="os/unix/ngx_time.h:19">ngx_tm_t</a>&nbsp; tm;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L300" title="core/ngx_times.c:300">ngx_gmtime</a>(t, &amp;tm);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(buf, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">, </span><span class="Special">%02d</span><span class="Constant"> </span><span class="Special">%s</span><span class="Constant"> </span><span class="Special">%4d</span><span class="Constant"> </span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant"> GMT&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L58" title="core/ngx_times.c:58">week</a>[tm.<a href="../os/unix/ngx_time.h.html#L27" title="os/unix/ngx_time.h:27">ngx_tm_wday</a>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L24" title="os/unix/ngx_time.h:24">ngx_tm_mday</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L59" title="core/ngx_times.c:59">months</a>[tm.<a href="../os/unix/ngx_time.h.html#L25" title="os/unix/ngx_time.h:25">ngx_tm_mon</a> - <span class="Constant">1</span>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L26" title="os/unix/ngx_time.h:26">ngx_tm_year</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L23" title="os/unix/ngx_time.h:23">ngx_tm_hour</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L22" title="os/unix/ngx_time.h:22">ngx_tm_min</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L21" title="os/unix/ngx_time.h:21">ngx_tm_sec</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li>u_char *<br/></li>
<li><a id="L273">&#x200c;</a><span class="linkable">ngx_http_cookie_time</span>(u_char *buf, <span class="Type">time_t</span> t)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_time.h.html#L19" title="os/unix/ngx_time.h:19">ngx_tm_t</a>&nbsp; tm;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L300" title="core/ngx_times.c:300">ngx_gmtime</a>(t, &amp;tm);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Netscape 3.x does not understand 4-digit years at all and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * 2-digit years more than &quot;37&quot;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(buf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (tm.<a href="../os/unix/ngx_time.h.html#L26" title="os/unix/ngx_time.h:26">ngx_tm_year</a> &gt; <span class="Constant">2037</span>) ?<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">, </span><span class="Special">%02d</span><span class="Constant">-</span><span class="Special">%s</span><span class="Constant">-</span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant"> GMT&quot;</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">, </span><span class="Special">%02d</span><span class="Constant">-</span><span class="Special">%s</span><span class="Constant">-</span><span class="Special">%02d</span><span class="Constant"> </span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant">:</span><span class="Special">%02d</span><span class="Constant"> GMT&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L58" title="core/ngx_times.c:58">week</a>[tm.<a href="../os/unix/ngx_time.h.html#L27" title="os/unix/ngx_time.h:27">ngx_tm_wday</a>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L24" title="os/unix/ngx_time.h:24">ngx_tm_mday</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L59" title="core/ngx_times.c:59">months</a>[tm.<a href="../os/unix/ngx_time.h.html#L25" title="os/unix/ngx_time.h:25">ngx_tm_mon</a> - <span class="Constant">1</span>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (tm.<a href="../os/unix/ngx_time.h.html#L26" title="os/unix/ngx_time.h:26">ngx_tm_year</a> &gt; <span class="Constant">2037</span>) ? tm.<a href="../os/unix/ngx_time.h.html#L26" title="os/unix/ngx_time.h:26">ngx_tm_year</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L26" title="os/unix/ngx_time.h:26">ngx_tm_year</a> % <span class="Constant">100</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L23" title="os/unix/ngx_time.h:23">ngx_tm_hour</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L22" title="os/unix/ngx_time.h:22">ngx_tm_min</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tm.<a href="../os/unix/ngx_time.h.html#L21" title="os/unix/ngx_time.h:21">ngx_tm_sec</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L300">&#x200c;</a></span><span class="linkable">ngx_gmtime</span>(<span class="Type">time_t</span> t, <a href="../os/unix/ngx_time.h.html#L19" title="os/unix/ngx_time.h:19">ngx_tm_t</a> *tp)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp;&nbsp; yday;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; n, sec, min, hour, <a href="../http/ngx_http_parse_time.c.html#L13" title="http/ngx_http_parse_time.c:13">mday</a>, mon, year, wday, days, leap;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* the calculation is valid for positive time_t only */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; n = (<a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) t;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; days = n / <span class="Constant">86400</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* January 1, 1970 was Thursday */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; wday = (<span class="Constant">4</span> + days) % <span class="Constant">7</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n %= <span class="Constant">86400</span>;<br/></li>
<li>&nbsp; &nbsp; hour = n / <span class="Constant">3600</span>;<br/></li>
<li>&nbsp; &nbsp; n %= <span class="Constant">3600</span>;<br/></li>
<li>&nbsp; &nbsp; min = n / <span class="Constant">60</span>;<br/></li>
<li>&nbsp; &nbsp; sec = n % <span class="Constant">60</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the algorithm based on Gauss' formula,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * see src/http/<a href="../http/ngx_http_parse_time.c.html#L16" title="http/ngx_http_parse_time.c:16">ngx_http_parse_time</a>.c<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* days since March 1, 1 BC */<br/></li>
<li></span>&nbsp; &nbsp; days = days - (<span class="Constant">31</span> + <span class="Constant">28</span>) + <span class="Constant">719527</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * The &quot;days&quot; should be adjusted to 1 only, however, some March 1st's go<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * to previous year, so we adjust them to 2.&nbsp; This causes also shift of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * last February days to next year, but we catch the case when &quot;yday&quot;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * becomes negative.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; year = (days + <span class="Constant">2</span>) * <span class="Constant">400</span> / (<span class="Constant">365</span> * <span class="Constant">400</span> + <span class="Constant">100</span> - <span class="Constant">4</span> + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; yday = days - (<span class="Constant">365</span> * year + year / <span class="Constant">4</span> - year / <span class="Constant">100</span> + year / <span class="Constant">400</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (yday &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; leap = (year % <span class="Constant">4</span> == <span class="Constant">0</span>) &amp;&amp; (year % <span class="Constant">100</span> || (year % <span class="Constant">400</span> == <span class="Constant">0</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; yday = <span class="Constant">365</span> + leap + yday;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; year--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * The empirical formula that maps &quot;yday&quot; to month.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * There are at least 10 variants, some of them are:<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; mon = (yday + 31) * 15 / 459<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; mon = (yday + 31) * 17 / 520<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; mon = (yday + 31) * 20 / 612<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; mon = (yday + <span class="Constant">31</span>) * <span class="Constant">10</span> / <span class="Constant">306</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* the Gauss' formula that evaluates days before the month */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../http/ngx_http_parse_time.c.html#L13" title="http/ngx_http_parse_time.c:13">mday</a> = yday - (<span class="Constant">367</span> * mon / <span class="Constant">12</span> - <span class="Constant">30</span>) + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (yday &gt;= <span class="Constant">306</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; year++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mon -= <span class="Constant">10</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * there is no &quot;yday&quot; in Win32 SYSTEMTIME<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * yday -= 306;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mon += <span class="Constant">2</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * there is no &quot;yday&quot; in Win32 SYSTEMTIME<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * yday += 31 + 28 + leap;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tp-&gt;<a href="../os/unix/ngx_time.h.html#L21" title="os/unix/ngx_time.h:21">ngx_tm_sec</a> = (<a href="../os/unix/ngx_time.h.html#L30" title="os/unix/ngx_time.h:30">ngx_tm_sec_t</a>) sec;<br/></li>
<li>&nbsp; &nbsp; tp-&gt;<a href="../os/unix/ngx_time.h.html#L22" title="os/unix/ngx_time.h:22">ngx_tm_min</a> = (<a href="../os/unix/ngx_time.h.html#L31" title="os/unix/ngx_time.h:31">ngx_tm_min_t</a>) min;<br/></li>
<li>&nbsp; &nbsp; tp-&gt;<a href="../os/unix/ngx_time.h.html#L23" title="os/unix/ngx_time.h:23">ngx_tm_hour</a> = (<a href="../os/unix/ngx_time.h.html#L32" title="os/unix/ngx_time.h:32">ngx_tm_hour_t</a>) hour;<br/></li>
<li>&nbsp; &nbsp; tp-&gt;<a href="../os/unix/ngx_time.h.html#L24" title="os/unix/ngx_time.h:24">ngx_tm_mday</a> = (<a href="../os/unix/ngx_time.h.html#L33" title="os/unix/ngx_time.h:33">ngx_tm_mday_t</a>) <a href="../http/ngx_http_parse_time.c.html#L13" title="http/ngx_http_parse_time.c:13">mday</a>;<br/></li>
<li>&nbsp; &nbsp; tp-&gt;<a href="../os/unix/ngx_time.h.html#L25" title="os/unix/ngx_time.h:25">ngx_tm_mon</a> = (<a href="../os/unix/ngx_time.h.html#L34" title="os/unix/ngx_time.h:34">ngx_tm_mon_t</a>) mon;<br/></li>
<li>&nbsp; &nbsp; tp-&gt;<a href="../os/unix/ngx_time.h.html#L26" title="os/unix/ngx_time.h:26">ngx_tm_year</a> = (<a href="../os/unix/ngx_time.h.html#L35" title="os/unix/ngx_time.h:35">ngx_tm_year_t</a>) year;<br/></li>
<li>&nbsp; &nbsp; tp-&gt;<a href="../os/unix/ngx_time.h.html#L27" title="os/unix/ngx_time.h:27">ngx_tm_wday</a> = (<a href="../os/unix/ngx_time.h.html#L36" title="os/unix/ngx_time.h:36">ngx_tm_wday_t</a>) wday;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">time_t<br/></li>
<li><a id="L393">&#x200c;</a></span><span class="linkable">ngx_next_time</span>(<span class="Type">time_t</span> when)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; &nbsp;&nbsp; now, next;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> tm&nbsp; tm;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; now = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_time.c.html#L76" title="os/unix/ngx_time.c:76">ngx_libc_localtime</a>(now, &amp;tm);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tm.tm_hour = (<span class="Type">int</span>) (when / <span class="Constant">3600</span>);<br/></li>
<li>&nbsp; &nbsp; when %= <span class="Constant">3600</span>;<br/></li>
<li>&nbsp; &nbsp; tm.tm_min = (<span class="Type">int</span>) (when / <span class="Constant">60</span>);<br/></li>
<li>&nbsp; &nbsp; tm.tm_sec = (<span class="Type">int</span>) (when % <span class="Constant">60</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; next = mktime(&amp;tm);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (next == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (next - now &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> next;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tm.tm_mday++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* mktime() should normalize a date (Jan 32, etc) */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; next = mktime(&amp;tm);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (next != -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> next;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
