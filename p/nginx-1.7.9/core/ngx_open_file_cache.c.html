<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>core/ngx_open_file_cache.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>core/ngx_open_file_cache.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L1032">ngx_close_cached_file</a></li>
<li><a href="#L1095">ngx_expire_old_cached_files</a></li>
<li><a href="#L781">ngx_file_info_wrapper</a></li>
<li><a href="#L559">ngx_file_o_path_info</a></li>
<li><a href="#L840">ngx_open_and_stat_file</a></li>
<li><a href="#L144">ngx_open_cached_file</a></li>
<li><a href="#L954">ngx_open_file_add_event</a></li>
<li><a href="#L89">ngx_open_file_cache_cleanup</a></li>
<li><a href="#L57">ngx_open_file_cache_init</a></li>
<li><a href="#L1146">ngx_open_file_cache_rbtree_insert_value</a></li>
<li><a href="#L1227">ngx_open_file_cache_remove</a></li>
<li><a href="#L1018">ngx_open_file_cleanup</a></li>
<li><a href="#L1078">ngx_open_file_del_event</a></li>
<li><a href="#L1187">ngx_open_file_lookup</a></li>
<li><a href="#L614">ngx_open_file_wrapper</a></li>
<li><a href="#L492">ngx_openat_file_owner</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L21">NGX_MIN_READ_AHEAD</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_event.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * open file cache caches<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; open file handles with stat() info;<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; directories stat() info;<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; files and directories errors: not found, access denied, etc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L21">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_MIN_READ_AHEAD</span>&nbsp; (</span><span class="Constant">128</span><span class="PreProc"> * </span><span class="Constant">1024</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L89" title="core/ngx_open_file_cache.c:89">ngx_open_file_cache_cleanup</a>(<span class="Type">void</span> *data);<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_OPENAT)<br/></li>
<li></span><span class="Type">static</span> <a href="../os/unix/ngx_files.h.html#L16" title="os/unix/ngx_files.h:16">ngx_fd_t</a> <a href="#L492" title="core/ngx_open_file_cache.c:492">ngx_openat_file_owner</a>(<a href="../os/unix/ngx_files.h.html#L16" title="os/unix/ngx_files.h:16">ngx_fd_t</a> at_fd, <span class="Type">const</span> u_char *name,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> mode, <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> create, <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> access, <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log);<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_O_PATH)<br/></li>
<li></span><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L559" title="core/ngx_open_file_cache.c:559">ngx_file_o_path_info</a>(<a href="../os/unix/ngx_files.h.html#L16" title="os/unix/ngx_files.h:16">ngx_fd_t</a> fd, <a href="../os/unix/ngx_files.h.html#L17" title="os/unix/ngx_files.h:17">ngx_file_info_t</a> *fi,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><span class="Type">static</span> <a href="../os/unix/ngx_files.h.html#L16" title="os/unix/ngx_files.h:16">ngx_fd_t</a> <a href="#L614" title="core/ngx_open_file_cache.c:614">ngx_open_file_wrapper</a>(<a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L51" title="core/ngx_open_file_cache.h:51">ngx_open_file_info_t</a> *of, <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> mode, <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> create,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> access, <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L781" title="core/ngx_open_file_cache.c:781">ngx_file_info_wrapper</a>(<a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L51" title="core/ngx_open_file_cache.h:51">ngx_open_file_info_t</a> *of, <a href="../os/unix/ngx_files.h.html#L17" title="os/unix/ngx_files.h:17">ngx_file_info_t</a> *fi, <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L840" title="core/ngx_open_file_cache.c:840">ngx_open_and_stat_file</a>(<a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L51" title="core/ngx_open_file_cache.h:51">ngx_open_file_info_t</a> *of, <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L954" title="core/ngx_open_file_cache.c:954">ngx_open_file_add_event</a>(<a href="ngx_open_file_cache.h.html#L99" title="core/ngx_open_file_cache.h:99">ngx_open_file_cache_t</a> *cache,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a> *file, <a href="ngx_open_file_cache.h.html#L51" title="core/ngx_open_file_cache.h:51">ngx_open_file_info_t</a> *of, <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1018" title="core/ngx_open_file_cache.c:1018">ngx_open_file_cleanup</a>(<span class="Type">void</span> *data);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1032" title="core/ngx_open_file_cache.c:1032">ngx_close_cached_file</a>(<a href="ngx_open_file_cache.h.html#L99" title="core/ngx_open_file_cache.h:99">ngx_open_file_cache_t</a> *cache,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a> *file, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> min_uses, <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1078" title="core/ngx_open_file_cache.c:1078">ngx_open_file_del_event</a>(<a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a> *file);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1095" title="core/ngx_open_file_cache.c:1095">ngx_expire_old_cached_files</a>(<a href="ngx_open_file_cache.h.html#L99" title="core/ngx_open_file_cache.h:99">ngx_open_file_cache_t</a> *cache,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> n, <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1146" title="core/ngx_open_file_cache.c:1146">ngx_open_file_cache_rbtree_insert_value</a>(<a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel);<br/></li>
<li><span class="Type">static</span> <a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a> *<br/></li>
<li>&nbsp; &nbsp; <a href="#L1187" title="core/ngx_open_file_cache.c:1187">ngx_open_file_lookup</a>(<a href="ngx_open_file_cache.h.html#L99" title="core/ngx_open_file_cache.h:99">ngx_open_file_cache_t</a> *cache, <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span> hash);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1227" title="core/ngx_open_file_cache.c:1227">ngx_open_file_cache_remove</a>(<a href="ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *ev);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="ngx_open_file_cache.h.html#L99" title="core/ngx_open_file_cache.h:99">ngx_open_file_cache_t</a> *<br/></li>
<li><a id="L57">&#x200c;</a><span class="linkable">ngx_open_file_cache_init</span>(<a href="ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> max, <span class="Type">time_t</span> inactive)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_palloc.h.html#L32" title="core/ngx_palloc.h:32">ngx_pool_cleanup_t</a>&nbsp; &nbsp;&nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L99" title="core/ngx_open_file_cache.h:99">ngx_open_file_cache_t</a>&nbsp; *cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache = <a href="ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(pool, <span class="Statement">sizeof</span>(<a href="ngx_open_file_cache.h.html#L99" title="core/ngx_open_file_cache.h:99">ngx_open_file_cache_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cache == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L44" title="core/ngx_rbtree.h:44">ngx_rbtree_init</a>(&amp;cache-&gt;rbtree, &amp;cache-&gt;sentinel,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1146" title="core/ngx_open_file_cache.c:1146">ngx_open_file_cache_rbtree_insert_value</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L24" title="core/ngx_queue.h:24">ngx_queue_init</a>(&amp;cache-&gt;expire_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;current = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;max = max;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;inactive = inactive;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = <a href="ngx_palloc.c.html#L314" title="core/ngx_palloc.c:314">ngx_pool_cleanup_add</a>(pool, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln-&gt;handler = <a href="#L89" title="core/ngx_open_file_cache.c:89">ngx_open_file_cache_cleanup</a>;<br/></li>
<li>&nbsp; &nbsp; cln-&gt;data = cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> cache;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L89">&#x200c;</a></span><span class="linkable">ngx_open_file_cache_cleanup</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L99" title="core/ngx_open_file_cache.h:99">ngx_open_file_cache_t</a>&nbsp; *cache = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a>&nbsp; *file;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, <a href="ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;open file cache cleanup&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_queue.h.html#L29" title="core/ngx_queue.h:29">ngx_queue_empty</a>(&amp;cache-&gt;expire_queue)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; q = <a href="ngx_queue.h.html#L54" title="core/ngx_queue.h:54">ngx_queue_last</a>(&amp;cache-&gt;expire_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file = <a href="ngx_queue.h.html#L103" title="core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;cache-&gt;rbtree, &amp;file-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;current--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, <a href="ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;delete cached open file: </span><span class="Special">%s</span><span class="Constant">&quot;</span>, file-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!file-&gt;err &amp;&amp; !file-&gt;is_dir) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file-&gt;close = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file-&gt;count = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1032" title="core/ngx_open_file_cache.c:1032">ngx_close_cached_file</a>(cache, file, <span class="Constant">0</span>, <a href="ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(file-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(file);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cache-&gt;current) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, <a href="ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">%u</span><span class="Constant">i items still leave in open file cache&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;current);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cache-&gt;rbtree.root != cache-&gt;rbtree.sentinel) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, <a href="ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;rbtree still is not empty in open file cache&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L144">&#x200c;</a><span class="linkable">ngx_open_cached_file</span>(<a href="ngx_open_file_cache.h.html#L99" title="core/ngx_open_file_cache.h:99">ngx_open_file_cache_t</a> *cache, <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L51" title="core/ngx_open_file_cache.h:51">ngx_open_file_info_t</a> *of, <a href="ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; now;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L17" title="os/unix/ngx_files.h:17">ngx_file_info_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; fi;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_palloc.h.html#L32" title="core/ngx_palloc.h:32">ngx_pool_cleanup_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *file;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_palloc.h.html#L72" title="core/ngx_palloc.h:72">ngx_pool_cleanup_file_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *clnf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L107" title="core/ngx_open_file_cache.h:107">ngx_open_file_cache_cleanup_t</a>&nbsp; *ofcln;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; of-&gt;fd = <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>&nbsp; &nbsp; of-&gt;err = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cache == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (of-&gt;test_only) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L781" title="core/ngx_open_file_cache.c:781">ngx_file_info_wrapper</a>(name, of, &amp;fi, pool-&gt;log)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;uniq = <a href="../os/unix/ngx_files.h.html#L190" title="os/unix/ngx_files.h:190">ngx_file_uniq</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;mtime = <a href="../os/unix/ngx_files.h.html#L189" title="os/unix/ngx_files.h:189">ngx_file_mtime</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;size = <a href="../os/unix/ngx_files.h.html#L187" title="os/unix/ngx_files.h:187">ngx_file_size</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;fs_size = <a href="../os/unix/ngx_files.h.html#L188" title="os/unix/ngx_files.h:188">ngx_file_fs_size</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;is_dir = <a href="../os/unix/ngx_files.h.html#L182" title="os/unix/ngx_files.h:182">ngx_is_dir</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;is_file = <a href="../os/unix/ngx_files.h.html#L183" title="os/unix/ngx_files.h:183">ngx_is_file</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;is_link = <a href="../os/unix/ngx_files.h.html#L184" title="os/unix/ngx_files.h:184">ngx_is_link</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;is_exec = <a href="../os/unix/ngx_files.h.html#L185" title="os/unix/ngx_files.h:185">ngx_is_exec</a>(&amp;fi);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cln = <a href="ngx_palloc.c.html#L314" title="core/ngx_palloc.c:314">ngx_pool_cleanup_add</a>(pool, <span class="Statement">sizeof</span>(<a href="ngx_palloc.h.html#L72" title="core/ngx_palloc.h:72">ngx_pool_cleanup_file_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L840" title="core/ngx_open_file_cache.c:840">ngx_open_and_stat_file</a>(name, of, pool-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a> &amp;&amp; !of-&gt;is_dir) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cln-&gt;handler = <a href="ngx_palloc.c.html#L366" title="core/ngx_palloc.c:366">ngx_pool_cleanup_file</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clnf = cln-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clnf-&gt;fd = of-&gt;fd;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clnf-&gt;name = name-&gt;data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clnf-&gt;log = pool-&gt;log;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = <a href="ngx_palloc.c.html#L314" title="core/ngx_palloc.c:314">ngx_pool_cleanup_add</a>(pool, <span class="Statement">sizeof</span>(<a href="ngx_open_file_cache.h.html#L107" title="core/ngx_open_file_cache.h:107">ngx_open_file_cache_cleanup_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; now = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hash = <a href="ngx_crc32.h.html#L39" title="core/ngx_crc32.h:39">ngx_crc32_long</a>(name-&gt;data, name-&gt;len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file = <a href="#L1187" title="core/ngx_open_file_cache.c:1187">ngx_open_file_lookup</a>(cache, name, hash);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (file) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file-&gt;uses++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;file-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;fd == <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a> &amp;&amp; file-&gt;err == <span class="Constant">0</span> &amp;&amp; !file-&gt;is_dir) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* file was not used often enough to keep open */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L840" title="core/ngx_open_file_cache.c:840">ngx_open_and_stat_file</a>(name, of, pool-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a> &amp;&amp; (of-&gt;err == <span class="Constant">0</span> || !of-&gt;errors)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> add_event;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;use_event<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || (file-&gt;event == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (of-&gt;uniq == <span class="Constant">0</span> || of-&gt;uniq == file-&gt;uniq)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; now - file-&gt;created &lt; of-&gt;valid<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_OPENAT)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; of-&gt;disable_symlinks == file-&gt;disable_symlinks<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; of-&gt;disable_symlinks_from == file-&gt;disable_symlinks_from<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;err == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;fd = file-&gt;fd;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;uniq = file-&gt;uniq;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;mtime = file-&gt;mtime;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;size = file-&gt;size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;is_dir = file-&gt;is_dir;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;is_file = file-&gt;is_file;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;is_link = file-&gt;is_link;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;is_exec = file-&gt;is_exec;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;is_directio = file-&gt;is_directio;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!file-&gt;is_dir) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file-&gt;count++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L954" title="core/ngx_open_file_cache.c:954">ngx_open_file_add_event</a>(cache, file, of, pool-&gt;log);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;err = file-&gt;err;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_OPENAT)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;failed = file-&gt;disable_symlinks ? <a href="../os/unix/ngx_files.h.html#L359" title="os/unix/ngx_files.h:359">ngx_openat_file_n</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : <a href="../os/unix/ngx_files.h.html#L70" title="os/unix/ngx_files.h:70">ngx_open_file_n</a>;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;failed = <a href="../os/unix/ngx_files.h.html#L70" title="os/unix/ngx_files.h:70">ngx_open_file_n</a>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L144" title="core/ngx_log.h:144">ngx_log_debug4</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, pool-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;retest open file: </span><span class="Special">%s</span><span class="Constant">, fd:</span><span class="Special">%d</span><span class="Constant">, c:</span><span class="Special">%d</span><span class="Constant">, e:</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file-&gt;name, file-&gt;fd, file-&gt;count, file-&gt;err);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;is_dir) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * chances that directory became file are very small<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * so test_dir flag allows to use a single syscall<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * in <a href="../os/unix/ngx_files.h.html#L173" title="os/unix/ngx_files.h:173">ngx_file_info</a>() instead of three syscalls<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;test_dir = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; of-&gt;fd = file-&gt;fd;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; of-&gt;uniq = file-&gt;uniq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L840" title="core/ngx_open_file_cache.c:840">ngx_open_and_stat_file</a>(name, of, pool-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a> &amp;&amp; (of-&gt;err == <span class="Constant">0</span> || !of-&gt;errors)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (of-&gt;is_dir) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;is_dir || file-&gt;err) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> update;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* file became directory */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (of-&gt;err == <span class="Constant">0</span>) {&nbsp; <span class="Comment">/* file */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;is_dir || file-&gt;err) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> add_event;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (of-&gt;uniq == file-&gt;uniq) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;event) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file-&gt;use_event = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;is_directio = file-&gt;is_directio;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> update;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* file was changed */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* error to cache */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;err || file-&gt;is_dir) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> update;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* file was removed, etc. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;count == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1078" title="core/ngx_open_file_cache.c:1078">ngx_open_file_del_event</a>(file);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L109" title="os/unix/ngx_files.h:109">ngx_close_file</a>(file-&gt;fd) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, pool-&gt;log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L110" title="os/unix/ngx_files.h:110">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> add_event;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;cache-&gt;rbtree, &amp;file-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;current--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file-&gt;close = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> create;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* not found */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L840" title="core/ngx_open_file_cache.c:840">ngx_open_and_stat_file</a>(name, of, pool-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a> &amp;&amp; (of-&gt;err == <span class="Constant">0</span> || !of-&gt;errors)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">create</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cache-&gt;current &gt;= cache-&gt;max) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1095" title="core/ngx_open_file_cache.c:1095">ngx_expire_old_cached_files</a>(cache, <span class="Constant">0</span>, pool-&gt;log);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file = <a href="../os/unix/ngx_alloc.c.html#L18" title="os/unix/ngx_alloc.c:18">ngx_alloc</a>(<span class="Statement">sizeof</span>(<a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a>), pool-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (file == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file-&gt;name = <a href="../os/unix/ngx_alloc.c.html#L18" title="os/unix/ngx_alloc.c:18">ngx_alloc</a>(name-&gt;len + <span class="Constant">1</span>, pool-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;name == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(file);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.c.html#L33" title="core/ngx_string.c:33">ngx_cpystrn</a>(file-&gt;name, name-&gt;data, name-&gt;len + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file-&gt;node.key = hash;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.c.html#L25" title="core/ngx_rbtree.c:25">ngx_rbtree_insert</a>(&amp;cache-&gt;rbtree, &amp;file-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;current++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file-&gt;uses = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; file-&gt;count = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; file-&gt;use_event = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; file-&gt;event = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">add_event</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L954" title="core/ngx_open_file_cache.c:954">ngx_open_file_add_event</a>(cache, file, of, pool-&gt;log);<br/></li>
<li><br/></li>
<li><span class="Statement">update</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; file-&gt;fd = of-&gt;fd;<br/></li>
<li>&nbsp; &nbsp; file-&gt;err = of-&gt;err;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_OPENAT)<br/></li>
<li></span>&nbsp; &nbsp; file-&gt;disable_symlinks = of-&gt;disable_symlinks;<br/></li>
<li>&nbsp; &nbsp; file-&gt;disable_symlinks_from = of-&gt;disable_symlinks_from;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (of-&gt;err == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file-&gt;uniq = of-&gt;uniq;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file-&gt;mtime = of-&gt;mtime;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file-&gt;size = of-&gt;size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file-&gt;close = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file-&gt;is_dir = of-&gt;is_dir;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file-&gt;is_file = of-&gt;is_file;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file-&gt;is_link = of-&gt;is_link;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file-&gt;is_exec = of-&gt;is_exec;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file-&gt;is_directio = of-&gt;is_directio;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!of-&gt;is_dir) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file-&gt;count++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file-&gt;created = now;<br/></li>
<li><br/></li>
<li><span class="Statement">found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; file-&gt;accessed = now;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;cache-&gt;expire_queue, &amp;file-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L147" title="core/ngx_log.h:147">ngx_log_debug5</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, pool-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;cached open file: </span><span class="Special">%s</span><span class="Constant">, fd:</span><span class="Special">%d</span><span class="Constant">, c:</span><span class="Special">%d</span><span class="Constant">, e:</span><span class="Special">%d</span><span class="Constant">, u:</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file-&gt;name, file-&gt;fd, file-&gt;count, file-&gt;err, file-&gt;uses);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (of-&gt;err == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!of-&gt;is_dir) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cln-&gt;handler = <a href="#L1018" title="core/ngx_open_file_cache.c:1018">ngx_open_file_cleanup</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ofcln = cln-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ofcln-&gt;cache = cache;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ofcln-&gt;file = file;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ofcln-&gt;min_uses = of-&gt;min_uses;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ofcln-&gt;log = pool-&gt;log;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (file) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;cache-&gt;rbtree, &amp;file-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;current--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;count == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;fd != <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L109" title="os/unix/ngx_files.h:109">ngx_close_file</a>(file-&gt;fd) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, pool-&gt;log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L110" title="os/unix/ngx_files.h:110">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(file-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(file);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file-&gt;close = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (of-&gt;fd != <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L109" title="os/unix/ngx_files.h:109">ngx_close_file</a>(of-&gt;fd) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, pool-&gt;log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L110" title="os/unix/ngx_files.h:110">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_OPENAT)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="../os/unix/ngx_files.h.html#L16" title="os/unix/ngx_files.h:16">ngx_fd_t</a><br/></li>
<li><a id="L492">&#x200c;</a><span class="linkable">ngx_openat_file_owner</span>(<a href="../os/unix/ngx_files.h.html#L16" title="os/unix/ngx_files.h:16">ngx_fd_t</a> at_fd, <span class="Type">const</span> u_char *name,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> mode, <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> create, <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> access, <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L16" title="os/unix/ngx_files.h:16">ngx_fd_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; fd;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_errno.h.html#L16" title="os/unix/ngx_errno.h:16">ngx_err_t</a>&nbsp; &nbsp; &nbsp; &nbsp; err;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L17" title="os/unix/ngx_files.h:17">ngx_file_info_t</a>&nbsp; fi, atfi;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * To allow symlinks with the same owner, use openat() (followed<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * by fstat()) and fstatat(AT_SYMLINK_NOFOLLOW), and then compare<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * uids between fstat() and fstatat().<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * As there is a race between openat() and fstatat() we don't<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * know if openat() in fact opened symlink or not.&nbsp; Therefore,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * we have to compare uids even if fstatat() reports the opened<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * component isn't a symlink (as we don't know whether it was<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * symlink during openat() or not).<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; fd = <a href="../os/unix/ngx_files.h.html#L356" title="os/unix/ngx_files.h:356">ngx_openat_file</a>(at_fd, name, mode, create, access);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd == <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L361" title="os/unix/ngx_files.h:361">ngx_file_at_info</a>(at_fd, name, &amp;atfi, AT_SYMLINK_NOFOLLOW)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_O_PATH)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L559" title="core/ngx_open_file_cache.c:559">ngx_file_o_path_info</a>(fd, &amp;fi, log) == <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L176" title="os/unix/ngx_files.h:176">ngx_fd_info</a>(fd, &amp;fi) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fi.st_uid != atfi.st_uid) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <a href="../os/unix/ngx_errno.h.html#L54" title="os/unix/ngx_errno.h:54">NGX_ELOOP</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> fd;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L109" title="os/unix/ngx_files.h:109">ngx_close_file</a>(fd) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L110" title="os/unix/ngx_files.h:110">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_errno.h.html#L70" title="os/unix/ngx_errno.h:70">ngx_set_errno</a>(err);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_O_PATH)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L559">&#x200c;</a><span class="linkable">ngx_file_o_path_info</span>(<a href="../os/unix/ngx_files.h.html#L16" title="os/unix/ngx_files.h:16">ngx_fd_t</a> fd, <a href="../os/unix/ngx_files.h.html#L17" title="os/unix/ngx_files.h:17">ngx_file_info_t</a> *fi, <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; use_fstat = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * In Linux 2.6.39 the O_PATH flag was introduced that allows to obtain<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * a descriptor without actually opening file or directory.&nbsp; It requires<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * less permissions for path components, but till Linux 3.6 fstat() returns<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * EBADF on such descriptors, and fstatat() with the AT_EMPTY_PATH flag<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * should be used instead.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Three scenarios are handled in this function:<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * 1) The kernel is newer than 3.6 or fstat() with O_PATH support was<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp; backported by vendor.&nbsp; Then fstat() is used.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * 2) The kernel is newer than 2.6.39 but older than 3.6.&nbsp; In this case<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp; the first call of fstat() returns EBADF and we fallback to fstatat()<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp; with AT_EMPTY_PATH which was introduced at the same time as O_PATH.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * 3) The kernel is older than 2.6.39 but <a href="../http/modules/perl/ngx_http_perl_module.h.html#L21" title="http/modules/perl/ngx_http_perl_module.h:21">nginx</a> was build with O_PATH<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp; support.&nbsp; Since descriptors are opened with O_PATH|O_RDONLY flags<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp; and O_PATH is ignored by the kernel then the O_RDONLY flag is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp; actually used.&nbsp; In this case fstat() just works.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (use_fstat) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L176" title="os/unix/ngx_files.h:176">ngx_fd_info</a>(fd, fi) != <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a> != <a href="../os/unix/ngx_errno.h.html#L55" title="os/unix/ngx_errno.h:55">NGX_EBADF</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L22" title="core/ngx_log.h:22">NGX_LOG_NOTICE</a>, log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;fstat(O_PATH) failed with EBADF, &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;switching to fstatat(AT_EMPTY_PATH)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; use_fstat = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L361" title="os/unix/ngx_files.h:361">ngx_file_at_info</a>(fd, <span class="Constant">&quot;&quot;</span>, fi, AT_EMPTY_PATH) != <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif</span> <span class="Comment">/* NGX_HAVE_OPENAT */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../os/unix/ngx_files.h.html#L16" title="os/unix/ngx_files.h:16">ngx_fd_t</a><br/></li>
<li><a id="L614">&#x200c;</a><span class="linkable">ngx_open_file_wrapper</span>(<a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name, <a href="ngx_open_file_cache.h.html#L51" title="core/ngx_open_file_cache.h:51">ngx_open_file_info_t</a> *of,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> mode, <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> create, <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> access, <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L16" title="os/unix/ngx_files.h:16">ngx_fd_t</a>&nbsp; fd;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if !(NGX_HAVE_OPENAT)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; fd = <a href="../os/unix/ngx_files.h.html#L60" title="os/unix/ngx_files.h:60">ngx_open_file</a>(name-&gt;data, mode, create, access);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd == <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; of-&gt;err = <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; of-&gt;failed = <a href="../os/unix/ngx_files.h.html#L70" title="os/unix/ngx_files.h:70">ngx_open_file_n</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> fd;<br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p, *cp, *end;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L16" title="os/unix/ngx_files.h:16">ngx_fd_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; at_fd;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; at_name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (of-&gt;disable_symlinks == <a href="ngx_core.h.html#L96" title="core/ngx_core.h:96">NGX_DISABLE_SYMLINKS_OFF</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fd = <a href="../os/unix/ngx_files.h.html#L60" title="os/unix/ngx_files.h:60">ngx_open_file</a>(name-&gt;data, mode, create, access);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fd == <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;err = <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;failed = <a href="../os/unix/ngx_files.h.html#L70" title="os/unix/ngx_files.h:70">ngx_open_file_n</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> fd;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = name-&gt;data;<br/></li>
<li>&nbsp; &nbsp; end = p + name-&gt;len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; at_name = *name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (of-&gt;disable_symlinks_from) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cp = p + of-&gt;disable_symlinks_from;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *cp = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; at_fd = <a href="../os/unix/ngx_files.h.html#L60" title="os/unix/ngx_files.h:60">ngx_open_file</a>(p, <a href="../os/unix/ngx_files.h.html#L91" title="os/unix/ngx_files.h:91">NGX_FILE_SEARCH</a>|<a href="../os/unix/ngx_files.h.html#L79" title="os/unix/ngx_files.h:79">NGX_FILE_NONBLOCK</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L76" title="os/unix/ngx_files.h:76">NGX_FILE_OPEN</a>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *cp = <span class="Constant">'/'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (at_fd == <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;err = <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;failed = <a href="../os/unix/ngx_files.h.html#L70" title="os/unix/ngx_files.h:70">ngx_open_file_n</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; at_name.len = of-&gt;disable_symlinks_from;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = cp + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (*p == <span class="Constant">'/'</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; at_fd = <a href="../os/unix/ngx_files.h.html#L60" title="os/unix/ngx_files.h:60">ngx_open_file</a>(<span class="Constant">&quot;/&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L91" title="os/unix/ngx_files.h:91">NGX_FILE_SEARCH</a>|<a href="../os/unix/ngx_files.h.html#L79" title="os/unix/ngx_files.h:79">NGX_FILE_NONBLOCK</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L76" title="os/unix/ngx_files.h:76">NGX_FILE_OPEN</a>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (at_fd == <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;err = <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;failed = <a href="../os/unix/ngx_files.h.html#L359" title="os/unix/ngx_files.h:359">ngx_openat_file_n</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; at_name.len = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; at_fd = <a href="../os/unix/ngx_files.h.html#L366" title="os/unix/ngx_files.h:366">NGX_AT_FDCWD</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cp = <a href="ngx_string.h.html#L66" title="core/ngx_string.h:66">ngx_strlchr</a>(p, end, <span class="Constant">'/'</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cp == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cp == p) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *cp = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (of-&gt;disable_symlinks == <a href="ngx_core.h.html#L98" title="core/ngx_core.h:98">NGX_DISABLE_SYMLINKS_NOTOWNER</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd = <a href="#L492" title="core/ngx_open_file_cache.c:492">ngx_openat_file_owner</a>(at_fd, p,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_files.h.html#L91" title="os/unix/ngx_files.h:91">NGX_FILE_SEARCH</a>|<a href="../os/unix/ngx_files.h.html#L79" title="os/unix/ngx_files.h:79">NGX_FILE_NONBLOCK</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_files.h.html#L76" title="os/unix/ngx_files.h:76">NGX_FILE_OPEN</a>, <span class="Constant">0</span>, log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd = <a href="../os/unix/ngx_files.h.html#L356" title="os/unix/ngx_files.h:356">ngx_openat_file</a>(at_fd, p,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_files.h.html#L91" title="os/unix/ngx_files.h:91">NGX_FILE_SEARCH</a>|<a href="../os/unix/ngx_files.h.html#L79" title="os/unix/ngx_files.h:79">NGX_FILE_NONBLOCK</a>|<a href="../os/unix/ngx_files.h.html#L82" title="os/unix/ngx_files.h:82">NGX_FILE_NOFOLLOW</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_files.h.html#L76" title="os/unix/ngx_files.h:76">NGX_FILE_OPEN</a>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *cp = <span class="Constant">'/'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fd == <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;err = <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;failed = <a href="../os/unix/ngx_files.h.html#L359" title="os/unix/ngx_files.h:359">ngx_openat_file_n</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (at_fd != <a href="../os/unix/ngx_files.h.html#L366" title="os/unix/ngx_files.h:366">NGX_AT_FDCWD</a> &amp;&amp; <a href="../os/unix/ngx_files.h.html#L109" title="os/unix/ngx_files.h:109">ngx_close_file</a>(at_fd) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L110" title="os/unix/ngx_files.h:110">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, &amp;at_name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = cp + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; at_fd = fd;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; at_name.len = cp - at_name.data;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == end) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If pathname ends with a trailing slash, assume the last path<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * component is a directory and reopen it with requested flags;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * if not, fail with ENOTDIR as per POSIX.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * We cannot rely on O_DIRECTORY in the loop above to check<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * that the last path component is a directory because<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * O_DIRECTORY doesn't work on FreeBSD 8.&nbsp; Fortunately, by<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * reopening a directory, we don't depend on it at all.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fd = <a href="../os/unix/ngx_files.h.html#L356" title="os/unix/ngx_files.h:356">ngx_openat_file</a>(at_fd, <span class="Constant">&quot;.&quot;</span>, mode, create, access);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (of-&gt;disable_symlinks == <a href="ngx_core.h.html#L98" title="core/ngx_core.h:98">NGX_DISABLE_SYMLINKS_NOTOWNER</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; !(create &amp; (<a href="../os/unix/ngx_files.h.html#L75" title="os/unix/ngx_files.h:75">NGX_FILE_CREATE_OR_OPEN</a>|<a href="../os/unix/ngx_files.h.html#L77" title="os/unix/ngx_files.h:77">NGX_FILE_TRUNCATE</a>)))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fd = <a href="#L492" title="core/ngx_open_file_cache.c:492">ngx_openat_file_owner</a>(at_fd, p, mode, create, access, log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fd = <a href="../os/unix/ngx_files.h.html#L356" title="os/unix/ngx_files.h:356">ngx_openat_file</a>(at_fd, p, mode|<a href="../os/unix/ngx_files.h.html#L82" title="os/unix/ngx_files.h:82">NGX_FILE_NOFOLLOW</a>, create, access);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd == <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; of-&gt;err = <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; of-&gt;failed = <a href="../os/unix/ngx_files.h.html#L359" title="os/unix/ngx_files.h:359">ngx_openat_file_n</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (at_fd != <a href="../os/unix/ngx_files.h.html#L366" title="os/unix/ngx_files.h:366">NGX_AT_FDCWD</a> &amp;&amp; <a href="../os/unix/ngx_files.h.html#L109" title="os/unix/ngx_files.h:109">ngx_close_file</a>(at_fd) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L110" title="os/unix/ngx_files.h:110">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, &amp;at_name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> fd;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L781">&#x200c;</a><span class="linkable">ngx_file_info_wrapper</span>(<a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name, <a href="ngx_open_file_cache.h.html#L51" title="core/ngx_open_file_cache.h:51">ngx_open_file_info_t</a> *of,<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L17" title="os/unix/ngx_files.h:17">ngx_file_info_t</a> *fi, <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; rc;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if !(NGX_HAVE_OPENAT)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../os/unix/ngx_files.h.html#L173" title="os/unix/ngx_files.h:173">ngx_file_info</a>(name-&gt;data, fi);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; of-&gt;err = <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; of-&gt;failed = <a href="../os/unix/ngx_files.h.html#L174" title="os/unix/ngx_files.h:174">ngx_file_info_n</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L16" title="os/unix/ngx_files.h:16">ngx_fd_t</a>&nbsp; fd;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (of-&gt;disable_symlinks == <a href="ngx_core.h.html#L96" title="core/ngx_core.h:96">NGX_DISABLE_SYMLINKS_OFF</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../os/unix/ngx_files.h.html#L173" title="os/unix/ngx_files.h:173">ngx_file_info</a>(name-&gt;data, fi);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;err = <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;failed = <a href="../os/unix/ngx_files.h.html#L174" title="os/unix/ngx_files.h:174">ngx_file_info_n</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fd = <a href="#L614" title="core/ngx_open_file_cache.c:614">ngx_open_file_wrapper</a>(name, of, <a href="../os/unix/ngx_files.h.html#L72" title="os/unix/ngx_files.h:72">NGX_FILE_RDONLY</a>|<a href="../os/unix/ngx_files.h.html#L79" title="os/unix/ngx_files.h:79">NGX_FILE_NONBLOCK</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_files.h.html#L76" title="os/unix/ngx_files.h:76">NGX_FILE_OPEN</a>, <span class="Constant">0</span>, log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd == <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../os/unix/ngx_files.h.html#L176" title="os/unix/ngx_files.h:176">ngx_fd_info</a>(fd, fi);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; of-&gt;err = <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; of-&gt;failed = <a href="../os/unix/ngx_files.h.html#L177" title="os/unix/ngx_files.h:177">ngx_fd_info_n</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L109" title="os/unix/ngx_files.h:109">ngx_close_file</a>(fd) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L110" title="os/unix/ngx_files.h:110">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L840">&#x200c;</a><span class="linkable">ngx_open_and_stat_file</span>(<a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name, <a href="ngx_open_file_cache.h.html#L51" title="core/ngx_open_file_cache.h:51">ngx_open_file_info_t</a> *of,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L16" title="os/unix/ngx_files.h:16">ngx_fd_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; fd;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L17" title="os/unix/ngx_files.h:17">ngx_file_info_t</a>&nbsp; fi;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (of-&gt;fd != <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L781" title="core/ngx_open_file_cache.c:781">ngx_file_info_wrapper</a>(name, of, &amp;fi, log) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;fd = <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (of-&gt;uniq == <a href="../os/unix/ngx_files.h.html#L190" title="os/unix/ngx_files.h:190">ngx_file_uniq</a>(&amp;fi)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (of-&gt;test_dir) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L781" title="core/ngx_open_file_cache.c:781">ngx_file_info_wrapper</a>(name, of, &amp;fi, log) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;fd = <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L182" title="os/unix/ngx_files.h:182">ngx_is_dir</a>(&amp;fi)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!of-&gt;log) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Use non-blocking open() not to hang on FIFO files, etc.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * This flag has no effect on a regular files.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fd = <a href="#L614" title="core/ngx_open_file_cache.c:614">ngx_open_file_wrapper</a>(name, of, <a href="../os/unix/ngx_files.h.html#L72" title="os/unix/ngx_files.h:72">NGX_FILE_RDONLY</a>|<a href="../os/unix/ngx_files.h.html#L79" title="os/unix/ngx_files.h:79">NGX_FILE_NONBLOCK</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_files.h.html#L76" title="os/unix/ngx_files.h:76">NGX_FILE_OPEN</a>, <span class="Constant">0</span>, log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fd = <a href="#L614" title="core/ngx_open_file_cache.c:614">ngx_open_file_wrapper</a>(name, of, <a href="../os/unix/ngx_files.h.html#L78" title="os/unix/ngx_files.h:78">NGX_FILE_APPEND</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_files.h.html#L75" title="os/unix/ngx_files.h:75">NGX_FILE_CREATE_OR_OPEN</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_files.h.html#L105" title="os/unix/ngx_files.h:105">NGX_FILE_DEFAULT_ACCESS</a>, log);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd == <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; of-&gt;fd = <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L176" title="os/unix/ngx_files.h:176">ngx_fd_info</a>(fd, &amp;fi) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>, log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L177" title="os/unix/ngx_files.h:177">ngx_fd_info_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L109" title="os/unix/ngx_files.h:109">ngx_close_file</a>(fd) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L110" title="os/unix/ngx_files.h:110">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; of-&gt;fd = <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L182" title="os/unix/ngx_files.h:182">ngx_is_dir</a>(&amp;fi)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L109" title="os/unix/ngx_files.h:109">ngx_close_file</a>(fd) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L110" title="os/unix/ngx_files.h:110">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; of-&gt;fd = <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; of-&gt;fd = fd;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (of-&gt;read_ahead &amp;&amp; <a href="../os/unix/ngx_files.h.html#L187" title="os/unix/ngx_files.h:187">ngx_file_size</a>(&amp;fi) &gt; <a href="#L21" title="core/ngx_open_file_cache.c:21">NGX_MIN_READ_AHEAD</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.c.html#L469" title="os/unix/ngx_files.c:469">ngx_read_ahead</a>(fd, of-&gt;read_ahead) == <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L309" title="os/unix/ngx_files.h:309">ngx_read_ahead_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (of-&gt;directio &lt;= <a href="../os/unix/ngx_files.h.html#L187" title="os/unix/ngx_files.h:187">ngx_file_size</a>(&amp;fi)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.c.html#L489" title="os/unix/ngx_files.c:489">ngx_directio_on</a>(fd) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L329" title="os/unix/ngx_files.h:329">ngx_directio_on_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of-&gt;is_directio = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; of-&gt;uniq = <a href="../os/unix/ngx_files.h.html#L190" title="os/unix/ngx_files.h:190">ngx_file_uniq</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; of-&gt;mtime = <a href="../os/unix/ngx_files.h.html#L189" title="os/unix/ngx_files.h:189">ngx_file_mtime</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; of-&gt;size = <a href="../os/unix/ngx_files.h.html#L187" title="os/unix/ngx_files.h:187">ngx_file_size</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; of-&gt;fs_size = <a href="../os/unix/ngx_files.h.html#L188" title="os/unix/ngx_files.h:188">ngx_file_fs_size</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; of-&gt;is_dir = <a href="../os/unix/ngx_files.h.html#L182" title="os/unix/ngx_files.h:182">ngx_is_dir</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; of-&gt;is_file = <a href="../os/unix/ngx_files.h.html#L183" title="os/unix/ngx_files.h:183">ngx_is_file</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; of-&gt;is_link = <a href="../os/unix/ngx_files.h.html#L184" title="os/unix/ngx_files.h:184">ngx_is_link</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; of-&gt;is_exec = <a href="../os/unix/ngx_files.h.html#L185" title="os/unix/ngx_files.h:185">ngx_is_exec</a>(&amp;fi);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * we ignore any possible event setting error and<br/></li>
<li></span><span class="Comment"> * fallback to <a href="../http/ngx_http_parse.c.html#L13" title="http/ngx_http_parse.c:13">usual</a> periodic file retests<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L954">&#x200c;</a></span><span class="linkable">ngx_open_file_add_event</span>(<a href="ngx_open_file_cache.h.html#L99" title="core/ngx_open_file_cache.h:99">ngx_open_file_cache_t</a> *cache,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a> *file, <a href="ngx_open_file_cache.h.html#L51" title="core/ngx_open_file_cache.h:51">ngx_open_file_info_t</a> *of, <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L120" title="core/ngx_open_file_cache.h:120">ngx_open_file_cache_event_t</a>&nbsp; *fev;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!(<a href="../event/ngx_event.c.html#L44" title="event/ngx_event.c:44">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L295" title="event/ngx_event.h:295">NGX_USE_VNODE_EVENT</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || !of-&gt;events<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || file-&gt;event<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || of-&gt;fd == <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || file-&gt;uses &lt; of-&gt;min_uses)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file-&gt;use_event = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file-&gt;event = <a href="../os/unix/ngx_alloc.c.html#L35" title="os/unix/ngx_alloc.c:35">ngx_calloc</a>(<span class="Statement">sizeof</span>(<a href="ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a>), log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;event== <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fev = <a href="../os/unix/ngx_alloc.c.html#L18" title="os/unix/ngx_alloc.c:18">ngx_alloc</a>(<span class="Statement">sizeof</span>(<a href="ngx_open_file_cache.h.html#L120" title="core/ngx_open_file_cache.h:120">ngx_open_file_cache_event_t</a>), log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fev == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(file-&gt;event);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file-&gt;event = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fev-&gt;fd = of-&gt;fd;<br/></li>
<li>&nbsp; &nbsp; fev-&gt;file = file;<br/></li>
<li>&nbsp; &nbsp; fev-&gt;cache = cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file-&gt;event-&gt;handler = <a href="#L1227" title="core/ngx_open_file_cache.c:1227">ngx_open_file_cache_remove</a>;<br/></li>
<li>&nbsp; &nbsp; file-&gt;event-&gt;data = fev;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * although vnode event may be called while <a href="ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;poll<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * destruction, however, cleanup procedures are run before any<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * memory freeing and events will be canceled.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; file-&gt;event-&gt;log = <a href="ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L422" title="event/ngx_event.h:422">ngx_add_event</a>(file-&gt;event, <a href="../event/ngx_event.h.html#L324" title="event/ngx_event.h:324">NGX_VNODE_EVENT</a>, <a href="../event/ngx_event.h.html#L357" title="event/ngx_event.h:357">NGX_ONESHOT_EVENT</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(file-&gt;event-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(file-&gt;event);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file-&gt;event = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * we do not <a href="../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> file-&gt;use_event here because there may be a race<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * condition: a file may be deleted between opening the file and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * adding event, so we rely upon event notification only after<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * one file revalidation on next file access<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1018">&#x200c;</a></span><span class="linkable">ngx_open_file_cleanup</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L107" title="core/ngx_open_file_cache.h:107">ngx_open_file_cache_cleanup_t</a>&nbsp; *c = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;file-&gt;count--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1032" title="core/ngx_open_file_cache.c:1032">ngx_close_cached_file</a>(c-&gt;cache, c-&gt;file, c-&gt;min_uses, c-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* drop one or two expired open files */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1095" title="core/ngx_open_file_cache.c:1095">ngx_expire_old_cached_files</a>(c-&gt;cache, <span class="Constant">1</span>, c-&gt;log);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1032">&#x200c;</a></span><span class="linkable">ngx_close_cached_file</span>(<a href="ngx_open_file_cache.h.html#L99" title="core/ngx_open_file_cache.h:99">ngx_open_file_cache_t</a> *cache,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a> *file, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> min_uses, <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L147" title="core/ngx_log.h:147">ngx_log_debug5</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;close cached open file: </span><span class="Special">%s</span><span class="Constant">, fd:</span><span class="Special">%d</span><span class="Constant">, c:</span><span class="Special">%d</span><span class="Constant">, u:</span><span class="Special">%d</span><span class="Constant">, </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file-&gt;name, file-&gt;fd, file-&gt;count, file-&gt;uses, file-&gt;close);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!file-&gt;close) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file-&gt;accessed = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;file-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;cache-&gt;expire_queue, &amp;file-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;uses &gt;= min_uses || file-&gt;count) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1078" title="core/ngx_open_file_cache.c:1078">ngx_open_file_del_event</a>(file);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;count) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;fd != <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L109" title="os/unix/ngx_files.h:109">ngx_close_file</a>(file-&gt;fd) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L110" title="os/unix/ngx_files.h:110">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, file-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file-&gt;fd = <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!file-&gt;close) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(file-&gt;name);<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(file);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1078">&#x200c;</a></span><span class="linkable">ngx_open_file_del_event</span>(<a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a> *file)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;event == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="../event/ngx_event.h.html#L423" title="event/ngx_event.h:423">ngx_del_event</a>(file-&gt;event, <a href="../event/ngx_event.h.html#L324" title="event/ngx_event.h:324">NGX_VNODE_EVENT</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file-&gt;count ? <a href="../event/ngx_event.h.html#L319" title="event/ngx_event.h:319">NGX_FLUSH_EVENT</a> : <a href="../event/ngx_event.h.html#L308" title="event/ngx_event.h:308">NGX_CLOSE_EVENT</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(file-&gt;event-&gt;data);<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(file-&gt;event);<br/></li>
<li>&nbsp; &nbsp; file-&gt;event = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; file-&gt;use_event = <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1095">&#x200c;</a></span><span class="linkable">ngx_expire_old_cached_files</span>(<a href="ngx_open_file_cache.h.html#L99" title="core/ngx_open_file_cache.h:99">ngx_open_file_cache_t</a> *cache, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> n,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; now;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a>&nbsp; *file;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; now = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * n == 1 deletes one or two inactive files<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * n == 0 deletes least recently used file by force<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp; &nbsp; &nbsp; and one or two inactive files<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (n &lt; <span class="Constant">3</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_queue.h.html#L29" title="core/ngx_queue.h:29">ngx_queue_empty</a>(&amp;cache-&gt;expire_queue)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; q = <a href="ngx_queue.h.html#L54" title="core/ngx_queue.h:54">ngx_queue_last</a>(&amp;cache-&gt;expire_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file = <a href="ngx_queue.h.html#L103" title="core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n++ != <span class="Constant">0</span> &amp;&amp; now - file-&gt;accessed &lt;= cache-&gt;inactive) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;cache-&gt;rbtree, &amp;file-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;current--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;expire cached open file: </span><span class="Special">%s</span><span class="Constant">&quot;</span>, file-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!file-&gt;err &amp;&amp; !file-&gt;is_dir) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file-&gt;close = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1032" title="core/ngx_open_file_cache.c:1032">ngx_close_cached_file</a>(cache, file, <span class="Constant">0</span>, log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(file-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(file);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1146">&#x200c;</a></span><span class="linkable">ngx_open_file_cache_rbtree_insert_value</span>(<a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp;&nbsp; **p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a>&nbsp; &nbsp; *file, *file_temp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;key &lt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;left;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (node-&gt;key &gt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;right;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* node-&gt;key == temp-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file = (<a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a> *) node;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file_temp = (<a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a> *) temp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (<a href="ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(file-&gt;name, file_temp-&gt;name) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ? &amp;temp-&gt;left : &amp;temp-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == sentinel) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; temp = *p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p = node;<br/></li>
<li>&nbsp; &nbsp; node-&gt;parent = temp;<br/></li>
<li>&nbsp; &nbsp; node-&gt;left = sentinel;<br/></li>
<li>&nbsp; &nbsp; node-&gt;right = sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L59" title="core/ngx_rbtree.h:59">ngx_rbt_red</a>(node);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a> *<br/></li>
<li><a id="L1187">&#x200c;</a><span class="linkable">ngx_open_file_lookup</span>(<a href="ngx_open_file_cache.h.html#L99" title="core/ngx_open_file_cache.h:99">ngx_open_file_cache_t</a> *cache, <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span> hash)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *node, *sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a>&nbsp; *file;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = cache-&gt;rbtree.root;<br/></li>
<li>&nbsp; &nbsp; sentinel = cache-&gt;rbtree.sentinel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (node != sentinel) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &lt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;left;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &gt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* hash == node-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file = (<a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a> *) node;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(name-&gt;data, file-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> file;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = (rc &lt; <span class="Constant">0</span>) ? node-&gt;left : node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1227">&#x200c;</a></span><span class="linkable">ngx_open_file_cache_remove</span>(<a href="ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L54" title="core/ngx_open_file_cache.h:54">ngx_cached_open_file_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *file;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_open_file_cache.h.html#L120" title="core/ngx_open_file_cache.h:120">ngx_open_file_cache_event_t</a>&nbsp; *fev;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fev = ev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; file = fev-&gt;file;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;file-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;fev-&gt;cache-&gt;rbtree, &amp;file-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fev-&gt;cache-&gt;current--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="../event/ngx_event.h.html#L357" title="event/ngx_event.h:357">NGX_ONESHOT_EVENT</a> was already deleted */<br/></li>
<li></span>&nbsp; &nbsp; file-&gt;event = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; file-&gt;use_event = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file-&gt;close = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1032" title="core/ngx_open_file_cache.c:1032">ngx_close_cached_file</a>(fev-&gt;cache, file, <span class="Constant">0</span>, ev-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* free memory only when fev-&gt;cache and fev-&gt;file are already not needed */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(ev-&gt;data);<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(ev);<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
