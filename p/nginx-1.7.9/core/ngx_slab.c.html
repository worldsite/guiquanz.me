<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>core/ngx_slab.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>core/ngx_slab.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L69">ngx_slab_exact_shift</a></li>
<li><a href="#L68">ngx_slab_exact_size</a></li>
<li><a href="#L67">ngx_slab_max_size</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L141">ngx_slab_alloc</a></li>
<li><a href="#L156">ngx_slab_alloc_locked</a></li>
<li><a href="#L651">ngx_slab_alloc_pages</a></li>
<li><a href="#L402">ngx_slab_calloc</a></li>
<li><a href="#L417">ngx_slab_calloc_locked</a></li>
<li><a href="#L786">ngx_slab_error</a></li>
<li><a href="#L431">ngx_slab_free</a></li>
<li><a href="#L442">ngx_slab_free_locked</a></li>
<li><a href="#L705">ngx_slab_free_pages</a></li>
<li><a href="#L73">ngx_slab_init</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L13">NGX_SLAB_BIG</a></li>
<li><a href="#L27">NGX_SLAB_BUSY</a></li>
<li><a href="#L39">NGX_SLAB_BUSY</a></li>
<li><a href="#L14">NGX_SLAB_EXACT</a></li>
<li><a href="#L24">NGX_SLAB_MAP_MASK</a></li>
<li><a href="#L36">NGX_SLAB_MAP_MASK</a></li>
<li><a href="#L25">NGX_SLAB_MAP_SHIFT</a></li>
<li><a href="#L37">NGX_SLAB_MAP_SHIFT</a></li>
<li><a href="#L12">NGX_SLAB_PAGE</a></li>
<li><a href="#L20">NGX_SLAB_PAGE_BUSY</a></li>
<li><a href="#L32">NGX_SLAB_PAGE_BUSY</a></li>
<li><a href="#L19">NGX_SLAB_PAGE_FREE</a></li>
<li><a href="#L31">NGX_SLAB_PAGE_FREE</a></li>
<li><a href="#L11">NGX_SLAB_PAGE_MASK</a></li>
<li><a href="#L21">NGX_SLAB_PAGE_START</a></li>
<li><a href="#L33">NGX_SLAB_PAGE_START</a></li>
<li><a href="#L23">NGX_SLAB_SHIFT_MASK</a></li>
<li><a href="#L35">NGX_SLAB_SHIFT_MASK</a></li>
<li><a href="#L15">NGX_SLAB_SMALL</a></li>
<li><a href="#L46">ngx_slab_junk</a></li>
<li><a href="#L50">ngx_slab_junk</a></li>
<li><a href="#L55">ngx_slab_junk</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L11">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_SLAB_PAGE_MASK</span>&nbsp;&nbsp; </span><span class="Constant">3<br/></li>
<li><a id="L12">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_SLAB_PAGE</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0<br/></li>
<li><a id="L13">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_SLAB_BIG</span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">1<br/></li>
<li><a id="L14">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_SLAB_EXACT</span>&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">2<br/></li>
<li><a id="L15">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_SLAB_SMALL</span>&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">3<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_PTR_SIZE == </span><span class="Constant">4</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L19">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_SLAB_PAGE_FREE</span>&nbsp;&nbsp; </span><span class="Constant">0<br/></li>
<li><a id="L20">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_SLAB_PAGE_BUSY</span>&nbsp;&nbsp; </span><span class="Constant">0xffffffff<br/></li>
<li><a id="L21">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_SLAB_PAGE_START</span>&nbsp; </span><span class="Constant">0x80000000<br/></li>
<li></span><br/></li>
<li><a id="L23">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_SLAB_SHIFT_MASK</span>&nbsp; </span><span class="Constant">0x0000000f<br/></li>
<li><a id="L24">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_SLAB_MAP_MASK</span>&nbsp; &nbsp; </span><span class="Constant">0xffff0000<br/></li>
<li><a id="L25">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_SLAB_MAP_SHIFT</span>&nbsp;&nbsp; </span><span class="Constant">16<br/></li>
<li></span><br/></li>
<li><a id="L27">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_SLAB_BUSY</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0xffffffff<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#else</span> <span class="Comment">/* (NGX_PTR_SIZE == 8) */<br/></li>
<li></span><br/></li>
<li><a id="L31">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_SLAB_PAGE_FREE</span>&nbsp;&nbsp; </span><span class="Constant">0<br/></li>
<li><a id="L32">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_SLAB_PAGE_BUSY</span>&nbsp;&nbsp; </span><span class="Constant">0xffffffffffffffff<br/></li>
<li><a id="L33">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_SLAB_PAGE_START</span>&nbsp; </span><span class="Constant">0x8000000000000000<br/></li>
<li></span><br/></li>
<li><a id="L35">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_SLAB_SHIFT_MASK</span>&nbsp; </span><span class="Constant">0x000000000000000f<br/></li>
<li><a id="L36">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_SLAB_MAP_MASK</span>&nbsp; &nbsp; </span><span class="Constant">0xffffffff00000000<br/></li>
<li><a id="L37">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_SLAB_MAP_SHIFT</span>&nbsp;&nbsp; </span><span class="Constant">32<br/></li>
<li></span><br/></li>
<li><a id="L39">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_SLAB_BUSY</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0xffffffffffffffff<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_DEBUG_MALLOC)<br/></li>
<li></span><br/></li>
<li><a id="L46">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_slab_junk</span>(p, size)&nbsp; &nbsp;&nbsp; <a href="ngx_string.h.html#L87" title="core/ngx_string.h:87">ngx_memset</a>(p, </span><span class="Constant">0xA5</span><span class="PreProc">, size)<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#elif (<a href="../os/unix/ngx_freebsd_config.h.html#L120" title="os/unix/ngx_freebsd_config.h:120">NGX_HAVE_DEBUG_MALLOC</a>)<br/></li>
<li></span><br/></li>
<li><a id="L50">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_slab_junk</span>(p, size)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; </span><span class="Statement">if</span><span class="PreProc"> (<a href="../os/unix/ngx_darwin_init.c.html#L18" title="os/unix/ngx_darwin_init.c:18">ngx_debug_malloc</a>)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L87" title="core/ngx_string.h:87">ngx_memset</a>(p, </span><span class="Constant">0xA5</span><span class="PreProc">, size)<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><br/></li>
<li><a id="L55">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_slab_junk</span>(p, size)<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *<a href="#L651" title="core/ngx_slab.c:651">ngx_slab_alloc_pages</a>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *pool,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> pages);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L705" title="core/ngx_slab.c:705">ngx_slab_free_pages</a>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *pool, <a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *page,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> pages);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L786" title="core/ngx_slab.c:786">ngx_slab_error</a>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *pool, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> level,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> *text);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L67">&#x200c;</a><span class="Type">static</span> <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; <span class="linkable">ngx_slab_max_size</span>;<br/></li>
<li><a id="L68">&#x200c;</a><span class="Type">static</span> <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; <span class="linkable">ngx_slab_exact_size</span>;<br/></li>
<li><a id="L69">&#x200c;</a><span class="Type">static</span> <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; <span class="linkable">ngx_slab_exact_shift</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L73">&#x200c;</a></span><span class="linkable">ngx_slab_init</span>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *pool)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; m;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; i, n, pages;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a>&nbsp; *slots;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* STUB */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L67" title="core/ngx_slab.c:67">ngx_slab_max_size</a> == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L67" title="core/ngx_slab.c:67">ngx_slab_max_size</a> = <a href="../os/unix/ngx_alloc.c.html#L12" title="os/unix/ngx_alloc.c:12">ngx_pagesize</a> / <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L68" title="core/ngx_slab.c:68">ngx_slab_exact_size</a> = <a href="../os/unix/ngx_alloc.c.html#L12" title="os/unix/ngx_alloc.c:12">ngx_pagesize</a> / (<span class="Constant">8</span> * <span class="Statement">sizeof</span>(<span class="Type">uintptr_t</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (n = <a href="#L68" title="core/ngx_slab.c:68">ngx_slab_exact_size</a>; n &gt;&gt;= <span class="Constant">1</span>; <a href="#L69" title="core/ngx_slab.c:69">ngx_slab_exact_shift</a>++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* void */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/**/<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; pool-&gt;min_size = <span class="Constant">1</span> &lt;&lt; pool-&gt;min_shift;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = (u_char *) pool + <span class="Statement">sizeof</span>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a>);<br/></li>
<li>&nbsp; &nbsp; size = pool-&gt;end - p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L46" title="core/ngx_slab.c:46">ngx_slab_junk</a>(p, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; slots = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *) p;<br/></li>
<li>&nbsp; &nbsp; n = <a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a> - pool-&gt;min_shift;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; n; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; slots[i].slab = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; slots[i].next = &amp;slots[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; slots[i].prev = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p += n * <span class="Statement">sizeof</span>(<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pages = (<a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) (size / (<a href="../os/unix/ngx_alloc.c.html#L12" title="os/unix/ngx_alloc.c:12">ngx_pagesize</a> + <span class="Statement">sizeof</span>(<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(p, pages * <span class="Statement">sizeof</span>(<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pool-&gt;pages = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *) p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pool-&gt;free.prev = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; pool-&gt;free.next = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *) p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pool-&gt;pages-&gt;slab = pages;<br/></li>
<li>&nbsp; &nbsp; pool-&gt;pages-&gt;next = &amp;pool-&gt;free;<br/></li>
<li>&nbsp; &nbsp; pool-&gt;pages-&gt;prev = (<span class="Type">uintptr_t</span>) &amp;pool-&gt;free;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pool-&gt;start = (u_char *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_config.h.html#L98" title="core/ngx_config.h:98">ngx_align_ptr</a>((<span class="Type">uintptr_t</span>) p + pages * <span class="Statement">sizeof</span>(<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_alloc.c.html#L12" title="os/unix/ngx_alloc.c:12">ngx_pagesize</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; m = pages - (pool-&gt;end - pool-&gt;start) / <a href="../os/unix/ngx_alloc.c.html#L12" title="os/unix/ngx_alloc.c:12">ngx_pagesize</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (m &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pages -= m;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pool-&gt;pages-&gt;slab = pages;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pool-&gt;last = pool-&gt;pages + pages;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pool-&gt;log_nomem = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; pool-&gt;log_ctx = &amp;pool-&gt;zero;<br/></li>
<li>&nbsp; &nbsp; pool-&gt;zero = <span class="Special">'\0'</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void</span> *<br/></li>
<li><a id="L141">&#x200c;</a><span class="linkable">ngx_slab_alloc</span>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *pool, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_shmtx.c.html#L70" title="core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;pool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="#L156" title="core/ngx_slab.c:156">ngx_slab_alloc_locked</a>(pool, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_shmtx.c.html#L136" title="core/ngx_shmtx.c:136">ngx_shmtx_unlock</a>(&amp;pool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void</span> *<br/></li>
<li><a id="L156">&#x200c;</a><span class="linkable">ngx_slab_alloc_locked</span>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *pool, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uintptr_t</span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; p, n, m, mask, *bitmap;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; i, <a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>, shift, map;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a>&nbsp; *page, *prev, *slots;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &gt; <a href="#L67" title="core/ngx_slab.c:67">ngx_slab_max_size</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="ngx_log.h.html#L27" title="core/ngx_log.h:27">NGX_LOG_DEBUG_ALLOC</a>, <a href="ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;slab alloc: </span><span class="Special">%u</span><span class="Constant">z&quot;</span>, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; page = <a href="#L651" title="core/ngx_slab.c:651">ngx_slab_alloc_pages</a>(pool, (size &gt;&gt; <a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + ((size % <a href="../os/unix/ngx_alloc.c.html#L12" title="os/unix/ngx_alloc.c:12">ngx_pagesize</a>) ? <span class="Constant">1</span> : <span class="Constant">0</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (page) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (page - pool-&gt;pages) &lt;&lt; <a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p += (<span class="Type">uintptr_t</span>) pool-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &gt; pool-&gt;min_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; shift = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (s = size - <span class="Constant">1</span>; s &gt;&gt;= <span class="Constant">1</span>; shift++) { <span class="Comment">/* void */</span> }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a> = shift - pool-&gt;min_shift;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = pool-&gt;min_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; shift = pool-&gt;min_shift;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="ngx_log.h.html#L27" title="core/ngx_log.h:27">NGX_LOG_DEBUG_ALLOC</a>, <a href="ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;slab alloc: </span><span class="Special">%u</span><span class="Constant">z <a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>: </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, size, <a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; slots = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *) ((u_char *) pool + <span class="Statement">sizeof</span>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a>));<br/></li>
<li>&nbsp; &nbsp; page = slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>].next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (page-&gt;next != page) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (shift &lt; <a href="#L69" title="core/ngx_slab.c:69">ngx_slab_exact_shift</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (page - pool-&gt;pages) &lt;&lt; <a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bitmap = (<span class="Type">uintptr_t</span> *) (pool-&gt;start + p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map = (<span class="Constant">1</span> &lt;&lt; (<a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a> - shift))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; / (<span class="Statement">sizeof</span>(<span class="Type">uintptr_t</span>) * <span class="Constant">8</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n &lt; map; n++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bitmap[n] != <a href="#L27" title="core/ngx_slab.c:27">NGX_SLAB_BUSY</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (m = <span class="Constant">1</span>, i = <span class="Constant">0</span>; m; m &lt;&lt;= <span class="Constant">1</span>, i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((bitmap[n] &amp; m)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bitmap[n] |= m;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = ((n * <span class="Statement">sizeof</span>(<span class="Type">uintptr_t</span>) * <span class="Constant">8</span>) &lt;&lt; shift)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + (i &lt;&lt; shift);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bitmap[n] == <a href="#L27" title="core/ngx_slab.c:27">NGX_SLAB_BUSY</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (n = n + <span class="Constant">1</span>; n &lt; map; n++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">if</span> (bitmap[n] != <a href="#L27" title="core/ngx_slab.c:27">NGX_SLAB_BUSY</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; p = (<span class="Type">uintptr_t</span>) bitmap + i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (page-&gt;prev &amp; ~<a href="#L11" title="core/ngx_slab.c:11">NGX_SLAB_PAGE_MASK</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;next = page-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next-&gt;prev = page-&gt;prev;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;prev = <a href="#L15" title="core/ngx_slab.c:15">NGX_SLAB_SMALL</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (<span class="Type">uintptr_t</span>) bitmap + i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page = page-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (page);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (shift == <a href="#L69" title="core/ngx_slab.c:69">ngx_slab_exact_shift</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (page-&gt;slab != <a href="#L27" title="core/ngx_slab.c:27">NGX_SLAB_BUSY</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (m = <span class="Constant">1</span>, i = <span class="Constant">0</span>; m; m &lt;&lt;= <span class="Constant">1</span>, i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((page-&gt;slab &amp; m)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;slab |= m;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (page-&gt;slab == <a href="#L27" title="core/ngx_slab.c:27">NGX_SLAB_BUSY</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (page-&gt;prev &amp; ~<a href="#L11" title="core/ngx_slab.c:11">NGX_SLAB_PAGE_MASK</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;next = page-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next-&gt;prev = page-&gt;prev;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;prev = <a href="#L14" title="core/ngx_slab.c:14">NGX_SLAB_EXACT</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (page - pool-&gt;pages) &lt;&lt; <a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p += i &lt;&lt; shift;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p += (<span class="Type">uintptr_t</span>) pool-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page = page-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (page);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* shift &gt; <a href="#L69" title="core/ngx_slab.c:69">ngx_slab_exact_shift</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a> - (page-&gt;slab &amp; <a href="#L23" title="core/ngx_slab.c:23">NGX_SLAB_SHIFT_MASK</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = <span class="Constant">1</span> &lt;&lt; n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = ((<span class="Type">uintptr_t</span>) <span class="Constant">1</span> &lt;&lt; n) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mask = n &lt;&lt; <a href="#L25" title="core/ngx_slab.c:25">NGX_SLAB_MAP_SHIFT</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((page-&gt;slab &amp; <a href="#L24" title="core/ngx_slab.c:24">NGX_SLAB_MAP_MASK</a>) != mask) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (m = (<span class="Type">uintptr_t</span>) <span class="Constant">1</span> &lt;&lt; <a href="#L25" title="core/ngx_slab.c:25">NGX_SLAB_MAP_SHIFT</a>, i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; m &amp; mask;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; m &lt;&lt;= <span class="Constant">1</span>, i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((page-&gt;slab &amp; m)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;slab |= m;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((page-&gt;slab &amp; <a href="#L24" title="core/ngx_slab.c:24">NGX_SLAB_MAP_MASK</a>) == mask) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (page-&gt;prev &amp; ~<a href="#L11" title="core/ngx_slab.c:11">NGX_SLAB_PAGE_MASK</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;next = page-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next-&gt;prev = page-&gt;prev;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;prev = <a href="#L13" title="core/ngx_slab.c:13">NGX_SLAB_BIG</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (page - pool-&gt;pages) &lt;&lt; <a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p += i &lt;&lt; shift;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p += (<span class="Type">uintptr_t</span>) pool-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page = page-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (page);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; page = <a href="#L651" title="core/ngx_slab.c:651">ngx_slab_alloc_pages</a>(pool, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (page) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (shift &lt; <a href="#L69" title="core/ngx_slab.c:69">ngx_slab_exact_shift</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (page - pool-&gt;pages) &lt;&lt; <a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bitmap = (<span class="Type">uintptr_t</span> *) (pool-&gt;start + p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = <span class="Constant">1</span> &lt;&lt; shift;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = (<span class="Constant">1</span> &lt;&lt; (<a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a> - shift)) / <span class="Constant">8</span> / s;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bitmap[<span class="Constant">0</span>] = (<span class="Constant">2</span> &lt;&lt; n) - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map = (<span class="Constant">1</span> &lt;&lt; (<a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a> - shift)) / (<span class="Statement">sizeof</span>(<span class="Type">uintptr_t</span>) * <span class="Constant">8</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt; map; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bitmap[i] = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;slab = shift;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next = &amp;slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;prev = (<span class="Type">uintptr_t</span>) &amp;slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>] | <a href="#L15" title="core/ngx_slab.c:15">NGX_SLAB_SMALL</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>].next = page;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = ((page - pool-&gt;pages) &lt;&lt; <a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a>) + s * n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p += (<span class="Type">uintptr_t</span>) pool-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (shift == <a href="#L69" title="core/ngx_slab.c:69">ngx_slab_exact_shift</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;slab = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next = &amp;slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;prev = (<span class="Type">uintptr_t</span>) &amp;slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>] | <a href="#L14" title="core/ngx_slab.c:14">NGX_SLAB_EXACT</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>].next = page;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (page - pool-&gt;pages) &lt;&lt; <a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p += (<span class="Type">uintptr_t</span>) pool-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* shift &gt; <a href="#L69" title="core/ngx_slab.c:69">ngx_slab_exact_shift</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;slab = ((<span class="Type">uintptr_t</span>) <span class="Constant">1</span> &lt;&lt; <a href="#L25" title="core/ngx_slab.c:25">NGX_SLAB_MAP_SHIFT</a>) | shift;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next = &amp;slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;prev = (<span class="Type">uintptr_t</span>) &amp;slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>] | <a href="#L13" title="core/ngx_slab.c:13">NGX_SLAB_BIG</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>].next = page;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (page - pool-&gt;pages) &lt;&lt; <a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p += (<span class="Type">uintptr_t</span>) pool-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="ngx_log.h.html#L27" title="core/ngx_log.h:27">NGX_LOG_DEBUG_ALLOC</a>, <a href="ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;slab alloc: </span><span class="Special">%p</span><span class="Constant">&quot;</span>, p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (<span class="Type">void</span> *) p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void</span> *<br/></li>
<li><a id="L402">&#x200c;</a><span class="linkable">ngx_slab_calloc</span>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *pool, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_shmtx.c.html#L70" title="core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;pool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="#L417" title="core/ngx_slab.c:417">ngx_slab_calloc_locked</a>(pool, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_shmtx.c.html#L136" title="core/ngx_shmtx.c:136">ngx_shmtx_unlock</a>(&amp;pool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void</span> *<br/></li>
<li><a id="L417">&#x200c;</a><span class="linkable">ngx_slab_calloc_locked</span>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *pool, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="#L156" title="core/ngx_slab.c:156">ngx_slab_alloc_locked</a>(pool, size);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(p, size);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L431">&#x200c;</a></span><span class="linkable">ngx_slab_free</span>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *pool, <span class="Type">void</span> *p)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_shmtx.c.html#L70" title="core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;pool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L442" title="core/ngx_slab.c:442">ngx_slab_free_locked</a>(pool, p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_shmtx.c.html#L136" title="core/ngx_shmtx.c:136">ngx_shmtx_unlock</a>(&amp;pool-&gt;mutex);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L442">&#x200c;</a></span><span class="linkable">ngx_slab_free_locked</span>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *pool, <span class="Type">void</span> *p)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uintptr_t</span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; slab, m, *bitmap;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; n, type, <a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>, shift, map;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a>&nbsp; *slots, *page;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="ngx_log.h.html#L27" title="core/ngx_log.h:27">NGX_LOG_DEBUG_ALLOC</a>, <a href="ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;slab free: </span><span class="Special">%p</span><span class="Constant">&quot;</span>, p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((u_char *) p &lt; pool-&gt;start || (u_char *) p &gt; pool-&gt;end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L786" title="core/ngx_slab.c:786">ngx_slab_error</a>(pool, <a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, <span class="Constant">&quot;<a href="#L431" title="core/ngx_slab.c:431">ngx_slab_free</a>(): outside of pool&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> fail;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = ((u_char *) p - pool-&gt;start) &gt;&gt; <a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a>;<br/></li>
<li>&nbsp; &nbsp; page = &amp;pool-&gt;pages[n];<br/></li>
<li>&nbsp; &nbsp; slab = page-&gt;slab;<br/></li>
<li>&nbsp; &nbsp; type = page-&gt;prev &amp; <a href="#L11" title="core/ngx_slab.c:11">NGX_SLAB_PAGE_MASK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (type) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L15" title="core/ngx_slab.c:15">NGX_SLAB_SMALL</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; shift = slab &amp; <a href="#L23" title="core/ngx_slab.c:23">NGX_SLAB_SHIFT_MASK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = <span class="Constant">1</span> &lt;&lt; shift;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">uintptr_t</span>) p &amp; (size - <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> wrong_chunk;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = ((<span class="Type">uintptr_t</span>) p &amp; (<a href="../os/unix/ngx_alloc.c.html#L12" title="os/unix/ngx_alloc.c:12">ngx_pagesize</a> - <span class="Constant">1</span>)) &gt;&gt; shift;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; m = (<span class="Type">uintptr_t</span>) <span class="Constant">1</span> &lt;&lt; (n &amp; (<span class="Statement">sizeof</span>(<span class="Type">uintptr_t</span>) * <span class="Constant">8</span> - <span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n /= (<span class="Statement">sizeof</span>(<span class="Type">uintptr_t</span>) * <span class="Constant">8</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bitmap = (<span class="Type">uintptr_t</span> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((<span class="Type">uintptr_t</span>) p &amp; ~((<span class="Type">uintptr_t</span>) <a href="../os/unix/ngx_alloc.c.html#L12" title="os/unix/ngx_alloc.c:12">ngx_pagesize</a> - <span class="Constant">1</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bitmap[n] &amp; m) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (page-&gt;next == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slots = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((u_char *) pool + <span class="Statement">sizeof</span>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a> = shift - pool-&gt;min_shift;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next = slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>].next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>].next = page;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;prev = (<span class="Type">uintptr_t</span>) &amp;slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>] | <a href="#L15" title="core/ngx_slab.c:15">NGX_SLAB_SMALL</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next-&gt;prev = (<span class="Type">uintptr_t</span>) page | <a href="#L15" title="core/ngx_slab.c:15">NGX_SLAB_SMALL</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bitmap[n] &amp;= ~m;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = (<span class="Constant">1</span> &lt;&lt; (<a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a> - shift)) / <span class="Constant">8</span> / (<span class="Constant">1</span> &lt;&lt; shift);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bitmap[<span class="Constant">0</span>] &amp; ~(((<span class="Type">uintptr_t</span>) <span class="Constant">1</span> &lt;&lt; n) - <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map = (<span class="Constant">1</span> &lt;&lt; (<a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a> - shift)) / (<span class="Statement">sizeof</span>(<span class="Type">uintptr_t</span>) * <span class="Constant">8</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">1</span>; n &lt; map; n++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bitmap[n]) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L705" title="core/ngx_slab.c:705">ngx_slab_free_pages</a>(pool, page, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> chunk_already_free;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L14" title="core/ngx_slab.c:14">NGX_SLAB_EXACT</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; m = (<span class="Type">uintptr_t</span>) <span class="Constant">1</span> &lt;&lt;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (((<span class="Type">uintptr_t</span>) p &amp; (<a href="../os/unix/ngx_alloc.c.html#L12" title="os/unix/ngx_alloc.c:12">ngx_pagesize</a> - <span class="Constant">1</span>)) &gt;&gt; <a href="#L69" title="core/ngx_slab.c:69">ngx_slab_exact_shift</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = <a href="#L68" title="core/ngx_slab.c:68">ngx_slab_exact_size</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">uintptr_t</span>) p &amp; (size - <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> wrong_chunk;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (slab &amp; m) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (slab == <a href="#L27" title="core/ngx_slab.c:27">NGX_SLAB_BUSY</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slots = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((u_char *) pool + <span class="Statement">sizeof</span>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a> = <a href="#L69" title="core/ngx_slab.c:69">ngx_slab_exact_shift</a> - pool-&gt;min_shift;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next = slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>].next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>].next = page;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;prev = (<span class="Type">uintptr_t</span>) &amp;slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>] | <a href="#L14" title="core/ngx_slab.c:14">NGX_SLAB_EXACT</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next-&gt;prev = (<span class="Type">uintptr_t</span>) page | <a href="#L14" title="core/ngx_slab.c:14">NGX_SLAB_EXACT</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;slab &amp;= ~m;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (page-&gt;slab) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L705" title="core/ngx_slab.c:705">ngx_slab_free_pages</a>(pool, page, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> chunk_already_free;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L13" title="core/ngx_slab.c:13">NGX_SLAB_BIG</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; shift = slab &amp; <a href="#L23" title="core/ngx_slab.c:23">NGX_SLAB_SHIFT_MASK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = <span class="Constant">1</span> &lt;&lt; shift;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">uintptr_t</span>) p &amp; (size - <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> wrong_chunk;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; m = (<span class="Type">uintptr_t</span>) <span class="Constant">1</span> &lt;&lt; ((((<span class="Type">uintptr_t</span>) p &amp; (<a href="../os/unix/ngx_alloc.c.html#L12" title="os/unix/ngx_alloc.c:12">ngx_pagesize</a> - <span class="Constant">1</span>)) &gt;&gt; shift)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <a href="#L25" title="core/ngx_slab.c:25">NGX_SLAB_MAP_SHIFT</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (slab &amp; m) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (page-&gt;next == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slots = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((u_char *) pool + <span class="Statement">sizeof</span>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a> = shift - pool-&gt;min_shift;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next = slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>].next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>].next = page;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;prev = (<span class="Type">uintptr_t</span>) &amp;slots[<a href="ngx_times.c.html#L23" title="core/ngx_times.c:23">slot</a>] | <a href="#L13" title="core/ngx_slab.c:13">NGX_SLAB_BIG</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next-&gt;prev = (<span class="Type">uintptr_t</span>) page | <a href="#L13" title="core/ngx_slab.c:13">NGX_SLAB_BIG</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;slab &amp;= ~m;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (page-&gt;slab &amp; <a href="#L24" title="core/ngx_slab.c:24">NGX_SLAB_MAP_MASK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L705" title="core/ngx_slab.c:705">ngx_slab_free_pages</a>(pool, page, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> chunk_already_free;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L12" title="core/ngx_slab.c:12">NGX_SLAB_PAGE</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">uintptr_t</span>) p &amp; (<a href="../os/unix/ngx_alloc.c.html#L12" title="os/unix/ngx_alloc.c:12">ngx_pagesize</a> - <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> wrong_chunk;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (slab == <a href="#L19" title="core/ngx_slab.c:19">NGX_SLAB_PAGE_FREE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L786" title="core/ngx_slab.c:786">ngx_slab_error</a>(pool, <a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;<a href="#L431" title="core/ngx_slab.c:431">ngx_slab_free</a>(): page is already free&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> fail;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (slab == <a href="#L20" title="core/ngx_slab.c:20">NGX_SLAB_PAGE_BUSY</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L786" title="core/ngx_slab.c:786">ngx_slab_error</a>(pool, <a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;<a href="#L431" title="core/ngx_slab.c:431">ngx_slab_free</a>(): pointer to wrong page&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> fail;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = ((u_char *) p - pool-&gt;start) &gt;&gt; <a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = slab &amp; ~<a href="#L21" title="core/ngx_slab.c:21">NGX_SLAB_PAGE_START</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L705" title="core/ngx_slab.c:705">ngx_slab_free_pages</a>(pool, &amp;pool-&gt;pages[n], size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L46" title="core/ngx_slab.c:46">ngx_slab_junk</a>(p, size &lt;&lt; <a href="../os/unix/ngx_alloc.c.html#L13" title="os/unix/ngx_alloc.c:13">ngx_pagesize_shift</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* not reached */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L46" title="core/ngx_slab.c:46">ngx_slab_junk</a>(p, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">wrong_chunk</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L786" title="core/ngx_slab.c:786">ngx_slab_error</a>(pool, <a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;<a href="#L431" title="core/ngx_slab.c:431">ngx_slab_free</a>(): pointer to wrong chunk&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">goto</span> fail;<br/></li>
<li><br/></li>
<li><span class="Statement">chunk_already_free</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L786" title="core/ngx_slab.c:786">ngx_slab_error</a>(pool, <a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;<a href="#L431" title="core/ngx_slab.c:431">ngx_slab_free</a>(): chunk is already free&quot;</span>);<br/></li>
<li><br/></li>
<li><span class="Statement">fail</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *<br/></li>
<li><a id="L651">&#x200c;</a><span class="linkable">ngx_slab_alloc_pages</span>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *pool, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> pages)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a>&nbsp; *page, *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (page = pool-&gt;free.next; page != &amp;pool-&gt;free; page = page-&gt;next) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (page-&gt;slab &gt;= pages) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (page-&gt;slab &gt; pages) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page[page-&gt;slab - <span class="Constant">1</span>].prev = (<span class="Type">uintptr_t</span>) &amp;page[pages];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page[pages].slab = page-&gt;slab - pages;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page[pages].next = page-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page[pages].prev = page-&gt;prev;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *) page-&gt;prev;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p-&gt;next = &amp;page[pages];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next-&gt;prev = (<span class="Type">uintptr_t</span>) &amp;page[pages];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *) page-&gt;prev;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p-&gt;next = page-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next-&gt;prev = page-&gt;prev;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;slab = pages | <a href="#L21" title="core/ngx_slab.c:21">NGX_SLAB_PAGE_START</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;prev = <a href="#L12" title="core/ngx_slab.c:12">NGX_SLAB_PAGE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (--pages == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> page;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (p = page + <span class="Constant">1</span>; pages; pages--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p-&gt;slab = <a href="#L20" title="core/ngx_slab.c:20">NGX_SLAB_PAGE_BUSY</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p-&gt;prev = <a href="#L12" title="core/ngx_slab.c:12">NGX_SLAB_PAGE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> page;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pool-&gt;log_nomem) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L786" title="core/ngx_slab.c:786">ngx_slab_error</a>(pool, <a href="ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;<a href="#L141" title="core/ngx_slab.c:141">ngx_slab_alloc</a>() failed: no memory&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L705">&#x200c;</a></span><span class="linkable">ngx_slab_free_pages</span>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *pool, <a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *page,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> pages)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; type;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a>&nbsp; *prev, *join;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; page-&gt;slab = pages--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pages) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;page[<span class="Constant">1</span>], pages * <span class="Statement">sizeof</span>(<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (page-&gt;next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; prev = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *) (page-&gt;prev &amp; ~<a href="#L11" title="core/ngx_slab.c:11">NGX_SLAB_PAGE_MASK</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;next = page-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next-&gt;prev = page-&gt;prev;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; join = page + page-&gt;slab;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (join &lt; pool-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; type = join-&gt;prev &amp; <a href="#L11" title="core/ngx_slab.c:11">NGX_SLAB_PAGE_MASK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (type == <a href="#L12" title="core/ngx_slab.c:12">NGX_SLAB_PAGE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (join-&gt;next != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pages += join-&gt;slab;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;slab += join-&gt;slab;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *) (join-&gt;prev &amp; ~<a href="#L11" title="core/ngx_slab.c:11">NGX_SLAB_PAGE_MASK</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;next = join-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; join-&gt;next-&gt;prev = join-&gt;prev;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; join-&gt;slab = <a href="#L19" title="core/ngx_slab.c:19">NGX_SLAB_PAGE_FREE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; join-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; join-&gt;prev = <a href="#L12" title="core/ngx_slab.c:12">NGX_SLAB_PAGE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (page &gt; pool-&gt;pages) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; join = page - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; type = join-&gt;prev &amp; <a href="#L11" title="core/ngx_slab.c:11">NGX_SLAB_PAGE_MASK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (type == <a href="#L12" title="core/ngx_slab.c:12">NGX_SLAB_PAGE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (join-&gt;slab == <a href="#L19" title="core/ngx_slab.c:19">NGX_SLAB_PAGE_FREE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; join = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *) (join-&gt;prev &amp; ~<a href="#L11" title="core/ngx_slab.c:11">NGX_SLAB_PAGE_MASK</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (join-&gt;next != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pages += join-&gt;slab;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; join-&gt;slab += page-&gt;slab;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev = (<a href="ngx_slab.h.html#L16" title="core/ngx_slab.h:16">ngx_slab_page_t</a> *) (join-&gt;prev &amp; ~<a href="#L11" title="core/ngx_slab.c:11">NGX_SLAB_PAGE_MASK</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;next = join-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; join-&gt;next-&gt;prev = join-&gt;prev;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;slab = <a href="#L19" title="core/ngx_slab.c:19">NGX_SLAB_PAGE_FREE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page-&gt;prev = <a href="#L12" title="core/ngx_slab.c:12">NGX_SLAB_PAGE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page = join;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pages) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; page[pages].prev = (<span class="Type">uintptr_t</span>) page;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; page-&gt;prev = (<span class="Type">uintptr_t</span>) &amp;pool-&gt;free;<br/></li>
<li>&nbsp; &nbsp; page-&gt;next = pool-&gt;free.next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; page-&gt;next-&gt;prev = (<span class="Type">uintptr_t</span>) page;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pool-&gt;free.next = page;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L786">&#x200c;</a></span><span class="linkable">ngx_slab_error</span>(<a href="ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *pool, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> level, <span class="Type">char</span> *text)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(level, <a href="ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;</span><span class="Special">%s%s</span><span class="Constant">&quot;</span>, text, pool-&gt;log_ctx);<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
