<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>http/ngx_http_upstream.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>http/ngx_http_upstream.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L401">ngx_http_upstream_cache_method_mask</a></li>
<li><a href="#L301">ngx_http_upstream_commands</a></li>
<li><a href="#L172">ngx_http_upstream_headers_in</a></li>
<li><a href="#L409">ngx_http_upstream_ignore_headers_masks</a></li>
<li><a href="#L336">ngx_http_upstream_module</a></li>
<li><a href="#L321">ngx_http_upstream_module_ctx</a></li>
<li><a href="#L390">ngx_http_upstream_next_errors</a></li>
<li><a href="#L352">ngx_http_upstream_vars</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L5040">ngx_http_upstream</a></li>
<li><a href="#L5295">ngx_http_upstream_add</a></li>
<li><a href="#L4627">ngx_http_upstream_add_variables</a></li>
<li><a href="#L4646">ngx_http_upstream_addr_variable</a></li>
<li><a href="#L5412">ngx_http_upstream_bind_set_slot</a></li>
<li><a href="#L726">ngx_http_upstream_cache</a></li>
<li><a href="#L5015">ngx_http_upstream_cache_etag</a></li>
<li><a href="#L886">ngx_http_upstream_cache_get</a></li>
<li><a href="#L4985">ngx_http_upstream_cache_last_modified</a></li>
<li><a href="#L929">ngx_http_upstream_cache_send</a></li>
<li><a href="#L4962">ngx_http_upstream_cache_status</a></li>
<li><a href="#L1102">ngx_http_upstream_check_broken_connection</a></li>
<li><a href="#L3707">ngx_http_upstream_cleanup</a></li>
<li><a href="#L1292">ngx_http_upstream_connect</a></li>
<li><a href="#L4926">ngx_http_upstream_cookie_variable</a></li>
<li><a href="#L4566">ngx_http_upstream_copy_allow_ranges</a></li>
<li><a href="#L4606">ngx_http_upstream_copy_content_encoding</a></li>
<li><a href="#L4361">ngx_http_upstream_copy_content_type</a></li>
<li><a href="#L4306">ngx_http_upstream_copy_header_line</a></li>
<li><a href="#L4413">ngx_http_upstream_copy_last_modified</a></li>
<li><a href="#L4328">ngx_http_upstream_copy_multi_header_lines</a></li>
<li><a href="#L424">ngx_http_upstream_create</a></li>
<li><a href="#L5691">ngx_http_upstream_create_main_conf</a></li>
<li><a href="#L3569">ngx_http_upstream_dummy_handler</a></li>
<li><a href="#L3719">ngx_http_upstream_finalize_request</a></li>
<li><a href="#L5488">ngx_http_upstream_get_local</a></li>
<li><a href="#L1059">ngx_http_upstream_handler</a></li>
<li><a href="#L4911">ngx_http_upstream_header_variable</a></li>
<li><a href="#L5579">ngx_http_upstream_hide_headers_hash</a></li>
<li><a href="#L3890">ngx_http_upstream_ignore_header_line</a></li>
<li><a href="#L460">ngx_http_upstream_init</a></li>
<li><a href="#L5712">ngx_http_upstream_init_main_conf</a></li>
<li><a href="#L497">ngx_http_upstream_init_request</a></li>
<li><a href="#L2111">ngx_http_upstream_intercept_errors</a></li>
<li><a href="#L3577">ngx_http_upstream_next</a></li>
<li><a href="#L3219">ngx_http_upstream_non_buffered_filter</a></li>
<li><a href="#L3212">ngx_http_upstream_non_buffered_filter_init</a></li>
<li><a href="#L5535">ngx_http_upstream_param_set_slot</a></li>
<li><a href="#L4105">ngx_http_upstream_process_accel_expires</a></li>
<li><a href="#L2377">ngx_http_upstream_process_body_in_memory</a></li>
<li><a href="#L4187">ngx_http_upstream_process_buffering</a></li>
<li><a href="#L3971">ngx_http_upstream_process_cache_control</a></li>
<li><a href="#L4225">ngx_http_upstream_process_charset</a></li>
<li><a href="#L4239">ngx_http_upstream_process_connection</a></li>
<li><a href="#L3898">ngx_http_upstream_process_content_length</a></li>
<li><a href="#L3261">ngx_http_upstream_process_downstream</a></li>
<li><a href="#L4065">ngx_http_upstream_process_expires</a></li>
<li><a href="#L1835">ngx_http_upstream_process_header</a></li>
<li><a href="#L3874">ngx_http_upstream_process_header_line</a></li>
<li><a href="#L2235">ngx_http_upstream_process_headers</a></li>
<li><a href="#L3913">ngx_http_upstream_process_last_modified</a></li>
<li><a href="#L4163">ngx_http_upstream_process_limit_rate</a></li>
<li><a href="#L3038">ngx_http_upstream_process_non_buffered_downstream</a></li>
<li><a href="#L3088">ngx_http_upstream_process_non_buffered_request</a></li>
<li><a href="#L3065">ngx_http_upstream_process_non_buffered_upstream</a></li>
<li><a href="#L3399">ngx_http_upstream_process_request</a></li>
<li><a href="#L3936">ngx_http_upstream_process_set_cookie</a></li>
<li><a href="#L4256">ngx_http_upstream_process_transfer_encoding</a></li>
<li><a href="#L2864">ngx_http_upstream_process_upgraded</a></li>
<li><a href="#L3331">ngx_http_upstream_process_upstream</a></li>
<li><a href="#L4273">ngx_http_upstream_process_vary</a></li>
<li><a href="#L1088">ngx_http_upstream_rd_check_broken_connection</a></li>
<li><a href="#L1646">ngx_http_upstream_reinit</a></li>
<li><a href="#L984">ngx_http_upstream_resolve_handler</a></li>
<li><a href="#L4851">ngx_http_upstream_response_length_variable</a></li>
<li><a href="#L4782">ngx_http_upstream_response_time_variable</a></li>
<li><a href="#L4441">ngx_http_upstream_rewrite_location</a></li>
<li><a href="#L4485">ngx_http_upstream_rewrite_refresh</a></li>
<li><a href="#L4531">ngx_http_upstream_rewrite_set_cookie</a></li>
<li><a href="#L1724">ngx_http_upstream_send_request</a></li>
<li><a href="#L1798">ngx_http_upstream_send_request_handler</a></li>
<li><a href="#L2454">ngx_http_upstream_send_response</a></li>
<li><a href="#L5155">ngx_http_upstream_server</a></li>
<li><a href="#L1496">ngx_http_upstream_ssl_handshake</a></li>
<li><a href="#L1439">ngx_http_upstream_ssl_init_connection</a></li>
<li><a href="#L1553">ngx_http_upstream_ssl_name</a></li>
<li><a href="#L4717">ngx_http_upstream_status_variable</a></li>
<li><a href="#L3488">ngx_http_upstream_store</a></li>
<li><a href="#L2184">ngx_http_upstream_test_connect</a></li>
<li><a href="#L2017">ngx_http_upstream_test_next</a></li>
<li><a href="#L2762">ngx_http_upstream_upgrade</a></li>
<li><a href="#L2834">ngx_http_upstream_upgraded_read_downstream</a></li>
<li><a href="#L2848">ngx_http_upstream_upgraded_read_upstream</a></li>
<li><a href="#L2841">ngx_http_upstream_upgraded_write_downstream</a></li>
<li><a href="#L2856">ngx_http_upstream_upgraded_write_upstream</a></li>
<li><a href="#L1095">ngx_http_upstream_wr_check_broken_connection</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L726" title="http/ngx_http_upstream.c:726">ngx_http_upstream_cache</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L886" title="http/ngx_http_upstream.c:886">ngx_http_upstream_cache_get</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u, <a href="ngx_http.h.html#L19" title="http/ngx_http.h:19">ngx_http_file_cache_t</a> **cache);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L929" title="http/ngx_http_upstream.c:929">ngx_http_upstream_cache_send</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4962" title="http/ngx_http_upstream.c:4962">ngx_http_upstream_cache_status</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4985" title="http/ngx_http_upstream.c:4985">ngx_http_upstream_cache_last_modified</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L5015" title="http/ngx_http_upstream.c:5015">ngx_http_upstream_cache_etag</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L497" title="http/ngx_http_upstream.c:497">ngx_http_upstream_init_request</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L984" title="http/ngx_http_upstream.c:984">ngx_http_upstream_resolve_handler</a>(<a href="../core/ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1088" title="http/ngx_http_upstream.c:1088">ngx_http_upstream_rd_check_broken_connection</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1095" title="http/ngx_http_upstream.c:1095">ngx_http_upstream_wr_check_broken_connection</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1102" title="http/ngx_http_upstream.c:1102">ngx_http_upstream_check_broken_connection</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1292" title="http/ngx_http_upstream.c:1292">ngx_http_upstream_connect</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1646" title="http/ngx_http_upstream.c:1646">ngx_http_upstream_reinit</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1724" title="http/ngx_http_upstream.c:1724">ngx_http_upstream_send_request</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1798" title="http/ngx_http_upstream.c:1798">ngx_http_upstream_send_request_handler</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1835" title="http/ngx_http_upstream.c:1835">ngx_http_upstream_process_header</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2017" title="http/ngx_http_upstream.c:2017">ngx_http_upstream_test_next</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2111" title="http/ngx_http_upstream.c:2111">ngx_http_upstream_intercept_errors</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2184" title="http/ngx_http_upstream.c:2184">ngx_http_upstream_test_connect</a>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2235" title="http/ngx_http_upstream.c:2235">ngx_http_upstream_process_headers</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2377" title="http/ngx_http_upstream.c:2377">ngx_http_upstream_process_body_in_memory</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2454" title="http/ngx_http_upstream.c:2454">ngx_http_upstream_send_response</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2762" title="http/ngx_http_upstream.c:2762">ngx_http_upstream_upgrade</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2834" title="http/ngx_http_upstream.c:2834">ngx_http_upstream_upgraded_read_downstream</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2841" title="http/ngx_http_upstream.c:2841">ngx_http_upstream_upgraded_write_downstream</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2848" title="http/ngx_http_upstream.c:2848">ngx_http_upstream_upgraded_read_upstream</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2856" title="http/ngx_http_upstream.c:2856">ngx_http_upstream_upgraded_write_upstream</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2864" title="http/ngx_http_upstream.c:2864">ngx_http_upstream_process_upgraded</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> from_upstream, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> do_write);<br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L3038" title="http/ngx_http_upstream.c:3038">ngx_http_upstream_process_non_buffered_downstream</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L3065" title="http/ngx_http_upstream.c:3065">ngx_http_upstream_process_non_buffered_upstream</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L3088" title="http/ngx_http_upstream.c:3088">ngx_http_upstream_process_non_buffered_request</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> do_write);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L3212" title="http/ngx_http_upstream.c:3212">ngx_http_upstream_non_buffered_filter_init</a>(<span class="Type">void</span> *data);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L3219" title="http/ngx_http_upstream.c:3219">ngx_http_upstream_non_buffered_filter</a>(<span class="Type">void</span> *data,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span> bytes);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3261" title="http/ngx_http_upstream.c:3261">ngx_http_upstream_process_downstream</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3331" title="http/ngx_http_upstream.c:3331">ngx_http_upstream_process_upstream</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3399" title="http/ngx_http_upstream.c:3399">ngx_http_upstream_process_request</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3488" title="http/ngx_http_upstream.c:3488">ngx_http_upstream_store</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3569" title="http/ngx_http_upstream.c:3569">ngx_http_upstream_dummy_handler</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3577" title="http/ngx_http_upstream.c:3577">ngx_http_upstream_next</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> ft_type);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3707" title="http/ngx_http_upstream.c:3707">ngx_http_upstream_cleanup</a>(<span class="Type">void</span> *data);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u, <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> rc);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L3874" title="http/ngx_http_upstream.c:3874">ngx_http_upstream_process_header_line</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L3898" title="http/ngx_http_upstream.c:3898">ngx_http_upstream_process_content_length</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L3913" title="http/ngx_http_upstream.c:3913">ngx_http_upstream_process_last_modified</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L3936" title="http/ngx_http_upstream.c:3936">ngx_http_upstream_process_set_cookie</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li>&nbsp; &nbsp; <a href="#L3971" title="http/ngx_http_upstream.c:3971">ngx_http_upstream_process_cache_control</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L3890" title="http/ngx_http_upstream.c:3890">ngx_http_upstream_ignore_header_line</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4065" title="http/ngx_http_upstream.c:4065">ngx_http_upstream_process_expires</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4105" title="http/ngx_http_upstream.c:4105">ngx_http_upstream_process_accel_expires</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4163" title="http/ngx_http_upstream.c:4163">ngx_http_upstream_process_limit_rate</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4187" title="http/ngx_http_upstream.c:4187">ngx_http_upstream_process_buffering</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4225" title="http/ngx_http_upstream.c:4225">ngx_http_upstream_process_charset</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4239" title="http/ngx_http_upstream.c:4239">ngx_http_upstream_process_connection</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li>&nbsp; &nbsp; <a href="#L4256" title="http/ngx_http_upstream.c:4256">ngx_http_upstream_process_transfer_encoding</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4273" title="http/ngx_http_upstream.c:4273">ngx_http_upstream_process_vary</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li>&nbsp; &nbsp; <a href="#L4328" title="http/ngx_http_upstream.c:4328">ngx_http_upstream_copy_multi_header_lines</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4361" title="http/ngx_http_upstream.c:4361">ngx_http_upstream_copy_content_type</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4413" title="http/ngx_http_upstream.c:4413">ngx_http_upstream_copy_last_modified</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4441" title="http/ngx_http_upstream.c:4441">ngx_http_upstream_rewrite_location</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4485" title="http/ngx_http_upstream.c:4485">ngx_http_upstream_rewrite_refresh</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4531" title="http/ngx_http_upstream.c:4531">ngx_http_upstream_rewrite_set_cookie</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4566" title="http/ngx_http_upstream.c:4566">ngx_http_upstream_copy_allow_ranges</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_GZIP)<br/></li>
<li></span><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4606" title="http/ngx_http_upstream.c:4606">ngx_http_upstream_copy_content_encoding</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4627" title="http/ngx_http_upstream.c:4627">ngx_http_upstream_add_variables</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4646" title="http/ngx_http_upstream.c:4646">ngx_http_upstream_addr_variable</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4717" title="http/ngx_http_upstream.c:4717">ngx_http_upstream_status_variable</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4782" title="http/ngx_http_upstream.c:4782">ngx_http_upstream_response_time_variable</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L4851" title="http/ngx_http_upstream.c:4851">ngx_http_upstream_response_length_variable</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L5040" title="http/ngx_http_upstream.c:5040">ngx_http_upstream</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *dummy);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L5155" title="http/ngx_http_upstream.c:5155">ngx_http_upstream_server</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a> *<a href="#L5488" title="http/ngx_http_upstream.c:5488">ngx_http_upstream_get_local</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L130" title="http/ngx_http_upstream.h:130">ngx_http_upstream_local_t</a> *local);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L5691" title="http/ngx_http_upstream.c:5691">ngx_http_upstream_create_main_conf</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L5712" title="http/ngx_http_upstream.c:5712">ngx_http_upstream_init_main_conf</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <span class="Type">void</span> *conf);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void</span> <a href="#L1439" title="http/ngx_http_upstream.c:1439">ngx_http_upstream_ssl_init_connection</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u, <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1496" title="http/ngx_http_upstream.c:1496">ngx_http_upstream_ssl_handshake</a>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1553" title="http/ngx_http_upstream.c:1553">ngx_http_upstream_ssl_name</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u, <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L172">&#x200c;</a><a href="ngx_http_upstream.h.html#L226" title="http/ngx_http_upstream.h:226">ngx_http_upstream_header_t</a>&nbsp; <span class="linkable">ngx_http_upstream_headers_in</span>[] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Status&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3874" title="http/ngx_http_upstream.c:3874">ngx_http_upstream_process_header_line</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_upstream.h.html#L268" title="http/ngx_http_upstream.h:268">ngx_http_upstream_headers_in_t</a>, status),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Content-Type&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3874" title="http/ngx_http_upstream.c:3874">ngx_http_upstream_process_header_line</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_upstream.h.html#L268" title="http/ngx_http_upstream.h:268">ngx_http_upstream_headers_in_t</a>, content_type),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4361" title="http/ngx_http_upstream.c:4361">ngx_http_upstream_copy_content_type</a>, <span class="Constant">0</span>, <span class="Constant">1</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Content-Length&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3898" title="http/ngx_http_upstream.c:3898">ngx_http_upstream_process_content_length</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3890" title="http/ngx_http_upstream.c:3890">ngx_http_upstream_ignore_header_line</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Date&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3874" title="http/ngx_http_upstream.c:3874">ngx_http_upstream_process_header_line</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_upstream.h.html#L268" title="http/ngx_http_upstream.h:268">ngx_http_upstream_headers_in_t</a>, date),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L275" title="http/ngx_http_request.h:275">ngx_http_headers_out_t</a>, date), <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Last-Modified&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3913" title="http/ngx_http_upstream.c:3913">ngx_http_upstream_process_last_modified</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4413" title="http/ngx_http_upstream.c:4413">ngx_http_upstream_copy_last_modified</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;ETag&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3874" title="http/ngx_http_upstream.c:3874">ngx_http_upstream_process_header_line</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_upstream.h.html#L268" title="http/ngx_http_upstream.h:268">ngx_http_upstream_headers_in_t</a>, etag),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L275" title="http/ngx_http_request.h:275">ngx_http_headers_out_t</a>, etag), <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Server&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3874" title="http/ngx_http_upstream.c:3874">ngx_http_upstream_process_header_line</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_upstream.h.html#L268" title="http/ngx_http_upstream.h:268">ngx_http_upstream_headers_in_t</a>, server),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L275" title="http/ngx_http_request.h:275">ngx_http_headers_out_t</a>, server), <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;WWW-Authenticate&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3874" title="http/ngx_http_upstream.c:3874">ngx_http_upstream_process_header_line</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_upstream.h.html#L268" title="http/ngx_http_upstream.h:268">ngx_http_upstream_headers_in_t</a>, www_authenticate),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Location&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3874" title="http/ngx_http_upstream.c:3874">ngx_http_upstream_process_header_line</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_upstream.h.html#L268" title="http/ngx_http_upstream.h:268">ngx_http_upstream_headers_in_t</a>, location),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4441" title="http/ngx_http_upstream.c:4441">ngx_http_upstream_rewrite_location</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Refresh&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3890" title="http/ngx_http_upstream.c:3890">ngx_http_upstream_ignore_header_line</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4485" title="http/ngx_http_upstream.c:4485">ngx_http_upstream_rewrite_refresh</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Set-Cookie&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3936" title="http/ngx_http_upstream.c:3936">ngx_http_upstream_process_set_cookie</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_upstream.h.html#L268" title="http/ngx_http_upstream.h:268">ngx_http_upstream_headers_in_t</a>, cookies),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4531" title="http/ngx_http_upstream.c:4531">ngx_http_upstream_rewrite_set_cookie</a>, <span class="Constant">0</span>, <span class="Constant">1</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Content-Disposition&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3890" title="http/ngx_http_upstream.c:3890">ngx_http_upstream_ignore_header_line</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>, <span class="Constant">0</span>, <span class="Constant">1</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Cache-Control&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3971" title="http/ngx_http_upstream.c:3971">ngx_http_upstream_process_cache_control</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4328" title="http/ngx_http_upstream.c:4328">ngx_http_upstream_copy_multi_header_lines</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L275" title="http/ngx_http_request.h:275">ngx_http_headers_out_t</a>, cache_control), <span class="Constant">1</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Expires&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4065" title="http/ngx_http_upstream.c:4065">ngx_http_upstream_process_expires</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L275" title="http/ngx_http_request.h:275">ngx_http_headers_out_t</a>, <a href="modules/ngx_http_userid_filter_module.c.html#L76" title="http/modules/ngx_http_userid_filter_module.c:76">expires</a>), <span class="Constant">1</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Accept-Ranges&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3874" title="http/ngx_http_upstream.c:3874">ngx_http_upstream_process_header_line</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_upstream.h.html#L268" title="http/ngx_http_upstream.h:268">ngx_http_upstream_headers_in_t</a>, accept_ranges),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4566" title="http/ngx_http_upstream.c:4566">ngx_http_upstream_copy_allow_ranges</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L275" title="http/ngx_http_request.h:275">ngx_http_headers_out_t</a>, accept_ranges), <span class="Constant">1</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Connection&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4239" title="http/ngx_http_upstream.c:4239">ngx_http_upstream_process_connection</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3890" title="http/ngx_http_upstream.c:3890">ngx_http_upstream_ignore_header_line</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Keep-Alive&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3890" title="http/ngx_http_upstream.c:3890">ngx_http_upstream_ignore_header_line</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3890" title="http/ngx_http_upstream.c:3890">ngx_http_upstream_ignore_header_line</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Vary&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4273" title="http/ngx_http_upstream.c:4273">ngx_http_upstream_process_vary</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;X-Powered-By&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3890" title="http/ngx_http_upstream.c:3890">ngx_http_upstream_ignore_header_line</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;X-Accel-Expires&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4105" title="http/ngx_http_upstream.c:4105">ngx_http_upstream_process_accel_expires</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;X-Accel-Redirect&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3874" title="http/ngx_http_upstream.c:3874">ngx_http_upstream_process_header_line</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_upstream.h.html#L268" title="http/ngx_http_upstream.h:268">ngx_http_upstream_headers_in_t</a>, x_accel_redirect),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;X-Accel-Limit-Rate&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4163" title="http/ngx_http_upstream.c:4163">ngx_http_upstream_process_limit_rate</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;X-Accel-Buffering&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4187" title="http/ngx_http_upstream.c:4187">ngx_http_upstream_process_buffering</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;X-Accel-Charset&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4225" title="http/ngx_http_upstream.c:4225">ngx_http_upstream_process_charset</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Transfer-Encoding&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4256" title="http/ngx_http_upstream.c:4256">ngx_http_upstream_process_transfer_encoding</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3890" title="http/ngx_http_upstream.c:3890">ngx_http_upstream_ignore_header_line</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_GZIP)<br/></li>
<li></span>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Content-Encoding&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3874" title="http/ngx_http_upstream.c:3874">ngx_http_upstream_process_header_line</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_upstream.h.html#L268" title="http/ngx_http_upstream.h:268">ngx_http_upstream_headers_in_t</a>, content_encoding),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4606" title="http/ngx_http_upstream.c:4606">ngx_http_upstream_copy_content_encoding</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L41" title="core/ngx_string.h:41">ngx_null_string</a>, <span class="Constant">NULL</span>, <span class="Constant">0</span>, <span class="Constant">NULL</span>, <span class="Constant">0</span>, <span class="Constant">0</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L301">&#x200c;</a><span class="Type">static</span> <a href="../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a>&nbsp; <span class="linkable">ngx_http_upstream_commands</span>[] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;upstream&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../core/ngx_conf_file.h.html#L43" title="core/ngx_conf_file.h:43">NGX_CONF_BLOCK</a>|<a href="../core/ngx_conf_file.h.html#L23" title="core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L5040" title="http/ngx_http_upstream.c:5040">ngx_http_upstream</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;server&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_http_config.h.html#L44" title="http/ngx_http_config.h:44">NGX_HTTP_UPS_CONF</a>|<a href="../core/ngx_conf_file.h.html#L46" title="core/ngx_conf_file.h:46">NGX_CONF_1MORE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L5155" title="http/ngx_http_upstream.c:5155">ngx_http_upstream_server</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_http_config.h.html#L51" title="http/ngx_http_config.h:51">NGX_HTTP_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L87" title="core/ngx_conf_file.h:87">ngx_null_command</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L321">&#x200c;</a><span class="Type">static</span> <a href="ngx_http_config.h.html#L36" title="http/ngx_http_config.h:36">ngx_http_module_t</a>&nbsp; <span class="linkable">ngx_http_upstream_module_ctx</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="#L4627" title="http/ngx_http_upstream.c:4627">ngx_http_upstream_add_variables</a>,&nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* preconfiguration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* postconfiguration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L5691" title="http/ngx_http_upstream.c:5691">ngx_http_upstream_create_main_conf</a>,&nbsp; &nbsp; <span class="Comment">/* create <a href="../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> configuration */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L5712" title="http/ngx_http_upstream.c:5712">ngx_http_upstream_init_main_conf</a>,&nbsp; &nbsp; &nbsp; <span class="Comment">/* init <a href="../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create server configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge server configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create location configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* merge location configuration */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L336">&#x200c;</a><a href="../core/ngx_core.h.html#L12" title="core/ngx_core.h:12">ngx_module_t</a>&nbsp; <span class="linkable">ngx_http_upstream_module</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L99" title="core/ngx_conf_file.h:99">NGX_MODULE_V1</a>,<br/></li>
<li>&nbsp; &nbsp; &amp;<a href="#L321" title="http/ngx_http_upstream.c:321">ngx_http_upstream_module_ctx</a>,&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module context */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L301" title="http/ngx_http_upstream.c:301">ngx_http_upstream_commands</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* module directives */<br/></li>
<li></span>&nbsp; &nbsp; <a href="ngx_http_config.h.html#L39" title="http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module type */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init master */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init module */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit master */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L100" title="core/ngx_conf_file.h:100">NGX_MODULE_V1_PADDING</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L352">&#x200c;</a><span class="Type">static</span> <a href="ngx_http_variables.h.html#L21" title="http/ngx_http_variables.h:21">ngx_http_variable_t</a>&nbsp; <span class="linkable">ngx_http_upstream_vars</span>[] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;upstream_addr&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L4646" title="http/ngx_http_upstream.c:4646">ngx_http_upstream_addr_variable</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_http_variables.h.html#L30" title="http/ngx_http_variables.h:30">NGX_HTTP_VAR_NOCACHEABLE</a>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;upstream_status&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L4717" title="http/ngx_http_upstream.c:4717">ngx_http_upstream_status_variable</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_http_variables.h.html#L30" title="http/ngx_http_variables.h:30">NGX_HTTP_VAR_NOCACHEABLE</a>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;upstream_response_time&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L4782" title="http/ngx_http_upstream.c:4782">ngx_http_upstream_response_time_variable</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_http_variables.h.html#L30" title="http/ngx_http_variables.h:30">NGX_HTTP_VAR_NOCACHEABLE</a>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;upstream_response_length&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L4851" title="http/ngx_http_upstream.c:4851">ngx_http_upstream_response_length_variable</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_http_variables.h.html#L30" title="http/ngx_http_variables.h:30">NGX_HTTP_VAR_NOCACHEABLE</a>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;upstream_cache_status&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L4962" title="http/ngx_http_upstream.c:4962">ngx_http_upstream_cache_status</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_http_variables.h.html#L30" title="http/ngx_http_variables.h:30">NGX_HTTP_VAR_NOCACHEABLE</a>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;upstream_cache_last_modified&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L4985" title="http/ngx_http_upstream.c:4985">ngx_http_upstream_cache_last_modified</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_http_variables.h.html#L30" title="http/ngx_http_variables.h:30">NGX_HTTP_VAR_NOCACHEABLE</a>|<a href="ngx_http_variables.h.html#L32" title="http/ngx_http_variables.h:32">NGX_HTTP_VAR_NOHASH</a>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;upstream_cache_etag&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L5015" title="http/ngx_http_upstream.c:5015">ngx_http_upstream_cache_etag</a>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_http_variables.h.html#L30" title="http/ngx_http_variables.h:30">NGX_HTTP_VAR_NOCACHEABLE</a>|<a href="ngx_http_variables.h.html#L32" title="http/ngx_http_variables.h:32">NGX_HTTP_VAR_NOHASH</a>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L41" title="core/ngx_string.h:41">ngx_null_string</a>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L390">&#x200c;</a><span class="Type">static</span> <a href="ngx_http_upstream.h.html#L373" title="http/ngx_http_upstream.h:373">ngx_http_upstream_next_t</a>&nbsp; <span class="linkable">ngx_http_upstream_next_errors</span>[] = {<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">500</span>, <a href="ngx_http_upstream.h.html#L23" title="http/ngx_http_upstream.h:23">NGX_HTTP_UPSTREAM_FT_HTTP_500</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">502</span>, <a href="ngx_http_upstream.h.html#L24" title="http/ngx_http_upstream.h:24">NGX_HTTP_UPSTREAM_FT_HTTP_502</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">503</span>, <a href="ngx_http_upstream.h.html#L25" title="http/ngx_http_upstream.h:25">NGX_HTTP_UPSTREAM_FT_HTTP_503</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">504</span>, <a href="ngx_http_upstream.h.html#L26" title="http/ngx_http_upstream.h:26">NGX_HTTP_UPSTREAM_FT_HTTP_504</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">403</span>, <a href="ngx_http_upstream.h.html#L27" title="http/ngx_http_upstream.h:27">NGX_HTTP_UPSTREAM_FT_HTTP_403</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">404</span>, <a href="ngx_http_upstream.h.html#L28" title="http/ngx_http_upstream.h:28">NGX_HTTP_UPSTREAM_FT_HTTP_404</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">0</span>, <span class="Constant">0</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L401">&#x200c;</a><a href="../core/ngx_conf_file.h.html#L209" title="core/ngx_conf_file.h:209">ngx_conf_bitmask_t</a>&nbsp; <span class="linkable">ngx_http_upstream_cache_method_mask</span>[] = {<br/></li>
<li>&nbsp;&nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;<a href="../core/ngx_md5.c.html#L152" title="core/ngx_md5.c:152">GET</a>&quot;</span>),&nbsp; <a href="ngx_http_request.h.html#L28" title="http/ngx_http_request.h:28">NGX_HTTP_GET</a>},<br/></li>
<li>&nbsp;&nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;HEAD&quot;</span>), <a href="ngx_http_request.h.html#L29" title="http/ngx_http_request.h:29">NGX_HTTP_HEAD</a> },<br/></li>
<li>&nbsp;&nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;POST&quot;</span>), <a href="ngx_http_request.h.html#L30" title="http/ngx_http_request.h:30">NGX_HTTP_POST</a> },<br/></li>
<li>&nbsp;&nbsp; { <a href="../core/ngx_string.h.html#L41" title="core/ngx_string.h:41">ngx_null_string</a>, <span class="Constant">0</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L409">&#x200c;</a><a href="../core/ngx_conf_file.h.html#L209" title="core/ngx_conf_file.h:209">ngx_conf_bitmask_t</a>&nbsp; <span class="linkable">ngx_http_upstream_ignore_headers_masks</span>[] = {<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;X-Accel-Redirect&quot;</span>), <a href="ngx_http_upstream.h.html#L45" title="http/ngx_http_upstream.h:45">NGX_HTTP_UPSTREAM_IGN_XA_REDIRECT</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;X-Accel-Expires&quot;</span>), <a href="ngx_http_upstream.h.html#L46" title="http/ngx_http_upstream.h:46">NGX_HTTP_UPSTREAM_IGN_XA_EXPIRES</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;X-Accel-Limit-Rate&quot;</span>), <a href="ngx_http_upstream.h.html#L50" title="http/ngx_http_upstream.h:50">NGX_HTTP_UPSTREAM_IGN_XA_LIMIT_RATE</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;X-Accel-Buffering&quot;</span>), <a href="ngx_http_upstream.h.html#L51" title="http/ngx_http_upstream.h:51">NGX_HTTP_UPSTREAM_IGN_XA_BUFFERING</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;X-Accel-Charset&quot;</span>), <a href="ngx_http_upstream.h.html#L52" title="http/ngx_http_upstream.h:52">NGX_HTTP_UPSTREAM_IGN_XA_CHARSET</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Expires&quot;</span>), <a href="ngx_http_upstream.h.html#L47" title="http/ngx_http_upstream.h:47">NGX_HTTP_UPSTREAM_IGN_EXPIRES</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Cache-Control&quot;</span>), <a href="ngx_http_upstream.h.html#L48" title="http/ngx_http_upstream.h:48">NGX_HTTP_UPSTREAM_IGN_CACHE_CONTROL</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Set-Cookie&quot;</span>), <a href="ngx_http_upstream.h.html#L49" title="http/ngx_http_upstream.h:49">NGX_HTTP_UPSTREAM_IGN_SET_COOKIE</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Vary&quot;</span>), <a href="ngx_http_upstream.h.html#L53" title="http/ngx_http_upstream.h:53">NGX_HTTP_UPSTREAM_IGN_VARY</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L41" title="core/ngx_string.h:41">ngx_null_string</a>, <span class="Constant">0</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L424">&#x200c;</a><span class="linkable">ngx_http_upstream_create</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u &amp;&amp; u-&gt;cleanup) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;<a href="../core/nginx.c.html#L202" title="core/nginx.c:202">main</a>-&gt;count++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3707" title="http/ngx_http_upstream.c:3707">ngx_http_upstream_cleanup</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;upstream = u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;peer.log = r-&gt;connection-&gt;log;<br/></li>
<li>&nbsp; &nbsp; u-&gt;peer.log_error = NGX_ERROR_ERR;<br/></li>
<li><span class="PreProc">#if (NGX_THREADS)<br/></li>
<li></span>&nbsp; &nbsp; u-&gt;peer.lock = &amp;r-&gt;connection-&gt;lock;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span>&nbsp; &nbsp; r-&gt;cache = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; u-&gt;headers_in.content_length_n = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; u-&gt;headers_in.last_modified_time = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L460">&#x200c;</a></span><span class="linkable">ngx_http_upstream_init</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp;&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http init upstream, client timer: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, c-&gt;read-&gt;timer_set);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SPDY)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;spdy_stream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L497" title="http/ngx_http_upstream.c:497">ngx_http_upstream_init_request</a>(r);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;read-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L428" title="event/ngx_event.h:428">ngx_del_timer</a>(c-&gt;read);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L44" title="event/ngx_event.c:44">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L233" title="event/ngx_event.h:233">NGX_USE_CLEAR_EVENT</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!c-&gt;write-&gt;active) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L422" title="event/ngx_event.h:422">ngx_add_event</a>(c-&gt;write, <a href="../event/ngx_event.h.html#L335" title="event/ngx_event.h:335">NGX_WRITE_EVENT</a>, <a href="../event/ngx_event.h.html#L358" title="event/ngx_event.h:358">NGX_CLEAR_EVENT</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L497" title="http/ngx_http_upstream.c:497">ngx_http_upstream_init_request</a>(r);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L497">&#x200c;</a></span><span class="linkable">ngx_http_upstream_init_request</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *host;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ctx, temp;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L320" title="http/ngx_http_request.h:320">ngx_http_cleanup_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *clcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L75" title="http/ngx_http_upstream.h:75">ngx_http_upstream_srv_conf_t</a>&nbsp;&nbsp; *uscf, **uscfp;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L73" title="http/ngx_http_upstream.h:73">ngx_http_upstream_main_conf_t</a>&nbsp; *umcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;aio) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;cache) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L726" title="http/ngx_http_upstream.c:726">ngx_http_upstream_cache</a>(r, u);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L32" title="core/ngx_core.h:32">NGX_BUSY</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;write_event_handler = <a href="#L497" title="http/ngx_http_upstream.c:497">ngx_http_upstream_init_request</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;write_event_handler = <a href="ngx_http_request.c.html#L3297" title="http/ngx_http_request.c:3297">ngx_http_request_empty_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; u-&gt;store = u-&gt;conf-&gt;store;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!u-&gt;store &amp;&amp; !r-&gt;post_action &amp;&amp; !u-&gt;conf-&gt;ignore_client_abort) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;read_event_handler = <a href="#L1088" title="http/ngx_http_upstream.c:1088">ngx_http_upstream_rd_check_broken_connection</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;write_event_handler = <a href="#L1095" title="http/ngx_http_upstream.c:1095">ngx_http_upstream_wr_check_broken_connection</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_body) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;request_bufs = r-&gt;request_body-&gt;bufs;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;create_request(r) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;peer.local = <a href="#L5488" title="http/ngx_http_upstream.c:5488">ngx_http_upstream_get_local</a>(r, u-&gt;conf-&gt;local);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;output.alignment = clcf-&gt;directio_alignment;<br/></li>
<li>&nbsp; &nbsp; u-&gt;output.pool = r-&gt;pool;<br/></li>
<li>&nbsp; &nbsp; u-&gt;output.bufs.num = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; u-&gt;output.bufs.size = clcf-&gt;client_body_buffer_size;<br/></li>
<li>&nbsp; &nbsp; u-&gt;output.output_filter = <a href="../core/ngx_output_chain.c.html#L602" title="core/ngx_output_chain.c:602">ngx_chain_writer</a>;<br/></li>
<li>&nbsp; &nbsp; u-&gt;output.filter_ctx = &amp;u-&gt;writer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;writer.pool = r-&gt;pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream_states == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;upstream_states = <a href="../core/ngx_array.c.html#L13" title="core/ngx_array.c:13">ngx_array_create</a>(r-&gt;pool, <span class="Constant">1</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_upstream.h.html#L66" title="http/ngx_http_upstream.h:66">ngx_http_upstream_state_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream_states == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;state = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(r-&gt;upstream_states);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;state == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(u-&gt;state, <span class="Statement">sizeof</span>(<a href="ngx_http_upstream.h.html#L66" title="http/ngx_http_upstream.h:66">ngx_http_upstream_state_t</a>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = <a href="ngx_http_core_module.c.html#L2729" title="http/ngx_http_core_module.c:2729">ngx_http_cleanup_add</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln-&gt;handler = <a href="#L3707" title="http/ngx_http_upstream.c:3707">ngx_http_upstream_cleanup</a>;<br/></li>
<li>&nbsp; &nbsp; cln-&gt;data = r;<br/></li>
<li>&nbsp; &nbsp; u-&gt;cleanup = &amp;cln-&gt;handler;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;resolved == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uscf = u-&gt;conf-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;ssl_name = u-&gt;resolved-&gt;host;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;resolved-&gt;sockaddr) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_upstream_round_robin.c.html#L275" title="http/ngx_http_upstream_round_robin.c:275">ngx_http_upstream_create_round_robin_peer</a>(r, u-&gt;resolved)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1292" title="http/ngx_http_upstream.c:1292">ngx_http_upstream_connect</a>(r, u);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; host = &amp;u-&gt;resolved-&gt;host;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; umcf = <a href="ngx_http_config.h.html#L55" title="http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(r, <a href="#L336" title="http/ngx_http_upstream.c:336">ngx_http_upstream_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uscfp = umcf-&gt;upstreams.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; umcf-&gt;upstreams.nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uscf = uscfp[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (uscf-&gt;host.len == host-&gt;len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; ((uscf-&gt;port == <span class="Constant">0</span> &amp;&amp; u-&gt;resolved-&gt;no_port)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; || uscf-&gt;port == u-&gt;resolved-&gt;port)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="../core/ngx_string.c.html#L593" title="core/ngx_string.c:593">ngx_strncasecmp</a>(uscf-&gt;host.data, host-&gt;data, host-&gt;len) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;resolved-&gt;port == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no port in upstream </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, host);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; temp.name = *host;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = <a href="../core/ngx_resolver.c.html#L318" title="core/ngx_resolver.c:318">ngx_resolve_start</a>(clcf-&gt;resolver, &amp;temp);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx == <a href="../core/ngx_resolver.h.html#L34" title="core/ngx_resolver.h:34">NGX_NO_RESOLVER</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no resolver defined to resolve %V&quot;</span>, host);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="ngx_http_request.h.html#L130" title="http/ngx_http_request.h:130">NGX_HTTP_BAD_GATEWAY</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;name = *host;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler = <a href="#L984" title="http/ngx_http_upstream.c:984">ngx_http_upstream_resolve_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;data = r;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;timeout = clcf-&gt;resolver_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;resolved-&gt;ctx = ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_resolver.c.html#L357" title="core/ngx_resolver.c:357">ngx_resolve_name</a>(ctx) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;resolved-&gt;ctx = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (uscf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no upstream configuration&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; u-&gt;ssl_name = uscf-&gt;host;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (uscf-&gt;peer.init(r, uscf) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;peer.start_time = <a href="../core/ngx_times.c.html#L26" title="core/ngx_times.c:26">ngx_current_msec</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;next_upstream_tries<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; u-&gt;peer.tries &gt; u-&gt;conf-&gt;next_upstream_tries)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.tries = u-&gt;conf-&gt;next_upstream_tries;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1292" title="http/ngx_http_upstream.c:1292">ngx_http_upstream_connect</a>(r, u);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L726">&#x200c;</a><span class="linkable">ngx_http_upstream_cache</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="http/ngx_http.h:18">ngx_http_cache_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; *cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(r-&gt;method &amp; u-&gt;conf-&gt;cache_methods)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L886" title="http/ngx_http_upstream.c:886">ngx_http_upstream_cache_get</a>(r, u, &amp;cache);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;method &amp; <a href="ngx_http_request.h.html#L29" title="http/ngx_http_request.h:29">NGX_HTTP_HEAD</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;method = <a href="ngx_http_core_module.c.html#L827" title="http/ngx_http_core_module.c:827">ngx_http_core_get_method</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_file_cache.c.html#L163" title="http/ngx_http_file_cache.c:163">ngx_http_file_cache_new</a>(r) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;create_key(r) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: add keys */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_file_cache.c.html#L217" title="http/ngx_http_file_cache.c:217">ngx_http_file_cache_create_key</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;cache-&gt;header_start + <span class="Constant">256</span> &gt;= u-&gt;conf-&gt;buffer_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;%V_buffer_size </span><span class="Special">%u</span><span class="Constant">z is not enough for cache key, &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;it should be increased to at least </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;u-&gt;conf-&gt;module, u-&gt;conf-&gt;buffer_size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_config.h.html#L97" title="core/ngx_config.h:97">ngx_align</a>(r-&gt;cache-&gt;header_start + <span class="Constant">256</span>, <span class="Constant">1024</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;cache = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cacheable = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c = r-&gt;cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;body_start = u-&gt;conf-&gt;buffer_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;min_uses = u-&gt;conf-&gt;cache_min_uses;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;file_cache = cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (<a href="ngx_http_script.c.html#L248" title="http/ngx_http_script.c:248">ngx_http_test_predicates</a>(r, u-&gt;conf-&gt;cache_bypass)) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cache_status = <a href="ngx_http_cache.h.html#L18" title="http/ngx_http_cache.h:18">NGX_HTTP_CACHE_BYPASS</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;lock = u-&gt;conf-&gt;cache_lock;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;lock_timeout = u-&gt;conf-&gt;cache_lock_timeout;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;lock_age = u-&gt;conf-&gt;cache_lock_age;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cache_status = <a href="ngx_http_cache.h.html#L17" title="http/ngx_http_cache.h:17">NGX_HTTP_CACHE_MISS</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="ngx_http_file_cache.c.html#L254" title="http/ngx_http_file_cache.c:254">ngx_http_file_cache_open</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream cache: </span><span class="Special">%i</span><span class="Constant">&quot;</span>, rc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (rc) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_http_cache.h.html#L21" title="http/ngx_http_cache.h:21">NGX_HTTP_CACHE_UPDATING</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;cache_use_stale &amp; <a href="ngx_http_upstream.h.html#L29" title="http/ngx_http_upstream.h:29">NGX_HTTP_UPSTREAM_FT_UPDATING</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cache_status = rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_cache.h.html#L20" title="http/ngx_http_cache.h:20">NGX_HTTP_CACHE_STALE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cache_status = <a href="ngx_http_cache.h.html#L23" title="http/ngx_http_cache.h:23">NGX_HTTP_CACHE_HIT</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (rc) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L929" title="http/ngx_http_upstream.c:929">ngx_http_upstream_cache_send</a>(r, u);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="ngx_http_upstream.h.html#L42" title="http/ngx_http_upstream.h:42">NGX_HTTP_UPSTREAM_INVALID_HEADER</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_http_cache.h.html#L20" title="http/ngx_http_cache.h:20">NGX_HTTP_CACHE_STALE</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;valid_sec = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.start = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cache_status = <a href="ngx_http_cache.h.html#L19" title="http/ngx_http_cache.h:19">NGX_HTTP_CACHE_EXPIRED</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) (u-&gt;buffer.end - u-&gt;buffer.start) &lt; u-&gt;conf-&gt;buffer_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.start = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.pos = u-&gt;buffer.start + c-&gt;header_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.last = u-&gt;buffer.pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_http_cache.h.html#L24" title="http/ngx_http_cache.h:24">NGX_HTTP_CACHE_SCARCE</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cacheable = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L32" title="core/ngx_core.h:32">NGX_BUSY</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* cached <a href="ngx_http_request.h.html#L130" title="http/ngx_http_request.h:130">NGX_HTTP_BAD_GATEWAY</a>, <a href="ngx_http_request.h.html#L132" title="http/ngx_http_request.h:132">NGX_HTTP_GATEWAY_TIME_OUT</a>, etc. */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cache_status = <a href="ngx_http_cache.h.html#L23" title="http/ngx_http_cache.h:23">NGX_HTTP_CACHE_HIT</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;cached = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L886">&#x200c;</a><span class="linkable">ngx_http_upstream_cache_get</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="http/ngx_http.h:19">ngx_http_file_cache_t</a> **cache)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *name, val;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; **caches;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;cache_zone) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *cache = u-&gt;conf-&gt;cache_zone-&gt;data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_script.c.html#L58" title="http/ngx_http_script.c:58">ngx_http_complex_value</a>(r, u-&gt;conf-&gt;cache_value, &amp;val) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (val.len == <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; || (val.len == <span class="Constant">3</span> &amp;&amp; <a href="../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(val.data, <span class="Constant">&quot;off&quot;</span>, <span class="Constant">3</span>) == <span class="Constant">0</span>))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; caches = u-&gt;caches-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; u-&gt;caches-&gt;nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name = &amp;caches[i]-&gt;shm_zone-&gt;shm.name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (name-&gt;len == val.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(name-&gt;data, val.data, val.len) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cache = caches[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;cache </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> not found&quot;</span>, &amp;val);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L929">&#x200c;</a><span class="linkable">ngx_http_upstream_cache_send</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="http/ngx_http.h:18">ngx_http_cache_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;cached = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; c = r-&gt;cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;header_start == c-&gt;body_start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;http_version = <a href="ngx_http_request.h.html#L23" title="http/ngx_http_request.h:23">NGX_HTTP_VERSION_9</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_file_cache.c.html#L1422" title="http/ngx_http_file_cache.c:1422">ngx_http_cache_send</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: cache stack */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; u-&gt;buffer = *c-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; u-&gt;buffer.pos += c-&gt;header_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;u-&gt;headers_in, <span class="Statement">sizeof</span>(<a href="ngx_http_upstream.h.html#L268" title="http/ngx_http_upstream.h:268">ngx_http_upstream_headers_in_t</a>));<br/></li>
<li>&nbsp; &nbsp; u-&gt;headers_in.content_length_n = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; u-&gt;headers_in.last_modified_time = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_list.h.html#L37" title="core/ngx_list.h:37">ngx_list_init</a>(&amp;u-&gt;headers_in.headers, r-&gt;pool, <span class="Constant">8</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = u-&gt;process_header(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2235" title="http/ngx_http_upstream.c:2235">ngx_http_upstream_process_headers</a>(r, u) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_file_cache.c.html#L1422" title="http/ngx_http_file_cache.c:1422">ngx_http_cache_send</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* rc == <a href="ngx_http_upstream.h.html#L42" title="http/ngx_http_upstream.h:42">NGX_HTTP_UPSTREAM_INVALID_HEADER</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: delete file */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L984">&#x200c;</a></span><span class="linkable">ngx_http_upstream_resolve_handler</span>(<a href="../core/ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L283" title="http/ngx_http_upstream.h:283">ngx_http_upstream_resolved_t</a>&nbsp; *ur;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = ctx-&gt;data;<br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li>&nbsp; &nbsp; ur = u-&gt;resolved;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L598" title="http/ngx_http_request.h:598">ngx_http_set_log_request</a>(c-&gt;log, r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream resolve: </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;uri, &amp;r-&gt;args);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;state) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;%V could not be resolved (</span><span class="Special">%i</span><span class="Constant">: </span><span class="Special">%s</span><span class="Constant">)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;ctx-&gt;name, ctx-&gt;state,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_resolver.c.html#L2998" title="core/ngx_resolver.c:2998">ngx_resolver_strerror</a>(ctx-&gt;state));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="ngx_http_request.h.html#L130" title="http/ngx_http_request.h:130">NGX_HTTP_BAD_GATEWAY</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ur-&gt;naddrs = ctx-&gt;naddrs;<br/></li>
<li>&nbsp; &nbsp; ur-&gt;addrs = ctx-&gt;addrs;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; text[<a href="../core/ngx_inet.h.html#L31" title="core/ngx_inet.h:31">NGX_SOCKADDR_STRLEN</a>];<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp;&nbsp; addr;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; addr.data = text;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; ctx-&gt;naddrs; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr.len = <a href="../core/ngx_inet.c.html#L177" title="core/ngx_inet.c:177">ngx_sock_ntop</a>(ur-&gt;addrs[i].sockaddr, ur-&gt;addrs[i].socklen,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; text, <a href="../core/ngx_inet.h.html#L31" title="core/ngx_inet.h:31">NGX_SOCKADDR_STRLEN</a>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;name was resolved to %V&quot;</span>, &amp;addr);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_upstream_round_robin.c.html#L275" title="http/ngx_http_upstream_round_robin.c:275">ngx_http_upstream_create_round_robin_peer</a>(r, ur) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_resolver.c.html#L403" title="core/ngx_resolver.c:403">ngx_resolve_name_done</a>(ctx);<br/></li>
<li>&nbsp; &nbsp; ur-&gt;ctx = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;peer.start_time = <a href="../core/ngx_times.c.html#L26" title="core/ngx_times.c:26">ngx_current_msec</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;next_upstream_tries<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; u-&gt;peer.tries &gt; u-&gt;conf-&gt;next_upstream_tries)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.tries = u-&gt;conf-&gt;next_upstream_tries;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1292" title="http/ngx_http_upstream.c:1292">ngx_http_upstream_connect</a>(r, u);<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.c.html#L2193" title="http/ngx_http_request.c:2193">ngx_http_run_posted_requests</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1059">&#x200c;</a></span><span class="linkable">ngx_http_upstream_handler</span>(<a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp;&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a>&nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = ev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; r = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L598" title="http/ngx_http_request.h:598">ngx_http_set_log_request</a>(c-&gt;log, r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream request: </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;uri, &amp;r-&gt;args);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ev-&gt;write) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;write_event_handler(r, u);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;read_event_handler(r, u);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.c.html#L2193" title="http/ngx_http_request.c:2193">ngx_http_run_posted_requests</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1088">&#x200c;</a></span><span class="linkable">ngx_http_upstream_rd_check_broken_connection</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L1102" title="http/ngx_http_upstream.c:1102">ngx_http_upstream_check_broken_connection</a>(r, r-&gt;connection-&gt;read);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1095">&#x200c;</a></span><span class="linkable">ngx_http_upstream_wr_check_broken_connection</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L1102" title="http/ngx_http_upstream.c:1102">ngx_http_upstream_check_broken_connection</a>(r, r-&gt;connection-&gt;write);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1102">&#x200c;</a></span><span class="linkable">ngx_http_upstream_check_broken_connection</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; buf[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_errno.h.html#L16" title="os/unix/ngx_errno.h:16">ngx_err_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp;&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, ev-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream check client, write event:</span><span class="Special">%d</span><span class="Constant">, </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ev-&gt;write, &amp;r-&gt;uri);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;error) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../event/ngx_event.c.html#L44" title="event/ngx_event.c:44">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L221" title="event/ngx_event.h:221">NGX_USE_LEVEL_EVENT</a>) &amp;&amp; ev-&gt;active) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event = ev-&gt;write ? <a href="../event/ngx_event.h.html#L335" title="event/ngx_event.h:335">NGX_WRITE_EVENT</a> : <a href="../event/ngx_event.h.html#L334" title="event/ngx_event.h:334">NGX_READ_EVENT</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L423" title="event/ngx_event.h:423">ngx_del_event</a>(ev, event, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!u-&gt;cacheable) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L125" title="http/ngx_http_request.h:125">NGX_HTTP_CLIENT_CLOSED_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SPDY)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;spdy_stream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_KQUEUE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L44" title="event/ngx_event.c:44">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L239" title="event/ngx_event.h:239">NGX_USE_KQUEUE_EVENT</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!ev-&gt;pending_eof) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ev-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ev-&gt;kq_errno) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ev-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!u-&gt;cacheable &amp;&amp; u-&gt;peer.connection) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="core/ngx_log.h:23">NGX_LOG_INFO</a>, ev-&gt;log, ev-&gt;kq_errno,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;kevent() reported that client prematurely closed &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;connection, so upstream connection is closed too&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L125" title="http/ngx_http_request.h:125">NGX_HTTP_CLIENT_CLOSED_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="core/ngx_log.h:23">NGX_LOG_INFO</a>, ev-&gt;log, ev-&gt;kq_errno,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;kevent() reported that client prematurely closed &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;connection&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.connection == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L125" title="http/ngx_http_request.h:125">NGX_HTTP_CLIENT_CLOSED_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_EPOLLRDHUP)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../event/ngx_event.c.html#L44" title="event/ngx_event.c:44">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L255" title="event/ngx_event.h:255">NGX_USE_EPOLL_EVENT</a>) &amp;&amp; ev-&gt;pending_eof) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; socklen_t&nbsp; len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ev-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<a href="../os/unix/ngx_errno.h.html#L16" title="os/unix/ngx_errno.h:16">ngx_err_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * BSDs and Linux return 0 and <a href="../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> a pending error in err<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Solaris returns -1 and sets errno<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (getsockopt(c-&gt;fd, SOL_SOCKET, SO_ERROR, (<span class="Type">void</span> *) &amp;err, &amp;len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <a href="../os/unix/ngx_errno.h.html#L69" title="os/unix/ngx_errno.h:69">ngx_socket_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (err) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ev-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!u-&gt;cacheable &amp;&amp; u-&gt;peer.connection) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="core/ngx_log.h:23">NGX_LOG_INFO</a>, ev-&gt;log, err,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;<a href="../event/modules/ngx_epoll_module.c.html#L68" title="event/modules/ngx_epoll_module.c:68">epoll_wait</a>() reported that client prematurely closed &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;connection, so upstream connection is closed too&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L125" title="http/ngx_http_request.h:125">NGX_HTTP_CLIENT_CLOSED_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="core/ngx_log.h:23">NGX_LOG_INFO</a>, ev-&gt;log, err,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;<a href="../event/modules/ngx_epoll_module.c.html#L68" title="event/modules/ngx_epoll_module.c:68">epoll_wait</a>() reported that client prematurely closed &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;connection&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.connection == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L125" title="http/ngx_http_request.h:125">NGX_HTTP_CLIENT_CLOSED_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; n = recv(c-&gt;fd, buf, <span class="Constant">1</span>, MSG_PEEK);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; err = <a href="../os/unix/ngx_errno.h.html#L69" title="os/unix/ngx_errno.h:69">ngx_socket_errno</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, ev-&gt;log, err,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream recv(): </span><span class="Special">%d</span><span class="Constant">&quot;</span>, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ev-&gt;write &amp;&amp; (n &gt;= <span class="Constant">0</span> || err == <a href="../os/unix/ngx_errno.h.html#L62" title="os/unix/ngx_errno.h:62">NGX_EAGAIN</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../event/ngx_event.c.html#L44" title="event/ngx_event.c:44">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L221" title="event/ngx_event.h:221">NGX_USE_LEVEL_EVENT</a>) &amp;&amp; ev-&gt;active) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; event = ev-&gt;write ? <a href="../event/ngx_event.h.html#L335" title="event/ngx_event.h:335">NGX_WRITE_EVENT</a> : <a href="../event/ngx_event.h.html#L334" title="event/ngx_event.h:334">NGX_READ_EVENT</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L423" title="event/ngx_event.h:423">ngx_del_event</a>(ev, event, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (err == <a href="../os/unix/ngx_errno.h.html#L62" title="os/unix/ngx_errno.h:62">NGX_EAGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ev-&gt;error = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* n == 0 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ev-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!u-&gt;cacheable &amp;&amp; u-&gt;peer.connection) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="core/ngx_log.h:23">NGX_LOG_INFO</a>, ev-&gt;log, err,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client prematurely closed connection, &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;so upstream connection is closed too&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L125" title="http/ngx_http_request.h:125">NGX_HTTP_CLIENT_CLOSED_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="core/ngx_log.h:23">NGX_LOG_INFO</a>, ev-&gt;log, err,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client prematurely closed connection&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.connection == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L125" title="http/ngx_http_request.h:125">NGX_HTTP_CLIENT_CLOSED_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1292">&#x200c;</a></span><span class="linkable">ngx_http_upstream_connect</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_times.h.html#L20" title="core/ngx_times.h:20">ngx_time_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *tp;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;connection-&gt;log-&gt;action = <span class="Constant">&quot;connecting to upstream&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;state &amp;&amp; u-&gt;state-&gt;response_sec) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tp = <a href="../core/ngx_times.h.html#L37" title="core/ngx_times.h:37">ngx_timeofday</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;state-&gt;response_sec = tp-&gt;sec - u-&gt;state-&gt;response_sec;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;state-&gt;response_msec = tp-&gt;msec - u-&gt;state-&gt;response_msec;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;state = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(r-&gt;upstream_states);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;state == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(u-&gt;state, <span class="Statement">sizeof</span>(<a href="ngx_http_upstream.h.html#L66" title="http/ngx_http_upstream.h:66">ngx_http_upstream_state_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tp = <a href="../core/ngx_times.h.html#L37" title="core/ngx_times.h:37">ngx_timeofday</a>();<br/></li>
<li>&nbsp; &nbsp; u-&gt;state-&gt;response_sec = tp-&gt;sec;<br/></li>
<li>&nbsp; &nbsp; u-&gt;state-&gt;response_msec = tp-&gt;msec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../event/ngx_event_connect.c.html#L15" title="event/ngx_event_connect.c:15">ngx_event_connect_peer</a>(&amp;u-&gt;peer);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream connect: </span><span class="Special">%i</span><span class="Constant">&quot;</span>, rc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;state-&gt;peer = u-&gt;peer.name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L32" title="core/ngx_core.h:32">NGX_BUSY</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;no live upstreams&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3577" title="http/ngx_http_upstream.c:3577">ngx_http_upstream_next</a>(r, u, <a href="ngx_http_upstream.h.html#L32" title="http/ngx_http_upstream.h:32">NGX_HTTP_UPSTREAM_FT_NOLIVE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3577" title="http/ngx_http_upstream.c:3577">ngx_http_upstream_next</a>(r, u, <a href="ngx_http_upstream.h.html#L20" title="http/ngx_http_upstream.h:20">NGX_HTTP_UPSTREAM_FT_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* rc == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a> || rc == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a> || rc == <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; c = u-&gt;peer.connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;data = r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;write-&gt;handler = <a href="#L1059" title="http/ngx_http_upstream.c:1059">ngx_http_upstream_handler</a>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;read-&gt;handler = <a href="#L1059" title="http/ngx_http_upstream.c:1059">ngx_http_upstream_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;write_event_handler = <a href="#L1798" title="http/ngx_http_upstream.c:1798">ngx_http_upstream_send_request_handler</a>;<br/></li>
<li>&nbsp; &nbsp; u-&gt;read_event_handler = <a href="#L1835" title="http/ngx_http_upstream.c:1835">ngx_http_upstream_process_header</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;sendfile &amp;= r-&gt;connection-&gt;sendfile;<br/></li>
<li>&nbsp; &nbsp; u-&gt;output.sendfile = c-&gt;sendfile;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;pool == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* we need separate pool here to be able to cache SSL connections */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;pool = <a href="../core/ngx_palloc.c.html#L17" title="core/ngx_palloc.c:17">ngx_create_pool</a>(<span class="Constant">128</span>, r-&gt;connection-&gt;log);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;pool == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log = r-&gt;connection-&gt;log;<br/></li>
<li>&nbsp; &nbsp; c-&gt;pool-&gt;log = c-&gt;log;<br/></li>
<li>&nbsp; &nbsp; c-&gt;read-&gt;log = c-&gt;log;<br/></li>
<li>&nbsp; &nbsp; c-&gt;write-&gt;log = c-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* init or reinit the <a href="../core/ngx_output_chain.c.html#L42" title="core/ngx_output_chain.c:42">ngx_output_chain</a>() and <a href="../core/ngx_output_chain.c.html#L602" title="core/ngx_output_chain.c:602">ngx_chain_writer</a>() contexts */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; u-&gt;writer.out = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; u-&gt;writer.last = &amp;u-&gt;writer.out;<br/></li>
<li>&nbsp; &nbsp; u-&gt;writer.connection = c;<br/></li>
<li>&nbsp; &nbsp; u-&gt;writer.limit = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;request_sent) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1646" title="http/ngx_http_upstream.c:1646">ngx_http_upstream_reinit</a>(r, u) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_body<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;request_body-&gt;buf<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;request_body-&gt;temp_file<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r == r-&gt;<a href="../core/nginx.c.html#L202" title="core/nginx.c:202">main</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the r-&gt;request_body-&gt;buf can be reused for one request only,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the subrequests should allocate their own temporary bufs<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;output.free = <a href="../core/ngx_buf.c.html#L48" title="core/ngx_buf.c:48">ngx_alloc_chain_link</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;output.free == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;output.free-&gt;buf = r-&gt;request_body-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;output.free-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;output.allocated = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_body-&gt;buf-&gt;pos = r-&gt;request_body-&gt;buf-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_body-&gt;buf-&gt;last = r-&gt;request_body-&gt;buf-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_body-&gt;buf-&gt;tag = u-&gt;output.tag;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;request_sent = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(c-&gt;write, u-&gt;conf-&gt;connect_timeout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;ssl &amp;&amp; c-&gt;ssl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1439" title="http/ngx_http_upstream.c:1439">ngx_http_upstream_ssl_init_connection</a>(r, u, c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L1724" title="http/ngx_http_upstream.c:1724">ngx_http_upstream_send_request</a>(r, u);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1439">&#x200c;</a></span><span class="linkable">ngx_http_upstream_ssl_init_connection</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u, <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp;&nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2184" title="http/ngx_http_upstream.c:2184">ngx_http_upstream_test_connect</a>(c) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3577" title="http/ngx_http_upstream.c:3577">ngx_http_upstream_next</a>(r, u, <a href="ngx_http_upstream.h.html#L20" title="http/ngx_http_upstream.h:20">NGX_HTTP_UPSTREAM_FT_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_openssl.c.html#L1017" title="event/ngx_event_openssl.c:1017">ngx_ssl_create_connection</a>(u-&gt;conf-&gt;ssl, c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event_openssl.h.html#L117" title="event/ngx_event_openssl.h:117">NGX_SSL_BUFFER</a>|<a href="../event/ngx_event_openssl.h.html#L118" title="event/ngx_event_openssl.h:118">NGX_SSL_CLIENT</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;sendfile = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; u-&gt;output.sendfile = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;ssl_server_name || u-&gt;conf-&gt;ssl_verify) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1553" title="http/ngx_http_upstream.c:1553">ngx_http_upstream_ssl_name</a>(r, u, c) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;ssl_session_reuse) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.set_session(&amp;u-&gt;peer, u-&gt;peer.data) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;connection-&gt;log-&gt;action = <span class="Constant">&quot;SSL handshaking to upstream&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../event/ngx_event_openssl.c.html#L1074" title="event/ngx_event_openssl.c:1074">ngx_ssl_handshake</a>(c);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!c-&gt;write-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(c-&gt;write, u-&gt;conf-&gt;connect_timeout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;handler = <a href="#L1496" title="http/ngx_http_upstream.c:1496">ngx_http_upstream_ssl_handshake</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1496" title="http/ngx_http_upstream.c:1496">ngx_http_upstream_ssl_handshake</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1496">&#x200c;</a></span><span class="linkable">ngx_http_upstream_ssl_handshake</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">long</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a>&nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = c-&gt;data;<br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L598" title="http/ngx_http_request.h:598">ngx_http_set_log_request</a>(c-&gt;log, r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;handshaked) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;ssl_verify) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = SSL_get_verify_result(c-&gt;ssl-&gt;connection);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != X509_V_OK) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;upstream SSL certificate verify error: (%l:</span><span class="Special">%s</span><span class="Constant">)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc, X509_verify_cert_error_string(rc));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_openssl.c.html#L2916" title="event/ngx_event_openssl.c:2916">ngx_ssl_check_host</a>(c, &amp;u-&gt;ssl_name) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;upstream SSL certificate does not match </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;u-&gt;ssl_name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;ssl_session_reuse) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.save_session(&amp;u-&gt;peer, u-&gt;peer.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;write-&gt;handler = <a href="#L1059" title="http/ngx_http_upstream.c:1059">ngx_http_upstream_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;handler = <a href="#L1059" title="http/ngx_http_upstream.c:1059">ngx_http_upstream_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1724" title="http/ngx_http_upstream.c:1724">ngx_http_upstream_send_request</a>(r, u);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2193" title="http/ngx_http_request.c:2193">ngx_http_run_posted_requests</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L3577" title="http/ngx_http_upstream.c:3577">ngx_http_upstream_next</a>(r, u, <a href="ngx_http_upstream.h.html#L20" title="http/ngx_http_upstream.h:20">NGX_HTTP_UPSTREAM_FT_ERROR</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.c.html#L2193" title="http/ngx_http_request.c:2193">ngx_http_run_posted_requests</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1553">&#x200c;</a><span class="linkable">ngx_http_upstream_ssl_name</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp;&nbsp; *p, *last;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp;&nbsp; name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;ssl_name) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_script.c.html#L58" title="http/ngx_http_script.c:58">ngx_http_complex_value</a>(r, u-&gt;conf-&gt;ssl_name, &amp;name) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name = u-&gt;ssl_name;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * ssl name here may contain port, notably if derived from $proxy_host<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * or $http_host; we have to strip it<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; p = name.data;<br/></li>
<li>&nbsp; &nbsp; last = name.data + name.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*p == <span class="Constant">'['</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.h.html#L66" title="core/ngx_string.h:66">ngx_strlchr</a>(p, last, <span class="Constant">']'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = name.data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.h.html#L66" title="core/ngx_string.h:66">ngx_strlchr</a>(p, last, <span class="Constant">':'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name.len = p - name.data;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!u-&gt;conf-&gt;ssl_server_name) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef SSL_CTRL_SET_TLSEXT_HOSTNAME<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* as per RFC 6066, literal IPv4 and IPv6 addresses are not permitted */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name.len == <span class="Constant">0</span> || *name.data == <span class="Constant">'['</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_inet.c.html#L18" title="core/ngx_inet.c:18">ngx_inet_addr</a>(name.data, name.len) != <a href="../core/ngx_config.h.html#L115" title="core/ngx_config.h:115">INADDR_NONE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * SSL_set_tlsext_host_name() needs a null-terminated string,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * hence we explicitly null-terminate name here<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(r-&gt;pool, name.len + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="../core/ngx_string.c.html#L33" title="core/ngx_string.c:33">ngx_cpystrn</a>(p, name.data, name.len + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name.data = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;upstream SSL server name: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SSL_set_tlsext_host_name(c-&gt;ssl-&gt;connection, name.data) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event_openssl.c.html#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_set_tlsext_host_name(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; u-&gt;ssl_name = name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1646">&#x200c;</a><span class="linkable">ngx_http_upstream_reinit</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">off_t</span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file_pos;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; *cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;reinit_request(r) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;keepalive = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; u-&gt;upgrade = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;u-&gt;headers_in, <span class="Statement">sizeof</span>(<a href="ngx_http_upstream.h.html#L268" title="http/ngx_http_upstream.h:268">ngx_http_upstream_headers_in_t</a>));<br/></li>
<li>&nbsp; &nbsp; u-&gt;headers_in.content_length_n = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; u-&gt;headers_in.last_modified_time = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_list.h.html#L37" title="core/ngx_list.h:37">ngx_list_init</a>(&amp;u-&gt;headers_in.headers, r-&gt;pool, <span class="Constant">8</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* reinit the request chain */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; file_pos = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (cl = u-&gt;request_bufs; cl; cl = cl-&gt;next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf-&gt;pos = cl-&gt;buf-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* there is at most one file */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl-&gt;buf-&gt;in_file) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf-&gt;file_pos = file_pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file_pos = cl-&gt;buf-&gt;file_last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* reinit the subrequest's <a href="../core/ngx_output_chain.c.html#L42" title="core/ngx_output_chain.c:42">ngx_output_chain</a>() context */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_body &amp;&amp; r-&gt;request_body-&gt;temp_file<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r != r-&gt;<a href="../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> &amp;&amp; u-&gt;output.buf)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;output.free = <a href="../core/ngx_buf.c.html#L48" title="core/ngx_buf.c:48">ngx_alloc_chain_link</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;output.free == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;output.free-&gt;buf = u-&gt;output.buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;output.free-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;output.buf-&gt;pos = u-&gt;output.buf-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;output.buf-&gt;last = u-&gt;output.buf-&gt;start;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;output.buf = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; u-&gt;output.in = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; u-&gt;output.busy = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* reinit u-&gt;buffer */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; u-&gt;buffer.pos = u-&gt;buffer.start;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;cache) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.pos += r-&gt;cache-&gt;header_start;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; u-&gt;buffer.last = u-&gt;buffer.pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1724">&#x200c;</a></span><span class="linkable">ngx_http_upstream_send_request</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = u-&gt;peer.connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream send request&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!u-&gt;request_sent &amp;&amp; <a href="#L2184" title="http/ngx_http_upstream.c:2184">ngx_http_upstream_test_connect</a>(c) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3577" title="http/ngx_http_upstream.c:3577">ngx_http_upstream_next</a>(r, u, <a href="ngx_http_upstream.h.html#L20" title="http/ngx_http_upstream.h:20">NGX_HTTP_UPSTREAM_FT_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;sending request to upstream&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../core/ngx_output_chain.c.html#L42" title="core/ngx_output_chain.c:42">ngx_output_chain</a>(&amp;u-&gt;output, u-&gt;request_sent ? <span class="Constant">NULL</span> : u-&gt;request_bufs);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;request_sent = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3577" title="http/ngx_http_upstream.c:3577">ngx_http_upstream_next</a>(r, u, <a href="ngx_http_upstream.h.html#L20" title="http/ngx_http_upstream.h:20">NGX_HTTP_UPSTREAM_FT_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;write-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L428" title="event/ngx_event.h:428">ngx_del_timer</a>(c-&gt;write);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(c-&gt;write, u-&gt;conf-&gt;send_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L338" title="event/ngx_event.c:338">ngx_handle_write_event</a>(c-&gt;write, u-&gt;conf-&gt;send_lowat) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* rc == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;tcp_nopush == NGX_TCP_NOPUSH_SET) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_socket.c.html#L65" title="os/unix/ngx_socket.c:65">ngx_tcp_push</a>(c-&gt;fd) == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>, c-&gt;log, <a href="../os/unix/ngx_errno.h.html#L69" title="os/unix/ngx_errno.h:69">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_socket.h.html#L47" title="os/unix/ngx_socket.h:47">ngx_tcp_push_n</a> <span class="Constant">&quot; failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;tcp_nopush = NGX_TCP_NOPUSH_UNSET;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;write_event_handler = <a href="#L3569" title="http/ngx_http_upstream.c:3569">ngx_http_upstream_dummy_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L338" title="event/ngx_event.c:338">ngx_handle_write_event</a>(c-&gt;write, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(c-&gt;read, u-&gt;conf-&gt;read_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;read-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1835" title="http/ngx_http_upstream.c:1835">ngx_http_upstream_process_header</a>(r, u);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1798">&#x200c;</a></span><span class="linkable">ngx_http_upstream_send_request_handler</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = u-&gt;peer.connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream send request handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;write-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3577" title="http/ngx_http_upstream.c:3577">ngx_http_upstream_next</a>(r, u, <a href="ngx_http_upstream.h.html#L21" title="http/ngx_http_upstream.h:21">NGX_HTTP_UPSTREAM_FT_TIMEOUT</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;ssl &amp;&amp; c-&gt;ssl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1439" title="http/ngx_http_upstream.c:1439">ngx_http_upstream_ssl_init_connection</a>(r, u, c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;header_sent) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;write_event_handler = <a href="#L3569" title="http/ngx_http_upstream.c:3569">ngx_http_upstream_dummy_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../event/ngx_event.c.html#L338" title="event/ngx_event.c:338">ngx_handle_write_event</a>(c-&gt;write, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1724" title="http/ngx_http_upstream.c:1724">ngx_http_upstream_send_request</a>(r, u);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1835">&#x200c;</a></span><span class="linkable">ngx_http_upstream_process_header</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = u-&gt;peer.connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream process header&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;reading response header from upstream&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;read-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3577" title="http/ngx_http_upstream.c:3577">ngx_http_upstream_next</a>(r, u, <a href="ngx_http_upstream.h.html#L21" title="http/ngx_http_upstream.h:21">NGX_HTTP_UPSTREAM_FT_TIMEOUT</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!u-&gt;request_sent &amp;&amp; <a href="#L2184" title="http/ngx_http_upstream.c:2184">ngx_http_upstream_test_connect</a>(c) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3577" title="http/ngx_http_upstream.c:3577">ngx_http_upstream_next</a>(r, u, <a href="ngx_http_upstream.h.html#L20" title="http/ngx_http_upstream.h:20">NGX_HTTP_UPSTREAM_FT_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;buffer.start == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.start = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(r-&gt;pool, u-&gt;conf-&gt;buffer_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;buffer.start == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.pos = u-&gt;buffer.start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.last = u-&gt;buffer.start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.end = u-&gt;buffer.start + u-&gt;conf-&gt;buffer_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.temporary = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.tag = u-&gt;output.tag;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_list.h.html#L37" title="core/ngx_list.h:37">ngx_list_init</a>(&amp;u-&gt;headers_in.headers, r-&gt;pool, <span class="Constant">8</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;cache) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.pos += r-&gt;cache-&gt;header_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.last = u-&gt;buffer.pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = c-&gt;recv(c, u-&gt;buffer.last, u-&gt;buffer.end - u-&gt;buffer.last);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li><span class="Comment">#if 0<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(rev, u-&gt;read_timeout);<br/></li>
<li></span><span class="Comment">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(c-&gt;read, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;upstream prematurely closed connection&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a> || n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3577" title="http/ngx_http_upstream.c:3577">ngx_http_upstream_next</a>(r, u, <a href="ngx_http_upstream.h.html#L20" title="http/ngx_http_upstream.h:20">NGX_HTTP_UPSTREAM_FT_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.last += n;<br/></li>
<li><br/></li>
<li><span class="Comment">#if 0<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;valid_header_in = 0;<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.cached = 0;<br/></li>
<li></span><span class="Comment">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = u-&gt;process_header(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;buffer.last == u-&gt;buffer.end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;upstream sent too big header&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3577" title="http/ngx_http_upstream.c:3577">ngx_http_upstream_next</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_upstream.h.html#L22" title="http/ngx_http_upstream.h:22">NGX_HTTP_UPSTREAM_FT_INVALID_HEADER</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="ngx_http_upstream.h.html#L42" title="http/ngx_http_upstream.h:42">NGX_HTTP_UPSTREAM_INVALID_HEADER</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3577" title="http/ngx_http_upstream.c:3577">ngx_http_upstream_next</a>(r, u, <a href="ngx_http_upstream.h.html#L22" title="http/ngx_http_upstream.h:22">NGX_HTTP_UPSTREAM_FT_INVALID_HEADER</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* rc == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;headers_in.status_n &gt;= <a href="ngx_http_request.h.html#L77" title="http/ngx_http_request.h:77">NGX_HTTP_SPECIAL_RESPONSE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2017" title="http/ngx_http_upstream.c:2017">ngx_http_upstream_test_next</a>(r, u) == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2111" title="http/ngx_http_upstream.c:2111">ngx_http_upstream_intercept_errors</a>(r, u) == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2235" title="http/ngx_http_upstream.c:2235">ngx_http_upstream_process_headers</a>(r, u) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!r-&gt;subrequest_in_memory) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2454" title="http/ngx_http_upstream.c:2454">ngx_http_upstream_send_response</a>(r, u);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* subrequest content in memory */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;input_filter == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;input_filter_init = <a href="#L3212" title="http/ngx_http_upstream.c:3212">ngx_http_upstream_non_buffered_filter_init</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;input_filter = <a href="#L3219" title="http/ngx_http_upstream.c:3219">ngx_http_upstream_non_buffered_filter</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;input_filter_ctx = r;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;input_filter_init(u-&gt;input_filter_ctx) == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = u-&gt;buffer.last - u-&gt;buffer.pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.last = u-&gt;buffer.pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;state-&gt;response_length += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;input_filter(u-&gt;input_filter_ctx, n) == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;length == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;read_event_handler = <a href="#L2377" title="http/ngx_http_upstream.c:2377">ngx_http_upstream_process_body_in_memory</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2377" title="http/ngx_http_upstream.c:2377">ngx_http_upstream_process_body_in_memory</a>(r, u);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2017">&#x200c;</a><span class="linkable">ngx_http_upstream_test_next</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; status;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L373" title="http/ngx_http_upstream.h:373">ngx_http_upstream_next_t</a>&nbsp; *un;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; status = u-&gt;headers_in.status_n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (un = <a href="#L390" title="http/ngx_http_upstream.c:390">ngx_http_upstream_next_errors</a>; un-&gt;status; un++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (status != un-&gt;status) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.tries &gt; <span class="Constant">1</span> &amp;&amp; (u-&gt;conf-&gt;next_upstream &amp; un-&gt;mask)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3577" title="http/ngx_http_upstream.c:3577">ngx_http_upstream_next</a>(r, u, un-&gt;mask);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;cache_status == <a href="ngx_http_cache.h.html#L19" title="http/ngx_http_cache.h:19">NGX_HTTP_CACHE_EXPIRED</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (u-&gt;conf-&gt;cache_use_stale &amp; un-&gt;mask))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = u-&gt;reinit_request(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cache_status = <a href="ngx_http_cache.h.html#L20" title="http/ngx_http_cache.h:20">NGX_HTTP_CACHE_STALE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L929" title="http/ngx_http_upstream.c:929">ngx_http_upstream_cache_send</a>(r, u);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (status == <a href="ngx_http_request.h.html#L81" title="http/ngx_http_request.h:81">NGX_HTTP_NOT_MODIFIED</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; u-&gt;cache_status == <a href="ngx_http_cache.h.html#L19" title="http/ngx_http_cache.h:19">NGX_HTTP_CACHE_EXPIRED</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; u-&gt;conf-&gt;cache_revalidate)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; &nbsp;&nbsp; now, valid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream not modified&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; now = <a href="../core/ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; valid = r-&gt;cache-&gt;valid_sec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = u-&gt;reinit_request(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cache_status = <a href="ngx_http_cache.h.html#L22" title="http/ngx_http_cache.h:22">NGX_HTTP_CACHE_REVALIDATED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L929" title="http/ngx_http_upstream.c:929">ngx_http_upstream_cache_send</a>(r, u);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (valid == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; valid = r-&gt;cache-&gt;valid_sec;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (valid == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; valid = <a href="ngx_http_file_cache.c.html#L2007" title="http/ngx_http_file_cache.c:2007">ngx_http_file_cache_valid</a>(u-&gt;conf-&gt;cache_valid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;headers_in.status_n);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (valid) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; valid = now + valid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (valid) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;cache-&gt;valid_sec = valid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;cache-&gt;date = now;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_file_cache.c.html#L1292" title="http/ngx_http_file_cache.c:1292">ngx_http_file_cache_update_header</a>(r);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2111">&#x200c;</a><span class="linkable">ngx_http_upstream_intercept_errors</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *h;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L304" title="http/ngx_http_core_module.h:304">ngx_http_err_page_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *err_page;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; status = u-&gt;headers_in.status_n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (status == <a href="ngx_http_request.h.html#L87" title="http/ngx_http_request.h:87">NGX_HTTP_NOT_FOUND</a> &amp;&amp; u-&gt;conf-&gt;intercept_404) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="ngx_http_request.h.html#L87" title="http/ngx_http_request.h:87">NGX_HTTP_NOT_FOUND</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!u-&gt;conf-&gt;intercept_errors) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;error_pages == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; err_page = clcf-&gt;error_pages-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; clcf-&gt;error_pages-&gt;nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (err_page[i].status == status) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (status == <a href="ngx_http_request.h.html#L85" title="http/ngx_http_request.h:85">NGX_HTTP_UNAUTHORIZED</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; u-&gt;headers_in.www_authenticate)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h = <a href="../core/ngx_list.c.html#L31" title="core/ngx_list.c:31">ngx_list_push</a>(&amp;r-&gt;headers_out.headers);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (h == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *h = *u-&gt;headers_in.www_authenticate;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.www_authenticate = h;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;cache) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; valid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; valid = <a href="ngx_http_file_cache.c.html#L2007" title="http/ngx_http_file_cache.c:2007">ngx_http_file_cache_valid</a>(u-&gt;conf-&gt;cache_valid, status);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (valid) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;cache-&gt;valid_sec = <a href="../core/ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>() + valid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;cache-&gt;error = status;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_file_cache.c.html#L1475" title="http/ngx_http_file_cache.c:1475">ngx_http_file_cache_free</a>(r-&gt;cache, u-&gt;pipe-&gt;temp_file);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, status);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2184">&#x200c;</a><span class="linkable">ngx_http_upstream_test_connect</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; err;<br/></li>
<li>&nbsp; &nbsp; socklen_t&nbsp; len;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_KQUEUE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L44" title="event/ngx_event.c:44">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L239" title="event/ngx_event.h:239">NGX_USE_KQUEUE_EVENT</a>)&nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;write-&gt;pending_eof || c-&gt;read-&gt;pending_eof) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;write-&gt;pending_eof) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = c-&gt;write-&gt;kq_errno;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = c-&gt;read-&gt;kq_errno;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;connecting to upstream&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../core/ngx_connection.c.html#L1136" title="core/ngx_connection.c:1136">ngx_connection_error</a>(c, err,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;kevent() reported that connect() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<span class="Type">int</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * BSDs and Linux return 0 and <a href="../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> a pending error in err<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Solaris returns -1 and sets errno<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (getsockopt(c-&gt;fd, SOL_SOCKET, SO_ERROR, (<span class="Type">void</span> *) &amp;err, &amp;len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <a href="../os/unix/ngx_errno.h.html#L69" title="os/unix/ngx_errno.h:69">ngx_socket_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (err) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;connecting to upstream&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../core/ngx_connection.c.html#L1136" title="core/ngx_connection.c:1136">ngx_connection_error</a>(c, err, <span class="Constant">&quot;connect() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2235">&#x200c;</a><span class="linkable">ngx_http_upstream_process_headers</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; uri, args;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i, flags;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_list.h.html#L16" title="core/ngx_list.h:16">ngx_list_part_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *part;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *h;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L226" title="http/ngx_http_upstream.h:226">ngx_http_upstream_header_t</a>&nbsp; &nbsp;&nbsp; *hh;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L73" title="http/ngx_http_upstream.h:73">ngx_http_upstream_main_conf_t</a>&nbsp; *umcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; umcf = <a href="ngx_http_config.h.html#L55" title="http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(r, <a href="#L336" title="http/ngx_http_upstream.c:336">ngx_http_upstream_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;headers_in.x_accel_redirect<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; !(u-&gt;conf-&gt;ignore_headers &amp; <a href="ngx_http_upstream.h.html#L45" title="http/ngx_http_upstream.h:45">NGX_HTTP_UPSTREAM_IGN_XA_REDIRECT</a>))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; part = &amp;u-&gt;headers_in.headers.part;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h = part-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; <span class="Comment">/* void */</span>; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &gt;= part-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (part-&gt;next == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; part = part-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h = part-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hh = <a href="../core/ngx_hash.c.html#L13" title="core/ngx_hash.c:13">ngx_hash_find</a>(&amp;umcf-&gt;headers_in_hash, h[i].hash,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h[i].lowcase_key, h[i].key.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hh &amp;&amp; hh-&gt;redirect) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hh-&gt;copy_handler(r, &amp;h[i], hh-&gt;conf) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uri = u-&gt;headers_in.x_accel_redirect-&gt;value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (uri.data[<span class="Constant">0</span>] == <span class="Constant">'@'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_core_module.c.html#L2653" title="http/ngx_http_core_module.c:2653">ngx_http_named_location</a>(r, &amp;uri);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L44" title="core/ngx_string.h:44">ngx_str_null</a>(&amp;args);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flags = <a href="ngx_http_request.h.html#L64" title="http/ngx_http_request.h:64">NGX_HTTP_LOG_UNSAFE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_parse.c.html#L1793" title="http/ngx_http_parse.c:1793">ngx_http_parse_unsafe_uri</a>(r, &amp;uri, &amp;args, &amp;flags) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L87" title="http/ngx_http_request.h:87">NGX_HTTP_NOT_FOUND</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;method != <a href="ngx_http_request.h.html#L29" title="http/ngx_http_request.h:29">NGX_HTTP_HEAD</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;method = <a href="ngx_http_request.h.html#L28" title="http/ngx_http_request.h:28">NGX_HTTP_GET</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_core_module.c.html#L2598" title="http/ngx_http_core_module.c:2598">ngx_http_internal_redirect</a>(r, &amp;uri, &amp;args);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; part = &amp;u-&gt;headers_in.headers.part;<br/></li>
<li>&nbsp; &nbsp; h = part-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; <span class="Comment">/* void */</span>; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &gt;= part-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (part-&gt;next == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; part = part-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h = part-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_hash.c.html#L13" title="core/ngx_hash.c:13">ngx_hash_find</a>(&amp;u-&gt;conf-&gt;hide_headers_hash, h[i].hash,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h[i].lowcase_key, h[i].key.len))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hh = <a href="../core/ngx_hash.c.html#L13" title="core/ngx_hash.c:13">ngx_hash_find</a>(&amp;umcf-&gt;headers_in_hash, h[i].hash,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h[i].lowcase_key, h[i].key.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hh) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hh-&gt;copy_handler(r, &amp;h[i], hh-&gt;conf) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L4306" title="http/ngx_http_upstream.c:4306">ngx_http_upstream_copy_header_line</a>(r, &amp;h[i], <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.server &amp;&amp; r-&gt;headers_out.server-&gt;value.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.server-&gt;hash = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.date &amp;&amp; r-&gt;headers_out.date-&gt;value.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.date-&gt;hash = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.status = u-&gt;headers_in.status_n;<br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.status_line = u-&gt;headers_in.status_line;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.content_length_n = u-&gt;headers_in.content_length_n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;disable_not_modified = !u-&gt;cacheable;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;force_ranges) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;allow_ranges = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;single_range = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;cached) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;single_range = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;length = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2377">&#x200c;</a></span><span class="linkable">ngx_http_upstream_process_body_in_memory</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *rev;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = u-&gt;peer.connection;<br/></li>
<li>&nbsp; &nbsp; rev = c-&gt;read;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream process body on memory&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1136" title="core/ngx_connection.c:1136">ngx_connection_error</a>(c, <a href="../os/unix/ngx_errno.h.html#L43" title="os/unix/ngx_errno.h:43">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;upstream timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="ngx_http_request.h.html#L132" title="http/ngx_http_request.h:132">NGX_HTTP_GATEWAY_TIME_OUT</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b = &amp;u-&gt;buffer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = b-&gt;end - b-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;upstream buffer is too small to read response&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = c-&gt;recv(c, b-&gt;last, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span> || n == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, n);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;state-&gt;response_length += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;input_filter(u-&gt;input_filter_ctx, n) == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!rev-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;length == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;active) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(rev, u-&gt;conf-&gt;read_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (rev-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L428" title="event/ngx_event.h:428">ngx_del_timer</a>(rev);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2454">&#x200c;</a></span><span class="linkable">ngx_http_upstream_send_response</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp_nodelay;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../event/ngx_event_pipe.h.html#L17" title="event/ngx_event_pipe.h:17">ngx_event_pipe_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="ngx_http_core_module.c.html#L1974" title="http/ngx_http_core_module.c:1974">ngx_http_send_header</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a> || rc &gt; <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a> || r-&gt;post_action) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;header_sent = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;upgrade) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2762" title="http/ngx_http_upstream.c:2762">ngx_http_upstream_upgrade</a>(r, u);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;header_only) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!u-&gt;buffering) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!u-&gt;cacheable &amp;&amp; !u-&gt;store) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;pipe-&gt;downstream_error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_body &amp;&amp; r-&gt;request_body-&gt;temp_file) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L345" title="core/ngx_palloc.c:345">ngx_pool_run_cleanup_file</a>(r-&gt;pool, r-&gt;request_body-&gt;temp_file-&gt;file.fd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_body-&gt;temp_file-&gt;file.fd = <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!u-&gt;buffering) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;input_filter == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;input_filter_init = <a href="#L3212" title="http/ngx_http_upstream.c:3212">ngx_http_upstream_non_buffered_filter_init</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;input_filter = <a href="#L3219" title="http/ngx_http_upstream.c:3219">ngx_http_upstream_non_buffered_filter</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;input_filter_ctx = r;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;read_event_handler = <a href="#L3065" title="http/ngx_http_upstream.c:3065">ngx_http_upstream_process_non_buffered_upstream</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;write_event_handler =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L3038" title="http/ngx_http_upstream.c:3038">ngx_http_upstream_process_non_buffered_downstream</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;limit_rate = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;input_filter_init(u-&gt;input_filter_ctx) == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;tcp_nodelay &amp;&amp; c-&gt;tcp_nodelay == NGX_TCP_NODELAY_UNSET) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;tcp_nodelay&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp_nodelay = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (setsockopt(c-&gt;fd, IPPROTO_TCP, TCP_NODELAY,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<span class="Type">const</span> <span class="Type">void</span> *) &amp;tcp_nodelay, <span class="Statement">sizeof</span>(<span class="Type">int</span>)) == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1136" title="core/ngx_connection.c:1136">ngx_connection_error</a>(c, <a href="../os/unix/ngx_errno.h.html#L69" title="os/unix/ngx_errno.h:69">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;setsockopt(TCP_NODELAY) failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;tcp_nodelay = NGX_TCP_NODELAY_SET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = u-&gt;buffer.last - u-&gt;buffer.pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.last = u-&gt;buffer.pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;state-&gt;response_length += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;input_filter(u-&gt;input_filter_ctx, n) == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3038" title="http/ngx_http_upstream.c:3038">ngx_http_upstream_process_non_buffered_downstream</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.pos = u-&gt;buffer.start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.last = u-&gt;buffer.start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_request.c.html#L3307" title="http/ngx_http_request.c:3307">ngx_http_send_special</a>(r, <a href="ngx_http.h.html#L138" title="http/ngx_http.h:138">NGX_HTTP_FLUSH</a>) == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.connection-&gt;read-&gt;ready || u-&gt;length == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3065" title="http/ngx_http_upstream.c:3065">ngx_http_upstream_process_non_buffered_upstream</a>(r, u);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: preallocate event_pipe bufs, look &quot;Content-Length&quot; */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;cache &amp;&amp; r-&gt;cache-&gt;file.fd != <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L345" title="core/ngx_palloc.c:345">ngx_pool_run_cleanup_file</a>(r-&gt;pool, r-&gt;cache-&gt;file.fd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;cache-&gt;file.fd = <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (<a href="ngx_http_script.c.html#L248" title="http/ngx_http_script.c:248">ngx_http_test_predicates</a>(r, u-&gt;conf-&gt;no_cache)) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;cache_status == <a href="ngx_http_cache.h.html#L18" title="http/ngx_http_cache.h:18">NGX_HTTP_CACHE_BYPASS</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create cache if previously bypassed */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_file_cache.c.html#L187" title="http/ngx_http_file_cache.c:187">ngx_http_file_cache_create</a>(r) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;cacheable) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; now, valid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; now = <a href="../core/ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; valid = r-&gt;cache-&gt;valid_sec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (valid == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; valid = <a href="ngx_http_file_cache.c.html#L2007" title="http/ngx_http_file_cache.c:2007">ngx_http_file_cache_valid</a>(u-&gt;conf-&gt;cache_valid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;headers_in.status_n);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (valid) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;cache-&gt;valid_sec = now + valid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (valid) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;cache-&gt;date = now;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;cache-&gt;body_start = (u_short) (u-&gt;buffer.pos - u-&gt;buffer.start);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;headers_in.status_n == <a href="ngx_http_request.h.html#L71" title="http/ngx_http_request.h:71">NGX_HTTP_OK</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || u-&gt;headers_in.status_n == <a href="ngx_http_request.h.html#L75" title="http/ngx_http_request.h:75">NGX_HTTP_PARTIAL_CONTENT</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;cache-&gt;last_modified = u-&gt;headers_in.last_modified_time;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;headers_in.etag) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;cache-&gt;etag = u-&gt;headers_in.etag-&gt;value;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_file_cache.c.html#L1126" title="http/ngx_http_file_cache.c:1126">ngx_http_file_cache_set_header</a>(r, u-&gt;buffer.start);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http cacheable: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, u-&gt;cacheable);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;cacheable == <span class="Constant">0</span> &amp;&amp; r-&gt;cache) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_file_cache.c.html#L1475" title="http/ngx_http_file_cache.c:1475">ngx_http_file_cache_free</a>(r-&gt;cache, u-&gt;pipe-&gt;temp_file);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; p = u-&gt;pipe;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p-&gt;output_filter = (<a href="../event/ngx_event_pipe.h.html#L21" title="event/ngx_event_pipe.h:21">ngx_event_pipe_output_filter_pt</a>) <a href="ngx_http_core_module.c.html#L1996" title="http/ngx_http_core_module.c:1996">ngx_http_output_filter</a>;<br/></li>
<li>&nbsp; &nbsp; p-&gt;output_ctx = r;<br/></li>
<li>&nbsp; &nbsp; p-&gt;tag = u-&gt;output.tag;<br/></li>
<li>&nbsp; &nbsp; p-&gt;bufs = u-&gt;conf-&gt;bufs;<br/></li>
<li>&nbsp; &nbsp; p-&gt;busy_size = u-&gt;conf-&gt;busy_buffers_size;<br/></li>
<li>&nbsp; &nbsp; p-&gt;upstream = u-&gt;peer.connection;<br/></li>
<li>&nbsp; &nbsp; p-&gt;downstream = c;<br/></li>
<li>&nbsp; &nbsp; p-&gt;pool = r-&gt;pool;<br/></li>
<li>&nbsp; &nbsp; p-&gt;log = c-&gt;log;<br/></li>
<li>&nbsp; &nbsp; p-&gt;limit_rate = u-&gt;conf-&gt;limit_rate;<br/></li>
<li>&nbsp; &nbsp; p-&gt;start_sec = <a href="../core/ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p-&gt;cacheable = u-&gt;cacheable || u-&gt;store;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p-&gt;temp_file = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="../core/ngx_file.h.html#L74" title="core/ngx_file.h:74">ngx_temp_file_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p-&gt;temp_file == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p-&gt;temp_file-&gt;file.fd = <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>&nbsp; &nbsp; p-&gt;temp_file-&gt;file.log = c-&gt;log;<br/></li>
<li>&nbsp; &nbsp; p-&gt;temp_file-&gt;path = u-&gt;conf-&gt;temp_path;<br/></li>
<li>&nbsp; &nbsp; p-&gt;temp_file-&gt;pool = r-&gt;pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p-&gt;cacheable) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p-&gt;temp_file-&gt;persistent = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p-&gt;temp_file-&gt;log_level = <a href="../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p-&gt;temp_file-&gt;warn = <span class="Constant">&quot;an upstream response is buffered &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;to a temporary file&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p-&gt;max_temp_file_size = u-&gt;conf-&gt;max_temp_file_size;<br/></li>
<li>&nbsp; &nbsp; p-&gt;temp_file_write_size = u-&gt;conf-&gt;temp_file_write_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p-&gt;preread_bufs = <a href="../core/ngx_buf.c.html#L48" title="core/ngx_buf.c:48">ngx_alloc_chain_link</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p-&gt;preread_bufs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p-&gt;preread_bufs-&gt;buf = &amp;u-&gt;buffer;<br/></li>
<li>&nbsp; &nbsp; p-&gt;preread_bufs-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; u-&gt;buffer.recycled = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p-&gt;preread_size = u-&gt;buffer.last - u-&gt;buffer.pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;cacheable) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p-&gt;buf_to_file = <a href="../core/ngx_buf.h.html#L143" title="core/ngx_buf.h:143">ngx_calloc_buf</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p-&gt;buf_to_file == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p-&gt;buf_to_file-&gt;start = u-&gt;buffer.start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p-&gt;buf_to_file-&gt;pos = u-&gt;buffer.start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p-&gt;buf_to_file-&gt;last = u-&gt;buffer.pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p-&gt;buf_to_file-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L44" title="event/ngx_event.c:44">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L266" title="event/ngx_event.h:266">NGX_USE_AIO_EVENT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the posted aio operation may corrupt a shadow buffer */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; p-&gt;single_buf = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: p-&gt;free_bufs = 0 if use <a href="../core/ngx_buf.c.html#L69" title="core/ngx_buf.c:69">ngx_create_chain_of_bufs</a>() */<br/></li>
<li></span>&nbsp; &nbsp; p-&gt;free_bufs = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * event_pipe would do u-&gt;buffer.last += p-&gt;preread_size<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * as though these bytes were read<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; u-&gt;buffer.last = u-&gt;buffer.pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;cyclic_temp_file) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * we need to disable the use of sendfile() if we use cyclic temp file<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * because the writing a new data may interfere with sendfile()<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * that uses the same kernel file pages (at least on FreeBSD)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p-&gt;cyclic_temp_file = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;sendfile = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p-&gt;cyclic_temp_file = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p-&gt;read_timeout = u-&gt;conf-&gt;read_timeout;<br/></li>
<li>&nbsp; &nbsp; p-&gt;send_timeout = clcf-&gt;send_timeout;<br/></li>
<li>&nbsp; &nbsp; p-&gt;send_lowat = clcf-&gt;send_lowat;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p-&gt;length = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;input_filter_init<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; u-&gt;input_filter_init(p-&gt;input_ctx) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;read_event_handler = <a href="#L3331" title="http/ngx_http_upstream.c:3331">ngx_http_upstream_process_upstream</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;write_event_handler = <a href="#L3261" title="http/ngx_http_upstream.c:3261">ngx_http_upstream_process_downstream</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L3331" title="http/ngx_http_upstream.c:3331">ngx_http_upstream_process_upstream</a>(r, u);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2762">&#x200c;</a></span><span class="linkable">ngx_http_upstream_upgrade</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp_nodelay;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: prevent upgrade if not requested or not possible */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; r-&gt;keepalive = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;proxying upgraded connection&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;read_event_handler = <a href="#L2848" title="http/ngx_http_upstream.c:2848">ngx_http_upstream_upgraded_read_upstream</a>;<br/></li>
<li>&nbsp; &nbsp; u-&gt;write_event_handler = <a href="#L2856" title="http/ngx_http_upstream.c:2856">ngx_http_upstream_upgraded_write_upstream</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;read_event_handler = <a href="#L2834" title="http/ngx_http_upstream.c:2834">ngx_http_upstream_upgraded_read_downstream</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;write_event_handler = <a href="#L2841" title="http/ngx_http_upstream.c:2841">ngx_http_upstream_upgraded_write_downstream</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;tcp_nodelay) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tcp_nodelay = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;tcp_nodelay == NGX_TCP_NODELAY_UNSET) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;tcp_nodelay&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (setsockopt(c-&gt;fd, IPPROTO_TCP, TCP_NODELAY,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<span class="Type">const</span> <span class="Type">void</span> *) &amp;tcp_nodelay, <span class="Statement">sizeof</span>(<span class="Type">int</span>)) == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1136" title="core/ngx_connection.c:1136">ngx_connection_error</a>(c, <a href="../os/unix/ngx_errno.h.html#L69" title="os/unix/ngx_errno.h:69">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;setsockopt(TCP_NODELAY) failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;tcp_nodelay = NGX_TCP_NODELAY_SET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.connection-&gt;tcp_nodelay == NGX_TCP_NODELAY_UNSET) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, u-&gt;peer.connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;tcp_nodelay&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (setsockopt(u-&gt;peer.connection-&gt;fd, IPPROTO_TCP, TCP_NODELAY,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<span class="Type">const</span> <span class="Type">void</span> *) &amp;tcp_nodelay, <span class="Statement">sizeof</span>(<span class="Type">int</span>)) == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1136" title="core/ngx_connection.c:1136">ngx_connection_error</a>(u-&gt;peer.connection, <a href="../os/unix/ngx_errno.h.html#L69" title="os/unix/ngx_errno.h:69">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;setsockopt(TCP_NODELAY) failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.connection-&gt;tcp_nodelay = NGX_TCP_NODELAY_SET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_request.c.html#L3307" title="http/ngx_http_request.c:3307">ngx_http_send_special</a>(r, <a href="ngx_http.h.html#L138" title="http/ngx_http.h:138">NGX_HTTP_FLUSH</a>) == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.connection-&gt;read-&gt;ready<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || u-&gt;buffer.pos != u-&gt;buffer.last)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event_posted.h.html#L17" title="event/ngx_event_posted.h:17">ngx_post_event</a>(c-&gt;read, &amp;<a href="../event/ngx_event_posted.c.html#L14" title="event/ngx_event_posted.c:14">ngx_posted_events</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2864" title="http/ngx_http_upstream.c:2864">ngx_http_upstream_process_upgraded</a>(r, <span class="Constant">1</span>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2864" title="http/ngx_http_upstream.c:2864">ngx_http_upstream_process_upgraded</a>(r, <span class="Constant">0</span>, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2834">&#x200c;</a></span><span class="linkable">ngx_http_upstream_upgraded_read_downstream</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L2864" title="http/ngx_http_upstream.c:2864">ngx_http_upstream_process_upgraded</a>(r, <span class="Constant">0</span>, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2841">&#x200c;</a></span><span class="linkable">ngx_http_upstream_upgraded_write_downstream</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L2864" title="http/ngx_http_upstream.c:2864">ngx_http_upstream_process_upgraded</a>(r, <span class="Constant">1</span>, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2848">&#x200c;</a></span><span class="linkable">ngx_http_upstream_upgraded_read_upstream</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L2864" title="http/ngx_http_upstream.c:2864">ngx_http_upstream_process_upgraded</a>(r, <span class="Constant">1</span>, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2856">&#x200c;</a></span><span class="linkable">ngx_http_upstream_upgraded_write_upstream</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L2864" title="http/ngx_http_upstream.c:2864">ngx_http_upstream_process_upgraded</a>(r, <span class="Constant">0</span>, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2864">&#x200c;</a></span><span class="linkable">ngx_http_upstream_process_upgraded</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> from_upstream, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> do_write)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c, *downstream, *upstream, *dst, *src;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream process upgraded, fu:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>, from_upstream);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; downstream = c;<br/></li>
<li>&nbsp; &nbsp; upstream = u-&gt;peer.connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (downstream-&gt;write-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;timedout = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1136" title="core/ngx_connection.c:1136">ngx_connection_error</a>(c, <a href="../os/unix/ngx_errno.h.html#L43" title="os/unix/ngx_errno.h:43">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;client timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="ngx_http_request.h.html#L89" title="http/ngx_http_request.h:89">NGX_HTTP_REQUEST_TIME_OUT</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (upstream-&gt;read-&gt;timedout || upstream-&gt;write-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1136" title="core/ngx_connection.c:1136">ngx_connection_error</a>(c, <a href="../os/unix/ngx_errno.h.html#L43" title="os/unix/ngx_errno.h:43">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;upstream timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="ngx_http_request.h.html#L132" title="http/ngx_http_request.h:132">NGX_HTTP_GATEWAY_TIME_OUT</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (from_upstream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; src = upstream;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst = downstream;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = &amp;u-&gt;buffer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; src = downstream;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst = upstream;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = &amp;u-&gt;from_client;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;header_in-&gt;last &gt; r-&gt;header_in-&gt;pos) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = r-&gt;header_in;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;end = b-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; do_write = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;start == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;start = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(r-&gt;pool, u-&gt;conf-&gt;buffer_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;start == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;end = b-&gt;start + u-&gt;conf-&gt;buffer_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;tag = u-&gt;output.tag;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (do_write) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = b-&gt;last - b-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &amp;&amp; dst-&gt;write-&gt;ready) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = dst-&gt;send(dst, b-&gt;pos, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;pos == b-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = b-&gt;end - b-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &amp;&amp; src-&gt;read-&gt;ready) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = src-&gt;recv(src, b-&gt;last, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a> || n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; do_write = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src-&gt;read-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((upstream-&gt;read-&gt;eof &amp;&amp; u-&gt;buffer.pos == u-&gt;buffer.last)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || (downstream-&gt;read-&gt;eof &amp;&amp; u-&gt;from_client.pos == u-&gt;from_client.last)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || (downstream-&gt;read-&gt;eof &amp;&amp; upstream-&gt;read-&gt;eof))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream upgraded done&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L338" title="event/ngx_event.c:338">ngx_handle_write_event</a>(upstream-&gt;write, u-&gt;conf-&gt;send_lowat)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (upstream-&gt;write-&gt;active &amp;&amp; !upstream-&gt;write-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(upstream-&gt;write, u-&gt;conf-&gt;send_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (upstream-&gt;write-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L428" title="event/ngx_event.h:428">ngx_del_timer</a>(upstream-&gt;write);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(upstream-&gt;read, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (upstream-&gt;read-&gt;active &amp;&amp; !upstream-&gt;read-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(upstream-&gt;read, u-&gt;conf-&gt;read_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (upstream-&gt;read-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L428" title="event/ngx_event.h:428">ngx_del_timer</a>(upstream-&gt;read);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L338" title="event/ngx_event.c:338">ngx_handle_write_event</a>(downstream-&gt;write, clcf-&gt;send_lowat)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(downstream-&gt;read, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (downstream-&gt;write-&gt;active &amp;&amp; !downstream-&gt;write-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(downstream-&gt;write, clcf-&gt;send_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (downstream-&gt;write-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L428" title="event/ngx_event.h:428">ngx_del_timer</a>(downstream-&gt;write);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3038">&#x200c;</a></span><span class="linkable">ngx_http_upstream_process_non_buffered_downstream</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *wev;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp;&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li>&nbsp; &nbsp; wev = c-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream process non buffered downstream&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;sending to client&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (wev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;timedout = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1136" title="core/ngx_connection.c:1136">ngx_connection_error</a>(c, <a href="../os/unix/ngx_errno.h.html#L43" title="os/unix/ngx_errno.h:43">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;client timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="ngx_http_request.h.html#L89" title="http/ngx_http_request.h:89">NGX_HTTP_REQUEST_TIME_OUT</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L3088" title="http/ngx_http_upstream.c:3088">ngx_http_upstream_process_non_buffered_request</a>(r, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3065">&#x200c;</a></span><span class="linkable">ngx_http_upstream_process_non_buffered_upstream</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = u-&gt;peer.connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream process non buffered upstream&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;reading upstream&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;read-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1136" title="core/ngx_connection.c:1136">ngx_connection_error</a>(c, <a href="../os/unix/ngx_errno.h.html#L43" title="os/unix/ngx_errno.h:43">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;upstream timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="ngx_http_request.h.html#L132" title="http/ngx_http_request.h:132">NGX_HTTP_GATEWAY_TIME_OUT</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L3088" title="http/ngx_http_upstream.c:3088">ngx_http_upstream_process_non_buffered_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3088">&#x200c;</a></span><span class="linkable">ngx_http_upstream_process_non_buffered_request</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> do_write)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *downstream, *upstream;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li>&nbsp; &nbsp; downstream = r-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; upstream = u-&gt;peer.connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b = &amp;u-&gt;buffer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; do_write = do_write || u-&gt;length == <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (do_write) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;out_bufs || u-&gt;busy_bufs) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_core_module.c.html#L1996" title="http/ngx_http_core_module.c:1996">ngx_http_output_filter</a>(r, u-&gt;out_bufs);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_buf.c.html#L184" title="core/ngx_buf.c:184">ngx_chain_update_chains</a>(r-&gt;pool, &amp;u-&gt;free_bufs, &amp;u-&gt;busy_bufs,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;u-&gt;out_bufs, u-&gt;output.tag);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;busy_bufs == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;length == <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || (upstream-&gt;read-&gt;eof &amp;&amp; u-&gt;length == -<span class="Constant">1</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (upstream-&gt;read-&gt;eof) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, upstream-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;upstream prematurely closed connection&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L130" title="http/ngx_http_request.h:130">NGX_HTTP_BAD_GATEWAY</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (upstream-&gt;read-&gt;error) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L130" title="http/ngx_http_request.h:130">NGX_HTTP_BAD_GATEWAY</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = b-&gt;end - b-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &amp;&amp; upstream-&gt;read-&gt;ready) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = upstream-&gt;recv(upstream, b-&gt;last, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;state-&gt;response_length += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;input_filter(u-&gt;input_filter_ctx, n) == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; do_write = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (downstream-&gt;data == r) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L338" title="event/ngx_event.c:338">ngx_handle_write_event</a>(downstream-&gt;write, clcf-&gt;send_lowat)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (downstream-&gt;write-&gt;active &amp;&amp; !downstream-&gt;write-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(downstream-&gt;write, clcf-&gt;send_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (downstream-&gt;write-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L428" title="event/ngx_event.h:428">ngx_del_timer</a>(downstream-&gt;write);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(upstream-&gt;read, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (upstream-&gt;read-&gt;active &amp;&amp; !upstream-&gt;read-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(upstream-&gt;read, u-&gt;conf-&gt;read_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (upstream-&gt;read-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L428" title="event/ngx_event.h:428">ngx_del_timer</a>(upstream-&gt;read);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3212">&#x200c;</a><span class="linkable">ngx_http_upstream_non_buffered_filter_init</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3219">&#x200c;</a><span class="linkable">ngx_http_upstream_non_buffered_filter</span>(<span class="Type">void</span> *data, <span class="Type">ssize_t</span> bytes)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; *r = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cl, **ll;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (cl = u-&gt;out_bufs, ll = &amp;u-&gt;out_bufs; cl; cl = cl-&gt;next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ll = &amp;cl-&gt;next;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = <a href="../core/ngx_buf.c.html#L156" title="core/ngx_buf.c:156">ngx_chain_get_free_buf</a>(r-&gt;pool, &amp;u-&gt;free_bufs);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ll = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl-&gt;buf-&gt;flush = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; cl-&gt;buf-&gt;memory = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b = &amp;u-&gt;buffer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl-&gt;buf-&gt;pos = b-&gt;last;<br/></li>
<li>&nbsp; &nbsp; b-&gt;last += bytes;<br/></li>
<li>&nbsp; &nbsp; cl-&gt;buf-&gt;last = b-&gt;last;<br/></li>
<li>&nbsp; &nbsp; cl-&gt;buf-&gt;tag = u-&gt;output.tag;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;length == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;length -= bytes;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3261">&#x200c;</a></span><span class="linkable">ngx_http_upstream_process_downstream</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *wev;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp;&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="../event/ngx_event_pipe.h.html#L17" title="event/ngx_event_pipe.h:17">ngx_event_pipe_t</a>&nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li>&nbsp; &nbsp; p = u-&gt;pipe;<br/></li>
<li>&nbsp; &nbsp; wev = c-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream process downstream&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;sending to client&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (wev-&gt;timedout) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (wev-&gt;delayed) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;timedout = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;delayed = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!wev-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(wev, p-&gt;send_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L338" title="event/ngx_event.c:338">ngx_handle_write_event</a>(wev, p-&gt;send_lowat) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_pipe.c.html#L23" title="event/ngx_event_pipe.c:23">ngx_event_pipe</a>(p, wev-&gt;write) == <a href="../core/ngx_core.h.html#L35" title="core/ngx_core.h:35">NGX_ABORT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p-&gt;downstream_error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;timedout = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1136" title="core/ngx_connection.c:1136">ngx_connection_error</a>(c, <a href="../os/unix/ngx_errno.h.html#L43" title="os/unix/ngx_errno.h:43">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;client timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (wev-&gt;delayed) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http downstream delayed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L338" title="event/ngx_event.c:338">ngx_handle_write_event</a>(wev, p-&gt;send_lowat) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_pipe.c.html#L23" title="event/ngx_event_pipe.c:23">ngx_event_pipe</a>(p, <span class="Constant">1</span>) == <a href="../core/ngx_core.h.html#L35" title="core/ngx_core.h:35">NGX_ABORT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L3399" title="http/ngx_http_upstream.c:3399">ngx_http_upstream_process_request</a>(r);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3331">&#x200c;</a></span><span class="linkable">ngx_http_upstream_process_upstream</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *rev;<br/></li>
<li>&nbsp; &nbsp; <a href="../event/ngx_event_pipe.h.html#L17" title="event/ngx_event_pipe.h:17">ngx_event_pipe_t</a>&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = u-&gt;peer.connection;<br/></li>
<li>&nbsp; &nbsp; p = u-&gt;pipe;<br/></li>
<li>&nbsp; &nbsp; rev = c-&gt;read;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream process upstream&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;reading upstream&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;timedout) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;delayed) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rev-&gt;timedout = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rev-&gt;delayed = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!rev-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(rev, p-&gt;read_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_pipe.c.html#L23" title="event/ngx_event_pipe.c:23">ngx_event_pipe</a>(p, <span class="Constant">0</span>) == <a href="../core/ngx_core.h.html#L35" title="core/ngx_core.h:35">NGX_ABORT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p-&gt;upstream_error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1136" title="core/ngx_connection.c:1136">ngx_connection_error</a>(c, <a href="../os/unix/ngx_errno.h.html#L43" title="os/unix/ngx_errno.h:43">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;upstream timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;delayed) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream delayed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_pipe.c.html#L23" title="event/ngx_event_pipe.c:23">ngx_event_pipe</a>(p, <span class="Constant">0</span>) == <a href="../core/ngx_core.h.html#L35" title="core/ngx_core.h:35">NGX_ABORT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L3399" title="http/ngx_http_upstream.c:3399">ngx_http_upstream_process_request</a>(r);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3399">&#x200c;</a></span><span class="linkable">ngx_http_upstream_process_request</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_file.h.html#L74" title="core/ngx_file.h:74">ngx_temp_file_t</a>&nbsp; &nbsp; &nbsp; *tf;<br/></li>
<li>&nbsp; &nbsp; <a href="../event/ngx_event_pipe.h.html#L17" title="event/ngx_event_pipe.h:17">ngx_event_pipe_t</a>&nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li>&nbsp; &nbsp; p = u-&gt;pipe;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.connection) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;store) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p-&gt;upstream_eof || p-&gt;upstream_done) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tf = p-&gt;temp_file;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;headers_in.status_n == <a href="ngx_http_request.h.html#L71" title="http/ngx_http_request.h:71">NGX_HTTP_OK</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (p-&gt;upstream_done || p-&gt;length == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (u-&gt;headers_in.content_length_n == -<span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || u-&gt;headers_in.content_length_n == tf-&gt;offset))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3488" title="http/ngx_http_upstream.c:3488">ngx_http_upstream_store</a>(r, u);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;cacheable) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p-&gt;upstream_done) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_file_cache.c.html#L1186" title="http/ngx_http_file_cache.c:1186">ngx_http_file_cache_update</a>(r, p-&gt;temp_file);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (p-&gt;upstream_eof) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tf = p-&gt;temp_file;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p-&gt;length == -<span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (u-&gt;headers_in.content_length_n == -<span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || u-&gt;headers_in.content_length_n<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; == tf-&gt;offset - (<span class="Type">off_t</span>) r-&gt;cache-&gt;body_start))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_file_cache.c.html#L1186" title="http/ngx_http_file_cache.c:1186">ngx_http_file_cache_update</a>(r, tf);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_file_cache.c.html#L1475" title="http/ngx_http_file_cache.c:1475">ngx_http_file_cache_free</a>(r-&gt;cache, tf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (p-&gt;upstream_error) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_file_cache.c.html#L1475" title="http/ngx_http_file_cache.c:1475">ngx_http_file_cache_free</a>(r-&gt;cache, p-&gt;temp_file);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p-&gt;upstream_done || p-&gt;upstream_eof || p-&gt;upstream_error) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream exit: </span><span class="Special">%p</span><span class="Constant">&quot;</span>, p-&gt;out);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p-&gt;upstream_done<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || (p-&gt;upstream_eof &amp;&amp; p-&gt;length == -<span class="Constant">1</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p-&gt;upstream_eof) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;upstream prematurely closed connection&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="ngx_http_request.h.html#L130" title="http/ngx_http_request.h:130">NGX_HTTP_BAD_GATEWAY</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p-&gt;downstream_error) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream downstream error&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!u-&gt;cacheable &amp;&amp; !u-&gt;store &amp;&amp; u-&gt;peer.connection) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3488">&#x200c;</a></span><span class="linkable">ngx_http_upstream_store</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; root;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lm;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; path;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_file.h.html#L74" title="core/ngx_file.h:74">ngx_temp_file_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *tf;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_file.h.html#L87" title="core/ngx_file.h:87">ngx_ext_rename_file_t</a>&nbsp;&nbsp; ext;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tf = u-&gt;pipe-&gt;temp_file;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (tf-&gt;file.fd == <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create file for empty 200 response */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tf = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="../core/ngx_file.h.html#L74" title="core/ngx_file.h:74">ngx_temp_file_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tf-&gt;file.fd = <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tf-&gt;file.log = r-&gt;connection-&gt;log;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tf-&gt;path = u-&gt;conf-&gt;temp_path;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tf-&gt;pool = r-&gt;pool;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tf-&gt;persistent = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_file.c.html#L132" title="core/ngx_file.c:132">ngx_create_temp_file</a>(&amp;tf-&gt;file, tf-&gt;path, tf-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tf-&gt;persistent, tf-&gt;clean, tf-&gt;access)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;pipe-&gt;temp_file = tf;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ext.access = u-&gt;conf-&gt;store_access;<br/></li>
<li>&nbsp; &nbsp; ext.path_access = u-&gt;conf-&gt;store_access;<br/></li>
<li>&nbsp; &nbsp; ext.time = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; ext.create_path = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; ext.delete_file = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; ext.log = r-&gt;connection-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;headers_in.last_modified) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lm = <a href="ngx_http_parse_time.c.html#L16" title="http/ngx_http_parse_time.c:16">ngx_http_parse_time</a>(u-&gt;headers_in.last_modified-&gt;value.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; u-&gt;headers_in.last_modified-&gt;value.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (lm != <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ext.time = lm;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ext.fd = tf-&gt;file.fd;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;store_lengths == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_core_module.c.html#L2018" title="http/ngx_http_core_module.c:2018">ngx_http_map_uri_to_path</a>(r, &amp;path, &amp;root, <span class="Constant">0</span>) == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_script.c.html#L486" title="http/ngx_http_script.c:486">ngx_http_script_run</a>(r, &amp;path, u-&gt;conf-&gt;store_lengths-&gt;elts, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;conf-&gt;store_values-&gt;elts)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; path.len--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;upstream stores </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> to </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tf-&gt;file.name.data, path.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="../core/ngx_file.c.html#L628" title="core/ngx_file.c:628">ngx_ext_rename_file</a>(&amp;tf-&gt;file.name, &amp;path, &amp;ext);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;store = <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3569">&#x200c;</a></span><span class="linkable">ngx_http_upstream_dummy_handler</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream dummy handler&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3577">&#x200c;</a></span><span class="linkable">ngx_http_upstream_next</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> ft_type)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>&nbsp; timeout;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; status, state;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http next upstream, </span><span class="Special">%x</span><span class="Constant">i&quot;</span>, ft_type);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.sockaddr) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ft_type == <a href="ngx_http_upstream.h.html#L27" title="http/ngx_http_upstream.h:27">NGX_HTTP_UPSTREAM_FT_HTTP_403</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || ft_type == <a href="ngx_http_upstream.h.html#L28" title="http/ngx_http_upstream.h:28">NGX_HTTP_UPSTREAM_FT_HTTP_404</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = <a href="../event/ngx_event_connect.h.html#L18" title="event/ngx_event_connect.h:18">NGX_PEER_NEXT</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = <a href="../event/ngx_event_connect.h.html#L19" title="event/ngx_event_connect.h:19">NGX_PEER_FAILED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.free(&amp;u-&gt;peer, u-&gt;peer.data, state);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.sockaddr = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ft_type == <a href="ngx_http_upstream.h.html#L21" title="http/ngx_http_upstream.h:21">NGX_HTTP_UPSTREAM_FT_TIMEOUT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <a href="../os/unix/ngx_errno.h.html#L43" title="os/unix/ngx_errno.h:43">NGX_ETIMEDOUT</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;upstream timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.cached &amp;&amp; ft_type == <a href="ngx_http_upstream.h.html#L20" title="http/ngx_http_upstream.h:20">NGX_HTTP_UPSTREAM_FT_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; status = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: inform balancer instead */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.tries++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ft_type) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_http_upstream.h.html#L21" title="http/ngx_http_upstream.h:21">NGX_HTTP_UPSTREAM_FT_TIMEOUT</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status = <a href="ngx_http_request.h.html#L132" title="http/ngx_http_request.h:132">NGX_HTTP_GATEWAY_TIME_OUT</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_http_upstream.h.html#L23" title="http/ngx_http_upstream.h:23">NGX_HTTP_UPSTREAM_FT_HTTP_500</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status = <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_http_upstream.h.html#L27" title="http/ngx_http_upstream.h:27">NGX_HTTP_UPSTREAM_FT_HTTP_403</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status = <a href="ngx_http_request.h.html#L86" title="http/ngx_http_request.h:86">NGX_HTTP_FORBIDDEN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_http_upstream.h.html#L28" title="http/ngx_http_upstream.h:28">NGX_HTTP_UPSTREAM_FT_HTTP_404</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status = <a href="ngx_http_request.h.html#L87" title="http/ngx_http_request.h:87">NGX_HTTP_NOT_FOUND</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="ngx_http_upstream.h.html#L30" title="http/ngx_http_upstream.h:30">NGX_HTTP_UPSTREAM_FT_BUSY_LOCK</a> and <a href="ngx_http_upstream.h.html#L31" title="http/ngx_http_upstream.h:31">NGX_HTTP_UPSTREAM_FT_MAX_WAITING</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * never reach here<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status = <a href="ngx_http_request.h.html#L130" title="http/ngx_http_request.h:130">NGX_HTTP_BAD_GATEWAY</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;connection-&gt;error) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_request.h.html#L125" title="http/ngx_http_request.h:125">NGX_HTTP_CLIENT_CLOSED_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (status) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;state-&gt;status = status;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timeout = u-&gt;conf-&gt;next_upstream_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.tries == <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || !(u-&gt;conf-&gt;next_upstream &amp; ft_type)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || (timeout &amp;&amp; <a href="../core/ngx_times.c.html#L26" title="core/ngx_times.c:26">ngx_current_msec</a> - u-&gt;peer.start_time &gt;= timeout))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;cache_status == <a href="ngx_http_cache.h.html#L19" title="http/ngx_http_cache.h:19">NGX_HTTP_CACHE_EXPIRED</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (u-&gt;conf-&gt;cache_use_stale &amp; ft_type))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = u-&gt;reinit_request(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cache_status = <a href="ngx_http_cache.h.html#L20" title="http/ngx_http_cache.h:20">NGX_HTTP_CACHE_STALE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L929" title="http/ngx_http_upstream.c:929">ngx_http_upstream_cache_send</a>(r, u);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, u, status);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.connection) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;close http upstream connection: </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; u-&gt;peer.connection-&gt;fd);<br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.connection-&gt;ssl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.connection-&gt;ssl-&gt;no_wait_shutdown = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.connection-&gt;ssl-&gt;no_send_shutdown = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../event/ngx_event_openssl.c.html#L1749" title="event/ngx_event_openssl.c:1749">ngx_ssl_shutdown</a>(u-&gt;peer.connection);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.connection-&gt;pool) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L45" title="core/ngx_palloc.c:45">ngx_destroy_pool</a>(u-&gt;peer.connection-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L914" title="core/ngx_connection.c:914">ngx_close_connection</a>(u-&gt;peer.connection);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.connection = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1292" title="http/ngx_http_upstream.c:1292">ngx_http_upstream_connect</a>(r, u);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3707">&#x200c;</a></span><span class="linkable">ngx_http_upstream_cleanup</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;cleanup http upstream request: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;uri);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L3719" title="http/ngx_http_upstream.c:3719">ngx_http_upstream_finalize_request</a>(r, r-&gt;upstream, <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3719">&#x200c;</a></span><span class="linkable">ngx_http_upstream_finalize_request</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a> *u, <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> rc)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp;&nbsp; flush;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_times.h.html#L20" title="core/ngx_times.h:20">ngx_time_t</a>&nbsp; *tp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;finalize http upstream request: </span><span class="Special">%i</span><span class="Constant">&quot;</span>, rc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;cleanup) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *u-&gt;cleanup = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cleanup = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;resolved &amp;&amp; u-&gt;resolved-&gt;ctx) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_resolver.c.html#L403" title="core/ngx_resolver.c:403">ngx_resolve_name_done</a>(u-&gt;resolved-&gt;ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;resolved-&gt;ctx = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;state &amp;&amp; u-&gt;state-&gt;response_sec) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tp = <a href="../core/ngx_times.h.html#L37" title="core/ngx_times.h:37">ngx_timeofday</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;state-&gt;response_sec = tp-&gt;sec - u-&gt;state-&gt;response_sec;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;state-&gt;response_msec = tp-&gt;msec - u-&gt;state-&gt;response_msec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;pipe &amp;&amp; u-&gt;pipe-&gt;read_length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;state-&gt;response_length = u-&gt;pipe-&gt;read_length;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;finalize_request(r, rc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.free &amp;&amp; u-&gt;peer.sockaddr) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.free(&amp;u-&gt;peer, u-&gt;peer.data, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.sockaddr = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.connection) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: do not shutdown persistent connection */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.connection-&gt;ssl) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * We send the &quot;close notify&quot; shutdown alert to the upstream only<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * and do not wait its &quot;close notify&quot; shutdown alert.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * It is acceptable according to the TLS standard.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.connection-&gt;ssl-&gt;no_wait_shutdown = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../event/ngx_event_openssl.c.html#L1749" title="event/ngx_event_openssl.c:1749">ngx_ssl_shutdown</a>(u-&gt;peer.connection);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;close http upstream connection: </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; u-&gt;peer.connection-&gt;fd);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.connection-&gt;pool) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L45" title="core/ngx_palloc.c:45">ngx_destroy_pool</a>(u-&gt;peer.connection-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L914" title="core/ngx_connection.c:914">ngx_close_connection</a>(u-&gt;peer.connection);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;peer.connection = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;pipe &amp;&amp; u-&gt;pipe-&gt;temp_file) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http upstream temp fd: </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; u-&gt;pipe-&gt;temp_file-&gt;file.fd);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;store &amp;&amp; u-&gt;pipe &amp;&amp; u-&gt;pipe-&gt;temp_file<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; u-&gt;pipe-&gt;temp_file-&gt;file.fd != <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L113" title="os/unix/ngx_files.h:113">ngx_delete_file</a>(u-&gt;pipe-&gt;temp_file-&gt;file.name.data)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>, r-&gt;connection-&gt;log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L114" title="os/unix/ngx_files.h:114">ngx_delete_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;pipe-&gt;temp_file-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;cache) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;cacheable) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="ngx_http_request.h.html#L130" title="http/ngx_http_request.h:130">NGX_HTTP_BAD_GATEWAY</a> || rc == <a href="ngx_http_request.h.html#L132" title="http/ngx_http_request.h:132">NGX_HTTP_GATEWAY_TIME_OUT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; valid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; valid = <a href="ngx_http_file_cache.c.html#L2007" title="http/ngx_http_file_cache.c:2007">ngx_http_file_cache_valid</a>(u-&gt;conf-&gt;cache_valid, rc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (valid) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;cache-&gt;valid_sec = <a href="../core/ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>() + valid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;cache-&gt;error = rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_file_cache.c.html#L1475" title="http/ngx_http_file_cache.c:1475">ngx_http_file_cache_free</a>(r-&gt;cache, u-&gt;pipe-&gt;temp_file);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;subrequest_in_memory<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; u-&gt;headers_in.status_n &gt;= <a href="ngx_http_request.h.html#L77" title="http/ngx_http_request.h:77">NGX_HTTP_SPECIAL_RESPONSE</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffer.last = u-&gt;buffer.pos;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;connection-&gt;log-&gt;action = <span class="Constant">&quot;sending to client&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!u-&gt;header_sent<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || rc == <a href="ngx_http_request.h.html#L89" title="http/ngx_http_request.h:89">NGX_HTTP_REQUEST_TIME_OUT</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || rc == <a href="ngx_http_request.h.html#L125" title="http/ngx_http_request.h:125">NGX_HTTP_CLIENT_CLOSED_REQUEST</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; flush = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc &gt;= <a href="ngx_http_request.h.html#L77" title="http/ngx_http_request.h:77">NGX_HTTP_SPECIAL_RESPONSE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; flush = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;header_only) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_request.c.html#L3307" title="http/ngx_http_request.c:3307">ngx_http_send_special</a>(r, <a href="ngx_http.h.html#L137" title="http/ngx_http.h:137">NGX_HTTP_LAST</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (flush) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;keepalive = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_request.c.html#L3307" title="http/ngx_http_request.c:3307">ngx_http_send_special</a>(r, <a href="ngx_http.h.html#L138" title="http/ngx_http.h:138">NGX_HTTP_FLUSH</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, rc);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3874">&#x200c;</a><span class="linkable">ngx_http_upstream_process_header_line</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; **ph;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ph = (<a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> **) ((<span class="Type">char</span> *) &amp;r-&gt;upstream-&gt;headers_in + offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*ph == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *ph = h;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3890">&#x200c;</a><span class="linkable">ngx_http_upstream_ignore_header_line</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3898">&#x200c;</a><span class="linkable">ngx_http_upstream_process_content_length</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;headers_in.content_length = h;<br/></li>
<li>&nbsp; &nbsp; u-&gt;headers_in.content_length_n = <a href="../core/ngx_string.c.html#L1000" title="core/ngx_string.c:1000">ngx_atoof</a>(h-&gt;value.data, h-&gt;value.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3913">&#x200c;</a><span class="linkable">ngx_http_upstream_process_last_modified</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;headers_in.last_modified = h;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;cacheable) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;headers_in.last_modified_time = <a href="ngx_http_parse_time.c.html#L16" title="http/ngx_http_parse_time.c:16">ngx_http_parse_time</a>(h-&gt;value.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h-&gt;value.len);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3936">&#x200c;</a><span class="linkable">ngx_http_upstream_process_set_cookie</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *pa;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; &nbsp; &nbsp; **ph;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp;&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li>&nbsp; &nbsp; pa = &amp;u-&gt;headers_in.cookies;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pa-&gt;elts == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(pa, r-&gt;pool, <span class="Constant">1</span>, <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *)) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ph = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(pa);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ph == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ph = h;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!(u-&gt;conf-&gt;ignore_headers &amp; <a href="ngx_http_upstream.h.html#L49" title="http/ngx_http_upstream.h:49">NGX_HTTP_UPSTREAM_IGN_SET_COOKIE</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3971">&#x200c;</a><span class="linkable">ngx_http_upstream_process_cache_control</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *pa;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; &nbsp;&nbsp; **ph;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li>&nbsp; &nbsp; pa = &amp;u-&gt;headers_in.cache_control;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pa-&gt;elts == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(pa, r-&gt;pool, <span class="Constant">2</span>, <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *)) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ph = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(pa);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ph == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ph = h;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp;&nbsp; *p, *start, *last;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp;&nbsp; n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;ignore_headers &amp; <a href="ngx_http_upstream.h.html#L48" title="http/ngx_http_upstream.h:48">NGX_HTTP_UPSTREAM_IGN_CACHE_CONTROL</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;cache == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;cache-&gt;valid_sec != <span class="Constant">0</span> &amp;&amp; u-&gt;headers_in.x_accel_expires != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; start = h-&gt;value.data;<br/></li>
<li>&nbsp; &nbsp; last = start + h-&gt;value.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.c.html#L717" title="core/ngx_string.c:717">ngx_strlcasestrn</a>(start, last, (u_char *) <span class="Constant">&quot;no-cache&quot;</span>, <span class="Constant">8</span> - <span class="Constant">1</span>) != <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; || <a href="../core/ngx_string.c.html#L717" title="core/ngx_string.c:717">ngx_strlcasestrn</a>(start, last, (u_char *) <span class="Constant">&quot;no-store&quot;</span>, <span class="Constant">8</span> - <span class="Constant">1</span>) != <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; || <a href="../core/ngx_string.c.html#L717" title="core/ngx_string.c:717">ngx_strlcasestrn</a>(start, last, (u_char *) <span class="Constant">&quot;private&quot;</span>, <span class="Constant">7</span> - <span class="Constant">1</span>) != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L717" title="core/ngx_string.c:717">ngx_strlcasestrn</a>(start, last, (u_char *) <span class="Constant">&quot;s-maxage=&quot;</span>, <span class="Constant">9</span> - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; offset = <span class="Constant">9</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L717" title="core/ngx_string.c:717">ngx_strlcasestrn</a>(start, last, (u_char *) <span class="Constant">&quot;max-age=&quot;</span>, <span class="Constant">8</span> - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; offset = <span class="Constant">8</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p += offset; p &lt; last; p++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == <span class="Constant">','</span> || *p == <span class="Constant">';'</span> || *p == <span class="Constant">' '</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p &gt;= <span class="Constant">'0'</span> &amp;&amp; *p &lt;= <span class="Constant">'9'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = n * <span class="Constant">10</span> + *p - <span class="Constant">'0'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;cache-&gt;valid_sec = <a href="../core/ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>() + n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4065">&#x200c;</a><span class="linkable">ngx_http_upstream_process_expires</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li>&nbsp; &nbsp; u-&gt;headers_in.<a href="modules/ngx_http_userid_filter_module.c.html#L76" title="http/modules/ngx_http_userid_filter_module.c:76">expires</a> = h;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; <a href="modules/ngx_http_userid_filter_module.c.html#L76" title="http/modules/ngx_http_userid_filter_module.c:76">expires</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;ignore_headers &amp; <a href="ngx_http_upstream.h.html#L47" title="http/ngx_http_upstream.h:47">NGX_HTTP_UPSTREAM_IGN_EXPIRES</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;cache == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;cache-&gt;valid_sec != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="modules/ngx_http_userid_filter_module.c.html#L76" title="http/modules/ngx_http_userid_filter_module.c:76">expires</a> = <a href="ngx_http_parse_time.c.html#L16" title="http/ngx_http_parse_time.c:16">ngx_http_parse_time</a>(h-&gt;value.data, h-&gt;value.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="modules/ngx_http_userid_filter_module.c.html#L76" title="http/modules/ngx_http_userid_filter_module.c:76">expires</a> == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a> || <a href="modules/ngx_http_userid_filter_module.c.html#L76" title="http/modules/ngx_http_userid_filter_module.c:76">expires</a> &lt; <a href="../core/ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;cache-&gt;valid_sec = <a href="modules/ngx_http_userid_filter_module.c.html#L76" title="http/modules/ngx_http_userid_filter_module.c:76">expires</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4105">&#x200c;</a><span class="linkable">ngx_http_upstream_process_accel_expires</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li>&nbsp; &nbsp; u-&gt;headers_in.x_accel_expires = h;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp;&nbsp; n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;ignore_headers &amp; <a href="ngx_http_upstream.h.html#L46" title="http/ngx_http_upstream.h:46">NGX_HTTP_UPSTREAM_IGN_XA_EXPIRES</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;cache == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = h-&gt;value.len;<br/></li>
<li>&nbsp; &nbsp; p = h-&gt;value.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p[<span class="Constant">0</span>] != <span class="Constant">'@'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../core/ngx_string.c.html#L898" title="core/ngx_string.c:898">ngx_atoi</a>(p, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">0</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* fall through */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;cache-&gt;valid_sec = <a href="../core/ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>() + n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p++;<br/></li>
<li>&nbsp; &nbsp; len--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = <a href="../core/ngx_string.c.html#L898" title="core/ngx_string.c:898">ngx_atoi</a>(p, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n != <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;cache-&gt;valid_sec = n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4163">&#x200c;</a><span class="linkable">ngx_http_upstream_process_limit_rate</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li>&nbsp; &nbsp; u-&gt;headers_in.x_accel_limit_rate = h;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;ignore_headers &amp; <a href="ngx_http_upstream.h.html#L50" title="http/ngx_http_upstream.h:50">NGX_HTTP_UPSTREAM_IGN_XA_LIMIT_RATE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = <a href="../core/ngx_string.c.html#L898" title="core/ngx_string.c:898">ngx_atoi</a>(h-&gt;value.data, h-&gt;value.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n != <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;limit_rate = (<span class="Type">size_t</span>) n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4187">&#x200c;</a><span class="linkable">ngx_http_upstream_process_buffering</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c0, c1, c2;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;ignore_headers &amp; <a href="ngx_http_upstream.h.html#L51" title="http/ngx_http_upstream.h:51">NGX_HTTP_UPSTREAM_IGN_XA_BUFFERING</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;change_buffering) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (h-&gt;value.len == <span class="Constant">2</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c0 = <a href="../core/ngx_string.h.html#L47" title="core/ngx_string.h:47">ngx_tolower</a>(h-&gt;value.data[<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c1 = <a href="../core/ngx_string.h.html#L47" title="core/ngx_string.h:47">ngx_tolower</a>(h-&gt;value.data[<span class="Constant">1</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c0 == <span class="Constant">'n'</span> &amp;&amp; c1 == <span class="Constant">'o'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffering = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (h-&gt;value.len == <span class="Constant">3</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c0 = <a href="../core/ngx_string.h.html#L47" title="core/ngx_string.h:47">ngx_tolower</a>(h-&gt;value.data[<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c1 = <a href="../core/ngx_string.h.html#L47" title="core/ngx_string.h:47">ngx_tolower</a>(h-&gt;value.data[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c2 = <a href="../core/ngx_string.h.html#L47" title="core/ngx_string.h:47">ngx_tolower</a>(h-&gt;value.data[<span class="Constant">2</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c0 == <span class="Constant">'y'</span> &amp;&amp; c1 == <span class="Constant">'e'</span> &amp;&amp; c2 == <span class="Constant">'s'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;buffering = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4225">&#x200c;</a><span class="linkable">ngx_http_upstream_process_charset</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream-&gt;conf-&gt;ignore_headers &amp; <a href="ngx_http_upstream.h.html#L52" title="http/ngx_http_upstream.h:52">NGX_HTTP_UPSTREAM_IGN_XA_CHARSET</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.override_charset = &amp;h-&gt;value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4239">&#x200c;</a><span class="linkable">ngx_http_upstream_process_connection</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; r-&gt;upstream-&gt;headers_in.connection = h;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.c.html#L717" title="core/ngx_string.c:717">ngx_strlcasestrn</a>(h-&gt;value.data, h-&gt;value.data + h-&gt;value.len,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (u_char *) <span class="Constant">&quot;close&quot;</span>, <span class="Constant">5</span> - <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;upstream-&gt;headers_in.connection_close = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4256">&#x200c;</a><span class="linkable">ngx_http_upstream_process_transfer_encoding</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; r-&gt;upstream-&gt;headers_in.transfer_encoding = h;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.c.html#L717" title="core/ngx_string.c:717">ngx_strlcasestrn</a>(h-&gt;value.data, h-&gt;value.data + h-&gt;value.len,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (u_char *) <span class="Constant">&quot;chunked&quot;</span>, <span class="Constant">7</span> - <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;upstream-&gt;headers_in.chunked = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4273">&#x200c;</a><span class="linkable">ngx_http_upstream_process_vary</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = r-&gt;upstream;<br/></li>
<li>&nbsp; &nbsp; u-&gt;headers_in.vary = h;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;conf-&gt;ignore_headers &amp; <a href="ngx_http_upstream.h.html#L53" title="http/ngx_http_upstream.h:53">NGX_HTTP_UPSTREAM_IGN_VARY</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;cache == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h-&gt;value.len &gt; <a href="ngx_http_cache.h.html#L28" title="http/ngx_http_cache.h:28">NGX_HTTP_CACHE_VARY_LEN</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || (h-&gt;value.len == <span class="Constant">1</span> &amp;&amp; h-&gt;value.data[<span class="Constant">0</span>] == <span class="Constant">'*'</span>))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;cache-&gt;vary = h-&gt;value;<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4306">&#x200c;</a><span class="linkable">ngx_http_upstream_copy_header_line</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; *ho, **ph;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ho = <a href="../core/ngx_list.c.html#L31" title="core/ngx_list.c:31">ngx_list_push</a>(&amp;r-&gt;headers_out.headers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ho == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ho = *h;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (offset) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ph = (<a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> **) ((<span class="Type">char</span> *) &amp;r-&gt;headers_out + offset);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *ph = ho;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4328">&#x200c;</a><span class="linkable">ngx_http_upstream_copy_multi_header_lines</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; *pa;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; *ho, **ph;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pa = (<a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> *) ((<span class="Type">char</span> *) &amp;r-&gt;headers_out + offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pa-&gt;elts == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(pa, r-&gt;pool, <span class="Constant">2</span>, <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *)) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ph = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(pa);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ph == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ho = <a href="../core/ngx_list.c.html#L31" title="core/ngx_list.c:31">ngx_list_push</a>(&amp;r-&gt;headers_out.headers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ho == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ho = *h;<br/></li>
<li>&nbsp; &nbsp; *ph = ho;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4361">&#x200c;</a><span class="linkable">ngx_http_upstream_copy_content_type</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; *p, *last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.content_type_len = h-&gt;value.len;<br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.content_type = h-&gt;value;<br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.content_type_lowcase = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = h-&gt;value.data; *p; p++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p != <span class="Constant">';'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (*++p == <span class="Constant">' '</span>) { <span class="Comment">/* void */</span> }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == <span class="Special">'\0'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.c.html#L593" title="core/ngx_string.c:593">ngx_strncasecmp</a>(p, (u_char *) <span class="Constant">&quot;charset=&quot;</span>, <span class="Constant">8</span>) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p += <span class="Constant">8</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_type_len = last - h-&gt;value.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == <span class="Constant">'&quot;'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = h-&gt;value.data + h-&gt;value.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*(last - <span class="Constant">1</span>) == <span class="Constant">'&quot;'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.charset.len = last - p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.charset.data = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4413">&#x200c;</a><span class="linkable">ngx_http_upstream_copy_last_modified</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; *ho;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ho = <a href="../core/ngx_list.c.html#L31" title="core/ngx_list.c:31">ngx_list_push</a>(&amp;r-&gt;headers_out.headers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ho == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ho = *h;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.last_modified = ho;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream-&gt;cacheable) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.last_modified_time =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;upstream-&gt;headers_in.last_modified_time;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4441">&#x200c;</a><span class="linkable">ngx_http_upstream_rewrite_location</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; *ho;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ho = <a href="../core/ngx_list.c.html#L31" title="core/ngx_list.c:31">ngx_list_push</a>(&amp;r-&gt;headers_out.headers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ho == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ho = *h;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream-&gt;rewrite_redirect) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = r-&gt;upstream-&gt;rewrite_redirect(r, ho, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.location = ho;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;rewritten location: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;ho-&gt;value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ho-&gt;value.data[<span class="Constant">0</span>] != <span class="Constant">'/'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.location = ho;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * we do not <a href="../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> r-&gt;headers_out.location here to avoid the handling<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the local redirects without a host name by <a href="ngx_http_header_filter_module.c.html#L151" title="http/ngx_http_header_filter_module.c:151">ngx_http_header_filter</a>()<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4485">&#x200c;</a><span class="linkable">ngx_http_upstream_rewrite_refresh</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; *ho;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ho = <a href="../core/ngx_list.c.html#L31" title="core/ngx_list.c:31">ngx_list_push</a>(&amp;r-&gt;headers_out.headers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ho == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ho = *h;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream-&gt;rewrite_redirect) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L685" title="core/ngx_string.c:685">ngx_strcasestrn</a>(ho-&gt;value.data, <span class="Constant">&quot;url=&quot;</span>, <span class="Constant">4</span> - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = r-&gt;upstream-&gt;rewrite_redirect(r, ho, p + <span class="Constant">4</span> - ho-&gt;value.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.refresh = ho;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;rewritten refresh: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;ho-&gt;value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.refresh = ho;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4531">&#x200c;</a><span class="linkable">ngx_http_upstream_rewrite_set_cookie</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; *ho;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ho = <a href="../core/ngx_list.c.html#L31" title="core/ngx_list.c:31">ngx_list_push</a>(&amp;r-&gt;headers_out.headers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ho == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ho = *h;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream-&gt;rewrite_cookie) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = r-&gt;upstream-&gt;rewrite_cookie(r, ho);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;rewritten cookie: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;ho-&gt;value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4566">&#x200c;</a><span class="linkable">ngx_http_upstream_copy_allow_ranges</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; *ho;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream-&gt;conf-&gt;force_ranges) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;cached) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;allow_ranges = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream-&gt;cacheable) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;allow_ranges = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;single_range = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ho = <a href="../core/ngx_list.c.html#L31" title="core/ngx_list.c:31">ngx_list_push</a>(&amp;r-&gt;headers_out.headers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ho == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ho = *h;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.accept_ranges = ho;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_GZIP)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4606">&#x200c;</a><span class="linkable">ngx_http_upstream_copy_content_encoding</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; *ho;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ho = <a href="../core/ngx_list.c.html#L31" title="core/ngx_list.c:31">ngx_list_push</a>(&amp;r-&gt;headers_out.headers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ho == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ho = *h;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.content_encoding = ho;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4627">&#x200c;</a><span class="linkable">ngx_http_upstream_add_variables</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L21" title="http/ngx_http_variables.h:21">ngx_http_variable_t</a>&nbsp; *var, *v;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (v = <a href="#L352" title="http/ngx_http_upstream.c:352">ngx_http_upstream_vars</a>; v-&gt;name.len; v++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; var = <a href="ngx_http_variables.c.html#L359" title="http/ngx_http_variables.c:359">ngx_http_add_variable</a>(cf, &amp;v-&gt;name, v-&gt;flags);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (var == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; var-&gt;get_handler = v-&gt;get_handler;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; var-&gt;data = v-&gt;data;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4646">&#x200c;</a><span class="linkable">ngx_http_upstream_addr_variable</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L66" title="http/ngx_http_upstream.h:66">ngx_http_upstream_state_t</a>&nbsp; *state;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;valid = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;no_cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream_states == <span class="Constant">NULL</span> || r-&gt;upstream_states-&gt;nelts == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; state = r-&gt;upstream_states-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; r-&gt;upstream_states-&gt;nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (state[i].peer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len += state[i].peer-&gt;len + <span class="Constant">2</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len += <span class="Constant">3</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(r-&gt;pool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;data = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (state[i].peer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(p, state[i].peer-&gt;data, state[i].peer-&gt;len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++i == r-&gt;upstream_states-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (state[i].peer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">','</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">' '</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">' '</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">':'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">' '</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++i == r-&gt;upstream_states-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;len = p - v-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4717">&#x200c;</a><span class="linkable">ngx_http_upstream_status_variable</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L66" title="http/ngx_http_upstream.h:66">ngx_http_upstream_state_t</a>&nbsp; *state;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;valid = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;no_cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream_states == <span class="Constant">NULL</span> || r-&gt;upstream_states-&gt;nelts == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = r-&gt;upstream_states-&gt;nelts * (<span class="Constant">3</span> + <span class="Constant">2</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(r-&gt;pool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;data = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; state = r-&gt;upstream_states-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (state[i].status) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(p, <span class="Constant">&quot;</span><span class="Special">%u</span><span class="Constant">i&quot;</span>, state[i].status);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">'-'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++i == r-&gt;upstream_states-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (state[i].peer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">','</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">' '</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">' '</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">':'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">' '</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++i == r-&gt;upstream_states-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;len = p - v-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4782">&#x200c;</a><span class="linkable">ngx_http_upstream_response_time_variable</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_time.h.html#L17" title="os/unix/ngx_time.h:17">ngx_msec_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ms;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L66" title="http/ngx_http_upstream.h:66">ngx_http_upstream_state_t</a>&nbsp; *state;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;valid = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;no_cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream_states == <span class="Constant">NULL</span> || r-&gt;upstream_states-&gt;nelts == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = r-&gt;upstream_states-&gt;nelts * (NGX_TIME_T_LEN + <span class="Constant">4</span> + <span class="Constant">2</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(r-&gt;pool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;data = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; state = r-&gt;upstream_states-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (state[i].status) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ms = (<a href="../os/unix/ngx_time.h.html#L17" title="os/unix/ngx_time.h:17">ngx_msec_int_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (state[i].response_sec * <span class="Constant">1000</span> + state[i].response_msec);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ms = <a href="../core/ngx_core.h.html#L90" title="core/ngx_core.h:90">ngx_max</a>(ms, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(p, <span class="Constant">&quot;%T.%03M&quot;</span>, (<span class="Type">time_t</span>) ms / <span class="Constant">1000</span>, ms % <span class="Constant">1000</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">'-'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++i == r-&gt;upstream_states-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (state[i].peer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">','</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">' '</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">' '</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">':'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">' '</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++i == r-&gt;upstream_states-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;len = p - v-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4851">&#x200c;</a><span class="linkable">ngx_http_upstream_response_length_variable</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L66" title="http/ngx_http_upstream.h:66">ngx_http_upstream_state_t</a>&nbsp; *state;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;valid = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;no_cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream_states == <span class="Constant">NULL</span> || r-&gt;upstream_states-&gt;nelts == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = r-&gt;upstream_states-&gt;nelts * (NGX_OFF_T_LEN + <span class="Constant">2</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(r-&gt;pool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;data = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; state = r-&gt;upstream_states-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(p, <span class="Constant">&quot;</span><span class="Special">%O</span><span class="Constant">&quot;</span>, state[i].response_length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++i == r-&gt;upstream_states-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (state[i].peer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">','</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">' '</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">' '</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">':'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">' '</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++i == r-&gt;upstream_states-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;len = p - v-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4911">&#x200c;</a><span class="linkable">ngx_http_upstream_header_variable</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_variables.c.html#L867" title="http/ngx_http_variables.c:867">ngx_http_variable_unknown_header</a>(v, (<a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *) data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;r-&gt;upstream-&gt;headers_in.headers.part,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<span class="Constant">&quot;upstream_http_&quot;</span>) - <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4926">&#x200c;</a><span class="linkable">ngx_http_upstream_cookie_variable</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; *name = (<a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *) data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp;&nbsp; cookie, s;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s.len = name-&gt;len - (<span class="Statement">sizeof</span>(<span class="Constant">&quot;upstream_cookie_&quot;</span>) - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; s.data = name-&gt;data + <span class="Statement">sizeof</span>(<span class="Constant">&quot;upstream_cookie_&quot;</span>) - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_parse.c.html#L1988" title="http/ngx_http_parse.c:1988">ngx_http_parse_set_cookie_lines</a>(&amp;r-&gt;upstream-&gt;headers_in.cookies,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;s, &amp;cookie)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; == <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;len = cookie.len;<br/></li>
<li>&nbsp; &nbsp; v-&gt;valid = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;no_cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;data = cookie.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4962">&#x200c;</a><span class="linkable">ngx_http_upstream_cache_status</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream == <span class="Constant">NULL</span> || r-&gt;upstream-&gt;cache_status == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = r-&gt;upstream-&gt;cache_status - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;valid = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;no_cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;len = <a href="ngx_http_file_cache.c.html#L58" title="http/ngx_http_file_cache.c:58">ngx_http_cache_status</a>[n].len;<br/></li>
<li>&nbsp; &nbsp; v-&gt;data = <a href="ngx_http_file_cache.c.html#L58" title="http/ngx_http_file_cache.c:58">ngx_http_cache_status</a>[n].data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4985">&#x200c;</a><span class="linkable">ngx_http_upstream_cache_last_modified</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; || !r-&gt;upstream-&gt;conf-&gt;cache_revalidate<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || r-&gt;upstream-&gt;cache_status != <a href="ngx_http_cache.h.html#L19" title="http/ngx_http_cache.h:19">NGX_HTTP_CACHE_EXPIRED</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || r-&gt;cache-&gt;last_modified == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<span class="Constant">&quot;Mon, 28 Sep 1970 06:00:00 GMT&quot;</span>) - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;len = <a href="../core/ngx_times.c.html#L255" title="core/ngx_times.c:255">ngx_http_time</a>(p, r-&gt;cache-&gt;last_modified) - p;<br/></li>
<li>&nbsp; &nbsp; v-&gt;valid = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;no_cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;data = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L5015">&#x200c;</a><span class="linkable">ngx_http_upstream_cache_etag</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;upstream == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; || !r-&gt;upstream-&gt;conf-&gt;cache_revalidate<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || r-&gt;upstream-&gt;cache_status != <a href="ngx_http_cache.h.html#L19" title="http/ngx_http_cache.h:19">NGX_HTTP_CACHE_EXPIRED</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || r-&gt;cache-&gt;etag.len == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;valid = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;no_cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;len = r-&gt;cache-&gt;etag.len;<br/></li>
<li>&nbsp; &nbsp; v-&gt;data = r-&gt;cache-&gt;etag.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L5040">&#x200c;</a><span class="linkable">ngx_http_upstream</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *dummy)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *rv;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *mconf;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_inet.h.html#L102" title="core/ngx_inet.h:102">ngx_url_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; m;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_config.h.html#L36" title="http/ngx_http_config.h:36">ngx_http_module_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *module;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_config.h.html#L21" title="http/ngx_http_config.h:21">ngx_http_conf_ctx_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ctx, *http_ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L75" title="http/ngx_http_upstream.h:75">ngx_http_upstream_srv_conf_t</a>&nbsp; *uscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;u, <span class="Statement">sizeof</span>(<a href="../core/ngx_inet.h.html#L102" title="core/ngx_inet.h:102">ngx_url_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; u.host = value[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u.no_resolve = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; u.no_port = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; uscf = <a href="#L5295" title="http/ngx_http_upstream.c:5295">ngx_http_upstream_add</a>(cf, &amp;u, <a href="ngx_http_upstream.h.html#L103" title="http/ngx_http_upstream.h:103">NGX_HTTP_UPSTREAM_CREATE</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; |<a href="ngx_http_upstream.h.html#L104" title="http/ngx_http_upstream.h:104">NGX_HTTP_UPSTREAM_WEIGHT</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; |<a href="ngx_http_upstream.h.html#L105" title="http/ngx_http_upstream.h:105">NGX_HTTP_UPSTREAM_MAX_FAILS</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; |<a href="ngx_http_upstream.h.html#L106" title="http/ngx_http_upstream.h:106">NGX_HTTP_UPSTREAM_FAIL_TIMEOUT</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; |<a href="ngx_http_upstream.h.html#L107" title="http/ngx_http_upstream.h:107">NGX_HTTP_UPSTREAM_DOWN</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; |<a href="ngx_http_upstream.h.html#L108" title="http/ngx_http_upstream.h:108">NGX_HTTP_UPSTREAM_BACKUP</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (uscf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_config.h.html#L21" title="http/ngx_http_config.h:21">ngx_http_conf_ctx_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; http_ctx = cf-&gt;ctx;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;main_conf = http_ctx-&gt;main_conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* the upstream{}'s srv_conf */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;srv_conf = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<span class="Type">void</span> *) * <a href="ngx_http.c.html#L69" title="http/ngx_http.c:69">ngx_http_max_module</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;srv_conf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;srv_conf[<a href="#L336" title="http/ngx_http_upstream.c:336">ngx_http_upstream_module</a>.ctx_index] = uscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; uscf-&gt;srv_conf = ctx-&gt;srv_conf;<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* the upstream{}'s loc_conf */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;loc_conf = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<span class="Type">void</span> *) * <a href="ngx_http.c.html#L69" title="http/ngx_http.c:69">ngx_http_max_module</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;loc_conf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (m = <span class="Constant">0</span>; ngx_modules[m]; m++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ngx_modules[m]-&gt;type != <a href="ngx_http_config.h.html#L39" title="http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; module = ngx_modules[m]-&gt;ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (module-&gt;create_srv_conf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mconf = module-&gt;create_srv_conf(cf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (mconf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;srv_conf[ngx_modules[m]-&gt;ctx_index] = mconf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (module-&gt;create_loc_conf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mconf = module-&gt;create_loc_conf(cf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (mconf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;loc_conf[ngx_modules[m]-&gt;ctx_index] = mconf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; uscf-&gt;servers = <a href="../core/ngx_array.c.html#L13" title="core/ngx_array.c:13">ngx_array_create</a>(cf-&gt;pool, <span class="Constant">4</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_upstream.h.html#L100" title="http/ngx_http_upstream.h:100">ngx_http_upstream_server_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (uscf-&gt;servers == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* parse inside upstream{} */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; pcf = *cf;<br/></li>
<li>&nbsp; &nbsp; cf-&gt;ctx = ctx;<br/></li>
<li>&nbsp; &nbsp; cf-&gt;cmd_type = <a href="ngx_http_config.h.html#L44" title="http/ngx_http_config.h:44">NGX_HTTP_UPS_CONF</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rv = <a href="../core/ngx_conf_file.c.html#L101" title="core/ngx_conf_file.c:101">ngx_conf_parse</a>(cf, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *cf = pcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rv != <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rv;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (uscf-&gt;servers-&gt;nelts == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;no servers are inside upstream&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rv;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L5155">&#x200c;</a><span class="linkable">ngx_http_upstream_server</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L75" title="http/ngx_http_upstream.h:75">ngx_http_upstream_srv_conf_t</a>&nbsp; *uscf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; fail_timeout;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *value, s;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_inet.h.html#L102" title="core/ngx_inet.h:102">ngx_url_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; weight, max_fails;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L100" title="http/ngx_http_upstream.h:100">ngx_http_upstream_server_t</a>&nbsp; *us;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; us = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(uscf-&gt;servers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (us == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(us, <span class="Statement">sizeof</span>(<a href="ngx_http_upstream.h.html#L100" title="http/ngx_http_upstream.h:100">ngx_http_upstream_server_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; weight = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; max_fails = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; fail_timeout = <span class="Constant">10</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">2</span>; i &lt; cf-&gt;args-&gt;nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;weight=&quot;</span>, <span class="Constant">7</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(uscf-&gt;flags &amp; <a href="ngx_http_upstream.h.html#L104" title="http/ngx_http_upstream.h:104">NGX_HTTP_UPSTREAM_WEIGHT</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> not_supported;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; weight = <a href="../core/ngx_string.c.html#L898" title="core/ngx_string.c:898">ngx_atoi</a>(&amp;value[i].data[<span class="Constant">7</span>], value[i].len - <span class="Constant">7</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (weight == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a> || weight == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;max_fails=&quot;</span>, <span class="Constant">10</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(uscf-&gt;flags &amp; <a href="ngx_http_upstream.h.html#L105" title="http/ngx_http_upstream.h:105">NGX_HTTP_UPSTREAM_MAX_FAILS</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> not_supported;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; max_fails = <a href="../core/ngx_string.c.html#L898" title="core/ngx_string.c:898">ngx_atoi</a>(&amp;value[i].data[<span class="Constant">10</span>], value[i].len - <span class="Constant">10</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (max_fails == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;fail_timeout=&quot;</span>, <span class="Constant">13</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(uscf-&gt;flags &amp; <a href="ngx_http_upstream.h.html#L106" title="http/ngx_http_upstream.h:106">NGX_HTTP_UPSTREAM_FAIL_TIMEOUT</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> not_supported;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.len = value[i].len - <span class="Constant">13</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.data = &amp;value[i].data[<span class="Constant">13</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fail_timeout = <a href="../core/ngx_parse.c.html#L97" title="core/ngx_parse.c:97">ngx_parse_time</a>(&amp;s, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fail_timeout == (<span class="Type">time_t</span>) <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[i].data, <span class="Constant">&quot;backup&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(uscf-&gt;flags &amp; <a href="ngx_http_upstream.h.html#L108" title="http/ngx_http_upstream.h:108">NGX_HTTP_UPSTREAM_BACKUP</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> not_supported;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; us-&gt;backup = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[i].data, <span class="Constant">&quot;down&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(uscf-&gt;flags &amp; <a href="ngx_http_upstream.h.html#L107" title="http/ngx_http_upstream.h:107">NGX_HTTP_UPSTREAM_DOWN</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> not_supported;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; us-&gt;down = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;u, <span class="Statement">sizeof</span>(<a href="../core/ngx_inet.h.html#L102" title="core/ngx_inet.h:102">ngx_url_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u.url = value[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u.default_port = <span class="Constant">80</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_inet.c.html#L525" title="core/ngx_inet.c:525">ngx_parse_url</a>(cf-&gt;pool, &amp;u) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u.err) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant"> in upstream </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, u.err, &amp;u.url);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; us-&gt;name = u.url;<br/></li>
<li>&nbsp; &nbsp; us-&gt;addrs = u.addrs;<br/></li>
<li>&nbsp; &nbsp; us-&gt;naddrs = u.naddrs;<br/></li>
<li>&nbsp; &nbsp; us-&gt;weight = weight;<br/></li>
<li>&nbsp; &nbsp; us-&gt;max_fails = max_fails;<br/></li>
<li>&nbsp; &nbsp; us-&gt;fail_timeout = fail_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">invalid</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid parameter </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">not_supported</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;balancing method does not support parameter </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;value[i]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="ngx_http_upstream.h.html#L75" title="http/ngx_http_upstream.h:75">ngx_http_upstream_srv_conf_t</a> *<br/></li>
<li><a id="L5295">&#x200c;</a><span class="linkable">ngx_http_upstream_add</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_inet.h.html#L102" title="core/ngx_inet.h:102">ngx_url_t</a> *u, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> flags)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L100" title="http/ngx_http_upstream.h:100">ngx_http_upstream_server_t</a>&nbsp; &nbsp;&nbsp; *us;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L75" title="http/ngx_http_upstream.h:75">ngx_http_upstream_srv_conf_t</a>&nbsp;&nbsp; *uscf, **uscfp;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L73" title="http/ngx_http_upstream.h:73">ngx_http_upstream_main_conf_t</a>&nbsp; *umcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!(flags &amp; <a href="ngx_http_upstream.h.html#L103" title="http/ngx_http_upstream.h:103">NGX_HTTP_UPSTREAM_CREATE</a>)) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_inet.c.html#L525" title="core/ngx_inet.c:525">ngx_parse_url</a>(cf-&gt;pool, u) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;err) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant"> in upstream </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, u-&gt;err, &amp;u-&gt;url);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; umcf = <a href="ngx_http_config.h.html#L61" title="http/ngx_http_config.h:61">ngx_http_conf_get_module_main_conf</a>(cf, <a href="#L336" title="http/ngx_http_upstream.c:336">ngx_http_upstream_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; uscfp = umcf-&gt;upstreams.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; umcf-&gt;upstreams.nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (uscfp[i]-&gt;host.len != u-&gt;host.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || <a href="../core/ngx_string.c.html#L593" title="core/ngx_string.c:593">ngx_strncasecmp</a>(uscfp[i]-&gt;host.data, u-&gt;host.data, u-&gt;host.len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((flags &amp; <a href="ngx_http_upstream.h.html#L103" title="http/ngx_http_upstream.h:103">NGX_HTTP_UPSTREAM_CREATE</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;&amp; (uscfp[i]-&gt;flags &amp; <a href="ngx_http_upstream.h.html#L103" title="http/ngx_http_upstream.h:103">NGX_HTTP_UPSTREAM_CREATE</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;duplicate upstream </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;u-&gt;host);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((uscfp[i]-&gt;flags &amp; <a href="ngx_http_upstream.h.html#L103" title="http/ngx_http_upstream.h:103">NGX_HTTP_UPSTREAM_CREATE</a>) &amp;&amp; !u-&gt;no_port) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;upstream </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> may not have port </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;u-&gt;host, u-&gt;port);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((flags &amp; <a href="ngx_http_upstream.h.html#L103" title="http/ngx_http_upstream.h:103">NGX_HTTP_UPSTREAM_CREATE</a>) &amp;&amp; !uscfp[i]-&gt;no_port) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;upstream </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> may not have port </span><span class="Special">%d</span><span class="Constant"> in </span><span class="Special">%s</span><span class="Constant">:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;u-&gt;host, uscfp[i]-&gt;port,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uscfp[i]-&gt;file_name, uscfp[i]-&gt;line);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (uscfp[i]-&gt;port &amp;&amp; u-&gt;port<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; uscfp[i]-&gt;port != u-&gt;port)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (uscfp[i]-&gt;default_port &amp;&amp; u-&gt;default_port<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; uscfp[i]-&gt;default_port != u-&gt;default_port)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (flags &amp; <a href="ngx_http_upstream.h.html#L103" title="http/ngx_http_upstream.h:103">NGX_HTTP_UPSTREAM_CREATE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uscfp[i]-&gt;flags = flags;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> uscfp[i];<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; uscf = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_upstream.h.html#L75" title="http/ngx_http_upstream.h:75">ngx_http_upstream_srv_conf_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (uscf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; uscf-&gt;flags = flags;<br/></li>
<li>&nbsp; &nbsp; uscf-&gt;host = u-&gt;host;<br/></li>
<li>&nbsp; &nbsp; uscf-&gt;file_name = cf-&gt;conf_file-&gt;file.name.data;<br/></li>
<li>&nbsp; &nbsp; uscf-&gt;line = cf-&gt;conf_file-&gt;line;<br/></li>
<li>&nbsp; &nbsp; uscf-&gt;port = u-&gt;port;<br/></li>
<li>&nbsp; &nbsp; uscf-&gt;default_port = u-&gt;default_port;<br/></li>
<li>&nbsp; &nbsp; uscf-&gt;no_port = u-&gt;no_port;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;naddrs == <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uscf-&gt;servers = <a href="../core/ngx_array.c.html#L13" title="core/ngx_array.c:13">ngx_array_create</a>(cf-&gt;pool, <span class="Constant">1</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_upstream.h.html#L100" title="http/ngx_http_upstream.h:100">ngx_http_upstream_server_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (uscf-&gt;servers == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; us = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(uscf-&gt;servers);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (us == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(us, <span class="Statement">sizeof</span>(<a href="ngx_http_upstream.h.html#L100" title="http/ngx_http_upstream.h:100">ngx_http_upstream_server_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; us-&gt;addrs = u-&gt;addrs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; us-&gt;naddrs = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; uscfp = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(&amp;umcf-&gt;upstreams);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (uscfp == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *uscfp = uscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> uscf;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">char</span> *<br/></li>
<li><a id="L5412">&#x200c;</a><span class="linkable">ngx_http_upstream_bind_set_slot</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; *p = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_script.h.html#L71" title="http/ngx_http_script.h:71">ngx_http_complex_value_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cv;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L130" title="http/ngx_http_upstream.h:130">ngx_http_upstream_local_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; **plocal, *local;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_script.h.html#L82" title="http/ngx_http_script.h:82">ngx_http_compile_complex_value_t</a>&nbsp; &nbsp; ccv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; plocal = (<a href="ngx_http_upstream.h.html#L130" title="http/ngx_http_upstream.h:130">ngx_http_upstream_local_t</a> **) (p + cmd-&gt;offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*plocal != <a href="../core/ngx_conf_file.h.html#L59" title="core/ngx_conf_file.h:59">NGX_CONF_UNSET_PTR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;is duplicate&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">1</span>].data, <span class="Constant">&quot;off&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *plocal = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;ccv, <span class="Statement">sizeof</span>(<a href="ngx_http_script.h.html#L82" title="http/ngx_http_script.h:82">ngx_http_compile_complex_value_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ccv.cf = cf;<br/></li>
<li>&nbsp; &nbsp; ccv.value = &amp;value[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; ccv.complex_value = &amp;cv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_script.c.html#L108" title="http/ngx_http_script.c:108">ngx_http_compile_complex_value</a>(&amp;ccv) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; local = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_upstream.h.html#L130" title="http/ngx_http_upstream.h:130">ngx_http_upstream_local_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (local == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *plocal = local;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cv.lengths) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; local-&gt;value = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_script.h.html#L71" title="http/ngx_http_script.h:71">ngx_http_complex_value_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (local-&gt;value == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *local-&gt;value = cv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; local-&gt;addr = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="../core/ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (local-&gt;addr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../core/ngx_inet.c.html#L465" title="core/ngx_inet.c:465">ngx_parse_addr</a>(cf-&gt;pool, local-&gt;addr, value[<span class="Constant">1</span>].data, value[<span class="Constant">1</span>].len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (rc) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; local-&gt;addr-&gt;name = value[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid address </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* fall through */<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a> *<br/></li>
<li><a id="L5488">&#x200c;</a><span class="linkable">ngx_http_upstream_get_local</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L130" title="http/ngx_http_upstream.h:130">ngx_http_upstream_local_t</a> *local)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; val;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a>&nbsp; *addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (local == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (local-&gt;value == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> local-&gt;addr;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_script.c.html#L58" title="http/ngx_http_script.c:58">ngx_http_complex_value</a>(r, local-&gt;value, &amp;val) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (val.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; addr = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="../core/ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (addr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../core/ngx_inet.c.html#L465" title="core/ngx_inet.c:465">ngx_parse_addr</a>(r-&gt;pool, addr, val.data, val.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (rc) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr-&gt;name = val;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;invalid local address </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* fall through */<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">char</span> *<br/></li>
<li><a id="L5535">&#x200c;</a><span class="linkable">ngx_http_upstream_param_set_slot</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; *p = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; **a;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L380" title="http/ngx_http_upstream.h:380">ngx_http_upstream_param_t</a>&nbsp;&nbsp; *param;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; a = (<a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> **) (p + cmd-&gt;offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*a == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *a = <a href="../core/ngx_array.c.html#L13" title="core/ngx_array.c:13">ngx_array_create</a>(cf-&gt;pool, <span class="Constant">4</span>, <span class="Statement">sizeof</span>(<a href="ngx_http_upstream.h.html#L380" title="http/ngx_http_upstream.h:380">ngx_http_upstream_param_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*a == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; param = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(*a);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (param == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; param-&gt;key = value[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; param-&gt;value = value[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; param-&gt;skip_empty = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cf-&gt;args-&gt;nelts == <span class="Constant">4</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">3</span>].data, <span class="Constant">&quot;if_not_empty&quot;</span>) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid parameter </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">3</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; param-&gt;skip_empty = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L5579">&#x200c;</a><span class="linkable">ngx_http_upstream_hide_headers_hash</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L216" title="http/ngx_http_upstream.h:216">ngx_http_upstream_conf_t</a> *conf, <a href="ngx_http_upstream.h.html#L216" title="http/ngx_http_upstream.h:216">ngx_http_upstream_conf_t</a> *prev,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *default_hide_headers, <a href="../core/ngx_hash.h.html#L62" title="core/ngx_hash.h:62">ngx_hash_init_t</a> *hash)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *h;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp;&nbsp; i, j;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; hide_headers;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L39" title="core/ngx_hash.h:39">ngx_hash_key_t</a>&nbsp; *hk;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;hide_headers == <a href="../core/ngx_conf_file.h.html#L59" title="core/ngx_conf_file.h:59">NGX_CONF_UNSET_PTR</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; conf-&gt;pass_headers == <a href="../core/ngx_conf_file.h.html#L59" title="core/ngx_conf_file.h:59">NGX_CONF_UNSET_PTR</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;hide_headers = prev-&gt;hide_headers;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;pass_headers = prev-&gt;pass_headers;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;hide_headers_hash = prev-&gt;hide_headers_hash;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;hide_headers_hash.buckets<br/></li>
<li><span class="PreProc">#if (NGX_HTTP_CACHE)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; ((conf-&gt;cache == <span class="Constant">0</span>) == (prev-&gt;cache == <span class="Constant">0</span>))<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; )<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;hide_headers == <a href="../core/ngx_conf_file.h.html#L59" title="core/ngx_conf_file.h:59">NGX_CONF_UNSET_PTR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;hide_headers = prev-&gt;hide_headers;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;pass_headers == <a href="../core/ngx_conf_file.h.html#L59" title="core/ngx_conf_file.h:59">NGX_CONF_UNSET_PTR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;pass_headers = prev-&gt;pass_headers;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;hide_headers, cf-&gt;temp_pool, <span class="Constant">4</span>, <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L39" title="core/ngx_hash.h:39">ngx_hash_key_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (h = default_hide_headers; h-&gt;len; h++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hk = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(&amp;hide_headers);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hk == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hk-&gt;key = *h;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hk-&gt;key_hash = <a href="../core/ngx_hash.c.html#L618" title="core/ngx_hash.c:618">ngx_hash_key_lc</a>(h-&gt;data, h-&gt;len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hk-&gt;value = (<span class="Type">void</span> *) <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;hide_headers != <a href="../core/ngx_conf_file.h.html#L59" title="core/ngx_conf_file.h:59">NGX_CONF_UNSET_PTR</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h = conf-&gt;hide_headers-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; conf-&gt;hide_headers-&gt;nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hk = hide_headers.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (j = <span class="Constant">0</span>; j &lt; hide_headers.nelts; j++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.c.html#L567" title="core/ngx_string.c:567">ngx_strcasecmp</a>(h[i].data, hk[j].key.data) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> exist;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hk = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(&amp;hide_headers);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hk == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hk-&gt;key = h[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hk-&gt;key_hash = <a href="../core/ngx_hash.c.html#L618" title="core/ngx_hash.c:618">ngx_hash_key_lc</a>(h[i].data, h[i].len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hk-&gt;value = (<span class="Type">void</span> *) <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">exist</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;pass_headers != <a href="../core/ngx_conf_file.h.html#L59" title="core/ngx_conf_file.h:59">NGX_CONF_UNSET_PTR</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h = conf-&gt;pass_headers-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hk = hide_headers.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; conf-&gt;pass_headers-&gt;nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (j = <span class="Constant">0</span>; j &lt; hide_headers.nelts; j++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hk[j].key.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.c.html#L567" title="core/ngx_string.c:567">ngx_strcasecmp</a>(h[i].data, hk[j].key.data) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hk[j].key.data = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hash-&gt;hash = &amp;conf-&gt;hide_headers_hash;<br/></li>
<li>&nbsp; &nbsp; hash-&gt;key = <a href="../core/ngx_hash.c.html#L618" title="core/ngx_hash.c:618">ngx_hash_key_lc</a>;<br/></li>
<li>&nbsp; &nbsp; hash-&gt;pool = cf-&gt;pool;<br/></li>
<li>&nbsp; &nbsp; hash-&gt;temp_pool = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_hash.c.html#L252" title="core/ngx_hash.c:252">ngx_hash_init</a>(hash, hide_headers.elts, hide_headers.nelts);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L5691">&#x200c;</a><span class="linkable">ngx_http_upstream_create_main_conf</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L73" title="http/ngx_http_upstream.h:73">ngx_http_upstream_main_conf_t</a>&nbsp; *umcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; umcf = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_upstream.h.html#L73" title="http/ngx_http_upstream.h:73">ngx_http_upstream_main_conf_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (umcf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;umcf-&gt;upstreams, cf-&gt;pool, <span class="Constant">4</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_upstream.h.html#L75" title="http/ngx_http_upstream.h:75">ngx_http_upstream_srv_conf_t</a> *))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> umcf;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L5712">&#x200c;</a><span class="linkable">ngx_http_upstream_init_main_conf</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L73" title="http/ngx_http_upstream.h:73">ngx_http_upstream_main_conf_t</a>&nbsp; *umcf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; headers_in;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L39" title="core/ngx_hash.h:39">ngx_hash_key_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *hk;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L62" title="core/ngx_hash.h:62">ngx_hash_init_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L77" title="http/ngx_http_upstream.h:77">ngx_http_upstream_init_pt</a>&nbsp; &nbsp; &nbsp;&nbsp; init;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L226" title="http/ngx_http_upstream.h:226">ngx_http_upstream_header_t</a>&nbsp; &nbsp;&nbsp; *header;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_upstream.h.html#L75" title="http/ngx_http_upstream.h:75">ngx_http_upstream_srv_conf_t</a>&nbsp; **uscfp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; uscfp = umcf-&gt;upstreams.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; umcf-&gt;upstreams.nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; init = uscfp[i]-&gt;peer.init_upstream ? uscfp[i]-&gt;peer.init_upstream:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_upstream_round_robin.c.html#L31" title="http/ngx_http_upstream_round_robin.c:31">ngx_http_upstream_init_round_robin</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (init(cf, uscfp[i]) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* upstream_headers_in_hash */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;headers_in, cf-&gt;temp_pool, <span class="Constant">32</span>, <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L39" title="core/ngx_hash.h:39">ngx_hash_key_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (header = <a href="#L172" title="http/ngx_http_upstream.c:172">ngx_http_upstream_headers_in</a>; header-&gt;name.len; header++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hk = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(&amp;headers_in);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hk == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hk-&gt;key = header-&gt;name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hk-&gt;key_hash = <a href="../core/ngx_hash.c.html#L618" title="core/ngx_hash.c:618">ngx_hash_key_lc</a>(header-&gt;name.data, header-&gt;name.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hk-&gt;value = header;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hash.hash = &amp;umcf-&gt;headers_in_hash;<br/></li>
<li>&nbsp; &nbsp; hash.key = <a href="../core/ngx_hash.c.html#L618" title="core/ngx_hash.c:618">ngx_hash_key_lc</a>;<br/></li>
<li>&nbsp; &nbsp; hash.max_size = <span class="Constant">512</span>;<br/></li>
<li>&nbsp; &nbsp; hash.bucket_size = <a href="../core/ngx_config.h.html#L97" title="core/ngx_config.h:97">ngx_align</a>(<span class="Constant">64</span>, <a href="../os/unix/ngx_alloc.c.html#L14" title="os/unix/ngx_alloc.c:14">ngx_cacheline_size</a>);<br/></li>
<li>&nbsp; &nbsp; hash.name = <span class="Constant">&quot;upstream_headers_in_hash&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; hash.pool = cf-&gt;pool;<br/></li>
<li>&nbsp; &nbsp; hash.temp_pool = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_hash.c.html#L252" title="core/ngx_hash.c:252">ngx_hash_init</a>(&amp;hash, headers_in.elts, headers_in.nelts) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
