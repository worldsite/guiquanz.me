<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>http/ngx_http.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>http/ngx_http.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L82">ngx_http_commands</a></li>
<li><a href="#L76">ngx_http_html_default_types</a></li>
<li><a href="#L69">ngx_http_max_module</a></li>
<li><a href="#L102">ngx_http_module</a></li>
<li><a href="#L95">ngx_http_module_ctx</a></li>
<li><a href="#L73">ngx_http_top_body_filter</a></li>
<li><a href="#L72">ngx_http_top_header_filter</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L1338">ngx_http_add_address</a></li>
<li><a href="#L1217">ngx_http_add_addresses</a></li>
<li><a href="#L1825">ngx_http_add_addrs</a></li>
<li><a href="#L1890">ngx_http_add_addrs6</a></li>
<li><a href="#L1143">ngx_http_add_listen</a></li>
<li><a href="#L1751">ngx_http_add_listening</a></li>
<li><a href="#L845">ngx_http_add_location</a></li>
<li><a href="#L1386">ngx_http_add_server</a></li>
<li><a href="#L119">ngx_http_block</a></li>
<li><a href="#L1626">ngx_http_cmp_conf_addrs</a></li>
<li><a href="#L1660">ngx_http_cmp_dns_wildcards</a></li>
<li><a href="#L892">ngx_http_cmp_locations</a></li>
<li><a href="#L1006">ngx_http_create_locations_list</a></li>
<li><a href="#L1070">ngx_http_create_locations_tree</a></li>
<li><a href="#L406">ngx_http_init_headers_in_hash</a></li>
<li><a href="#L1672">ngx_http_init_listening</a></li>
<li><a href="#L670">ngx_http_init_locations</a></li>
<li><a href="#L447">ngx_http_init_phase_handlers</a></li>
<li><a href="#L350">ngx_http_init_phases</a></li>
<li><a href="#L799">ngx_http_init_static_location_trees</a></li>
<li><a href="#L965">ngx_http_join_exact_locations</a></li>
<li><a href="#L625">ngx_http_merge_locations</a></li>
<li><a href="#L563">ngx_http_merge_servers</a></li>
<li><a href="#L2031">ngx_http_merge_types</a></li>
<li><a href="#L1423">ngx_http_optimize_servers</a></li>
<li><a href="#L1470">ngx_http_server_names</a></li>
<li><a href="#L2096">ngx_http_set_default_types</a></li>
<li><a href="#L1954">ngx_http_types_slot</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L119" title="http/ngx_http.c:119">ngx_http_block</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L350" title="http/ngx_http.c:350">ngx_http_init_phases</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a> *cmcf);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L406" title="http/ngx_http.c:406">ngx_http_init_headers_in_hash</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a> *cmcf);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L447" title="http/ngx_http.c:447">ngx_http_init_phase_handlers</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a> *cmcf);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1217" title="http/ngx_http.c:1217">ngx_http_add_addresses</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a> *cscf, <a href="ngx_http_core_module.h.html#L278" title="http/ngx_http_core_module.h:278">ngx_http_conf_port_t</a> *port,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L110" title="http/ngx_http_core_module.h:110">ngx_http_listen_opt_t</a> *lsopt);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1338" title="http/ngx_http.c:1338">ngx_http_add_address</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a> *cscf, <a href="ngx_http_core_module.h.html#L278" title="http/ngx_http_core_module.h:278">ngx_http_conf_port_t</a> *port,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L110" title="http/ngx_http_core_module.h:110">ngx_http_listen_opt_t</a> *lsopt);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1386" title="http/ngx_http.c:1386">ngx_http_add_server</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a> *cscf, <a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a> *addr);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L563" title="http/ngx_http.c:563">ngx_http_merge_servers</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a> *cmcf, <a href="ngx_http_config.h.html#L36" title="http/ngx_http_config.h:36">ngx_http_module_t</a> *module,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> ctx_index);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L625" title="http/ngx_http.c:625">ngx_http_merge_locations</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *locations, <span class="Type">void</span> **loc_conf, <a href="ngx_http_config.h.html#L36" title="http/ngx_http_config.h:36">ngx_http_module_t</a> *module,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> ctx_index);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L670" title="http/ngx_http.c:670">ngx_http_init_locations</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a> *cscf, <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a> *pclcf);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L799" title="http/ngx_http.c:799">ngx_http_init_static_location_trees</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a> *pclcf);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L892" title="http/ngx_http.c:892">ngx_http_cmp_locations</a>(<span class="Type">const</span> <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *one,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *two);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L965" title="http/ngx_http.c:965">ngx_http_join_exact_locations</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *locations);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1006" title="http/ngx_http.c:1006">ngx_http_create_locations_list</a>(<a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *locations,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *q);<br/></li>
<li><span class="Type">static</span> <a href="ngx_http_core_module.h.html#L52" title="http/ngx_http_core_module.h:52">ngx_http_location_tree_node_t</a> *<br/></li>
<li>&nbsp; &nbsp; <a href="#L1070" title="http/ngx_http.c:1070">ngx_http_create_locations_tree</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *locations,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> prefix);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1423" title="http/ngx_http.c:1423">ngx_http_optimize_servers</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a> *cmcf, <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> *ports);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1470" title="http/ngx_http.c:1470">ngx_http_server_names</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a> *cmcf, <a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a> *addr);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1626" title="http/ngx_http.c:1626">ngx_http_cmp_conf_addrs</a>(<span class="Type">const</span> <span class="Type">void</span> *one, <span class="Type">const</span> <span class="Type">void</span> *two);<br/></li>
<li><span class="Type">static</span> <span class="Type">int</span> <a href="../core/ngx_config.h.html#L74" title="core/ngx_config.h:74">ngx_libc_cdecl</a> <a href="#L1660" title="http/ngx_http.c:1660">ngx_http_cmp_dns_wildcards</a>(<span class="Type">const</span> <span class="Type">void</span> *one,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">void</span> *two);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1672" title="http/ngx_http.c:1672">ngx_http_init_listening</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L278" title="http/ngx_http_core_module.h:278">ngx_http_conf_port_t</a> *port);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_connection.h.html#L16" title="core/ngx_connection.h:16">ngx_listening_t</a> *<a href="#L1751" title="http/ngx_http.c:1751">ngx_http_add_listening</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a> *addr);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1825" title="http/ngx_http.c:1825">ngx_http_add_addrs</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L271" title="http/ngx_http_core_module.h:271">ngx_http_port_t</a> *hport,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a> *addr);<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1890" title="http/ngx_http.c:1890">ngx_http_add_addrs6</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L271" title="http/ngx_http_core_module.h:271">ngx_http_port_t</a> *hport,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a> *addr);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><a id="L69">&#x200c;</a><a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp;&nbsp; <span class="linkable">ngx_http_max_module</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L72">&#x200c;</a><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; (*<span class="linkable">ngx_http_top_header_filter</span>) (<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><a id="L73">&#x200c;</a><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; (*<span class="linkable">ngx_http_top_body_filter</span>) (<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *ch);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L76">&#x200c;</a><a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; <span class="linkable">ngx_http_html_default_types</span>[] = {<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;text/html&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L41" title="core/ngx_string.h:41">ngx_null_string</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L82">&#x200c;</a><span class="Type">static</span> <a href="../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a>&nbsp; <span class="linkable">ngx_http_commands</span>[] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;http&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L52" title="core/ngx_conf_file.h:52">NGX_MAIN_CONF</a>|<a href="../core/ngx_conf_file.h.html#L43" title="core/ngx_conf_file.h:43">NGX_CONF_BLOCK</a>|<a href="../core/ngx_conf_file.h.html#L22" title="core/ngx_conf_file.h:22">NGX_CONF_NOARGS</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L119" title="http/ngx_http.c:119">ngx_http_block</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L87" title="core/ngx_conf_file.h:87">ngx_null_command</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L95">&#x200c;</a><span class="Type">static</span> <a href="../core/ngx_conf_file.h.html#L143" title="core/ngx_conf_file.h:143">ngx_core_module_t</a>&nbsp; <span class="linkable">ngx_http_module_ctx</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;http&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L102">&#x200c;</a><a href="../core/ngx_core.h.html#L12" title="core/ngx_core.h:12">ngx_module_t</a>&nbsp; <span class="linkable">ngx_http_module</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L99" title="core/ngx_conf_file.h:99">NGX_MODULE_V1</a>,<br/></li>
<li>&nbsp; &nbsp; &amp;<a href="#L95" title="http/ngx_http.c:95">ngx_http_module_ctx</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* module context */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L82" title="http/ngx_http.c:82">ngx_http_commands</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module directives */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L71" title="core/ngx_conf_file.h:71">NGX_CORE_MODULE</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module type */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init master */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init module */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit master */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L100" title="core/ngx_conf_file.h:100">NGX_MODULE_V1_PADDING</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L119">&#x200c;</a><span class="linkable">ngx_http_block</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *rv;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; mi, m, s;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_config.h.html#L36" title="http/ngx_http_config.h:36">ngx_http_module_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *module;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_config.h.html#L21" title="http/ngx_http_config.h:21">ngx_http_conf_ctx_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; &nbsp; *clcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a>&nbsp;&nbsp; **cscfp;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a>&nbsp;&nbsp; *cmcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* the <a href="../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> http context */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_config.h.html#L21" title="http/ngx_http_config.h:21">ngx_http_conf_ctx_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *(<a href="ngx_http_config.h.html#L21" title="http/ngx_http_config.h:21">ngx_http_conf_ctx_t</a> **) conf = ctx;<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* count the number of the http modules and <a href="../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> up their indices */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L69" title="http/ngx_http.c:69">ngx_http_max_module</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (m = <span class="Constant">0</span>; ngx_modules[m]; m++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ngx_modules[m]-&gt;type != <a href="ngx_http_config.h.html#L39" title="http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ngx_modules[m]-&gt;ctx_index = <a href="#L69" title="http/ngx_http.c:69">ngx_http_max_module</a>++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* the http main_conf context, it is the same in the all http contexts */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;main_conf = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<span class="Type">void</span> *) * <a href="#L69" title="http/ngx_http.c:69">ngx_http_max_module</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;main_conf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the http null srv_conf context, it is used to merge<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the server{}s' srv_conf's<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;srv_conf = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<span class="Type">void</span> *) * <a href="#L69" title="http/ngx_http.c:69">ngx_http_max_module</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;srv_conf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the http null loc_conf context, it is used to merge<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the server{}s' loc_conf's<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;loc_conf = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<span class="Type">void</span> *) * <a href="#L69" title="http/ngx_http.c:69">ngx_http_max_module</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;loc_conf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * create the main_conf's, the null srv_conf's, and the null loc_conf's<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * of the all http modules<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (m = <span class="Constant">0</span>; ngx_modules[m]; m++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ngx_modules[m]-&gt;type != <a href="ngx_http_config.h.html#L39" title="http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; module = ngx_modules[m]-&gt;ctx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mi = ngx_modules[m]-&gt;ctx_index;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (module-&gt;create_main_conf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;main_conf[mi] = module-&gt;create_main_conf(cf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;main_conf[mi] == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (module-&gt;create_srv_conf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;srv_conf[mi] = module-&gt;create_srv_conf(cf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;srv_conf[mi] == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (module-&gt;create_loc_conf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;loc_conf[mi] = module-&gt;create_loc_conf(cf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;loc_conf[mi] == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pcf = *cf;<br/></li>
<li>&nbsp; &nbsp; cf-&gt;ctx = ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (m = <span class="Constant">0</span>; ngx_modules[m]; m++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ngx_modules[m]-&gt;type != <a href="ngx_http_config.h.html#L39" title="http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; module = ngx_modules[m]-&gt;ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (module-&gt;preconfiguration) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (module-&gt;preconfiguration(cf) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* parse inside the http{} block */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; cf-&gt;module_type = <a href="ngx_http_config.h.html#L39" title="http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>;<br/></li>
<li>&nbsp; &nbsp; cf-&gt;cmd_type = <a href="ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>;<br/></li>
<li>&nbsp; &nbsp; rv = <a href="../core/ngx_conf_file.c.html#L101" title="core/ngx_conf_file.c:101">ngx_conf_parse</a>(cf, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rv != <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * init http{} main_conf's, merge the server{}s' srv_conf's<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * and its location{}s' loc_conf's<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; cmcf = ctx-&gt;main_conf[<a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>.ctx_index];<br/></li>
<li>&nbsp; &nbsp; cscfp = cmcf-&gt;servers.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (m = <span class="Constant">0</span>; ngx_modules[m]; m++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ngx_modules[m]-&gt;type != <a href="ngx_http_config.h.html#L39" title="http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; module = ngx_modules[m]-&gt;ctx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mi = ngx_modules[m]-&gt;ctx_index;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init http{} main_conf's */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (module-&gt;init_main_conf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rv = module-&gt;init_main_conf(cf, ctx-&gt;main_conf[mi]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rv != <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="#L563" title="http/ngx_http.c:563">ngx_http_merge_servers</a>(cf, cmcf, module, mi);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rv != <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* create location trees */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (s = <span class="Constant">0</span>; s &lt; cmcf-&gt;servers.nelts; s++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; clcf = cscfp[s]-&gt;ctx-&gt;loc_conf[<a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>.ctx_index];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L670" title="http/ngx_http.c:670">ngx_http_init_locations</a>(cf, cscfp[s], clcf) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L799" title="http/ngx_http.c:799">ngx_http_init_static_location_trees</a>(cf, clcf) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L350" title="http/ngx_http.c:350">ngx_http_init_phases</a>(cf, cmcf) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L406" title="http/ngx_http.c:406">ngx_http_init_headers_in_hash</a>(cf, cmcf) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (m = <span class="Constant">0</span>; ngx_modules[m]; m++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ngx_modules[m]-&gt;type != <a href="ngx_http_config.h.html#L39" title="http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; module = ngx_modules[m]-&gt;ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (module-&gt;postconfiguration) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (module-&gt;postconfiguration(cf) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_variables.c.html#L2493" title="http/ngx_http_variables.c:2493">ngx_http_variables_init_vars</a>(cf) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * http{}'s cf-&gt;ctx was needed while the configuration merging<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * and in postconfiguration process<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; *cf = pcf;<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L447" title="http/ngx_http.c:447">ngx_http_init_phase_handlers</a>(cf, cmcf) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* optimize the lists of ports, addresses and server names */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1423" title="http/ngx_http.c:1423">ngx_http_optimize_servers</a>(cf, cmcf, cmcf-&gt;ports) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; *cf = pcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rv;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L350">&#x200c;</a><span class="linkable">ngx_http_init_phases</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a> *cmcf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;cmcf-&gt;phases[NGX_HTTP_POST_READ_PHASE].handlers,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cf-&gt;pool, <span class="Constant">1</span>, <span class="Statement">sizeof</span>(<a href="ngx_http_request.h.html#L355" title="http/ngx_http_request.h:355">ngx_http_handler_pt</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;cmcf-&gt;phases[NGX_HTTP_SERVER_REWRITE_PHASE].handlers,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cf-&gt;pool, <span class="Constant">1</span>, <span class="Statement">sizeof</span>(<a href="ngx_http_request.h.html#L355" title="http/ngx_http_request.h:355">ngx_http_handler_pt</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;cmcf-&gt;phases[NGX_HTTP_REWRITE_PHASE].handlers,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cf-&gt;pool, <span class="Constant">1</span>, <span class="Statement">sizeof</span>(<a href="ngx_http_request.h.html#L355" title="http/ngx_http_request.h:355">ngx_http_handler_pt</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;cmcf-&gt;phases[NGX_HTTP_PREACCESS_PHASE].handlers,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cf-&gt;pool, <span class="Constant">1</span>, <span class="Statement">sizeof</span>(<a href="ngx_http_request.h.html#L355" title="http/ngx_http_request.h:355">ngx_http_handler_pt</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;cmcf-&gt;phases[NGX_HTTP_ACCESS_PHASE].handlers,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cf-&gt;pool, <span class="Constant">2</span>, <span class="Statement">sizeof</span>(<a href="ngx_http_request.h.html#L355" title="http/ngx_http_request.h:355">ngx_http_handler_pt</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;cmcf-&gt;phases[NGX_HTTP_CONTENT_PHASE].handlers,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cf-&gt;pool, <span class="Constant">4</span>, <span class="Statement">sizeof</span>(<a href="ngx_http_request.h.html#L355" title="http/ngx_http_request.h:355">ngx_http_handler_pt</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;cmcf-&gt;phases[NGX_HTTP_LOG_PHASE].handlers,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cf-&gt;pool, <span class="Constant">1</span>, <span class="Statement">sizeof</span>(<a href="ngx_http_request.h.html#L355" title="http/ngx_http_request.h:355">ngx_http_handler_pt</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L406">&#x200c;</a><span class="linkable">ngx_http_init_headers_in_hash</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a> *cmcf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; headers_in;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L39" title="core/ngx_hash.h:39">ngx_hash_key_t</a>&nbsp; &nbsp;&nbsp; *hk;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L62" title="core/ngx_hash.h:62">ngx_hash_init_t</a>&nbsp; &nbsp;&nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L163" title="http/ngx_http_request.h:163">ngx_http_header_t</a>&nbsp; *header;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;headers_in, cf-&gt;temp_pool, <span class="Constant">32</span>, <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L39" title="core/ngx_hash.h:39">ngx_hash_key_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (header = <a href="ngx_http_request.c.html#L80" title="http/ngx_http_request.c:80">ngx_http_headers_in</a>; header-&gt;name.len; header++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hk = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(&amp;headers_in);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hk == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hk-&gt;key = header-&gt;name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hk-&gt;key_hash = <a href="../core/ngx_hash.c.html#L618" title="core/ngx_hash.c:618">ngx_hash_key_lc</a>(header-&gt;name.data, header-&gt;name.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hk-&gt;value = header;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hash.hash = &amp;cmcf-&gt;headers_in_hash;<br/></li>
<li>&nbsp; &nbsp; hash.key = <a href="../core/ngx_hash.c.html#L618" title="core/ngx_hash.c:618">ngx_hash_key_lc</a>;<br/></li>
<li>&nbsp; &nbsp; hash.max_size = <span class="Constant">512</span>;<br/></li>
<li>&nbsp; &nbsp; hash.bucket_size = <a href="../core/ngx_config.h.html#L97" title="core/ngx_config.h:97">ngx_align</a>(<span class="Constant">64</span>, <a href="../os/unix/ngx_alloc.c.html#L14" title="os/unix/ngx_alloc.c:14">ngx_cacheline_size</a>);<br/></li>
<li>&nbsp; &nbsp; hash.name = <span class="Constant">&quot;headers_in_hash&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; hash.pool = cf-&gt;pool;<br/></li>
<li>&nbsp; &nbsp; hash.temp_pool = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_hash.c.html#L252" title="core/ngx_hash.c:252">ngx_hash_init</a>(&amp;hash, headers_in.elts, headers_in.nelts) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L447">&#x200c;</a><span class="linkable">ngx_http_init_phase_handlers</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a> *cmcf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; j;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i, n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; find_config_index, use_rewrite, use_access;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L355" title="http/ngx_http_request.h:355">ngx_http_handler_pt</a>&nbsp; &nbsp; &nbsp; &nbsp; *h;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L133" title="http/ngx_http_core_module.h:133">ngx_http_phase_handler_t</a>&nbsp;&nbsp; *ph;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L135" title="http/ngx_http_core_module.h:135">ngx_http_phase_handler_pt</a>&nbsp;&nbsp; checker;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cmcf-&gt;phase_engine.server_rewrite_index = (<a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; cmcf-&gt;phase_engine.location_rewrite_index = (<a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; find_config_index = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; use_rewrite = cmcf-&gt;phases[NGX_HTTP_REWRITE_PHASE].handlers.nelts ? <span class="Constant">1</span> : <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; use_access = cmcf-&gt;phases[NGX_HTTP_ACCESS_PHASE].handlers.nelts ? <span class="Constant">1</span> : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = use_rewrite + use_access + cmcf-&gt;try_files + <span class="Constant">1</span> <span class="Comment">/* find config phase */</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; NGX_HTTP_LOG_PHASE; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n += cmcf-&gt;phases[i].handlers.nelts;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ph = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n * <span class="Statement">sizeof</span>(<a href="ngx_http_core_module.h.html#L133" title="http/ngx_http_core_module.h:133">ngx_http_phase_handler_t</a>) + <span class="Statement">sizeof</span>(<span class="Type">void</span> *));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ph == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cmcf-&gt;phase_engine.handlers = ph;<br/></li>
<li>&nbsp; &nbsp; n = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; NGX_HTTP_LOG_PHASE; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h = cmcf-&gt;phases[i].handlers.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (i) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> NGX_HTTP_SERVER_REWRITE_PHASE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cmcf-&gt;phase_engine.server_rewrite_index == (<a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmcf-&gt;phase_engine.server_rewrite_index = n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; checker = <a href="ngx_http_core_module.c.html#L935" title="http/ngx_http_core_module.c:935">ngx_http_core_rewrite_phase</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> NGX_HTTP_FIND_CONFIG_PHASE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; find_config_index = n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ph-&gt;checker = <a href="ngx_http_core_module.c.html#L962" title="http/ngx_http_core_module.c:962">ngx_http_core_find_config_phase</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ph++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> NGX_HTTP_REWRITE_PHASE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cmcf-&gt;phase_engine.location_rewrite_index == (<a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmcf-&gt;phase_engine.location_rewrite_index = n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; checker = <a href="ngx_http_core_module.c.html#L935" title="http/ngx_http_core_module.c:935">ngx_http_core_rewrite_phase</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> NGX_HTTP_POST_REWRITE_PHASE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (use_rewrite) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ph-&gt;checker = <a href="ngx_http_core_module.c.html#L1057" title="http/ngx_http_core_module.c:1057">ngx_http_core_post_rewrite_phase</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ph-&gt;next = find_config_index;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ph++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> NGX_HTTP_ACCESS_PHASE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; checker = <a href="ngx_http_core_module.c.html#L1101" title="http/ngx_http_core_module.c:1101">ngx_http_core_access_phase</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> NGX_HTTP_POST_ACCESS_PHASE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (use_access) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ph-&gt;checker = <a href="ngx_http_core_module.c.html#L1164" title="http/ngx_http_core_module.c:1164">ngx_http_core_post_access_phase</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ph-&gt;next = n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ph++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> NGX_HTTP_TRY_FILES_PHASE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cmcf-&gt;try_files) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ph-&gt;checker = <a href="ngx_http_core_module.c.html#L1191" title="http/ngx_http_core_module.c:1191">ngx_http_core_try_files_phase</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ph++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> NGX_HTTP_CONTENT_PHASE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; checker = <a href="ngx_http_core_module.c.html#L1398" title="http/ngx_http_core_module.c:1398">ngx_http_core_content_phase</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; checker = <a href="ngx_http_core_module.c.html#L898" title="http/ngx_http_core_module.c:898">ngx_http_core_generic_phase</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n += cmcf-&gt;phases[i].handlers.nelts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (j = cmcf-&gt;phases[i].handlers.nelts - <span class="Constant">1</span>; j &gt;=<span class="Constant">0</span>; j--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ph-&gt;checker = checker;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ph-&gt;handler = h[j];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ph-&gt;next = n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ph++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L563">&#x200c;</a><span class="linkable">ngx_http_merge_servers</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a> *cmcf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_config.h.html#L36" title="http/ngx_http_config.h:36">ngx_http_module_t</a> *module, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> ctx_index)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *rv;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; s;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_config.h.html#L21" title="http/ngx_http_config.h:21">ngx_http_conf_ctx_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ctx, saved;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; &nbsp; *clcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a>&nbsp;&nbsp; **cscfp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cscfp = cmcf-&gt;servers.elts;<br/></li>
<li>&nbsp; &nbsp; ctx = (<a href="ngx_http_config.h.html#L21" title="http/ngx_http_config.h:21">ngx_http_conf_ctx_t</a> *) cf-&gt;ctx;<br/></li>
<li>&nbsp; &nbsp; saved = *ctx;<br/></li>
<li>&nbsp; &nbsp; rv = <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (s = <span class="Constant">0</span>; s &lt; cmcf-&gt;servers.nelts; s++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge the server{}s' srv_conf's */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;srv_conf = cscfp[s]-&gt;ctx-&gt;srv_conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (module-&gt;merge_srv_conf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rv = module-&gt;merge_srv_conf(cf, saved.srv_conf[ctx_index],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cscfp[s]-&gt;ctx-&gt;srv_conf[ctx_index]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rv != <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (module-&gt;merge_loc_conf) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge the server{}'s loc_conf */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;loc_conf = cscfp[s]-&gt;ctx-&gt;loc_conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rv = module-&gt;merge_loc_conf(cf, saved.loc_conf[ctx_index],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cscfp[s]-&gt;ctx-&gt;loc_conf[ctx_index]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rv != <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge the locations{}' loc_conf's */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clcf = cscfp[s]-&gt;ctx-&gt;loc_conf[<a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>.ctx_index];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="#L625" title="http/ngx_http.c:625">ngx_http_merge_locations</a>(cf, clcf-&gt;locations,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cscfp[s]-&gt;ctx-&gt;loc_conf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; module, ctx_index);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rv != <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; *ctx = saved;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rv;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L625">&#x200c;</a><span class="linkable">ngx_http_merge_locations</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *locations,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> **loc_conf, <a href="ngx_http_config.h.html#L36" title="http/ngx_http_config.h:36">ngx_http_module_t</a> *module, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> ctx_index)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *rv;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_config.h.html#L21" title="http/ngx_http_config.h:21">ngx_http_conf_ctx_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *ctx, saved;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp;&nbsp; *clcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a>&nbsp; *lq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (locations == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = (<a href="ngx_http_config.h.html#L21" title="http/ngx_http_config.h:21">ngx_http_conf_ctx_t</a> *) cf-&gt;ctx;<br/></li>
<li>&nbsp; &nbsp; saved = *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (q = <a href="../core/ngx_queue.h.html#L50" title="core/ngx_queue.h:50">ngx_queue_head</a>(locations);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q != <a href="../core/ngx_queue.h.html#L58" title="core/ngx_queue.h:58">ngx_queue_sentinel</a>(locations);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q = <a href="../core/ngx_queue.h.html#L62" title="core/ngx_queue.h:62">ngx_queue_next</a>(q))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lq = (<a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a> *) q;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; clcf = lq-&gt;exact ? lq-&gt;exact : lq-&gt;inclusive;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;loc_conf = clcf-&gt;loc_conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rv = module-&gt;merge_loc_conf(cf, loc_conf[ctx_index],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clcf-&gt;loc_conf[ctx_index]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rv != <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rv;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="#L625" title="http/ngx_http.c:625">ngx_http_merge_locations</a>(cf, clcf-&gt;locations, clcf-&gt;loc_conf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; module, ctx_index);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rv != <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rv;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ctx = saved;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L670">&#x200c;</a><span class="linkable">ngx_http_init_locations</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a> *cscf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a> *pclcf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *q, *locations, *named, tail;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; &nbsp; *clcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a>&nbsp;&nbsp; *lq;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp;&nbsp; **clcfp;<br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; r;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *regex;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; locations = pclcf-&gt;locations;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (locations == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.c.html#L51" title="core/ngx_queue.c:51">ngx_queue_sort</a>(locations, <a href="#L892" title="http/ngx_http.c:892">ngx_http_cmp_locations</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; named = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; n = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span>&nbsp; &nbsp; regex = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; r = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (q = <a href="../core/ngx_queue.h.html#L50" title="core/ngx_queue.h:50">ngx_queue_head</a>(locations);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q != <a href="../core/ngx_queue.h.html#L58" title="core/ngx_queue.h:58">ngx_queue_sentinel</a>(locations);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q = <a href="../core/ngx_queue.h.html#L62" title="core/ngx_queue.h:62">ngx_queue_next</a>(q))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lq = (<a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a> *) q;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; clcf = lq-&gt;exact ? lq-&gt;exact : lq-&gt;inclusive;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L670" title="http/ngx_http.c:670">ngx_http_init_locations</a>(cf, <span class="Constant">NULL</span>, clcf) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;regex) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (regex == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; regex = q;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;named) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (named == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; named = q;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;noname) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (q != <a href="../core/ngx_queue.h.html#L58" title="core/ngx_queue.h:58">ngx_queue_sentinel</a>(locations)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L87" title="core/ngx_queue.h:87">ngx_queue_split</a>(locations, q, &amp;tail);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (named) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; clcfp = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(cf-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (n + <span class="Constant">1</span>) * <span class="Statement">sizeof</span>(<a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a> *));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcfp == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cscf-&gt;named_locations = clcfp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (q = named;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q != <a href="../core/ngx_queue.h.html#L58" title="core/ngx_queue.h:58">ngx_queue_sentinel</a>(locations);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q = <a href="../core/ngx_queue.h.html#L62" title="core/ngx_queue.h:62">ngx_queue_next</a>(q))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lq = (<a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a> *) q;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *(clcfp++) = lq-&gt;exact;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *clcfp = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L87" title="core/ngx_queue.h:87">ngx_queue_split</a>(locations, named, &amp;tail);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (regex) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; clcfp = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(cf-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (r + <span class="Constant">1</span>) * <span class="Statement">sizeof</span>(<a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a> *));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcfp == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pclcf-&gt;regex_locations = clcfp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (q = regex;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q != <a href="../core/ngx_queue.h.html#L58" title="core/ngx_queue.h:58">ngx_queue_sentinel</a>(locations);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q = <a href="../core/ngx_queue.h.html#L62" title="core/ngx_queue.h:62">ngx_queue_next</a>(q))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lq = (<a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a> *) q;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *(clcfp++) = lq-&gt;exact;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *clcfp = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L87" title="core/ngx_queue.h:87">ngx_queue_split</a>(locations, regex, &amp;tail);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L799">&#x200c;</a><span class="linkable">ngx_http_init_static_location_trees</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a> *pclcf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *q, *locations;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp;&nbsp; *clcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a>&nbsp; *lq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; locations = pclcf-&gt;locations;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (locations == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_queue.h.html#L29" title="core/ngx_queue.h:29">ngx_queue_empty</a>(locations)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (q = <a href="../core/ngx_queue.h.html#L50" title="core/ngx_queue.h:50">ngx_queue_head</a>(locations);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q != <a href="../core/ngx_queue.h.html#L58" title="core/ngx_queue.h:58">ngx_queue_sentinel</a>(locations);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q = <a href="../core/ngx_queue.h.html#L62" title="core/ngx_queue.h:62">ngx_queue_next</a>(q))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lq = (<a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a> *) q;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; clcf = lq-&gt;exact ? lq-&gt;exact : lq-&gt;inclusive;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L799" title="http/ngx_http.c:799">ngx_http_init_static_location_trees</a>(cf, clcf) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L965" title="http/ngx_http.c:965">ngx_http_join_exact_locations</a>(cf, locations) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1006" title="http/ngx_http.c:1006">ngx_http_create_locations_list</a>(locations, <a href="../core/ngx_queue.h.html#L50" title="core/ngx_queue.h:50">ngx_queue_head</a>(locations));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pclcf-&gt;static_locations = <a href="#L1070" title="http/ngx_http.c:1070">ngx_http_create_locations_tree</a>(cf, locations, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pclcf-&gt;static_locations == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L845">&#x200c;</a><span class="linkable">ngx_http_add_location</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> **locations,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a> *clcf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a>&nbsp; *lq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*locations == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *locations = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(cf-&gt;temp_pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*locations == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L24" title="core/ngx_queue.h:24">ngx_queue_init</a>(*locations);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lq = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(cf-&gt;temp_pool, <span class="Statement">sizeof</span>(<a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (lq == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;exact_match<br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; || clcf-&gt;regex<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; || clcf-&gt;named || clcf-&gt;noname)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lq-&gt;exact = clcf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lq-&gt;inclusive = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lq-&gt;exact = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lq-&gt;inclusive = clcf;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lq-&gt;name = &amp;clcf-&gt;name;<br/></li>
<li>&nbsp; &nbsp; lq-&gt;file_name = cf-&gt;conf_file-&gt;file.name.data;<br/></li>
<li>&nbsp; &nbsp; lq-&gt;line = cf-&gt;conf_file-&gt;line;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L24" title="core/ngx_queue.h:24">ngx_queue_init</a>(&amp;lq-&gt;list);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L43" title="core/ngx_queue.h:43">ngx_queue_insert_tail</a>(*locations, &amp;lq-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L892">&#x200c;</a><span class="linkable">ngx_http_cmp_locations</span>(<span class="Type">const</span> <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *one, <span class="Type">const</span> <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *two)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp;&nbsp; *first, *second;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a>&nbsp; *lq1, *lq2;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lq1 = (<a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a> *) one;<br/></li>
<li>&nbsp; &nbsp; lq2 = (<a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a> *) two;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; first = lq1-&gt;exact ? lq1-&gt;exact : lq1-&gt;inclusive;<br/></li>
<li>&nbsp; &nbsp; second = lq2-&gt;exact ? lq2-&gt;exact : lq2-&gt;inclusive;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (first-&gt;noname &amp;&amp; !second-&gt;noname) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* shift no named locations to the end */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!first-&gt;noname &amp;&amp; second-&gt;noname) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* shift no named locations to the end */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (first-&gt;noname || second-&gt;noname) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* do not sort no named locations */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (first-&gt;named &amp;&amp; !second-&gt;named) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* shift named locations to the end */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!first-&gt;named &amp;&amp; second-&gt;named) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* shift named locations to the end */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (first-&gt;named &amp;&amp; second-&gt;named) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(first-&gt;name.data, second-&gt;name.data);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (first-&gt;regex &amp;&amp; !second-&gt;regex) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* shift the regex matches to the end */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!first-&gt;regex &amp;&amp; second-&gt;regex) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* shift the regex matches to the end */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (first-&gt;regex || second-&gt;regex) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* do not sort the regex matches */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../core/ngx_string.c.html#L858" title="core/ngx_string.c:858">ngx_filename_cmp</a>(first-&gt;name.data, second-&gt;name.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_core.h.html#L91" title="core/ngx_core.h:91">ngx_min</a>(first-&gt;name.len, second-&gt;name.len) + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <span class="Constant">0</span> &amp;&amp; !first-&gt;exact_match &amp;&amp; second-&gt;exact_match) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* an exact match must be before the same inclusive one */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L965">&#x200c;</a><span class="linkable">ngx_http_join_exact_locations</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *locations)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *q, *x;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a>&nbsp; *lq, *lx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; q = <a href="../core/ngx_queue.h.html#L50" title="core/ngx_queue.h:50">ngx_queue_head</a>(locations);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (q != <a href="../core/ngx_queue.h.html#L54" title="core/ngx_queue.h:54">ngx_queue_last</a>(locations)) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; x = <a href="../core/ngx_queue.h.html#L62" title="core/ngx_queue.h:62">ngx_queue_next</a>(q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lq = (<a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a> *) q;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lx = (<a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a> *) x;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (lq-&gt;name-&gt;len == lx-&gt;name-&gt;len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="../core/ngx_string.c.html#L858" title="core/ngx_string.c:858">ngx_filename_cmp</a>(lq-&gt;name-&gt;data, lx-&gt;name-&gt;data, lx-&gt;name-&gt;len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((lq-&gt;exact &amp;&amp; lx-&gt;exact) || (lq-&gt;inclusive &amp;&amp; lx-&gt;inclusive)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;duplicate location </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> in </span><span class="Special">%s</span><span class="Constant">:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lx-&gt;name, lx-&gt;file_name, lx-&gt;line);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lq-&gt;inclusive = lx-&gt;inclusive;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(x);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; q = <a href="../core/ngx_queue.h.html#L62" title="core/ngx_queue.h:62">ngx_queue_next</a>(q);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1006">&#x200c;</a></span><span class="linkable">ngx_http_create_locations_list</span>(<a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *locations, <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *q)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *name;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *x, tail;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a>&nbsp; *lq, *lx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (q == <a href="../core/ngx_queue.h.html#L54" title="core/ngx_queue.h:54">ngx_queue_last</a>(locations)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lq = (<a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a> *) q;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (lq-&gt;inclusive == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1006" title="http/ngx_http.c:1006">ngx_http_create_locations_list</a>(locations, <a href="../core/ngx_queue.h.html#L62" title="core/ngx_queue.h:62">ngx_queue_next</a>(q));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = lq-&gt;name-&gt;len;<br/></li>
<li>&nbsp; &nbsp; name = lq-&gt;name-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (x = <a href="../core/ngx_queue.h.html#L62" title="core/ngx_queue.h:62">ngx_queue_next</a>(q);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; x != <a href="../core/ngx_queue.h.html#L58" title="core/ngx_queue.h:58">ngx_queue_sentinel</a>(locations);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; x = <a href="../core/ngx_queue.h.html#L62" title="core/ngx_queue.h:62">ngx_queue_next</a>(x))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lx = (<a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a> *) x;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len &gt; lx-&gt;name-&gt;len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || <a href="../core/ngx_string.c.html#L858" title="core/ngx_string.c:858">ngx_filename_cmp</a>(name, lx-&gt;name-&gt;data, len) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; q = <a href="../core/ngx_queue.h.html#L62" title="core/ngx_queue.h:62">ngx_queue_next</a>(q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (q == x) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1006" title="http/ngx_http.c:1006">ngx_http_create_locations_list</a>(locations, x);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L87" title="core/ngx_queue.h:87">ngx_queue_split</a>(locations, q, &amp;tail);<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L96" title="core/ngx_queue.h:96">ngx_queue_add</a>(&amp;lq-&gt;list, &amp;tail);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (x == <a href="../core/ngx_queue.h.html#L58" title="core/ngx_queue.h:58">ngx_queue_sentinel</a>(locations)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1006" title="http/ngx_http.c:1006">ngx_http_create_locations_list</a>(&amp;lq-&gt;list, <a href="../core/ngx_queue.h.html#L50" title="core/ngx_queue.h:50">ngx_queue_head</a>(&amp;lq-&gt;list));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L87" title="core/ngx_queue.h:87">ngx_queue_split</a>(&amp;lq-&gt;list, x, &amp;tail);<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L96" title="core/ngx_queue.h:96">ngx_queue_add</a>(locations, &amp;tail);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1006" title="http/ngx_http.c:1006">ngx_http_create_locations_list</a>(&amp;lq-&gt;list, <a href="../core/ngx_queue.h.html#L50" title="core/ngx_queue.h:50">ngx_queue_head</a>(&amp;lq-&gt;list));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1006" title="http/ngx_http.c:1006">ngx_http_create_locations_list</a>(locations, x);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * to keep cache locality for left leaf nodes, allocate nodes in following<br/></li>
<li></span><span class="Comment"> * order: node, left subtree, right subtree, inclusive subtree<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="ngx_http_core_module.h.html#L52" title="http/ngx_http_core_module.h:52">ngx_http_location_tree_node_t</a> *<br/></li>
<li><a id="L1070">&#x200c;</a><span class="linkable">ngx_http_create_locations_tree</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *locations,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> prefix)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *q, tail;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a>&nbsp; &nbsp; &nbsp; *lq;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L52" title="http/ngx_http_core_module.h:52">ngx_http_location_tree_node_t</a>&nbsp; *node;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; q = <a href="../core/ngx_queue.c.html#L18" title="core/ngx_queue.c:18">ngx_queue_middle</a>(locations);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lq = (<a href="ngx_http_core_module.h.html#L464" title="http/ngx_http_core_module.h:464">ngx_http_location_queue_t</a> *) q;<br/></li>
<li>&nbsp; &nbsp; len = lq-&gt;name-&gt;len - prefix;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(cf-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; offsetof(<a href="ngx_http_core_module.h.html#L52" title="http/ngx_http_core_module.h:52">ngx_http_location_tree_node_t</a>, name) + len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (node == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node-&gt;left = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; node-&gt;right = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; node-&gt;tree = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; node-&gt;exact = lq-&gt;exact;<br/></li>
<li>&nbsp; &nbsp; node-&gt;inclusive = lq-&gt;inclusive;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node-&gt;auto_redirect = (u_char) ((lq-&gt;exact &amp;&amp; lq-&gt;exact-&gt;auto_redirect)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; || (lq-&gt;inclusive &amp;&amp; lq-&gt;inclusive-&gt;auto_redirect));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node-&gt;len = (u_char) len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(node-&gt;name, &amp;lq-&gt;name-&gt;data[prefix], len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L87" title="core/ngx_queue.h:87">ngx_queue_split</a>(locations, q, &amp;tail);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_queue.h.html#L29" title="core/ngx_queue.h:29">ngx_queue_empty</a>(locations)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="../core/ngx_queue.h.html#L87" title="core/ngx_queue.h:87">ngx_queue_split</a>() insures that if left part is empty,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * then right one is empty too<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> inclusive;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node-&gt;left = <a href="#L1070" title="http/ngx_http.c:1070">ngx_http_create_locations_tree</a>(cf, locations, prefix);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;left == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_queue.h.html#L29" title="core/ngx_queue.h:29">ngx_queue_empty</a>(&amp;tail)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> inclusive;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node-&gt;right = <a href="#L1070" title="http/ngx_http.c:1070">ngx_http_create_locations_tree</a>(cf, &amp;tail, prefix);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;right == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">inclusive</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_queue.h.html#L29" title="core/ngx_queue.h:29">ngx_queue_empty</a>(&amp;lq-&gt;list)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> node;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node-&gt;tree = <a href="#L1070" title="http/ngx_http.c:1070">ngx_http_create_locations_tree</a>(cf, &amp;lq-&gt;list, prefix + len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;tree == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> node;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1143">&#x200c;</a><span class="linkable">ngx_http_add_listen</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a> *cscf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L110" title="http/ngx_http_core_module.h:110">ngx_http_listen_opt_t</a> *lsopt)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; in_port_t&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; p;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *sa;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *sin;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L278" title="http/ngx_http_core_module.h:278">ngx_http_conf_port_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *port;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a>&nbsp; *cmcf;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in6&nbsp; &nbsp; &nbsp; &nbsp; *sin6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; cmcf = <a href="ngx_http_config.h.html#L61" title="http/ngx_http_config.h:61">ngx_http_conf_get_module_main_conf</a>(cf, <a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cmcf-&gt;ports == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cmcf-&gt;ports = <a href="../core/ngx_array.c.html#L13" title="core/ngx_array.c:13">ngx_array_create</a>(cf-&gt;temp_pool, <span class="Constant">2</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_core_module.h.html#L278" title="http/ngx_http_core_module.h:278">ngx_http_conf_port_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cmcf-&gt;ports == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sa = &amp;lsopt-&gt;u.sockaddr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (sa-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sin6 = &amp;lsopt-&gt;u.sockaddr_in6;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = sin6-&gt;sin6_port;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_UNIX_DOMAIN)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> AF_UNIX:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; sin = &amp;lsopt-&gt;u.sockaddr_in;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = sin-&gt;sin_port;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; port = cmcf-&gt;ports-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; cmcf-&gt;ports-&gt;nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p != port[i].port || sa-&gt;sa_family != port[i].family) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* a port is already in the port list */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1217" title="http/ngx_http.c:1217">ngx_http_add_addresses</a>(cf, cscf, &amp;port[i], lsopt);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* add a port to the port list */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; port = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(cmcf-&gt;ports);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (port == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; port-&gt;family = sa-&gt;sa_family;<br/></li>
<li>&nbsp; &nbsp; port-&gt;port = p;<br/></li>
<li>&nbsp; &nbsp; port-&gt;addrs.elts = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1338" title="http/ngx_http.c:1338">ngx_http_add_address</a>(cf, cscf, port, lsopt);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1217">&#x200c;</a><span class="linkable">ngx_http_add_addresses</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a> *cscf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L278" title="http/ngx_http_core_module.h:278">ngx_http_conf_port_t</a> *port, <a href="ngx_http_core_module.h.html#L110" title="http/ngx_http_core_module.h:110">ngx_http_listen_opt_t</a> *lsopt)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len, off;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i, default_server;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr&nbsp; &nbsp; &nbsp;&nbsp; *sa;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a>&nbsp; *addr;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_UNIX_DOMAIN)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_un&nbsp; &nbsp; *saun;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ssl;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#if (NGX_HTTP_SPDY)<br/></li>
<li></span>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; spdy;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * we cannot compare whole sockaddr struct's as kernel<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * may fill some fields in inherited sockaddr struct's<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; sa = &amp;lsopt-&gt;u.sockaddr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (sa-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; off = offsetof(<span class="Type">struct</span> sockaddr_in6, sin6_addr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Constant">16</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_UNIX_DOMAIN)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> AF_UNIX:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; off = offsetof(<span class="Type">struct</span> sockaddr_un, sun_path);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Statement">sizeof</span>(saun-&gt;sun_path);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; off = offsetof(<span class="Type">struct</span> sockaddr_in, sin_addr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Constant">4</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = lsopt-&gt;u.sockaddr_data + off;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; addr = port-&gt;addrs.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; port-&gt;addrs.nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L144" title="core/ngx_string.h:144">ngx_memcmp</a>(p, addr[i].opt.u.sockaddr_data + off, len) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the address is already in the address list */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1386" title="http/ngx_http.c:1386">ngx_http_add_server</a>(cf, cscf, &amp;addr[i]) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* preserve default_server bit during listen options overwriting */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; default_server = addr[i].opt.default_server;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; ssl = lsopt-&gt;ssl || addr[i].opt.ssl;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#if (NGX_HTTP_SPDY)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; spdy = lsopt-&gt;spdy || addr[i].opt.spdy;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (lsopt-&gt;<a href="../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr[i].opt.<a href="../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;duplicate listen options for </span><span class="Special">%s</span><span class="Constant">&quot;</span>, addr[i].opt.addr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr[i].opt = *lsopt;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* check the duplicate &quot;default&quot; server for this address:port */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (lsopt-&gt;default_server) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (default_server) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;a duplicate default server for </span><span class="Special">%s</span><span class="Constant">&quot;</span>, addr[i].opt.addr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default_server = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr[i].default_server = cscf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr[i].opt.default_server = default_server;<br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; addr[i].opt.ssl = ssl;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#if (NGX_HTTP_SPDY)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; addr[i].opt.spdy = spdy;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* add the address to the addresses list that bound to this port */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1338" title="http/ngx_http.c:1338">ngx_http_add_address</a>(cf, cscf, port, lsopt);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * add the server address, the server names and the server core module<br/></li>
<li></span><span class="Comment"> * configurations to the port list<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1338">&#x200c;</a><span class="linkable">ngx_http_add_address</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a> *cscf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L278" title="http/ngx_http_core_module.h:278">ngx_http_conf_port_t</a> *port, <a href="ngx_http_core_module.h.html#L110" title="http/ngx_http_core_module.h:110">ngx_http_listen_opt_t</a> *lsopt)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a>&nbsp; *addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (port-&gt;addrs.elts == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;port-&gt;addrs, cf-&gt;temp_pool, <span class="Constant">4</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SPDY &amp;&amp; NGX_HTTP_SSL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp;&nbsp; &amp;&amp; !defined TLSEXT_TYPE_application_layer_protocol_negotiation&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp;&nbsp; &amp;&amp; !defined TLSEXT_TYPE_next_proto_neg)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (lsopt-&gt;spdy &amp;&amp; lsopt-&gt;ssl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;<a href="modules/perl/ngx_http_perl_module.h.html#L21" title="http/modules/perl/ngx_http_perl_module.h:21">nginx</a> was built without OpenSSL ALPN or NPN &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;support, SPDY is not enabled for </span><span class="Special">%s</span><span class="Constant">&quot;</span>, lsopt-&gt;addr);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; addr = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(&amp;port-&gt;addrs);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (addr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; addr-&gt;opt = *lsopt;<br/></li>
<li>&nbsp; &nbsp; addr-&gt;hash.buckets = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; addr-&gt;hash.size = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; addr-&gt;wc_head = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; addr-&gt;wc_tail = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span>&nbsp; &nbsp; addr-&gt;nregex = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; addr-&gt;regex = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; addr-&gt;default_server = cscf;<br/></li>
<li>&nbsp; &nbsp; addr-&gt;servers.elts = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1386" title="http/ngx_http.c:1386">ngx_http_add_server</a>(cf, cscf, addr);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* add the server core module configuration to the address:port */<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1386">&#x200c;</a><span class="linkable">ngx_http_add_server</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a> *cscf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a> *addr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a>&nbsp; **server;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (addr-&gt;servers.elts == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;addr-&gt;servers, cf-&gt;temp_pool, <span class="Constant">4</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a> *))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; server = addr-&gt;servers.elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; addr-&gt;servers.nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (server[i] == cscf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;a duplicate listen </span><span class="Special">%s</span><span class="Constant">&quot;</span>, addr-&gt;opt.addr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; server = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(&amp;addr-&gt;servers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (server == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *server = cscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1423">&#x200c;</a><span class="linkable">ngx_http_optimize_servers</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a> *cmcf,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> *ports)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; p, a;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L278" title="http/ngx_http_core_module.h:278">ngx_http_conf_port_t</a>&nbsp; *port;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a>&nbsp; *addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ports == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; port = ports-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = <span class="Constant">0</span>; p &lt; ports-&gt;nelts; p++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1914" title="core/ngx_string.c:1914">ngx_sort</a>(port[p].addrs.elts, (<span class="Type">size_t</span>) port[p].addrs.nelts,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a>), <a href="#L1626" title="http/ngx_http.c:1626">ngx_http_cmp_conf_addrs</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * check whether all name-based servers have the same<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * configuration as a default server for given address:port<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr = port[p].addrs.elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (a = <span class="Constant">0</span>; a &lt; port[p].addrs.nelts; a++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr[a].servers.nelts &gt; <span class="Constant">1<br/></li>
<li></span><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || addr[a].default_server-&gt;captures<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; )<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1470" title="http/ngx_http.c:1470">ngx_http_server_names</a>(cf, cmcf, &amp;addr[a]) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1672" title="http/ngx_http.c:1672">ngx_http_init_listening</a>(cf, &amp;port[p]) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1470">&#x200c;</a><span class="linkable">ngx_http_server_names</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a> *cmcf,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a> *addr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n, s;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L62" title="core/ngx_hash.h:62">ngx_hash_init_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L89" title="core/ngx_hash.h:89">ngx_hash_keys_arrays_t</a>&nbsp; &nbsp; &nbsp; ha;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L224" title="http/ngx_http_core_module.h:224">ngx_http_server_name_t</a>&nbsp; &nbsp;&nbsp; *name;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a>&nbsp; **cscfp;<br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; regex, i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; regex = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;ha, <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L89" title="core/ngx_hash.h:89">ngx_hash_keys_arrays_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ha.temp_pool = <a href="../core/ngx_palloc.c.html#L17" title="core/ngx_palloc.c:17">ngx_create_pool</a>(<a href="../core/ngx_palloc.h.html#L22" title="core/ngx_palloc.h:22">NGX_DEFAULT_POOL_SIZE</a>, cf-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ha.temp_pool == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ha.pool = cf-&gt;pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_hash.c.html#L651" title="core/ngx_hash.c:651">ngx_hash_keys_array_init</a>(&amp;ha, <a href="../core/ngx_hash.h.html#L66" title="core/ngx_hash.h:66">NGX_HASH_LARGE</a>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cscfp = addr-&gt;servers.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (s = <span class="Constant">0</span>; s &lt; addr-&gt;servers.nelts; s++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name = cscfp[s]-&gt;server_names.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n &lt; cscfp[s]-&gt;server_names.nelts; n++) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (name[n].regex) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; regex++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../core/ngx_hash.c.html#L706" title="core/ngx_hash.c:706">ngx_hash_add_key</a>(&amp;ha, &amp;name[n].name, name[n].server,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L71" title="core/ngx_hash.h:71">NGX_HASH_WILDCARD_KEY</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;invalid server name or wildcard </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> on </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;name[n].name, addr-&gt;opt.addr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L32" title="core/ngx_core.h:32">NGX_BUSY</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;conflicting server name </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> on </span><span class="Special">%s</span><span class="Constant">, ignored&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;name[n].name, addr-&gt;opt.addr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hash.key = <a href="../core/ngx_hash.c.html#L618" title="core/ngx_hash.c:618">ngx_hash_key_lc</a>;<br/></li>
<li>&nbsp; &nbsp; hash.max_size = cmcf-&gt;server_names_hash_max_size;<br/></li>
<li>&nbsp; &nbsp; hash.bucket_size = cmcf-&gt;server_names_hash_bucket_size;<br/></li>
<li>&nbsp; &nbsp; hash.name = <span class="Constant">&quot;server_names_hash&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; hash.pool = cf-&gt;pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ha.keys.nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.hash = &amp;addr-&gt;hash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.temp_pool = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_hash.c.html#L252" title="core/ngx_hash.c:252">ngx_hash_init</a>(&amp;hash, ha.keys.elts, ha.keys.nelts) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ha.dns_wc_head.nelts) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L227" title="core/ngx_string.h:227">ngx_qsort</a>(ha.dns_wc_head.elts, (<span class="Type">size_t</span>) ha.dns_wc_head.nelts,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L39" title="core/ngx_hash.h:39">ngx_hash_key_t</a>), <a href="#L1660" title="http/ngx_http.c:1660">ngx_http_cmp_dns_wildcards</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.hash = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.temp_pool = ha.temp_pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_hash.c.html#L458" title="core/ngx_hash.c:458">ngx_hash_wildcard_init</a>(&amp;hash, ha.dns_wc_head.elts,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ha.dns_wc_head.nelts)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr-&gt;wc_head = (<a href="../core/ngx_hash.h.html#L32" title="core/ngx_hash.h:32">ngx_hash_wildcard_t</a> *) hash.hash;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ha.dns_wc_tail.nelts) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L227" title="core/ngx_string.h:227">ngx_qsort</a>(ha.dns_wc_tail.elts, (<span class="Type">size_t</span>) ha.dns_wc_tail.nelts,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L39" title="core/ngx_hash.h:39">ngx_hash_key_t</a>), <a href="#L1660" title="http/ngx_http.c:1660">ngx_http_cmp_dns_wildcards</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.hash = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.temp_pool = ha.temp_pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_hash.c.html#L458" title="core/ngx_hash.c:458">ngx_hash_wildcard_init</a>(&amp;hash, ha.dns_wc_tail.elts,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ha.dns_wc_tail.nelts)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr-&gt;wc_tail = (<a href="../core/ngx_hash.h.html#L32" title="core/ngx_hash.h:32">ngx_hash_wildcard_t</a> *) hash.hash;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L45" title="core/ngx_palloc.c:45">ngx_destroy_pool</a>(ha.temp_pool);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (regex == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; addr-&gt;nregex = regex;<br/></li>
<li>&nbsp; &nbsp; addr-&gt;regex = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(cf-&gt;pool, regex * <span class="Statement">sizeof</span>(<a href="ngx_http_core_module.h.html#L224" title="http/ngx_http_core_module.h:224">ngx_http_server_name_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (addr-&gt;regex == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (s = <span class="Constant">0</span>; s &lt; addr-&gt;servers.nelts; s++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name = cscfp[s]-&gt;server_names.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n &lt; cscfp[s]-&gt;server_names.nelts; n++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (name[n].regex) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr-&gt;regex[i++] = name[n];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L45" title="core/ngx_palloc.c:45">ngx_destroy_pool</a>(ha.temp_pool);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1626">&#x200c;</a><span class="linkable">ngx_http_cmp_conf_addrs</span>(<span class="Type">const</span> <span class="Type">void</span> *one, <span class="Type">const</span> <span class="Type">void</span> *two)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a>&nbsp; *first, *second;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; first = (<a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a> *) one;<br/></li>
<li>&nbsp; &nbsp; second = (<a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a> *) two;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (first-&gt;opt.wildcard) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* a wildcard address must be the last resort, shift it to the end */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (second-&gt;opt.wildcard) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* a wildcard address must be the last resort, shift it to the end */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (first-&gt;opt.bind &amp;&amp; !second-&gt;opt.bind) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* shift explicit bind()ed addresses to the start */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!first-&gt;opt.bind &amp;&amp; second-&gt;opt.bind) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* shift explicit bind()ed addresses to the start */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* do not sort by default */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">int</span> <a href="../core/ngx_config.h.html#L74" title="core/ngx_config.h:74">ngx_libc_cdecl</a><br/></li>
<li><a id="L1660">&#x200c;</a><span class="linkable">ngx_http_cmp_dns_wildcards</span>(<span class="Type">const</span> <span class="Type">void</span> *one, <span class="Type">const</span> <span class="Type">void</span> *two)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L39" title="core/ngx_hash.h:39">ngx_hash_key_t</a>&nbsp; *first, *second;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; first = (<a href="../core/ngx_hash.h.html#L39" title="core/ngx_hash.h:39">ngx_hash_key_t</a> *) one;<br/></li>
<li>&nbsp; &nbsp; second = (<a href="../core/ngx_hash.h.html#L39" title="core/ngx_hash.h:39">ngx_hash_key_t</a> *) two;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_string.c.html#L827" title="core/ngx_string.c:827">ngx_dns_strcmp</a>(first-&gt;key.data, second-&gt;key.data);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1672">&#x200c;</a><span class="linkable">ngx_http_init_listening</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L278" title="http/ngx_http_core_module.h:278">ngx_http_conf_port_t</a> *port)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i, last, bind_wildcard;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_connection.h.html#L16" title="core/ngx_connection.h:16">ngx_listening_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ls;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L271" title="http/ngx_http_core_module.h:271">ngx_http_port_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *hport;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a>&nbsp; &nbsp; &nbsp; *addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; addr = port-&gt;addrs.elts;<br/></li>
<li>&nbsp; &nbsp; last = port-&gt;addrs.nelts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If there is a binding to an &quot;*:port&quot; then we need to bind() to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the &quot;*:port&quot; only and ignore other implicit bindings.&nbsp; The bindings<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * have been already sorted: explicit bindings are on the start, then<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * implicit bindings go, and wildcard binding is in the end.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (addr[last - <span class="Constant">1</span>].opt.wildcard) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr[last - <span class="Constant">1</span>].opt.bind = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bind_wildcard = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bind_wildcard = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (i &lt; last) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bind_wildcard &amp;&amp; !addr[i].opt.bind) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ls = <a href="#L1751" title="http/ngx_http.c:1751">ngx_http_add_listening</a>(cf, &amp;addr[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ls == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hport = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_core_module.h.html#L271" title="http/ngx_http_core_module.h:271">ngx_http_port_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hport == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ls-&gt;servers = hport;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i == last - <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hport-&gt;naddrs = last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hport-&gt;naddrs = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ls-&gt;sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1890" title="http/ngx_http.c:1890">ngx_http_add_addrs6</a>(cf, hport, addr) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1825" title="http/ngx_http.c:1825">ngx_http_add_addrs</a>(cf, hport, addr) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_connection.h.html#L16" title="core/ngx_connection.h:16">ngx_listening_t</a> *<br/></li>
<li><a id="L1751">&#x200c;</a><span class="linkable">ngx_http_add_listening</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a> *addr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_connection.h.html#L16" title="core/ngx_connection.h:16">ngx_listening_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ls;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a>&nbsp; *cscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ls = <a href="../core/ngx_connection.c.html#L20" title="core/ngx_connection.c:20">ngx_create_listening</a>(cf, &amp;addr-&gt;opt.u.sockaddr, addr-&gt;opt.socklen);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ls == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ls-&gt;addr_ntop = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ls-&gt;handler = <a href="ngx_http_request.c.html#L195" title="http/ngx_http_request.c:195">ngx_http_init_connection</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cscf = addr-&gt;default_server;<br/></li>
<li>&nbsp; &nbsp; ls-&gt;pool_size = cscf-&gt;connection_pool_size;<br/></li>
<li>&nbsp; &nbsp; ls-&gt;post_accept_timeout = cscf-&gt;client_header_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = cscf-&gt;ctx-&gt;loc_conf[<a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>.ctx_index];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ls-&gt;logp = clcf-&gt;error_log;<br/></li>
<li>&nbsp; &nbsp; ls-&gt;log.data = &amp;ls-&gt;addr_text;<br/></li>
<li>&nbsp; &nbsp; ls-&gt;log.handler = <a href="../event/ngx_event_accept.c.html#L504" title="event/ngx_event_accept.c:504">ngx_accept_log_error</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_WIN32)<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; ngx_iocp_conf_t&nbsp; *iocpcf = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_conf_file.h.html#L217" title="core/ngx_conf_file.h:217">ngx_get_conf</a>(cf-&gt;cycle-&gt;conf_ctx, <a href="../event/ngx_event.c.html#L102" title="event/ngx_event.c:102">ngx_events_module</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; iocpcf = <a href="../event/ngx_event.h.html#L505" title="event/ngx_event.h:505">ngx_event_get_conf</a>(cf-&gt;cycle-&gt;conf_ctx, ngx_iocp_module);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (iocpcf &amp;&amp; iocpcf-&gt;acceptex_read) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ls-&gt;post_accept_buffer_size = cscf-&gt;client_header_buffer_size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ls-&gt;backlog = addr-&gt;opt.backlog;<br/></li>
<li>&nbsp; &nbsp; ls-&gt;rcvbuf = addr-&gt;opt.rcvbuf;<br/></li>
<li>&nbsp; &nbsp; ls-&gt;sndbuf = addr-&gt;opt.sndbuf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ls-&gt;keepalive = addr-&gt;opt.so_keepalive;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_KEEPALIVE_TUNABLE)<br/></li>
<li></span>&nbsp; &nbsp; ls-&gt;keepidle = addr-&gt;opt.tcp_keepidle;<br/></li>
<li>&nbsp; &nbsp; ls-&gt;keepintvl = addr-&gt;opt.tcp_keepintvl;<br/></li>
<li>&nbsp; &nbsp; ls-&gt;keepcnt = addr-&gt;opt.tcp_keepcnt;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)<br/></li>
<li></span>&nbsp; &nbsp; ls-&gt;accept_filter = addr-&gt;opt.accept_filter;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined TCP_DEFER_ACCEPT)<br/></li>
<li></span>&nbsp; &nbsp; ls-&gt;deferred_accept = addr-&gt;opt.deferred_accept;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6 &amp;&amp; defined IPV6_V6ONLY)<br/></li>
<li></span>&nbsp; &nbsp; ls-&gt;ipv6only = addr-&gt;opt.ipv6only;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_SETFIB)<br/></li>
<li></span>&nbsp; &nbsp; ls-&gt;setfib = addr-&gt;opt.setfib;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_TCP_FASTOPEN)<br/></li>
<li></span>&nbsp; &nbsp; ls-&gt;fastopen = addr-&gt;opt.fastopen;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> ls;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1825">&#x200c;</a><span class="linkable">ngx_http_add_addrs</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L271" title="http/ngx_http_core_module.h:271">ngx_http_port_t</a> *hport,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a> *addr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L254" title="http/ngx_http_core_module.h:254">ngx_http_in_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *addrs;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp; &nbsp; &nbsp; &nbsp; *sin;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L232" title="http/ngx_http_core_module.h:232">ngx_http_virtual_names_t</a>&nbsp; *vn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hport-&gt;addrs = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; hport-&gt;naddrs * <span class="Statement">sizeof</span>(<a href="ngx_http_core_module.h.html#L254" title="http/ngx_http_core_module.h:254">ngx_http_in_addr_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hport-&gt;addrs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; addrs = hport-&gt;addrs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; hport-&gt;naddrs; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sin = &amp;addr[i].opt.u.sockaddr_in;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addrs[i].addr = sin-&gt;sin_addr.s_addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addrs[i].conf.default_server = addr[i].default_server;<br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; addrs[i].conf.ssl = addr[i].opt.ssl;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#if (NGX_HTTP_SPDY)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; addrs[i].conf.spdy = addr[i].opt.spdy;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; addrs[i].conf.proxy_protocol = addr[i].opt.proxy_protocol;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr[i].hash.buckets == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (addr[i].wc_head == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || addr[i].wc_head-&gt;hash.buckets == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (addr[i].wc_tail == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || addr[i].wc_tail-&gt;hash.buckets == <span class="Constant">NULL</span>)<br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; addr[i].nregex == <span class="Constant">0<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; vn = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_core_module.h.html#L232" title="http/ngx_http_core_module.h:232">ngx_http_virtual_names_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (vn == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addrs[i].conf.virtual_names = vn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; vn-&gt;names.hash = addr[i].hash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; vn-&gt;names.wc_head = addr[i].wc_head;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; vn-&gt;names.wc_tail = addr[i].wc_tail;<br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; vn-&gt;nregex = addr[i].nregex;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; vn-&gt;regex = addr[i].regex;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1890">&#x200c;</a><span class="linkable">ngx_http_add_addrs6</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_http_core_module.h.html#L271" title="http/ngx_http_core_module.h:271">ngx_http_port_t</a> *hport,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L296" title="http/ngx_http_core_module.h:296">ngx_http_conf_addr_t</a> *addr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L262" title="http/ngx_http_core_module.h:262">ngx_http_in6_addr_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *addrs6;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in6&nbsp; &nbsp; &nbsp;&nbsp; *sin6;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L232" title="http/ngx_http_core_module.h:232">ngx_http_virtual_names_t</a>&nbsp; *vn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hport-&gt;addrs = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; hport-&gt;naddrs * <span class="Statement">sizeof</span>(<a href="ngx_http_core_module.h.html#L262" title="http/ngx_http_core_module.h:262">ngx_http_in6_addr_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hport-&gt;addrs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; addrs6 = hport-&gt;addrs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; hport-&gt;naddrs; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sin6 = &amp;addr[i].opt.u.sockaddr_in6;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addrs6[i].addr6 = sin6-&gt;sin6_addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addrs6[i].conf.default_server = addr[i].default_server;<br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; addrs6[i].conf.ssl = addr[i].opt.ssl;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#if (NGX_HTTP_SPDY)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; addrs6[i].conf.spdy = addr[i].opt.spdy;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr[i].hash.buckets == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (addr[i].wc_head == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || addr[i].wc_head-&gt;hash.buckets == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (addr[i].wc_tail == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || addr[i].wc_tail-&gt;hash.buckets == <span class="Constant">NULL</span>)<br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; addr[i].nregex == <span class="Constant">0<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; vn = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_core_module.h.html#L232" title="http/ngx_http_core_module.h:232">ngx_http_virtual_names_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (vn == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addrs6[i].conf.virtual_names = vn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; vn-&gt;names.hash = addr[i].hash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; vn-&gt;names.wc_head = addr[i].wc_head;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; vn-&gt;names.wc_tail = addr[i].wc_tail;<br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; vn-&gt;nregex = addr[i].nregex;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; vn-&gt;regex = addr[i].regex;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">char</span> *<br/></li>
<li><a id="L1954">&#x200c;</a><span class="linkable">ngx_http_types_slot</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; *p = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp;&nbsp; **types;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *value, *default_type;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; i, n, hash;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L39" title="core/ngx_hash.h:39">ngx_hash_key_t</a>&nbsp;&nbsp; *type;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; types = (<a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> **) (p + cmd-&gt;offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*types == (<span class="Type">void</span> *) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; default_type = cmd-&gt;post;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*types == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *types = <a href="../core/ngx_array.c.html#L13" title="core/ngx_array.c:13">ngx_array_create</a>(cf-&gt;temp_pool, <span class="Constant">1</span>, <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L39" title="core/ngx_hash.h:39">ngx_hash_key_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*types == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (default_type) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(*types);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (type == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type-&gt;key = *default_type;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type-&gt;key_hash = <a href="../core/ngx_hash.c.html#L603" title="core/ngx_hash.c:603">ngx_hash_key</a>(default_type-&gt;data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default_type-&gt;len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type-&gt;value = (<span class="Type">void</span> *) <span class="Constant">4</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt; cf-&gt;args-&gt;nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (value[i].len == <span class="Constant">1</span> &amp;&amp; value[i].data[<span class="Constant">0</span>] == <span class="Constant">'*'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *types = (<span class="Type">void</span> *) -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash = <a href="../core/ngx_hash.c.html#L633" title="core/ngx_hash.c:633">ngx_hash_strlow</a>(value[i].data, value[i].data, value[i].len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; value[i].data[value[i].len] = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; type = (*types)-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n &lt; (*types)-&gt;nelts; n++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[i].data, type[n].key.data) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;duplicate MIME type </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; type = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(*types);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (type == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; type-&gt;key = value[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; type-&gt;key_hash = hash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; type-&gt;value = (<span class="Type">void</span> *) <span class="Constant">4</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">next</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">char</span> *<br/></li>
<li><a id="L2031">&#x200c;</a><span class="linkable">ngx_http_merge_types</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> **keys, <a href="../core/ngx_hash.h.html#L26" title="core/ngx_hash.h:26">ngx_hash_t</a> *types_hash,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> **prev_keys, <a href="../core/ngx_hash.h.html#L26" title="core/ngx_hash.h:26">ngx_hash_t</a> *prev_types_hash,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *default_types)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L62" title="core/ngx_hash.h:62">ngx_hash_init_t</a>&nbsp; hash;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*keys) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*keys == (<span class="Type">void</span> *) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.hash = types_hash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.key = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.max_size = <span class="Constant">2048</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.bucket_size = <span class="Constant">64</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.name = <span class="Constant">&quot;test_types_hash&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.pool = cf-&gt;pool;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.temp_pool = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_hash.c.html#L252" title="core/ngx_hash.c:252">ngx_hash_init</a>(&amp;hash, (*keys)-&gt;elts, (*keys)-&gt;nelts) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (prev_types_hash-&gt;buckets == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*prev_keys == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2096" title="http/ngx_http.c:2096">ngx_http_set_default_types</a>(cf, prev_keys, default_types)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (*prev_keys == (<span class="Type">void</span> *) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *keys = *prev_keys;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.hash = prev_types_hash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.key = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.max_size = <span class="Constant">2048</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.bucket_size = <span class="Constant">64</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.name = <span class="Constant">&quot;test_types_hash&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.pool = cf-&gt;pool;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash.temp_pool = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_hash.c.html#L252" title="core/ngx_hash.c:252">ngx_hash_init</a>(&amp;hash, (*prev_keys)-&gt;elts, (*prev_keys)-&gt;nelts)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *types_hash = *prev_types_hash;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li><br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2096">&#x200c;</a><span class="linkable">ngx_http_set_default_types</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> **types,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *default_type)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L39" title="core/ngx_hash.h:39">ngx_hash_key_t</a>&nbsp; *type;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *types = <a href="../core/ngx_array.c.html#L13" title="core/ngx_array.c:13">ngx_array_create</a>(cf-&gt;temp_pool, <span class="Constant">1</span>, <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L39" title="core/ngx_hash.h:39">ngx_hash_key_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*types == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (default_type-&gt;len) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; type = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(*types);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (type == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; type-&gt;key = *default_type;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; type-&gt;key_hash = <a href="../core/ngx_hash.c.html#L603" title="core/ngx_hash.c:603">ngx_hash_key</a>(default_type-&gt;data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default_type-&gt;len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; type-&gt;value = (<span class="Type">void</span> *) <span class="Constant">4</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; default_type++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
