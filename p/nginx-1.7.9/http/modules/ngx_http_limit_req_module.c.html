<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>http/modules/ngx_http_limit_req_module.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>http/modules/ngx_http_limit_req_module.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L91">ngx_http_limit_req_commands</a></li>
<li><a href="#L77">ngx_http_limit_req_log_levels</a></li>
<li><a href="#L140">ngx_http_limit_req_module</a></li>
<li><a href="#L125">ngx_http_limit_req_module_ctx</a></li>
<li><a href="#L86">ngx_http_limit_req_status_bounds</a></li>
</ul>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L56">ngx_http_limit_req_conf_t</a></li>
<li><a href="#L40">ngx_http_limit_req_ctx_t</a></li>
<li><a href="#L48">ngx_http_limit_req_limit_t</a></li>
<li><a href="#L23">ngx_http_limit_req_node_t</a></li>
<li><a href="#L30">ngx_http_limit_req_shctx_t</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L861">ngx_http_limit_req</a></li>
<li><a href="#L482">ngx_http_limit_req_account</a></li>
<li><a href="#L684">ngx_http_limit_req_create_conf</a></li>
<li><a href="#L286">ngx_http_limit_req_delay</a></li>
<li><a href="#L549">ngx_http_limit_req_expire</a></li>
<li><a href="#L157">ngx_http_limit_req_handler</a></li>
<li><a href="#L960">ngx_http_limit_req_init</a></li>
<li><a href="#L618">ngx_http_limit_req_init_zone</a></li>
<li><a href="#L360">ngx_http_limit_req_lookup</a></li>
<li><a href="#L707">ngx_http_limit_req_merge_conf</a></li>
<li><a href="#L319">ngx_http_limit_req_rbtree_insert_value</a></li>
<li><a href="#L730">ngx_http_limit_req_zone</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; color;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; dummy;<br/></li>
<li>&nbsp; &nbsp; u_short&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; queue;<br/></li>
<li>&nbsp; &nbsp; <a href="../../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; last;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* integer value, 1 corresponds to 0.001 r/s */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; excess;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; count;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; data[<span class="Constant">1</span>];<br/></li>
<li><a id="L23">&#x200c;</a>} <span class="linkable">ngx_http_limit_req_node_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L32" title="core/ngx_rbtree.h:32">ngx_rbtree_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rbtree;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; queue;<br/></li>
<li><a id="L30">&#x200c;</a>} <span class="linkable">ngx_http_limit_req_shctx_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="#L30" title="http/modules/ngx_http_limit_req_module.c:30">ngx_http_limit_req_shctx_t</a>&nbsp; *sh;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *shpool;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* integer value, 1 corresponds to 0.001 r/s */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rate;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L71" title="http/ngx_http_script.h:71">ngx_http_complex_value_t</a>&nbsp; &nbsp;&nbsp; key;<br/></li>
<li>&nbsp; &nbsp; <a href="#L23" title="http/modules/ngx_http_limit_req_module.c:23">ngx_http_limit_req_node_t</a>&nbsp;&nbsp; *node;<br/></li>
<li><a id="L40">&#x200c;</a>} <span class="linkable">ngx_http_limit_req_ctx_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_cycle.h.html#L25" title="core/ngx_cycle.h:25">ngx_shm_zone_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *shm_zone;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* integer value, 1 corresponds to 0.001 r/s */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; burst;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; nodelay; <span class="Comment">/* unsigned&nbsp; nodelay:1 */<br/></li>
<li><a id="L48">&#x200c;</a></span>} <span class="linkable">ngx_http_limit_req_limit_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; limits;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; limit_log_level;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; delay_log_level;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; status_code;<br/></li>
<li><a id="L56">&#x200c;</a>} <span class="linkable">ngx_http_limit_req_conf_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L286" title="http/modules/ngx_http_limit_req_module.c:286">ngx_http_limit_req_delay</a>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L360" title="http/modules/ngx_http_limit_req_module.c:360">ngx_http_limit_req_lookup</a>(<a href="#L48" title="http/modules/ngx_http_limit_req_module.c:48">ngx_http_limit_req_limit_t</a> *limit,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> hash, <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *key, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> *<a href="../../event/modules/ngx_epoll_module.c.html#L119" title="event/modules/ngx_epoll_module.c:119">ep</a>, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> account);<br/></li>
<li><span class="Type">static</span> <a href="../../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a> <a href="#L482" title="http/modules/ngx_http_limit_req_module.c:482">ngx_http_limit_req_account</a>(<a href="#L48" title="http/modules/ngx_http_limit_req_module.c:48">ngx_http_limit_req_limit_t</a> *limits,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> n, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> *<a href="../../event/modules/ngx_epoll_module.c.html#L119" title="event/modules/ngx_epoll_module.c:119">ep</a>, <a href="#L48" title="http/modules/ngx_http_limit_req_module.c:48">ngx_http_limit_req_limit_t</a> **limit);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L549" title="http/modules/ngx_http_limit_req_module.c:549">ngx_http_limit_req_expire</a>(<a href="#L40" title="http/modules/ngx_http_limit_req_module.c:40">ngx_http_limit_req_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> n);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L684" title="http/modules/ngx_http_limit_req_module.c:684">ngx_http_limit_req_create_conf</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L707" title="http/modules/ngx_http_limit_req_module.c:707">ngx_http_limit_req_merge_conf</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <span class="Type">void</span> *parent,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *child);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L730" title="http/modules/ngx_http_limit_req_module.c:730">ngx_http_limit_req_zone</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L861" title="http/modules/ngx_http_limit_req_module.c:861">ngx_http_limit_req</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L960" title="http/modules/ngx_http_limit_req_module.c:960">ngx_http_limit_req_init</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L77">&#x200c;</a><span class="Type">static</span> <a href="../../core/ngx_conf_file.h.html#L201" title="core/ngx_conf_file.h:201">ngx_conf_enum_t</a>&nbsp; <span class="linkable">ngx_http_limit_req_log_levels</span>[] = {<br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;info&quot;</span>), <a href="../../core/ngx_log.h.html#L23" title="core/ngx_log.h:23">NGX_LOG_INFO</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;notice&quot;</span>), <a href="../../core/ngx_log.h.html#L22" title="core/ngx_log.h:22">NGX_LOG_NOTICE</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;warn&quot;</span>), <a href="../../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;error&quot;</span>), <a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L41" title="core/ngx_string.h:41">ngx_null_string</a>, <span class="Constant">0</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L86">&#x200c;</a><span class="Type">static</span> <a href="../../core/ngx_conf_file.h.html#L195" title="core/ngx_conf_file.h:195">ngx_conf_num_bounds_t</a>&nbsp; <span class="linkable">ngx_http_limit_req_status_bounds</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L1377" title="core/ngx_conf_file.c:1377">ngx_conf_check_num_bounds</a>, <span class="Constant">400</span>, <span class="Constant">599<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L91">&#x200c;</a><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a>&nbsp; <span class="linkable">ngx_http_limit_req_commands</span>[] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;limit_req_zone&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L25" title="core/ngx_conf_file.h:25">NGX_CONF_TAKE3</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L730" title="http/modules/ngx_http_limit_req_module.c:730">ngx_http_limit_req_zone</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;limit_req&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L38" title="core/ngx_conf_file.h:38">NGX_CONF_TAKE123</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L861" title="http/modules/ngx_http_limit_req_module.c:861">ngx_http_limit_req</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;limit_req_log_level&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L23" title="core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L1269" title="core/ngx_conf_file.c:1269">ngx_conf_set_enum_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L56" title="http/modules/ngx_http_limit_req_module.c:56">ngx_http_limit_req_conf_t</a>, limit_log_level),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &amp;<a href="#L77" title="http/modules/ngx_http_limit_req_module.c:77">ngx_http_limit_req_log_levels</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;limit_req_status&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L23" title="core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L1084" title="core/ngx_conf_file.c:1084">ngx_conf_set_num_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L56" title="http/modules/ngx_http_limit_req_module.c:56">ngx_http_limit_req_conf_t</a>, status_code),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &amp;<a href="#L86" title="http/modules/ngx_http_limit_req_module.c:86">ngx_http_limit_req_status_bounds</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L87" title="core/ngx_conf_file.h:87">ngx_null_command</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L125">&#x200c;</a><span class="Type">static</span> <a href="../ngx_http_config.h.html#L36" title="http/ngx_http_config.h:36">ngx_http_module_t</a>&nbsp; <span class="linkable">ngx_http_limit_req_module_ctx</span> = {<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* preconfiguration */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L960" title="http/modules/ngx_http_limit_req_module.c:960">ngx_http_limit_req_init</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* postconfiguration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create <a href="../../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init <a href="../../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create server configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge server configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L684" title="http/modules/ngx_http_limit_req_module.c:684">ngx_http_limit_req_create_conf</a>,&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create location configuration */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L707" title="http/modules/ngx_http_limit_req_module.c:707">ngx_http_limit_req_merge_conf</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge location configuration */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L140">&#x200c;</a><a href="../../core/ngx_core.h.html#L12" title="core/ngx_core.h:12">ngx_module_t</a>&nbsp; <span class="linkable">ngx_http_limit_req_module</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L99" title="core/ngx_conf_file.h:99">NGX_MODULE_V1</a>,<br/></li>
<li>&nbsp; &nbsp; &amp;<a href="#L125" title="http/modules/ngx_http_limit_req_module.c:125">ngx_http_limit_req_module_ctx</a>,&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* module context */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L91" title="http/modules/ngx_http_limit_req_module.c:91">ngx_http_limit_req_commands</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module directives */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../ngx_http_config.h.html#L39" title="http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module type */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init master */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init module */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit master */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L100" title="core/ngx_conf_file.h:100">NGX_MODULE_V1_PADDING</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L157">&#x200c;</a><span class="linkable">ngx_http_limit_req_handler</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; key;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n, excess;<br/></li>
<li>&nbsp; &nbsp; <a href="../../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; delay;<br/></li>
<li>&nbsp; &nbsp; <a href="#L40" title="http/modules/ngx_http_limit_req_module.c:40">ngx_http_limit_req_ctx_t</a>&nbsp; &nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="#L56" title="http/modules/ngx_http_limit_req_module.c:56">ngx_http_limit_req_conf_t</a>&nbsp;&nbsp; *lrcf;<br/></li>
<li>&nbsp; &nbsp; <a href="#L48" title="http/modules/ngx_http_limit_req_module.c:48">ngx_http_limit_req_limit_t</a>&nbsp; *limit, *limits;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;<a href="../../core/nginx.c.html#L202" title="core/nginx.c:202">main</a>-&gt;limit_req_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lrcf = <a href="../ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="#L140" title="http/modules/ngx_http_limit_req_module.c:140">ngx_http_limit_req_module</a>);<br/></li>
<li>&nbsp; &nbsp; limits = lrcf-&gt;limits.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; excess = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_SUPPRESS_WARN)<br/></li>
<li></span>&nbsp; &nbsp; limit = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n &lt; lrcf-&gt;limits.nelts; n++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; limit = &amp;limits[n];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = limit-&gt;shm_zone-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_script.c.html#L58" title="http/ngx_http_script.c:58">ngx_http_complex_value</a>(r, &amp;ctx-&gt;key, &amp;key) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (key.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (key.len &gt; <span class="Constant">65535</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;the value of the </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> key &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;is more than 65535 bytes: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;ctx-&gt;key.value, &amp;key);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash = <a href="../../core/ngx_crc32.h.html#L21" title="core/ngx_crc32.h:21">ngx_crc32_short</a>(key.data, key.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_shmtx.c.html#L70" title="core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;ctx-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L360" title="http/modules/ngx_http_limit_req_module.c:360">ngx_http_limit_req_lookup</a>(limit, hash, &amp;key, &amp;excess,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (n == lrcf-&gt;limits.nelts - <span class="Constant">1</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_shmtx.c.html#L136" title="core/ngx_shmtx.c:136">ngx_shmtx_unlock</a>(&amp;ctx-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L144" title="core/ngx_log.h:144">ngx_log_debug4</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;limit_req[</span><span class="Special">%u</span><span class="Constant">i]: </span><span class="Special">%i</span><span class="Constant"> </span><span class="Special">%u</span><span class="Constant">i.</span><span class="Special">%03u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n, rc, excess / <span class="Constant">1000</span>, excess % <span class="Constant">1000</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;<a href="../../core/nginx.c.html#L202" title="core/nginx.c:202">main</a>-&gt;limit_req_set = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L32" title="core/ngx_core.h:32">NGX_BUSY</a> || rc == <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L32" title="core/ngx_core.h:32">NGX_BUSY</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(lrcf-&gt;limit_log_level, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;limiting requests, excess: </span><span class="Special">%u</span><span class="Constant">i.</span><span class="Special">%03u</span><span class="Constant">i by zone </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; excess / <span class="Constant">1000</span>, excess % <span class="Constant">1000</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;limit-&gt;shm_zone-&gt;shm.name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (n--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = limits[n].shm_zone-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;node == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_shmtx.c.html#L70" title="core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;ctx-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;node-&gt;count--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_shmtx.c.html#L136" title="core/ngx_shmtx.c:136">ngx_shmtx_unlock</a>(&amp;ctx-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;node = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> lrcf-&gt;status_code;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* rc == <a href="../../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a> || rc == <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; excess = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; delay = <a href="#L482" title="http/modules/ngx_http_limit_req_module.c:482">ngx_http_limit_req_account</a>(limits, n, &amp;excess, &amp;limit);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!delay) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(lrcf-&gt;delay_log_level, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;delaying request, excess: </span><span class="Special">%u</span><span class="Constant">i.</span><span class="Special">%03u</span><span class="Constant">i, by zone </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; excess / <span class="Constant">1000</span>, excess % <span class="Constant">1000</span>, &amp;limit-&gt;shm_zone-&gt;shm.name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../event/ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(r-&gt;connection-&gt;read, <span class="Constant">0</span>) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;read_event_handler = <a href="../ngx_http_request.c.html#L2709" title="http/ngx_http_request.c:2709">ngx_http_test_reading</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;write_event_handler = <a href="#L286" title="http/modules/ngx_http_limit_req_module.c:286">ngx_http_limit_req_delay</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(r-&gt;connection-&gt;write, delay);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L286">&#x200c;</a></span><span class="linkable">ngx_http_limit_req_delay</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a>&nbsp; *wev;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;limit_req delay&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; wev = r-&gt;connection-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!wev-&gt;timedout) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../event/ngx_event.c.html#L338" title="event/ngx_event.c:338">ngx_handle_write_event</a>(wev, <span class="Constant">0</span>) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; wev-&gt;timedout = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../event/ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(r-&gt;connection-&gt;read, <span class="Constant">0</span>) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;read_event_handler = <a href="../ngx_http_request.c.html#L2691" title="http/ngx_http_request.c:2691">ngx_http_block_reading</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;write_event_handler = <a href="../ngx_http_core_module.c.html#L876" title="http/ngx_http_core_module.c:876">ngx_http_core_run_phases</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.c.html#L876" title="http/ngx_http_core_module.c:876">ngx_http_core_run_phases</a>(r);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L319">&#x200c;</a></span><span class="linkable">ngx_http_limit_req_rbtree_insert_value</span>(<a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; **p;<br/></li>
<li>&nbsp; &nbsp; <a href="#L23" title="http/modules/ngx_http_limit_req_module.c:23">ngx_http_limit_req_node_t</a>&nbsp;&nbsp; *lrn, *lrnt;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;key &lt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;left;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (node-&gt;key &gt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;right;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* node-&gt;key == temp-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lrn = (<a href="#L23" title="http/modules/ngx_http_limit_req_module.c:23">ngx_http_limit_req_node_t</a> *) &amp;node-&gt;color;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lrnt = (<a href="#L23" title="http/modules/ngx_http_limit_req_module.c:23">ngx_http_limit_req_node_t</a> *) &amp;temp-&gt;color;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (<a href="../../core/ngx_string.c.html#L802" title="core/ngx_string.c:802">ngx_memn2cmp</a>(lrn-&gt;data, lrnt-&gt;data, lrn-&gt;len, lrnt-&gt;len) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ? &amp;temp-&gt;left : &amp;temp-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == sentinel) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; temp = *p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p = node;<br/></li>
<li>&nbsp; &nbsp; node-&gt;parent = temp;<br/></li>
<li>&nbsp; &nbsp; node-&gt;left = sentinel;<br/></li>
<li>&nbsp; &nbsp; node-&gt;right = sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L59" title="core/ngx_rbtree.h:59">ngx_rbt_red</a>(node);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L360">&#x200c;</a><span class="linkable">ngx_http_limit_req_lookup</span>(<a href="#L48" title="http/modules/ngx_http_limit_req_module.c:48">ngx_http_limit_req_limit_t</a> *limit, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> hash,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *key, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> *<a href="../../event/modules/ngx_epoll_module.c.html#L119" title="event/modules/ngx_epoll_module.c:119">ep</a>, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> account)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc, excess;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_times.h.html#L20" title="core/ngx_times.h:20">ngx_time_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *tp;<br/></li>
<li>&nbsp; &nbsp; <a href="../../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; now;<br/></li>
<li>&nbsp; &nbsp; <a href="../../os/unix/ngx_time.h.html#L17" title="os/unix/ngx_time.h:17">ngx_msec_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ms;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *node, *sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="#L40" title="http/modules/ngx_http_limit_req_module.c:40">ngx_http_limit_req_ctx_t</a>&nbsp;&nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="#L23" title="http/modules/ngx_http_limit_req_module.c:23">ngx_http_limit_req_node_t</a>&nbsp; *lr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tp = <a href="../../core/ngx_times.h.html#L37" title="core/ngx_times.h:37">ngx_timeofday</a>();<br/></li>
<li>&nbsp; &nbsp; now = (<a href="../../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>) (tp-&gt;sec * <span class="Constant">1000</span> + tp-&gt;msec);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = limit-&gt;shm_zone-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = ctx-&gt;sh-&gt;rbtree.root;<br/></li>
<li>&nbsp; &nbsp; sentinel = ctx-&gt;sh-&gt;rbtree.sentinel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (node != sentinel) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &lt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;left;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &gt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* hash == node-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lr = (<a href="#L23" title="http/modules/ngx_http_limit_req_module.c:23">ngx_http_limit_req_node_t</a> *) &amp;node-&gt;color;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../../core/ngx_string.c.html#L802" title="core/ngx_string.c:802">ngx_memn2cmp</a>(key-&gt;data, lr-&gt;data, key-&gt;len, (<span class="Type">size_t</span>) lr-&gt;len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;lr-&gt;queue);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L33" title="core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;ctx-&gt;sh-&gt;queue, &amp;lr-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ms = (<a href="../../os/unix/ngx_time.h.html#L17" title="os/unix/ngx_time.h:17">ngx_msec_int_t</a>) (now - lr-&gt;last);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; excess = lr-&gt;excess - ctx-&gt;rate * <a href="../../core/ngx_core.h.html#L89" title="core/ngx_core.h:89">ngx_abs</a>(ms) / <span class="Constant">1000</span> + <span class="Constant">1000</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (excess &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; excess = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *<a href="../../event/modules/ngx_epoll_module.c.html#L119" title="event/modules/ngx_epoll_module.c:119">ep</a> = excess;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) excess &gt; limit-&gt;burst) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L32" title="core/ngx_core.h:32">NGX_BUSY</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (account) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lr-&gt;excess = excess;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lr-&gt;last = now;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lr-&gt;count++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;node = lr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = (rc &lt; <span class="Constant">0</span>) ? node-&gt;left : node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *<a href="../../event/modules/ngx_epoll_module.c.html#L119" title="event/modules/ngx_epoll_module.c:119">ep</a> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = offsetof(<a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>, color)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + offsetof(<a href="#L23" title="http/modules/ngx_http_limit_req_module.c:23">ngx_http_limit_req_node_t</a>, data)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + key-&gt;len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L549" title="http/modules/ngx_http_limit_req_module.c:549">ngx_http_limit_req_expire</a>(ctx, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = <a href="../../core/ngx_slab.c.html#L156" title="core/ngx_slab.c:156">ngx_slab_alloc_locked</a>(ctx-&gt;shpool, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (node == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L549" title="http/modules/ngx_http_limit_req_module.c:549">ngx_http_limit_req_expire</a>(ctx, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = <a href="../../core/ngx_slab.c.html#L156" title="core/ngx_slab.c:156">ngx_slab_alloc_locked</a>(ctx-&gt;shpool, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, <a href="../../core/ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;could not allocate node</span><span class="Special">%s</span><span class="Constant">&quot;</span>, ctx-&gt;shpool-&gt;log_ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node-&gt;key = hash;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lr = (<a href="#L23" title="http/modules/ngx_http_limit_req_module.c:23">ngx_http_limit_req_node_t</a> *) &amp;node-&gt;color;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lr-&gt;len = (u_short) key-&gt;len;<br/></li>
<li>&nbsp; &nbsp; lr-&gt;excess = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(lr-&gt;data, key-&gt;data, key-&gt;len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.c.html#L25" title="core/ngx_rbtree.c:25">ngx_rbtree_insert</a>(&amp;ctx-&gt;sh-&gt;rbtree, node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L33" title="core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;ctx-&gt;sh-&gt;queue, &amp;lr-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (account) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lr-&gt;last = now;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lr-&gt;count = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lr-&gt;last = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; lr-&gt;count = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;node = lr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a><br/></li>
<li><a id="L482">&#x200c;</a><span class="linkable">ngx_http_limit_req_account</span>(<a href="#L48" title="http/modules/ngx_http_limit_req_module.c:48">ngx_http_limit_req_limit_t</a> *limits, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> n,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> *<a href="../../event/modules/ngx_epoll_module.c.html#L119" title="event/modules/ngx_epoll_module.c:119">ep</a>, <a href="#L48" title="http/modules/ngx_http_limit_req_module.c:48">ngx_http_limit_req_limit_t</a> **limit)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; excess;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_times.h.html#L20" title="core/ngx_times.h:20">ngx_time_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *tp;<br/></li>
<li>&nbsp; &nbsp; <a href="../../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; now, delay, max_delay;<br/></li>
<li>&nbsp; &nbsp; <a href="../../os/unix/ngx_time.h.html#L17" title="os/unix/ngx_time.h:17">ngx_msec_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ms;<br/></li>
<li>&nbsp; &nbsp; <a href="#L40" title="http/modules/ngx_http_limit_req_module.c:40">ngx_http_limit_req_ctx_t</a>&nbsp;&nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="#L23" title="http/modules/ngx_http_limit_req_module.c:23">ngx_http_limit_req_node_t</a>&nbsp; *lr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; excess = *<a href="../../event/modules/ngx_epoll_module.c.html#L119" title="event/modules/ngx_epoll_module.c:119">ep</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (excess == <span class="Constant">0</span> || (*limit)-&gt;nodelay) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; max_delay = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = (*limit)-&gt;shm_zone-&gt;data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; max_delay = excess * <span class="Constant">1000</span> / ctx-&gt;rate;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (n--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = limits[n].shm_zone-&gt;data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lr = ctx-&gt;node;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (lr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_shmtx.c.html#L70" title="core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;ctx-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tp = <a href="../../core/ngx_times.h.html#L37" title="core/ngx_times.h:37">ngx_timeofday</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; now = (<a href="../../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>) (tp-&gt;sec * <span class="Constant">1000</span> + tp-&gt;msec);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ms = (<a href="../../os/unix/ngx_time.h.html#L17" title="os/unix/ngx_time.h:17">ngx_msec_int_t</a>) (now - lr-&gt;last);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; excess = lr-&gt;excess - ctx-&gt;rate * <a href="../../core/ngx_core.h.html#L89" title="core/ngx_core.h:89">ngx_abs</a>(ms) / <span class="Constant">1000</span> + <span class="Constant">1000</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (excess &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; excess = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lr-&gt;last = now;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lr-&gt;excess = excess;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lr-&gt;count--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_shmtx.c.html#L136" title="core/ngx_shmtx.c:136">ngx_shmtx_unlock</a>(&amp;ctx-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;node = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (limits[n].nodelay) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; delay = excess * <span class="Constant">1000</span> / ctx-&gt;rate;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (delay &gt; max_delay) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; max_delay = delay;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *<a href="../../event/modules/ngx_epoll_module.c.html#L119" title="event/modules/ngx_epoll_module.c:119">ep</a> = excess;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *limit = &amp;limits[n];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> max_delay;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L549">&#x200c;</a></span><span class="linkable">ngx_http_limit_req_expire</span>(<a href="#L40" title="http/modules/ngx_http_limit_req_module.c:40">ngx_http_limit_req_ctx_t</a> *ctx, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; excess;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_times.h.html#L20" title="core/ngx_times.h:20">ngx_time_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *tp;<br/></li>
<li>&nbsp; &nbsp; <a href="../../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; now;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="../../os/unix/ngx_time.h.html#L17" title="os/unix/ngx_time.h:17">ngx_msec_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ms;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *node;<br/></li>
<li>&nbsp; &nbsp; <a href="#L23" title="http/modules/ngx_http_limit_req_module.c:23">ngx_http_limit_req_node_t</a>&nbsp; *lr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tp = <a href="../../core/ngx_times.h.html#L37" title="core/ngx_times.h:37">ngx_timeofday</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; now = (<a href="../../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>) (tp-&gt;sec * <span class="Constant">1000</span> + tp-&gt;msec);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * n == 1 deletes one or two zero rate entries<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * n == 0 deletes oldest entry by force<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp; &nbsp; &nbsp; and one or two zero rate entries<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (n &lt; <span class="Constant">3</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_queue.h.html#L29" title="core/ngx_queue.h:29">ngx_queue_empty</a>(&amp;ctx-&gt;sh-&gt;queue)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; q = <a href="../../core/ngx_queue.h.html#L54" title="core/ngx_queue.h:54">ngx_queue_last</a>(&amp;ctx-&gt;sh-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lr = <a href="../../core/ngx_queue.h.html#L103" title="core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="#L23" title="http/modules/ngx_http_limit_req_module.c:23">ngx_http_limit_req_node_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (lr-&gt;count) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * There is not much sense in looking further,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * because we bump nodes on the lookup stage.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n++ != <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ms = (<a href="../../os/unix/ngx_time.h.html#L17" title="os/unix/ngx_time.h:17">ngx_msec_int_t</a>) (now - lr-&gt;last);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ms = <a href="../../core/ngx_core.h.html#L89" title="core/ngx_core.h:89">ngx_abs</a>(ms);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ms &lt; <span class="Constant">60000</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; excess = lr-&gt;excess - ctx-&gt;rate * ms / <span class="Constant">1000</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (excess &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = (<a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((u_char *) lr - offsetof(<a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>, color));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;ctx-&gt;sh-&gt;rbtree, node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_slab.c.html#L442" title="core/ngx_slab.c:442">ngx_slab_free_locked</a>(ctx-&gt;shpool, node);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L618">&#x200c;</a><span class="linkable">ngx_http_limit_req_init_zone</span>(<a href="../../core/ngx_cycle.h.html#L25" title="core/ngx_cycle.h:25">ngx_shm_zone_t</a> *shm_zone, <span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L40" title="http/modules/ngx_http_limit_req_module.c:40">ngx_http_limit_req_ctx_t</a>&nbsp; *octx = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="#L40" title="http/modules/ngx_http_limit_req_module.c:40">ngx_http_limit_req_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = shm_zone-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (octx) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;key.value.len != octx-&gt;key.value.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || <a href="../../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(ctx-&gt;key.value.data, octx-&gt;key.value.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ctx-&gt;key.value.len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, shm_zone-&gt;shm.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;limit_req </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> uses the </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> key &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;while previously it used the </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> key&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;shm_zone-&gt;shm.name, &amp;ctx-&gt;key.value,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;octx-&gt;key.value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;sh = octx-&gt;sh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;shpool = octx-&gt;shpool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;shpool = (<a href="../../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *) shm_zone-&gt;shm.addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shm_zone-&gt;shm.exists) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;sh = ctx-&gt;shpool-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;sh = <a href="../../core/ngx_slab.c.html#L141" title="core/ngx_slab.c:141">ngx_slab_alloc</a>(ctx-&gt;shpool, <span class="Statement">sizeof</span>(<a href="#L30" title="http/modules/ngx_http_limit_req_module.c:30">ngx_http_limit_req_shctx_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;sh == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;shpool-&gt;data = ctx-&gt;sh;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L44" title="core/ngx_rbtree.h:44">ngx_rbtree_init</a>(&amp;ctx-&gt;sh-&gt;rbtree, &amp;ctx-&gt;sh-&gt;sentinel,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L319" title="http/modules/ngx_http_limit_req_module.c:319">ngx_http_limit_req_rbtree_insert_value</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L24" title="core/ngx_queue.h:24">ngx_queue_init</a>(&amp;ctx-&gt;sh-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<span class="Constant">&quot; in limit_req zone </span><span class="Special">\&quot;\&quot;</span><span class="Constant">&quot;</span>) + shm_zone-&gt;shm.name.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;shpool-&gt;log_ctx = <a href="../../core/ngx_slab.c.html#L141" title="core/ngx_slab.c:141">ngx_slab_alloc</a>(ctx-&gt;shpool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;shpool-&gt;log_ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(ctx-&gt;shpool-&gt;log_ctx, <span class="Constant">&quot; in limit_req zone </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">%Z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;shm_zone-&gt;shm.name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;shpool-&gt;log_nomem = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L684">&#x200c;</a><span class="linkable">ngx_http_limit_req_create_conf</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L56" title="http/modules/ngx_http_limit_req_module.c:56">ngx_http_limit_req_conf_t</a>&nbsp; *conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; conf = <a href="../../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L56" title="http/modules/ngx_http_limit_req_module.c:56">ngx_http_limit_req_conf_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> by <a href="../../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>():<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;limits.elts = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; conf-&gt;limit_log_level = <a href="../../core/ngx_conf_file.h.html#L58" title="core/ngx_conf_file.h:58">NGX_CONF_UNSET_UINT</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;status_code = <a href="../../core/ngx_conf_file.h.html#L58" title="core/ngx_conf_file.h:58">NGX_CONF_UNSET_UINT</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> conf;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L707">&#x200c;</a><span class="linkable">ngx_http_limit_req_merge_conf</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <span class="Type">void</span> *parent, <span class="Type">void</span> *child)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L56" title="http/modules/ngx_http_limit_req_module.c:56">ngx_http_limit_req_conf_t</a> *prev = parent;<br/></li>
<li>&nbsp; &nbsp; <a href="#L56" title="http/modules/ngx_http_limit_req_module.c:56">ngx_http_limit_req_conf_t</a> *conf = child;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;limits.elts == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;limits = prev-&gt;limits;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L256" title="core/ngx_conf_file.h:256">ngx_conf_merge_uint_value</a>(conf-&gt;limit_log_level, prev-&gt;limit_log_level,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; conf-&gt;delay_log_level = (conf-&gt;limit_log_level == <a href="../../core/ngx_log.h.html#L23" title="core/ngx_log.h:23">NGX_LOG_INFO</a>) ?<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L23" title="core/ngx_log.h:23">NGX_LOG_INFO</a> : conf-&gt;limit_log_level + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L256" title="core/ngx_conf_file.h:256">ngx_conf_merge_uint_value</a>(conf-&gt;status_code, prev-&gt;status_code,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.h.html#L131" title="http/ngx_http_request.h:131">NGX_HTTP_SERVICE_UNAVAILABLE</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L730">&#x200c;</a><span class="linkable">ngx_http_limit_req_zone</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *value, name, s;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rate, scale;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_cycle.h.html#L25" title="core/ngx_cycle.h:25">ngx_shm_zone_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *shm_zone;<br/></li>
<li>&nbsp; &nbsp; <a href="#L40" title="http/modules/ngx_http_limit_req_module.c:40">ngx_http_limit_req_ctx_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L82" title="http/ngx_http_script.h:82">ngx_http_compile_complex_value_t</a>&nbsp;&nbsp; ccv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="../../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L40" title="http/modules/ngx_http_limit_req_module.c:40">ngx_http_limit_req_ctx_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;ccv, <span class="Statement">sizeof</span>(<a href="../ngx_http_script.h.html#L82" title="http/ngx_http_script.h:82">ngx_http_compile_complex_value_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ccv.cf = cf;<br/></li>
<li>&nbsp; &nbsp; ccv.value = &amp;value[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; ccv.complex_value = &amp;ctx-&gt;key;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_script.c.html#L108" title="http/ngx_http_script.c:108">ngx_http_compile_complex_value</a>(&amp;ccv) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rate = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; scale = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; name.len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">2</span>; i &lt; cf-&gt;args-&gt;nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;zone=&quot;</span>, <span class="Constant">5</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name.data = value[i].data + <span class="Constant">5</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (u_char *) <a href="../../core/ngx_string.h.html#L63" title="core/ngx_string.h:63">ngx_strchr</a>(name.data, <span class="Constant">':'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid zone size </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name.len = p - name.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.data = p + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.len = value[i].data + value[i].len - s.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = <a href="../../core/ngx_parse.c.html#L13" title="core/ngx_parse.c:13">ngx_parse_size</a>(&amp;s);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size == <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid zone size </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &lt; (<span class="Type">ssize_t</span>) (<span class="Constant">8</span> * <a href="../../os/unix/ngx_alloc.c.html#L12" title="os/unix/ngx_alloc.c:12">ngx_pagesize</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;zone </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> is too small&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;rate=&quot;</span>, <span class="Constant">5</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = value[i].len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = value[i].data + len - <span class="Constant">3</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(p, <span class="Constant">&quot;r/s&quot;</span>, <span class="Constant">3</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scale = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len -= <span class="Constant">3</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(p, <span class="Constant">&quot;r/m&quot;</span>, <span class="Constant">3</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scale = <span class="Constant">60</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len -= <span class="Constant">3</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rate = <a href="../../core/ngx_string.c.html#L898" title="core/ngx_string.c:898">ngx_atoi</a>(value[i].data + <span class="Constant">5</span>, len - <span class="Constant">5</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rate &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid rate </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid parameter </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> must have </span><span class="Special">\&quot;</span><span class="Constant">zone</span><span class="Special">\&quot;</span><span class="Constant"> parameter&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;cmd-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;rate = rate * <span class="Constant">1000</span> / scale;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shm_zone = <a href="../../core/ngx_cycle.c.html#L1175" title="core/ngx_cycle.c:1175">ngx_shared_memory_add</a>(cf, &amp;name, size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;<a href="#L140" title="http/modules/ngx_http_limit_req_module.c:140">ngx_http_limit_req_module</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shm_zone == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shm_zone-&gt;data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = shm_zone-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;%V </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> is already bound to key </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;cmd-&gt;name, &amp;name, &amp;ctx-&gt;key.value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shm_zone-&gt;init = <a href="#L618" title="http/modules/ngx_http_limit_req_module.c:618">ngx_http_limit_req_init_zone</a>;<br/></li>
<li>&nbsp; &nbsp; shm_zone-&gt;data = ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L861">&#x200c;</a><span class="linkable">ngx_http_limit_req</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L56" title="http/modules/ngx_http_limit_req_module.c:56">ngx_http_limit_req_conf_t</a>&nbsp; *lrcf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; burst;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *value, s;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i, nodelay;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_cycle.h.html#L25" title="core/ngx_cycle.h:25">ngx_shm_zone_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *shm_zone;<br/></li>
<li>&nbsp; &nbsp; <a href="#L48" title="http/modules/ngx_http_limit_req_module.c:48">ngx_http_limit_req_limit_t</a>&nbsp; *limit, *limits;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shm_zone = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; burst = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; nodelay = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt; cf-&gt;args-&gt;nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;zone=&quot;</span>, <span class="Constant">5</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.len = value[i].len - <span class="Constant">5</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.data = value[i].data + <span class="Constant">5</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shm_zone = <a href="../../core/ngx_cycle.c.html#L1175" title="core/ngx_cycle.c:1175">ngx_shared_memory_add</a>(cf, &amp;s, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;<a href="#L140" title="http/modules/ngx_http_limit_req_module.c:140">ngx_http_limit_req_module</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (shm_zone == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;burst=&quot;</span>, <span class="Constant">6</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; burst = <a href="../../core/ngx_string.c.html#L898" title="core/ngx_string.c:898">ngx_atoi</a>(value[i].data + <span class="Constant">6</span>, value[i].len - <span class="Constant">6</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (burst &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid burst rate </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[i].data, <span class="Constant">&quot;nodelay&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nodelay = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid parameter </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shm_zone == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> must have </span><span class="Special">\&quot;</span><span class="Constant">zone</span><span class="Special">\&quot;</span><span class="Constant"> parameter&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;cmd-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shm_zone-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;unknown limit_req_zone </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;shm_zone-&gt;shm.name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; limits = lrcf-&gt;limits.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (limits == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;lrcf-&gt;limits, cf-&gt;pool, <span class="Constant">1</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="#L48" title="http/modules/ngx_http_limit_req_module.c:48">ngx_http_limit_req_limit_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; lrcf-&gt;limits.nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (shm_zone == limits[i].shm_zone) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;is duplicate&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; limit = <a href="../../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(&amp;lrcf-&gt;limits);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (limit == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; limit-&gt;shm_zone = shm_zone;<br/></li>
<li>&nbsp; &nbsp; limit-&gt;burst = burst * <span class="Constant">1000</span>;<br/></li>
<li>&nbsp; &nbsp; limit-&gt;nodelay = nodelay;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L960">&#x200c;</a><span class="linkable">ngx_http_limit_req_init</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_request.h.html#L355" title="http/ngx_http_request.h:355">ngx_http_handler_pt</a>&nbsp; &nbsp; &nbsp; &nbsp; *h;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a>&nbsp; *cmcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cmcf = <a href="../ngx_http_config.h.html#L61" title="http/ngx_http_config.h:61">ngx_http_conf_get_module_main_conf</a>(cf, <a href="../ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h = <a href="../../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(&amp;cmcf-&gt;phases[NGX_HTTP_PREACCESS_PHASE].handlers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *h = <a href="#L157" title="http/modules/ngx_http_limit_req_module.c:157">ngx_http_limit_req_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
