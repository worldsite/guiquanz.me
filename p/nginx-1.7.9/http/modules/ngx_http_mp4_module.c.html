<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>http/modules/ngx_http_mp4_module.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>http/modules/ngx_http_mp4_module.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L370">ngx_http_mp4_atoms</a></li>
<li><a href="#L312">ngx_http_mp4_commands</a></li>
<li><a href="#L390">ngx_http_mp4_mdia_atoms</a></li>
<li><a href="#L397">ngx_http_mp4_minf_atoms</a></li>
<li><a href="#L354">ngx_http_mp4_module</a></li>
<li><a href="#L339">ngx_http_mp4_module_ctx</a></li>
<li><a href="#L377">ngx_http_mp4_moov_atoms</a></li>
<li><a href="#L405">ngx_http_mp4_stbl_atoms</a></li>
<li><a href="#L384">ngx_http_mp4_trak_atoms</a></li>
</ul>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L163">ngx_http_mp4_atom_handler_t</a></li>
<li><a href="#L46">ngx_http_mp4_conf_t</a></li>
<li><a href="#L156">ngx_http_mp4_file_t</a></li>
<li><a href="#L2206">ngx_http_mp4_stss_atom_t</a></li>
<li><a href="#L116">ngx_http_mp4_trak_t</a></li>
<li><a href="#L852">ngx_mp4_atom_header64_t</a></li>
<li><a href="#L846">ngx_mp4_atom_header_t</a></li>
<li><a href="#L3282">ngx_mp4_co64_atom_t</a></li>
<li><a href="#L2399">ngx_mp4_ctts_atom_t</a></li>
<li><a href="#L2404">ngx_mp4_ctts_entry_t</a></li>
<li><a href="#L1618">ngx_mp4_mdhd64_atom_t</a></li>
<li><a href="#L1605">ngx_mp4_mdhd_atom_t</a></li>
<li><a href="#L1252">ngx_mp4_mvhd64_atom_t</a></li>
<li><a href="#L1230">ngx_mp4_mvhd_atom_t</a></li>
<li><a href="#L3098">ngx_mp4_stco_atom_t</a></li>
<li><a href="#L2596">ngx_mp4_stsc_atom_t</a></li>
<li><a href="#L53">ngx_mp4_stsc_entry_t</a></li>
<li><a href="#L1929">ngx_mp4_stsd_atom_t</a></li>
<li><a href="#L2937">ngx_mp4_stsz_atom_t</a></li>
<li><a href="#L1985">ngx_mp4_stts_atom_t</a></li>
<li><a href="#L1990">ngx_mp4_stts_entry_t</a></li>
<li><a href="#L1460">ngx_mp4_tkhd64_atom_t</a></li>
<li><a href="#L1440">ngx_mp4_tkhd_atom_t</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L3461">ngx_http_mp4</a></li>
<li><a href="#L3433">ngx_http_mp4_adjust_co64_atom</a></li>
<li><a href="#L3249">ngx_http_mp4_adjust_stco_atom</a></li>
<li><a href="#L3473">ngx_http_mp4_create_conf</a></li>
<li><a href="#L2519">ngx_http_mp4_crop_ctts_data</a></li>
<li><a href="#L2733">ngx_http_mp4_crop_stsc_data</a></li>
<li><a href="#L2332">ngx_http_mp4_crop_stss_data</a></li>
<li><a href="#L2103">ngx_http_mp4_crop_stts_data</a></li>
<li><a href="#L419">ngx_http_mp4_handler</a></li>
<li><a href="#L3490">ngx_http_mp4_merge_conf</a></li>
<li><a href="#L690">ngx_http_mp4_process</a></li>
<li><a href="#L953">ngx_http_mp4_read</a></li>
<li><a href="#L856">ngx_http_mp4_read_atom</a></li>
<li><a href="#L1412">ngx_http_mp4_read_cmov_atom</a></li>
<li><a href="#L3286">ngx_http_mp4_read_co64_atom</a></li>
<li><a href="#L2408">ngx_http_mp4_read_ctts_atom</a></li>
<li><a href="#L1853">ngx_http_mp4_read_dinf_atom</a></li>
<li><a href="#L1002">ngx_http_mp4_read_ftyp_atom</a></li>
<li><a href="#L1720">ngx_http_mp4_read_hdlr_atom</a></li>
<li><a href="#L1138">ngx_http_mp4_read_mdat_atom</a></li>
<li><a href="#L1622">ngx_http_mp4_read_mdhd_atom</a></li>
<li><a href="#L1558">ngx_http_mp4_read_mdia_atom</a></li>
<li><a href="#L1751">ngx_http_mp4_read_minf_atom</a></li>
<li><a href="#L1058">ngx_http_mp4_read_moov_atom</a></li>
<li><a href="#L1256">ngx_http_mp4_read_mvhd_atom</a></li>
<li><a href="#L1822">ngx_http_mp4_read_smhd_atom</a></li>
<li><a href="#L1884">ngx_http_mp4_read_stbl_atom</a></li>
<li><a href="#L3102">ngx_http_mp4_read_stco_atom</a></li>
<li><a href="#L2600">ngx_http_mp4_read_stsc_atom</a></li>
<li><a href="#L1933">ngx_http_mp4_read_stsd_atom</a></li>
<li><a href="#L2210">ngx_http_mp4_read_stss_atom</a></li>
<li><a href="#L2941">ngx_http_mp4_read_stsz_atom</a></li>
<li><a href="#L1994">ngx_http_mp4_read_stts_atom</a></li>
<li><a href="#L1464">ngx_http_mp4_read_tkhd_atom</a></li>
<li><a href="#L1351">ngx_http_mp4_read_trak_atom</a></li>
<li><a href="#L1791">ngx_http_mp4_read_vmhd_atom</a></li>
<li><a href="#L3346">ngx_http_mp4_update_co64_atom</a></li>
<li><a href="#L2470">ngx_http_mp4_update_ctts_atom</a></li>
<li><a href="#L1168">ngx_http_mp4_update_mdat_atom</a></li>
<li><a href="#L1583">ngx_http_mp4_update_mdia_atom</a></li>
<li><a href="#L1776">ngx_http_mp4_update_minf_atom</a></li>
<li><a href="#L1909">ngx_http_mp4_update_stbl_atom</a></li>
<li><a href="#L3162">ngx_http_mp4_update_stco_atom</a></li>
<li><a href="#L2661">ngx_http_mp4_update_stsc_atom</a></li>
<li><a href="#L2272">ngx_http_mp4_update_stss_atom</a></li>
<li><a href="#L3016">ngx_http_mp4_update_stsz_atom</a></li>
<li><a href="#L2055">ngx_http_mp4_update_stts_atom</a></li>
<li><a href="#L1400">ngx_http_mp4_update_trak_atom</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L37">NGX_HTTP_MP4_CO64_ATOM</a></li>
<li><a href="#L38">NGX_HTTP_MP4_CO64_DATA</a></li>
<li><a href="#L27">NGX_HTTP_MP4_CTTS_ATOM</a></li>
<li><a href="#L28">NGX_HTTP_MP4_CTTS_DATA</a></li>
<li><a href="#L20">NGX_HTTP_MP4_DINF_ATOM</a></li>
<li><a href="#L16">NGX_HTTP_MP4_HDLR_ATOM</a></li>
<li><a href="#L40">NGX_HTTP_MP4_LAST_ATOM</a></li>
<li><a href="#L15">NGX_HTTP_MP4_MDHD_ATOM</a></li>
<li><a href="#L14">NGX_HTTP_MP4_MDIA_ATOM</a></li>
<li><a href="#L17">NGX_HTTP_MP4_MINF_ATOM</a></li>
<li><a href="#L1055">NGX_HTTP_MP4_MOOV_BUFFER_EXCESS</a></li>
<li><a href="#L19">NGX_HTTP_MP4_SMHD_ATOM</a></li>
<li><a href="#L21">NGX_HTTP_MP4_STBL_ATOM</a></li>
<li><a href="#L35">NGX_HTTP_MP4_STCO_ATOM</a></li>
<li><a href="#L36">NGX_HTTP_MP4_STCO_DATA</a></li>
<li><a href="#L29">NGX_HTTP_MP4_STSC_ATOM</a></li>
<li><a href="#L31">NGX_HTTP_MP4_STSC_DATA</a></li>
<li><a href="#L32">NGX_HTTP_MP4_STSC_END</a></li>
<li><a href="#L30">NGX_HTTP_MP4_STSC_START</a></li>
<li><a href="#L22">NGX_HTTP_MP4_STSD_ATOM</a></li>
<li><a href="#L25">NGX_HTTP_MP4_STSS_ATOM</a></li>
<li><a href="#L26">NGX_HTTP_MP4_STSS_DATA</a></li>
<li><a href="#L33">NGX_HTTP_MP4_STSZ_ATOM</a></li>
<li><a href="#L34">NGX_HTTP_MP4_STSZ_DATA</a></li>
<li><a href="#L23">NGX_HTTP_MP4_STTS_ATOM</a></li>
<li><a href="#L24">NGX_HTTP_MP4_STTS_DATA</a></li>
<li><a href="#L13">NGX_HTTP_MP4_TKHD_ATOM</a></li>
<li><a href="#L12">NGX_HTTP_MP4_TRAK_ATOM</a></li>
<li><a href="#L18">NGX_HTTP_MP4_VMHD_ATOM</a></li>
<li><a href="#L167">ngx_mp4_atom_data</a></li>
<li><a href="#L168">ngx_mp4_atom_data_size</a></li>
<li><a href="#L166">ngx_mp4_atom_header</a></li>
<li><a href="#L171">ngx_mp4_atom_next</a></li>
<li><a href="#L182">ngx_mp4_get_32value</a></li>
<li><a href="#L194">ngx_mp4_get_64value</a></li>
<li><a href="#L214">ngx_mp4_last_trak</a></li>
<li><a href="#L188">ngx_mp4_set_32value</a></li>
<li><a href="#L204">ngx_mp4_set_64value</a></li>
<li><a href="#L176">ngx_mp4_set_atom_name</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L12">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_TRAK_ATOM</span>&nbsp; &nbsp;&nbsp; </span><span class="Constant">0<br/></li>
<li><a id="L13">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_TKHD_ATOM</span>&nbsp; &nbsp;&nbsp; </span><span class="Constant">1<br/></li>
<li><a id="L14">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_MDIA_ATOM</span>&nbsp; &nbsp;&nbsp; </span><span class="Constant">2<br/></li>
<li><a id="L15">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_MDHD_ATOM</span>&nbsp; &nbsp;&nbsp; </span><span class="Constant">3<br/></li>
<li><a id="L16">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_HDLR_ATOM</span>&nbsp; &nbsp;&nbsp; </span><span class="Constant">4<br/></li>
<li><a id="L17">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_MINF_ATOM</span>&nbsp; &nbsp;&nbsp; </span><span class="Constant">5<br/></li>
<li><a id="L18">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_VMHD_ATOM</span>&nbsp; &nbsp;&nbsp; </span><span class="Constant">6<br/></li>
<li><a id="L19">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_SMHD_ATOM</span>&nbsp; &nbsp;&nbsp; </span><span class="Constant">7<br/></li>
<li><a id="L20">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_DINF_ATOM</span>&nbsp; &nbsp;&nbsp; </span><span class="Constant">8<br/></li>
<li><a id="L21">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_STBL_ATOM</span>&nbsp; &nbsp;&nbsp; </span><span class="Constant">9<br/></li>
<li><a id="L22">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_STSD_ATOM</span>&nbsp; &nbsp; </span><span class="Constant">10<br/></li>
<li><a id="L23">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_STTS_ATOM</span>&nbsp; &nbsp; </span><span class="Constant">11<br/></li>
<li><a id="L24">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_STTS_DATA</span>&nbsp; &nbsp; </span><span class="Constant">12<br/></li>
<li><a id="L25">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_STSS_ATOM</span>&nbsp; &nbsp; </span><span class="Constant">13<br/></li>
<li><a id="L26">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_STSS_DATA</span>&nbsp; &nbsp; </span><span class="Constant">14<br/></li>
<li><a id="L27">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_CTTS_ATOM</span>&nbsp; &nbsp; </span><span class="Constant">15<br/></li>
<li><a id="L28">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_CTTS_DATA</span>&nbsp; &nbsp; </span><span class="Constant">16<br/></li>
<li><a id="L29">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_STSC_ATOM</span>&nbsp; &nbsp; </span><span class="Constant">17<br/></li>
<li><a id="L30">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_STSC_START</span>&nbsp;&nbsp; </span><span class="Constant">18<br/></li>
<li><a id="L31">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_STSC_DATA</span>&nbsp; &nbsp; </span><span class="Constant">19<br/></li>
<li><a id="L32">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_STSC_END</span>&nbsp; &nbsp;&nbsp; </span><span class="Constant">20<br/></li>
<li><a id="L33">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_STSZ_ATOM</span>&nbsp; &nbsp; </span><span class="Constant">21<br/></li>
<li><a id="L34">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_STSZ_DATA</span>&nbsp; &nbsp; </span><span class="Constant">22<br/></li>
<li><a id="L35">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_STCO_ATOM</span>&nbsp; &nbsp; </span><span class="Constant">23<br/></li>
<li><a id="L36">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_STCO_DATA</span>&nbsp; &nbsp; </span><span class="Constant">24<br/></li>
<li><a id="L37">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_CO64_ATOM</span>&nbsp; &nbsp; </span><span class="Constant">25<br/></li>
<li><a id="L38">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_CO64_DATA</span>&nbsp; &nbsp; </span><span class="Constant">26<br/></li>
<li></span><br/></li>
<li><a id="L40">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_LAST_ATOM</span>&nbsp; &nbsp; <a href="#L38" title="http/modules/ngx_http_mp4_module.c:38">NGX_HTTP_MP4_CO64_DATA</a><br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buffer_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; max_buffer_size;<br/></li>
<li><a id="L46">&#x200c;</a>} <span class="linkable">ngx_http_mp4_conf_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; chunk[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; samples[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id[<span class="Constant">4</span>];<br/></li>
<li><a id="L53">&#x200c;</a>} <span class="linkable">ngx_mp4_stsc_entry_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timescale;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; time_to_sample_entries;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sample_to_chunk_entries;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sync_samples_entries;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; composition_offset_entries;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sample_sizes_entries;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; chunks;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start_sample;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end_sample;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start_chunk;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end_chunk;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start_chunk_samples;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end_chunk_samples;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start_chunk_samples_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end_chunk_samples_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">off_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; start_offset;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">off_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; end_offset;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tkhd_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mdhd_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hdlr_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vmhd_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; smhd_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dinf_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; out[<a href="#L40" title="http/modules/ngx_http_mp4_module.c:40">NGX_HTTP_MP4_LAST_ATOM</a> + <span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; trak_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tkhd_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; mdia_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; mdhd_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; hdlr_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; minf_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; vmhd_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; smhd_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; dinf_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stbl_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stsd_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stts_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stts_data_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stss_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stss_data_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ctts_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ctts_data_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stsc_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stsc_start_chunk_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stsc_end_chunk_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stsc_data_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stsz_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stsz_data_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stco_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stco_data_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; co64_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; co64_data_buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L53" title="http/modules/ngx_http_mp4_module.c:53">ngx_mp4_stsc_entry_t</a>&nbsp; stsc_start_chunk_entry;<br/></li>
<li>&nbsp; &nbsp; <a href="#L53" title="http/modules/ngx_http_mp4_module.c:53">ngx_mp4_stsc_entry_t</a>&nbsp; stsc_end_chunk_entry;<br/></li>
<li><a id="L116">&#x200c;</a>} <span class="linkable">ngx_http_mp4_trak_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L20" title="core/ngx_core.h:20">ngx_file_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *buffer;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *buffer_start;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *buffer_pos;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *buffer_end;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buffer_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">off_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offset;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">off_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; end;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">off_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; content_length;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; length;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timescale;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a>&nbsp;&nbsp; *request;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; trak;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp;&nbsp; traks[<span class="Constant">2</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ftyp_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; moov_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *out;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ftyp_atom;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; moov_atom;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; mvhd_atom;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; mdat_atom;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; mdat_data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ftyp_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; moov_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; mvhd_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; mdat_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; mdat_data_buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; moov_atom_header[<span class="Constant">8</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mdat_atom_header[<span class="Constant">16</span>];<br/></li>
<li><a id="L156">&#x200c;</a>} <span class="linkable">ngx_http_mp4_file_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *name;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (*handler)(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><a id="L163">&#x200c;</a>} <span class="linkable">ngx_http_mp4_atom_handler_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L166">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_mp4_atom_header</span>(mp4)&nbsp;&nbsp; (mp4-&gt;buffer_pos - </span><span class="Constant">8</span><span class="PreProc">)<br/></li>
<li><a id="L167">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ngx_mp4_atom_data</span>(mp4)&nbsp; &nbsp;&nbsp; mp4-&gt;buffer_pos<br/></li>
<li><a id="L168">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ngx_mp4_atom_data_size</span>(t)&nbsp; (</span><span class="Type">uint64_t</span><span class="PreProc">) (</span><span class="Statement">sizeof</span><span class="PreProc">(t) - </span><span class="Constant">8</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L171">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_mp4_atom_next</span>(mp4, n)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; mp4-&gt;buffer_pos += (</span><span class="Type">size_t</span><span class="PreProc">) n;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; mp4-&gt;offset += n<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L176">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_mp4_set_atom_name</span>(p, n1, n2, n3, n4)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">4</span><span class="PreProc">] = n1;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">5</span><span class="PreProc">] = n2;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">6</span><span class="PreProc">] = n3;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">7</span><span class="PreProc">] = n4<br/></li>
<li></span><br/></li>
<li><a id="L182">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_mp4_get_32value</span>(p)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ( ((</span><span class="Type">uint32_t</span><span class="PreProc">) ((u_char *) (p))[</span><span class="Constant">0</span><span class="PreProc">] &lt;&lt; </span><span class="Constant">24</span><span class="PreProc">)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; + (&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((u_char *) (p))[</span><span class="Constant">1</span><span class="PreProc">] &lt;&lt; </span><span class="Constant">16</span><span class="PreProc">)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; + (&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((u_char *) (p))[</span><span class="Constant">2</span><span class="PreProc">] &lt;&lt; </span><span class="Constant">8</span><span class="PreProc">)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; + (&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((u_char *) (p))[</span><span class="Constant">3</span><span class="PreProc">]) )<br/></li>
<li></span><br/></li>
<li><a id="L188">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_mp4_set_32value</span>(p, n)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">0</span><span class="PreProc">] = (u_char) ((n) &gt;&gt; </span><span class="Constant">24</span><span class="PreProc">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">1</span><span class="PreProc">] = (u_char) ((n) &gt;&gt; </span><span class="Constant">16</span><span class="PreProc">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">2</span><span class="PreProc">] = (u_char) ((n) &gt;&gt; </span><span class="Constant">8</span><span class="PreProc">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">3</span><span class="PreProc">] = (u_char)&nbsp; (n)<br/></li>
<li></span><br/></li>
<li><a id="L194">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_mp4_get_64value</span>(p)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ( ((</span><span class="Type">uint64_t</span><span class="PreProc">) ((u_char *) (p))[</span><span class="Constant">0</span><span class="PreProc">] &lt;&lt; </span><span class="Constant">56</span><span class="PreProc">)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; + ((</span><span class="Type">uint64_t</span><span class="PreProc">) ((u_char *) (p))[</span><span class="Constant">1</span><span class="PreProc">] &lt;&lt; </span><span class="Constant">48</span><span class="PreProc">)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; + ((</span><span class="Type">uint64_t</span><span class="PreProc">) ((u_char *) (p))[</span><span class="Constant">2</span><span class="PreProc">] &lt;&lt; </span><span class="Constant">40</span><span class="PreProc">)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; + ((</span><span class="Type">uint64_t</span><span class="PreProc">) ((u_char *) (p))[</span><span class="Constant">3</span><span class="PreProc">] &lt;&lt; </span><span class="Constant">32</span><span class="PreProc">)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; + ((</span><span class="Type">uint64_t</span><span class="PreProc">) ((u_char *) (p))[</span><span class="Constant">4</span><span class="PreProc">] &lt;&lt; </span><span class="Constant">24</span><span class="PreProc">)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; + (&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((u_char *) (p))[</span><span class="Constant">5</span><span class="PreProc">] &lt;&lt; </span><span class="Constant">16</span><span class="PreProc">)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; + (&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((u_char *) (p))[</span><span class="Constant">6</span><span class="PreProc">] &lt;&lt; </span><span class="Constant">8</span><span class="PreProc">)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; + (&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((u_char *) (p))[</span><span class="Constant">7</span><span class="PreProc">]) )<br/></li>
<li></span><br/></li>
<li><a id="L204">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_mp4_set_64value</span>(p, n)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">0</span><span class="PreProc">] = (u_char) ((</span><span class="Type">uint64_t</span><span class="PreProc">) (n) &gt;&gt; </span><span class="Constant">56</span><span class="PreProc">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">1</span><span class="PreProc">] = (u_char) ((</span><span class="Type">uint64_t</span><span class="PreProc">) (n) &gt;&gt; </span><span class="Constant">48</span><span class="PreProc">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">2</span><span class="PreProc">] = (u_char) ((</span><span class="Type">uint64_t</span><span class="PreProc">) (n) &gt;&gt; </span><span class="Constant">40</span><span class="PreProc">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">3</span><span class="PreProc">] = (u_char) ((</span><span class="Type">uint64_t</span><span class="PreProc">) (n) &gt;&gt; </span><span class="Constant">32</span><span class="PreProc">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">4</span><span class="PreProc">] = (u_char) (&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (n) &gt;&gt; </span><span class="Constant">24</span><span class="PreProc">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">5</span><span class="PreProc">] = (u_char) (&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (n) &gt;&gt; </span><span class="Constant">16</span><span class="PreProc">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">6</span><span class="PreProc">] = (u_char) (&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (n) &gt;&gt; </span><span class="Constant">8</span><span class="PreProc">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((u_char *) (p))[</span><span class="Constant">7</span><span class="PreProc">] = (u_char)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (n)<br/></li>
<li></span><br/></li>
<li><a id="L214">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_mp4_last_trak</span>(mp4)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &amp;((<a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *) mp4-&gt;trak.elts)[mp4-&gt;trak.nelts - </span><span class="Constant">1</span><span class="PreProc">]<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L419" title="http/modules/ngx_http_mp4_module.c:419">ngx_http_mp4_handler</a>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L690" title="http/modules/ngx_http_mp4_module.c:690">ngx_http_mp4_process</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L856" title="http/modules/ngx_http_mp4_module.c:856">ngx_http_mp4_read_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L163" title="http/modules/ngx_http_mp4_module.c:163">ngx_http_mp4_atom_handler_t</a> *atom, <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L953" title="http/modules/ngx_http_mp4_module.c:953">ngx_http_mp4_read</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">size_t</span> size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1002" title="http/modules/ngx_http_mp4_module.c:1002">ngx_http_mp4_read_ftyp_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1058" title="http/modules/ngx_http_mp4_module.c:1058">ngx_http_mp4_read_moov_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1138" title="http/modules/ngx_http_mp4_module.c:1138">ngx_http_mp4_read_mdat_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <span class="Type">size_t</span> <a href="#L1168" title="http/modules/ngx_http_mp4_module.c:1168">ngx_http_mp4_update_mdat_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">off_t</span> start_offset, <span class="Type">off_t</span> end_offset);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1256" title="http/modules/ngx_http_mp4_module.c:1256">ngx_http_mp4_read_mvhd_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1351" title="http/modules/ngx_http_mp4_module.c:1351">ngx_http_mp4_read_trak_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1400" title="http/modules/ngx_http_mp4_module.c:1400">ngx_http_mp4_update_trak_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1412" title="http/modules/ngx_http_mp4_module.c:1412">ngx_http_mp4_read_cmov_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1464" title="http/modules/ngx_http_mp4_module.c:1464">ngx_http_mp4_read_tkhd_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1558" title="http/modules/ngx_http_mp4_module.c:1558">ngx_http_mp4_read_mdia_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1583" title="http/modules/ngx_http_mp4_module.c:1583">ngx_http_mp4_update_mdia_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1622" title="http/modules/ngx_http_mp4_module.c:1622">ngx_http_mp4_read_mdhd_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1720" title="http/modules/ngx_http_mp4_module.c:1720">ngx_http_mp4_read_hdlr_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1751" title="http/modules/ngx_http_mp4_module.c:1751">ngx_http_mp4_read_minf_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1776" title="http/modules/ngx_http_mp4_module.c:1776">ngx_http_mp4_update_minf_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1853" title="http/modules/ngx_http_mp4_module.c:1853">ngx_http_mp4_read_dinf_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1791" title="http/modules/ngx_http_mp4_module.c:1791">ngx_http_mp4_read_vmhd_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1822" title="http/modules/ngx_http_mp4_module.c:1822">ngx_http_mp4_read_smhd_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1884" title="http/modules/ngx_http_mp4_module.c:1884">ngx_http_mp4_read_stbl_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1909" title="http/modules/ngx_http_mp4_module.c:1909">ngx_http_mp4_update_stbl_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1933" title="http/modules/ngx_http_mp4_module.c:1933">ngx_http_mp4_read_stsd_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1994" title="http/modules/ngx_http_mp4_module.c:1994">ngx_http_mp4_read_stts_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2055" title="http/modules/ngx_http_mp4_module.c:2055">ngx_http_mp4_update_stts_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2103" title="http/modules/ngx_http_mp4_module.c:2103">ngx_http_mp4_crop_stts_data</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> start);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2210" title="http/modules/ngx_http_mp4_module.c:2210">ngx_http_mp4_read_stss_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2272" title="http/modules/ngx_http_mp4_module.c:2272">ngx_http_mp4_update_stss_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2332" title="http/modules/ngx_http_mp4_module.c:2332">ngx_http_mp4_crop_stss_data</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> start);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2408" title="http/modules/ngx_http_mp4_module.c:2408">ngx_http_mp4_read_ctts_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2470" title="http/modules/ngx_http_mp4_module.c:2470">ngx_http_mp4_update_ctts_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2519" title="http/modules/ngx_http_mp4_module.c:2519">ngx_http_mp4_crop_ctts_data</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> start);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2600" title="http/modules/ngx_http_mp4_module.c:2600">ngx_http_mp4_read_stsc_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2661" title="http/modules/ngx_http_mp4_module.c:2661">ngx_http_mp4_update_stsc_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2733" title="http/modules/ngx_http_mp4_module.c:2733">ngx_http_mp4_crop_stsc_data</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> start);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2941" title="http/modules/ngx_http_mp4_module.c:2941">ngx_http_mp4_read_stsz_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L3016" title="http/modules/ngx_http_mp4_module.c:3016">ngx_http_mp4_update_stsz_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L3102" title="http/modules/ngx_http_mp4_module.c:3102">ngx_http_mp4_read_stco_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L3162" title="http/modules/ngx_http_mp4_module.c:3162">ngx_http_mp4_update_stco_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3249" title="http/modules/ngx_http_mp4_module.c:3249">ngx_http_mp4_adjust_stco_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak, <span class="Type">int32_t</span> adjustment);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L3286" title="http/modules/ngx_http_mp4_module.c:3286">ngx_http_mp4_read_co64_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span> atom_data_size);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L3346" title="http/modules/ngx_http_mp4_module.c:3346">ngx_http_mp4_update_co64_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3433" title="http/modules/ngx_http_mp4_module.c:3433">ngx_http_mp4_adjust_co64_atom</a>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak, <span class="Type">off_t</span> adjustment);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L3461" title="http/modules/ngx_http_mp4_module.c:3461">ngx_http_mp4</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L3473" title="http/modules/ngx_http_mp4_module.c:3473">ngx_http_mp4_create_conf</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L3490" title="http/modules/ngx_http_mp4_module.c:3490">ngx_http_mp4_merge_conf</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <span class="Type">void</span> *parent, <span class="Type">void</span> *child);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L312">&#x200c;</a><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a>&nbsp; <span class="linkable">ngx_http_mp4_commands</span>[] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;mp4&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L43" title="http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L22" title="core/ngx_conf_file.h:22">NGX_CONF_NOARGS</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L3461" title="http/modules/ngx_http_mp4_module.c:3461">ngx_http_mp4</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;mp4_buffer_size&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L23" title="core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L1115" title="core/ngx_conf_file.c:1115">ngx_conf_set_size_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L46" title="http/modules/ngx_http_mp4_module.c:46">ngx_http_mp4_conf_t</a>, buffer_size),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;mp4_max_buffer_size&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L23" title="core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L1115" title="core/ngx_conf_file.c:1115">ngx_conf_set_size_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L46" title="http/modules/ngx_http_mp4_module.c:46">ngx_http_mp4_conf_t</a>, max_buffer_size),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L87" title="core/ngx_conf_file.h:87">ngx_null_command</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L339">&#x200c;</a><span class="Type">static</span> <a href="../ngx_http_config.h.html#L36" title="http/ngx_http_config.h:36">ngx_http_module_t</a>&nbsp; <span class="linkable">ngx_http_mp4_module_ctx</span> = {<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* preconfiguration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* postconfiguration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create <a href="../../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init <a href="../../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create server configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge server configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L3473" title="http/modules/ngx_http_mp4_module.c:3473">ngx_http_mp4_create_conf</a>,&nbsp; &nbsp; &nbsp; <span class="Comment">/* create location configuration */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L3490" title="http/modules/ngx_http_mp4_module.c:3490">ngx_http_mp4_merge_conf</a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge location configuration */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L354">&#x200c;</a><a href="../../core/ngx_core.h.html#L12" title="core/ngx_core.h:12">ngx_module_t</a>&nbsp; <span class="linkable">ngx_http_mp4_module</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L99" title="core/ngx_conf_file.h:99">NGX_MODULE_V1</a>,<br/></li>
<li>&nbsp; &nbsp; &amp;<a href="#L339" title="http/modules/ngx_http_mp4_module.c:339">ngx_http_mp4_module_ctx</a>,&nbsp; &nbsp; &nbsp; <span class="Comment">/* module context */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L312" title="http/modules/ngx_http_mp4_module.c:312">ngx_http_mp4_commands</a>,&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module directives */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../ngx_http_config.h.html#L39" title="http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module type */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init master */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init module */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit master */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L100" title="core/ngx_conf_file.h:100">NGX_MODULE_V1_PADDING</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L370">&#x200c;</a><span class="Type">static</span> <a href="#L163" title="http/modules/ngx_http_mp4_module.c:163">ngx_http_mp4_atom_handler_t</a>&nbsp; <span class="linkable">ngx_http_mp4_atoms</span>[] = {<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;ftyp&quot;</span>, <a href="#L1002" title="http/modules/ngx_http_mp4_module.c:1002">ngx_http_mp4_read_ftyp_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;moov&quot;</span>, <a href="#L1058" title="http/modules/ngx_http_mp4_module.c:1058">ngx_http_mp4_read_moov_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;mdat&quot;</span>, <a href="#L1138" title="http/modules/ngx_http_mp4_module.c:1138">ngx_http_mp4_read_mdat_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">NULL</span>, <span class="Constant">NULL</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L377">&#x200c;</a><span class="Type">static</span> <a href="#L163" title="http/modules/ngx_http_mp4_module.c:163">ngx_http_mp4_atom_handler_t</a>&nbsp; <span class="linkable">ngx_http_mp4_moov_atoms</span>[] = {<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;mvhd&quot;</span>, <a href="#L1256" title="http/modules/ngx_http_mp4_module.c:1256">ngx_http_mp4_read_mvhd_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;trak&quot;</span>, <a href="#L1351" title="http/modules/ngx_http_mp4_module.c:1351">ngx_http_mp4_read_trak_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;cmov&quot;</span>, <a href="#L1412" title="http/modules/ngx_http_mp4_module.c:1412">ngx_http_mp4_read_cmov_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">NULL</span>, <span class="Constant">NULL</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L384">&#x200c;</a><span class="Type">static</span> <a href="#L163" title="http/modules/ngx_http_mp4_module.c:163">ngx_http_mp4_atom_handler_t</a>&nbsp; <span class="linkable">ngx_http_mp4_trak_atoms</span>[] = {<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;tkhd&quot;</span>, <a href="#L1464" title="http/modules/ngx_http_mp4_module.c:1464">ngx_http_mp4_read_tkhd_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;mdia&quot;</span>, <a href="#L1558" title="http/modules/ngx_http_mp4_module.c:1558">ngx_http_mp4_read_mdia_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">NULL</span>, <span class="Constant">NULL</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L390">&#x200c;</a><span class="Type">static</span> <a href="#L163" title="http/modules/ngx_http_mp4_module.c:163">ngx_http_mp4_atom_handler_t</a>&nbsp; <span class="linkable">ngx_http_mp4_mdia_atoms</span>[] = {<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;mdhd&quot;</span>, <a href="#L1622" title="http/modules/ngx_http_mp4_module.c:1622">ngx_http_mp4_read_mdhd_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;hdlr&quot;</span>, <a href="#L1720" title="http/modules/ngx_http_mp4_module.c:1720">ngx_http_mp4_read_hdlr_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;minf&quot;</span>, <a href="#L1751" title="http/modules/ngx_http_mp4_module.c:1751">ngx_http_mp4_read_minf_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">NULL</span>, <span class="Constant">NULL</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L397">&#x200c;</a><span class="Type">static</span> <a href="#L163" title="http/modules/ngx_http_mp4_module.c:163">ngx_http_mp4_atom_handler_t</a>&nbsp; <span class="linkable">ngx_http_mp4_minf_atoms</span>[] = {<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;vmhd&quot;</span>, <a href="#L1791" title="http/modules/ngx_http_mp4_module.c:1791">ngx_http_mp4_read_vmhd_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;smhd&quot;</span>, <a href="#L1822" title="http/modules/ngx_http_mp4_module.c:1822">ngx_http_mp4_read_smhd_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;dinf&quot;</span>, <a href="#L1853" title="http/modules/ngx_http_mp4_module.c:1853">ngx_http_mp4_read_dinf_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;stbl&quot;</span>, <a href="#L1884" title="http/modules/ngx_http_mp4_module.c:1884">ngx_http_mp4_read_stbl_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">NULL</span>, <span class="Constant">NULL</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L405">&#x200c;</a><span class="Type">static</span> <a href="#L163" title="http/modules/ngx_http_mp4_module.c:163">ngx_http_mp4_atom_handler_t</a>&nbsp; <span class="linkable">ngx_http_mp4_stbl_atoms</span>[] = {<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;stsd&quot;</span>, <a href="#L1933" title="http/modules/ngx_http_mp4_module.c:1933">ngx_http_mp4_read_stsd_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;stts&quot;</span>, <a href="#L1994" title="http/modules/ngx_http_mp4_module.c:1994">ngx_http_mp4_read_stts_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;stss&quot;</span>, <a href="#L2210" title="http/modules/ngx_http_mp4_module.c:2210">ngx_http_mp4_read_stss_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;ctts&quot;</span>, <a href="#L2408" title="http/modules/ngx_http_mp4_module.c:2408">ngx_http_mp4_read_ctts_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;stsc&quot;</span>, <a href="#L2600" title="http/modules/ngx_http_mp4_module.c:2600">ngx_http_mp4_read_stsc_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;stsz&quot;</span>, <a href="#L2941" title="http/modules/ngx_http_mp4_module.c:2941">ngx_http_mp4_read_stsz_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;stco&quot;</span>, <a href="#L3102" title="http/modules/ngx_http_mp4_module.c:3102">ngx_http_mp4_read_stco_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">&quot;co64&quot;</span>, <a href="#L3286" title="http/modules/ngx_http_mp4_module.c:3286">ngx_http_mp4_read_co64_atom</a> },<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">NULL</span>, <span class="Constant">NULL</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L419">&#x200c;</a><span class="linkable">ngx_http_mp4_handler</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *last;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; root;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc, start, end;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; level, length;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; path, value;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *log;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out;<br/></li>
<li>&nbsp; &nbsp; <a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *mp4;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_open_file_cache.h.html#L51" title="core/ngx_open_file_cache.h:51">ngx_open_file_info_t</a>&nbsp; &nbsp; &nbsp;&nbsp; of;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!(r-&gt;method &amp; (<a href="../ngx_http_request.h.html#L28" title="http/ngx_http_request.h:28">NGX_HTTP_GET</a>|<a href="../ngx_http_request.h.html#L29" title="http/ngx_http_request.h:29">NGX_HTTP_HEAD</a>))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L88" title="http/ngx_http_request.h:88">NGX_HTTP_NOT_ALLOWED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;uri.data[r-&gt;uri.len - <span class="Constant">1</span>] == <span class="Constant">'/'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../ngx_http_request_body.c.html#L492" title="http/ngx_http_request_body.c:492">ngx_http_discard_request_body</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; last = <a href="../ngx_http_core_module.c.html#L2018" title="http/ngx_http_core_module.c:2018">ngx_http_map_uri_to_path</a>(r, &amp;path, &amp;root, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (last == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; log = r-&gt;connection-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; path.len = last - path.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http mp4 filename: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;path);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="../ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="../ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;of, <span class="Statement">sizeof</span>(<a href="../../core/ngx_open_file_cache.h.html#L51" title="core/ngx_open_file_cache.h:51">ngx_open_file_info_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; of.read_ahead = clcf-&gt;read_ahead;<br/></li>
<li>&nbsp; &nbsp; of.directio = NGX_MAX_OFF_T_VALUE;<br/></li>
<li>&nbsp; &nbsp; of.valid = clcf-&gt;open_file_cache_valid;<br/></li>
<li>&nbsp; &nbsp; of.min_uses = clcf-&gt;open_file_cache_min_uses;<br/></li>
<li>&nbsp; &nbsp; of.errors = clcf-&gt;open_file_cache_errors;<br/></li>
<li>&nbsp; &nbsp; of.events = clcf-&gt;open_file_cache_events;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_core_module.c.html#L2763" title="http/ngx_http_core_module.c:2763">ngx_http_set_disable_symlinks</a>(r, clcf, &amp;path, &amp;of) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_open_file_cache.c.html#L144" title="core/ngx_open_file_cache.c:144">ngx_open_cached_file</a>(clcf-&gt;open_file_cache, &amp;path, &amp;of, r-&gt;pool)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (of.err) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">0</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../../os/unix/ngx_errno.h.html#L19" title="os/unix/ngx_errno.h:19">NGX_ENOENT</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../../os/unix/ngx_errno.h.html#L29" title="os/unix/ngx_errno.h:29">NGX_ENOTDIR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../../os/unix/ngx_errno.h.html#L45" title="os/unix/ngx_errno.h:45">NGX_ENAMETOOLONG</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; level = <a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../ngx_http_request.h.html#L87" title="http/ngx_http_request.h:87">NGX_HTTP_NOT_FOUND</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../../os/unix/ngx_errno.h.html#L25" title="os/unix/ngx_errno.h:25">NGX_EACCES</a>:<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_OPENAT)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../../os/unix/ngx_errno.h.html#L58" title="os/unix/ngx_errno.h:58">NGX_EMLINK</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../../os/unix/ngx_errno.h.html#L54" title="os/unix/ngx_errno.h:54">NGX_ELOOP</a>:<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; level = <a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../ngx_http_request.h.html#L86" title="http/ngx_http_request.h:86">NGX_HTTP_FORBIDDEN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; level = <a href="../../core/ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../ngx_http_request.h.html#L87" title="http/ngx_http_request.h:87">NGX_HTTP_NOT_FOUND</a> || clcf-&gt;log_not_found) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(level, log, of.err,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant"> </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, of.failed, path.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!of.is_file) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../os/unix/ngx_files.h.html#L109" title="os/unix/ngx_files.h:109">ngx_close_file</a>(of.fd) == <a href="../../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <a href="../../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../os/unix/ngx_files.h.html#L110" title="os/unix/ngx_files.h:110">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, path.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;root_tested = !r-&gt;error_page;<br/></li>
<li>&nbsp; &nbsp; r-&gt;allow_ranges = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; start = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; length = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.content_length_n = of.size;<br/></li>
<li>&nbsp; &nbsp; mp4 = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; b = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;args.len) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_parse.c.html#L2039" title="http/ngx_http_parse.c:2039">ngx_http_arg</a>(r, (u_char *) <span class="Constant">&quot;start&quot;</span>, <span class="Constant">5</span>, &amp;value) == <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * A Flash player may send start value with a lot of digits<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * after dot so strtod() is used instead of atofp().&nbsp; NaNs and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * infinities become negative numbers after (int) conversion.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../os/unix/ngx_errno.h.html#L70" title="os/unix/ngx_errno.h:70">ngx_set_errno</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start = (<span class="Type">int</span>) (strtod((<span class="Type">char</span> *) value.data, <span class="Constant">NULL</span>) * <span class="Constant">1000</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a> != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_parse.c.html#L2039" title="http/ngx_http_parse.c:2039">ngx_http_arg</a>(r, (u_char *) <span class="Constant">&quot;end&quot;</span>, <span class="Constant">3</span>, &amp;value) == <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../os/unix/ngx_errno.h.html#L70" title="os/unix/ngx_errno.h:70">ngx_set_errno</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end = (<span class="Type">int</span>) (strtod((<span class="Type">char</span> *) value.data, <span class="Constant">NULL</span>) * <span class="Constant">1000</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a> != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (end &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (start &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (end &gt; start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; length = end - start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (start &gt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;single_range = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4 = <a href="../../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (mp4 == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.fd = of.fd;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name = path;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.log = r-&gt;connection-&gt;log;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;end = of.size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;start = (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;length = length;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;request = r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (<a href="#L690" title="http/modules/ngx_http_mp4_module.c:690">ngx_http_mp4_process</a>(mp4)) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;buffer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L280" title="core/ngx_palloc.c:280">ngx_pfree</a>(r-&gt;pool, mp4-&gt;buffer);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L280" title="core/ngx_palloc.c:280">ngx_pfree</a>(r-&gt;pool, mp4);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4 = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_length_n = mp4-&gt;content_length;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;buffer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L280" title="core/ngx_palloc.c:280">ngx_pfree</a>(r-&gt;pool, mp4-&gt;buffer);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L280" title="core/ngx_palloc.c:280">ngx_pfree</a>(r-&gt;pool, mp4);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; log-&gt;action = <span class="Constant">&quot;sending mp4 to client&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;directio &lt;= of.size) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * DIRECTIO is <a href="../../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> on transfer only<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * to allow kernel to cache &quot;moov&quot; atom<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../os/unix/ngx_files.c.html#L489" title="os/unix/ngx_files.c:489">ngx_directio_on</a>(of.fd) == <a href="../../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <a href="../../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../os/unix/ngx_files.h.html#L329" title="os/unix/ngx_files.h:329">ngx_directio_on_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, path.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; of.is_directio = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (mp4) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.directio = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.status = <a href="../ngx_http_request.h.html#L71" title="http/ngx_http_request.h:71">NGX_HTTP_OK</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.last_modified_time = of.mtime;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_core_module.c.html#L1819" title="http/ngx_http_core_module.c:1819">ngx_http_set_etag</a>(r) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_core_module.c.html#L1739" title="http/ngx_http_core_module.c:1739">ngx_http_set_content_type</a>(r) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4 == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = <a href="../../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;file = <a href="../../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="../../core/ngx_core.h.html#L20" title="core/ngx_core.h:20">ngx_file_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;file == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../ngx_http_core_module.c.html#L1974" title="http/ngx_http_core_module.c:1974">ngx_http_send_header</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a> || rc &gt; <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a> || r-&gt;header_only) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_core_module.c.html#L1996" title="http/ngx_http_core_module.c:1996">ngx_http_output_filter</a>(r, mp4-&gt;out);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;file_pos = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; b-&gt;file_last = of.size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;in_file = b-&gt;file_last ? <span class="Constant">1</span> : <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; b-&gt;last_buf = (r == r-&gt;<a href="../../core/nginx.c.html#L202" title="core/nginx.c:202">main</a>) ? <span class="Constant">1</span> : <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; b-&gt;last_in_chain = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;file-&gt;fd = of.fd;<br/></li>
<li>&nbsp; &nbsp; b-&gt;file-&gt;name = path;<br/></li>
<li>&nbsp; &nbsp; b-&gt;file-&gt;log = log;<br/></li>
<li>&nbsp; &nbsp; b-&gt;file-&gt;directio = of.is_directio;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out.buf = b;<br/></li>
<li>&nbsp; &nbsp; out.next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_core_module.c.html#L1996" title="http/ngx_http_core_module.c:1996">ngx_http_output_filter</a>(r, &amp;out);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L690">&#x200c;</a><span class="linkable">ngx_http_mp4_process</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">off_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start_offset, end_offset, adjustment;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i, j;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; **prev;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp;&nbsp; *trak;<br/></li>
<li>&nbsp; &nbsp; <a href="#L46" title="http/modules/ngx_http_mp4_module.c:46">ngx_http_mp4_conf_t</a>&nbsp;&nbsp; *conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 start:</span><span class="Special">%u</span><span class="Constant">i, length:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>, mp4-&gt;start, mp4-&gt;length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; conf = <a href="../ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(mp4-&gt;request, <a href="#L354" title="http/modules/ngx_http_mp4_module.c:354">ngx_http_mp4_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mp4-&gt;buffer_size = conf-&gt;buffer_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L856" title="http/modules/ngx_http_mp4_module.c:856">ngx_http_mp4_read_atom</a>(mp4, <a href="#L370" title="http/modules/ngx_http_mp4_module.c:370">ngx_http_mp4_atoms</a>, mp4-&gt;end);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;trak.nelts == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no mp4 trak atoms were found in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;mdat_atom.buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no mp4 mdat atom was found in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; prev = &amp;mp4-&gt;out;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;ftyp_atom.buf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *prev = &amp;mp4-&gt;ftyp_atom;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; prev = &amp;mp4-&gt;ftyp_atom.next;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *prev = &amp;mp4-&gt;moov_atom;<br/></li>
<li>&nbsp; &nbsp; prev = &amp;mp4-&gt;moov_atom.next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;mvhd_atom.buf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;moov_size += mp4-&gt;mvhd_atom_buf.last - mp4-&gt;mvhd_atom_buf.pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *prev = &amp;mp4-&gt;mvhd_atom;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; prev = &amp;mp4-&gt;mvhd_atom.next;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; start_offset = mp4-&gt;end;<br/></li>
<li>&nbsp; &nbsp; end_offset = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; trak = mp4-&gt;trak.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; mp4-&gt;trak.nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2055" title="http/modules/ngx_http_mp4_module.c:2055">ngx_http_mp4_update_stts_atom</a>(mp4, &amp;trak[i]) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2272" title="http/modules/ngx_http_mp4_module.c:2272">ngx_http_mp4_update_stss_atom</a>(mp4, &amp;trak[i]) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2470" title="http/modules/ngx_http_mp4_module.c:2470">ngx_http_mp4_update_ctts_atom</a>(mp4, &amp;trak[i]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2661" title="http/modules/ngx_http_mp4_module.c:2661">ngx_http_mp4_update_stsc_atom</a>(mp4, &amp;trak[i]) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3016" title="http/modules/ngx_http_mp4_module.c:3016">ngx_http_mp4_update_stsz_atom</a>(mp4, &amp;trak[i]) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (trak[i].out[<a href="#L38" title="http/modules/ngx_http_mp4_module.c:38">NGX_HTTP_MP4_CO64_DATA</a>].buf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3346" title="http/modules/ngx_http_mp4_module.c:3346">ngx_http_mp4_update_co64_atom</a>(mp4, &amp;trak[i]) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3162" title="http/modules/ngx_http_mp4_module.c:3162">ngx_http_mp4_update_stco_atom</a>(mp4, &amp;trak[i]) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1909" title="http/modules/ngx_http_mp4_module.c:1909">ngx_http_mp4_update_stbl_atom</a>(mp4, &amp;trak[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1776" title="http/modules/ngx_http_mp4_module.c:1776">ngx_http_mp4_update_minf_atom</a>(mp4, &amp;trak[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak[i].size += trak[i].mdhd_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak[i].size += trak[i].hdlr_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1583" title="http/modules/ngx_http_mp4_module.c:1583">ngx_http_mp4_update_mdia_atom</a>(mp4, &amp;trak[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak[i].size += trak[i].tkhd_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1400" title="http/modules/ngx_http_mp4_module.c:1400">ngx_http_mp4_update_trak_atom</a>(mp4, &amp;trak[i]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;moov_size += trak[i].size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (start_offset &gt; trak[i].start_offset) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start_offset = trak[i].start_offset;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (end_offset &lt; trak[i].end_offset) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end_offset = trak[i].end_offset;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *prev = &amp;trak[i].out[<a href="#L12" title="http/modules/ngx_http_mp4_module.c:12">NGX_HTTP_MP4_TRAK_ATOM</a>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; prev = &amp;trak[i].out[<a href="#L12" title="http/modules/ngx_http_mp4_module.c:12">NGX_HTTP_MP4_TRAK_ATOM</a>].next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (j = <span class="Constant">0</span>; j &lt; <a href="#L40" title="http/modules/ngx_http_mp4_module.c:40">NGX_HTTP_MP4_LAST_ATOM</a> + <span class="Constant">1</span>; j++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (trak[i].out[j].buf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *prev = &amp;trak[i].out[j];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev = &amp;trak[i].out[j].next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (end_offset &lt; start_offset) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; end_offset = start_offset;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mp4-&gt;moov_size += <span class="Constant">8</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(mp4-&gt;moov_atom_header, mp4-&gt;moov_size);<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(mp4-&gt;moov_atom_header, <span class="Constant">'m'</span>, <span class="Constant">'o'</span>, <span class="Constant">'o'</span>, <span class="Constant">'v'</span>);<br/></li>
<li>&nbsp; &nbsp; mp4-&gt;content_length += mp4-&gt;moov_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *prev = &amp;mp4-&gt;mdat_atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (start_offset &gt; mp4-&gt;mdat_data.buf-&gt;file_last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;start time is out mp4 mdat atom in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; adjustment = mp4-&gt;ftyp_size + mp4-&gt;moov_size<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + <a href="#L1168" title="http/modules/ngx_http_mp4_module.c:1168">ngx_http_mp4_update_mdat_atom</a>(mp4, start_offset, end_offset)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; - start_offset;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 adjustment:</span><span class="Special">%O</span><span class="Constant">&quot;</span>, adjustment);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; mp4-&gt;trak.nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (trak[i].out[<a href="#L38" title="http/modules/ngx_http_mp4_module.c:38">NGX_HTTP_MP4_CO64_DATA</a>].buf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3433" title="http/modules/ngx_http_mp4_module.c:3433">ngx_http_mp4_adjust_co64_atom</a>(mp4, &amp;trak[i], adjustment);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3249" title="http/modules/ngx_http_mp4_module.c:3249">ngx_http_mp4_adjust_stco_atom</a>(mp4, &amp;trak[i], (<span class="Type">int32_t</span>) adjustment);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li><a id="L846">&#x200c;</a>} <span class="linkable">ngx_mp4_atom_header_t</span>;<br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size64[<span class="Constant">8</span>];<br/></li>
<li><a id="L852">&#x200c;</a>} <span class="linkable">ngx_mp4_atom_header64_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L856">&#x200c;</a><span class="linkable">ngx_http_mp4_read_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L163" title="http/modules/ngx_http_mp4_module.c:163">ngx_http_mp4_atom_handler_t</a> *atom, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">off_t</span>&nbsp; &nbsp; &nbsp; &nbsp; end;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp;&nbsp; atom_header_size;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; *atom_header, *atom_name;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span>&nbsp; &nbsp;&nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp;&nbsp; n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; end = mp4-&gt;offset + atom_data_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (mp4-&gt;offset &lt; end) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L953" title="http/modules/ngx_http_mp4_module.c:953">ngx_http_mp4_read</a>(mp4, <span class="Statement">sizeof</span>(<span class="Type">uint32_t</span>)) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; atom_header = mp4-&gt;buffer_pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; atom_size = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(atom_header);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; atom_header_size = <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (atom_size == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 atom end&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (atom_size &lt; <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>)) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (atom_size == <span class="Constant">1</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L953" title="http/modules/ngx_http_mp4_module.c:953">ngx_http_mp4_read</a>(mp4, <span class="Statement">sizeof</span>(<a href="#L852" title="http/modules/ngx_http_mp4_module.c:852">ngx_mp4_atom_header64_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 64-bit atom size */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; atom_header = mp4-&gt;buffer_pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; atom_size = <a href="#L194" title="http/modules/ngx_http_mp4_module.c:194">ngx_mp4_get_64value</a>(atom_header + <span class="Constant">8</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; atom_header_size = <span class="Statement">sizeof</span>(<a href="#L852" title="http/modules/ngx_http_mp4_module.c:852">ngx_mp4_atom_header64_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 atom is too small:</span><span class="Special">%u</span><span class="Constant">L&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data, atom_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L953" title="http/modules/ngx_http_mp4_module.c:953">ngx_http_mp4_read</a>(mp4, <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>)) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; atom_header = mp4-&gt;buffer_pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; atom_name = atom_header + <span class="Statement">sizeof</span>(<span class="Type">uint32_t</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L144" title="core/ngx_log.h:144">ngx_log_debug4</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 atom: </span><span class="Special">%*s</span><span class="Constant"> @</span><span class="Special">%O</span><span class="Constant">:</span><span class="Special">%u</span><span class="Constant">L&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">4</span>, atom_name, mp4-&gt;offset, atom_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (atom_size &gt; (<span class="Type">uint64_t</span>) (NGX_MAX_OFF_T_VALUE - mp4-&gt;offset)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || mp4-&gt;offset + (<span class="Type">off_t</span>) atom_size &gt; end)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 atom too large:</span><span class="Special">%u</span><span class="Constant">L&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data, atom_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; atom[n].name; n++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(atom_name, atom[n].name, <span class="Constant">4</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_header_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = atom[n].handler(mp4, atom_size - atom_header_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_size);<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">next</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L953">&#x200c;</a><span class="linkable">ngx_http_mp4_read</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;buffer_pos + size &lt;= mp4-&gt;buffer_end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;offset + (<span class="Type">off_t</span>) mp4-&gt;buffer_size &gt; mp4-&gt;end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;buffer_size = (<span class="Type">size_t</span>) (mp4-&gt;end - mp4-&gt;offset);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;buffer_size &lt; size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 file truncated&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;buffer == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;buffer = <a href="../../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(mp4-&gt;request-&gt;pool, mp4-&gt;buffer_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;buffer == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;buffer_start = mp4-&gt;buffer;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = <a href="../../os/unix/ngx_files.c.html#L20" title="os/unix/ngx_files.c:20">ngx_read_file</a>(&amp;mp4-&gt;file, mp4-&gt;buffer_start, mp4-&gt;buffer_size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) n != mp4-&gt;buffer_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../os/unix/ngx_files.h.html#L124" title="os/unix/ngx_files.h:124">ngx_read_file_n</a> <span class="Constant">&quot; read only %z of %z from </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n, mp4-&gt;buffer_size, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mp4-&gt;buffer_pos = mp4-&gt;buffer_start;<br/></li>
<li>&nbsp; &nbsp; mp4-&gt;buffer_end = mp4-&gt;buffer_start + mp4-&gt;buffer_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1002">&#x200c;</a><span class="linkable">ngx_http_mp4_read_ftyp_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp;&nbsp; *ftyp_atom;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 ftyp atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (atom_data_size &gt; <span class="Constant">1024<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; || <a href="#L167" title="http/modules/ngx_http_mp4_module.c:167">ngx_mp4_atom_data</a>(mp4) + (<span class="Type">size_t</span>) atom_data_size &gt; mp4-&gt;buffer_end)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 ftyp atom is too large:</span><span class="Special">%u</span><span class="Constant">L&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data, atom_data_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>) + (<span class="Type">size_t</span>) atom_data_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ftyp_atom = <a href="../../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(mp4-&gt;request-&gt;pool, atom_size);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ftyp_atom == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(ftyp_atom, atom_size);<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(ftyp_atom, <span class="Constant">'f'</span>, <span class="Constant">'t'</span>, <span class="Constant">'y'</span>, <span class="Constant">'p'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * only moov atom content is guaranteed to be in mp4-&gt;buffer<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * during sending response, so ftyp atom content should be copied<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(ftyp_atom + <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L167" title="http/modules/ngx_http_mp4_module.c:167">ngx_mp4_atom_data</a>(mp4), (<span class="Type">size_t</span>) atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;mp4-&gt;ftyp_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = ftyp_atom;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = ftyp_atom + atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mp4-&gt;ftyp_atom.buf = atom;<br/></li>
<li>&nbsp; &nbsp; mp4-&gt;ftyp_size = atom_size;<br/></li>
<li>&nbsp; &nbsp; mp4-&gt;content_length = atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Small excess buffer to process atoms after moov atom, mp4-&gt;buffer_start<br/></li>
<li></span><span class="Comment"> * will be <a href="../../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> to this buffer part after moov atom processing.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L1055">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_MP4_MOOV_BUFFER_EXCESS</span>&nbsp; (</span><span class="Constant">4</span><span class="PreProc"> * </span><span class="Constant">1024</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1058">&#x200c;</a><span class="linkable">ngx_http_mp4_read_moov_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; no_mdat;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L46" title="http/modules/ngx_http_mp4_module.c:46">ngx_http_mp4_conf_t</a>&nbsp; *conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 moov atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; no_mdat = (mp4-&gt;mdat_atom.buf == <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (no_mdat &amp;&amp; mp4-&gt;start == <span class="Constant">0</span> &amp;&amp; mp4-&gt;length == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * send original file if moov atom resides before<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * mdat atom and client requests integral file<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; conf = <a href="../ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(mp4-&gt;request, <a href="#L354" title="http/modules/ngx_http_mp4_module.c:354">ngx_http_mp4_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (atom_data_size &gt; mp4-&gt;buffer_size) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (atom_data_size &gt; conf-&gt;max_buffer_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 moov atom is too large:</span><span class="Special">%u</span><span class="Constant">L, &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;you may want to increase mp4_max_buffer_size&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data, atom_data_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L280" title="core/ngx_palloc.c:280">ngx_pfree</a>(mp4-&gt;request-&gt;pool, mp4-&gt;buffer);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;buffer = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;buffer_pos = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;buffer_end = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;buffer_size = (<span class="Type">size_t</span>) atom_data_size<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + <a href="#L1055" title="http/modules/ngx_http_mp4_module.c:1055">NGX_HTTP_MP4_MOOV_BUFFER_EXCESS</a> * no_mdat;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L953" title="http/modules/ngx_http_mp4_module.c:953">ngx_http_mp4_read</a>(mp4, (<span class="Type">size_t</span>) atom_data_size) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mp4-&gt;trak.elts = &amp;mp4-&gt;traks;<br/></li>
<li>&nbsp; &nbsp; mp4-&gt;trak.size = <span class="Statement">sizeof</span>(<a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>);<br/></li>
<li>&nbsp; &nbsp; mp4-&gt;trak.nalloc = <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; mp4-&gt;trak.pool = mp4-&gt;request-&gt;pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;mp4-&gt;moov_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = mp4-&gt;moov_atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = mp4-&gt;moov_atom_header + <span class="Constant">8</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mp4-&gt;moov_atom.buf = &amp;mp4-&gt;moov_atom_buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L856" title="http/modules/ngx_http_mp4_module.c:856">ngx_http_mp4_read_atom</a>(mp4, <a href="#L377" title="http/modules/ngx_http_mp4_module.c:377">ngx_http_mp4_moov_atoms</a>, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 moov atom done&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (no_mdat) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;buffer_start = mp4-&gt;buffer_pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;buffer_size = <a href="#L1055" title="http/modules/ngx_http_mp4_module.c:1055">NGX_HTTP_MP4_MOOV_BUFFER_EXCESS</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;buffer_start + mp4-&gt;buffer_size &gt; mp4-&gt;buffer_end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;buffer = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;buffer_pos = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;buffer_end = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* skip atoms after moov atom */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;offset = mp4-&gt;end;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1138">&#x200c;</a><span class="linkable">ngx_http_mp4_read_mdat_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 mdat atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = &amp;mp4-&gt;mdat_data_buf;<br/></li>
<li>&nbsp; &nbsp; data-&gt;file = &amp;mp4-&gt;file;<br/></li>
<li>&nbsp; &nbsp; data-&gt;in_file = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; data-&gt;last_buf = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; data-&gt;last_in_chain = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; data-&gt;file_last = mp4-&gt;offset + atom_data_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mp4-&gt;mdat_atom.buf = &amp;mp4-&gt;mdat_atom_buf;<br/></li>
<li>&nbsp; &nbsp; mp4-&gt;mdat_atom.next = &amp;mp4-&gt;mdat_data;<br/></li>
<li>&nbsp; &nbsp; mp4-&gt;mdat_data.buf = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;trak.nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* skip atoms after mdat atom */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;offset = mp4-&gt;end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">size_t<br/></li>
<li><a id="L1168">&#x200c;</a></span><span class="linkable">ngx_http_mp4_update_mdat_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">off_t</span> start_offset,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">off_t</span> end_offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">off_t</span>&nbsp; &nbsp; &nbsp;&nbsp; atom_data_size;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp;&nbsp; *atom_header;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; atom_header_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span>&nbsp; &nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_data_size = end_offset - start_offset;<br/></li>
<li>&nbsp; &nbsp; mp4-&gt;mdat_data.buf-&gt;file_pos = start_offset;<br/></li>
<li>&nbsp; &nbsp; mp4-&gt;mdat_data.buf-&gt;file_last = end_offset;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mdat new offset @</span><span class="Special">%O</span><span class="Constant">:</span><span class="Special">%O</span><span class="Constant">&quot;</span>, start_offset, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = mp4-&gt;mdat_atom_header;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">uint64_t</span>) atom_data_size &gt; (<span class="Type">uint64_t</span>) <span class="Constant">0xffffffff</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; atom_size = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; atom_header_size = <span class="Statement">sizeof</span>(<a href="#L852" title="http/modules/ngx_http_mp4_module.c:852">ngx_mp4_atom_header64_t</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L204" title="http/modules/ngx_http_mp4_module.c:204">ngx_mp4_set_64value</a>(atom_header + <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="#L852" title="http/modules/ngx_http_mp4_module.c:852">ngx_mp4_atom_header64_t</a>) + atom_data_size);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>) + atom_data_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; atom_header_size = <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mp4-&gt;content_length += atom_header_size + atom_data_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(atom_header, atom_size);<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(atom_header, <span class="Constant">'m'</span>, <span class="Constant">'d'</span>, <span class="Constant">'a'</span>, <span class="Constant">'t'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;mp4-&gt;mdat_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_header + atom_header_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> atom_header_size;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; version[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; flags[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; creation_time[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; modification_time[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; timescale[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; duration[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; rate[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; volume[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; reserved[<span class="Constant">10</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; matrix[<span class="Constant">36</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; preview_time[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; preview_duration[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; poster_time[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; selection_time[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; selection_duration[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; current_time[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; next_track_id[<span class="Constant">4</span>];<br/></li>
<li><a id="L1230">&#x200c;</a>} <span class="linkable">ngx_mp4_mvhd_atom_t</span>;<br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; version[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; flags[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; creation_time[<span class="Constant">8</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; modification_time[<span class="Constant">8</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; timescale[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; duration[<span class="Constant">8</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; rate[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; volume[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; reserved[<span class="Constant">10</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; matrix[<span class="Constant">36</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; preview_time[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; preview_duration[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; poster_time[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; selection_time[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; selection_duration[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; current_time[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; next_track_id[<span class="Constant">4</span>];<br/></li>
<li><a id="L1252">&#x200c;</a>} <span class="linkable">ngx_mp4_mvhd64_atom_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1256">&#x200c;</a><span class="linkable">ngx_http_mp4_read_mvhd_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom_header;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timescale;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; duration, start_time, length_time;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1230" title="http/modules/ngx_http_mp4_module.c:1230">ngx_mp4_mvhd_atom_t</a>&nbsp; &nbsp; *mvhd_atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1252" title="http/modules/ngx_http_mp4_module.c:1252">ngx_mp4_mvhd64_atom_t</a>&nbsp; *mvhd64_atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 mvhd atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; mvhd_atom = (<a href="#L1230" title="http/modules/ngx_http_mp4_module.c:1230">ngx_mp4_mvhd_atom_t</a> *) atom_header;<br/></li>
<li>&nbsp; &nbsp; mvhd64_atom = (<a href="#L1252" title="http/modules/ngx_http_mp4_module.c:1252">ngx_mp4_mvhd64_atom_t</a> *) atom_header;<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(atom_header, <span class="Constant">'m'</span>, <span class="Constant">'v'</span>, <span class="Constant">'h'</span>, <span class="Constant">'d'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L1230" title="http/modules/ngx_http_mp4_module.c:1230">ngx_mp4_mvhd_atom_t</a>) &gt; atom_data_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 mvhd atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mvhd_atom-&gt;version[<span class="Constant">0</span>] == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* version 0: 32-bit duration */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; timescale = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(mvhd_atom-&gt;timescale);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; duration = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(mvhd_atom-&gt;duration);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* version 1: 64-bit duration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L1252" title="http/modules/ngx_http_mp4_module.c:1252">ngx_mp4_mvhd64_atom_t</a>) &gt; atom_data_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 mvhd atom too small&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timescale = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(mvhd64_atom-&gt;timescale);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; duration = <a href="#L194" title="http/modules/ngx_http_mp4_module.c:194">ngx_mp4_get_64value</a>(mvhd64_atom-&gt;duration);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mp4-&gt;timescale = timescale;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L141" title="core/ngx_log.h:141">ngx_log_debug3</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mvhd timescale:</span><span class="Special">%u</span><span class="Constant">D, duration:</span><span class="Special">%u</span><span class="Constant">L, time:</span><span class="Special">%.3f</span><span class="Constant">s&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; timescale, duration, (<span class="Type">double</span>) duration / timescale);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; start_time = (<span class="Type">uint64_t</span>) mp4-&gt;start * timescale / <span class="Constant">1000</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (duration &lt; start_time) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 start time exceeds file duration&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; duration -= start_time;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; length_time = (<span class="Type">uint64_t</span>) mp4-&gt;length * timescale / <span class="Constant">1000</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (duration &gt; length_time) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; duration = length_time;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mvhd new duration:</span><span class="Special">%u</span><span class="Constant">L, time:</span><span class="Special">%.3f</span><span class="Constant">s&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; duration, (<span class="Type">double</span>) duration / timescale);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>) + (<span class="Type">size_t</span>) atom_data_size;<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(mvhd_atom-&gt;size, atom_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mvhd_atom-&gt;version[<span class="Constant">0</span>] == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(mvhd_atom-&gt;duration, duration);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L204" title="http/modules/ngx_http_mp4_module.c:204">ngx_mp4_set_64value</a>(mvhd64_atom-&gt;duration, duration);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;mp4-&gt;mvhd_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_header + atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mp4-&gt;mvhd_atom.buf = atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1351">&#x200c;</a><span class="linkable">ngx_http_mp4_read_trak_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom_header, *atom_end;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">off_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; atom_file_end;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; *trak;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 trak atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="../../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(&amp;mp4-&gt;trak);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (trak == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(trak, <span class="Statement">sizeof</span>(<a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(atom_header, <span class="Constant">'t'</span>, <span class="Constant">'r'</span>, <span class="Constant">'a'</span>, <span class="Constant">'k'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;trak_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_header + <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L12" title="http/modules/ngx_http_mp4_module.c:12">NGX_HTTP_MP4_TRAK_ATOM</a>].buf = atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_end = mp4-&gt;buffer_pos + (<span class="Type">size_t</span>) atom_data_size;<br/></li>
<li>&nbsp; &nbsp; atom_file_end = mp4-&gt;offset + atom_data_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L856" title="http/modules/ngx_http_mp4_module.c:856">ngx_http_mp4_read_atom</a>(mp4, <a href="#L384" title="http/modules/ngx_http_mp4_module.c:384">ngx_http_mp4_trak_atoms</a>, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 trak atom: </span><span class="Special">%i</span><span class="Constant">&quot;</span>, rc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* skip this trak */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(trak, <span class="Statement">sizeof</span>(<a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;trak.nelts--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;buffer_pos = atom_end;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;offset = atom_file_end;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1400">&#x200c;</a></span><span class="linkable">ngx_http_mp4_update_trak_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;size += <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>);<br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;trak_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(atom-&gt;pos, trak-&gt;size);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1412">&#x200c;</a><span class="linkable">ngx_http_mp4_read_cmov_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 compressed moov atom (cmov) is not supported&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; version[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; flags[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; creation_time[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; modification_time[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; track_id[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; reserved1[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; duration[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; reserved2[<span class="Constant">8</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; layer[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; group[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; volume[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; reverved3[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; matrix[<span class="Constant">36</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; width[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; heigth[<span class="Constant">4</span>];<br/></li>
<li><a id="L1440">&#x200c;</a>} <span class="linkable">ngx_mp4_tkhd_atom_t</span>;<br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; version[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; flags[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; creation_time[<span class="Constant">8</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; modification_time[<span class="Constant">8</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; track_id[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; reserved1[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; duration[<span class="Constant">8</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; reserved2[<span class="Constant">8</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; layer[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; group[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; volume[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; reverved3[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; matrix[<span class="Constant">36</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; width[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; heigth[<span class="Constant">4</span>];<br/></li>
<li><a id="L1460">&#x200c;</a>} <span class="linkable">ngx_mp4_tkhd64_atom_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1464">&#x200c;</a><span class="linkable">ngx_http_mp4_read_tkhd_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom_header;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; duration, start_time, length_time;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; &nbsp; *trak;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1440" title="http/modules/ngx_http_mp4_module.c:1440">ngx_mp4_tkhd_atom_t</a>&nbsp; &nbsp; *tkhd_atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1460" title="http/modules/ngx_http_mp4_module.c:1460">ngx_mp4_tkhd64_atom_t</a>&nbsp; *tkhd64_atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 tkhd atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; tkhd_atom = (<a href="#L1440" title="http/modules/ngx_http_mp4_module.c:1440">ngx_mp4_tkhd_atom_t</a> *) atom_header;<br/></li>
<li>&nbsp; &nbsp; tkhd64_atom = (<a href="#L1460" title="http/modules/ngx_http_mp4_module.c:1460">ngx_mp4_tkhd64_atom_t</a> *) atom_header;<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(tkhd_atom, <span class="Constant">'t'</span>, <span class="Constant">'k'</span>, <span class="Constant">'h'</span>, <span class="Constant">'d'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L1440" title="http/modules/ngx_http_mp4_module.c:1440">ngx_mp4_tkhd_atom_t</a>) &gt; atom_data_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 tkhd atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (tkhd_atom-&gt;version[<span class="Constant">0</span>] == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* version 0: 32-bit duration */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; duration = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(tkhd_atom-&gt;duration);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* version 1: 64-bit duration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L1460" title="http/modules/ngx_http_mp4_module.c:1460">ngx_mp4_tkhd64_atom_t</a>) &gt; atom_data_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 tkhd atom too small&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; duration = <a href="#L194" title="http/modules/ngx_http_mp4_module.c:194">ngx_mp4_get_64value</a>(tkhd64_atom-&gt;duration);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;tkhd duration:</span><span class="Special">%u</span><span class="Constant">L, time:</span><span class="Special">%.3f</span><span class="Constant">s&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; duration, (<span class="Type">double</span>) duration / mp4-&gt;timescale);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; start_time = (<span class="Type">uint64_t</span>) mp4-&gt;start * mp4-&gt;timescale / <span class="Constant">1000</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (duration &lt;= start_time) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;tkhd duration is less than start time&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; duration -= start_time;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; length_time = (<span class="Type">uint64_t</span>) mp4-&gt;length * mp4-&gt;timescale / <span class="Constant">1000</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (duration &gt; length_time) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; duration = length_time;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;tkhd new duration:</span><span class="Special">%u</span><span class="Constant">L, time:</span><span class="Special">%.3f</span><span class="Constant">s&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; duration, (<span class="Type">double</span>) duration / mp4-&gt;timescale);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>) + (<span class="Type">size_t</span>) atom_data_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;tkhd_size = atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(tkhd_atom-&gt;size, atom_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (tkhd_atom-&gt;version[<span class="Constant">0</span>] == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(tkhd_atom-&gt;duration, duration);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L204" title="http/modules/ngx_http_mp4_module.c:204">ngx_mp4_set_64value</a>(tkhd64_atom-&gt;duration, duration);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;tkhd_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_header + atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L13" title="http/modules/ngx_http_mp4_module.c:13">NGX_HTTP_MP4_TKHD_ATOM</a>].buf = atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1558">&#x200c;</a><span class="linkable">ngx_http_mp4_read_mdia_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom_header;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; *trak;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;process mdia atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(atom_header, <span class="Constant">'m'</span>, <span class="Constant">'d'</span>, <span class="Constant">'i'</span>, <span class="Constant">'a'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;mdia_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_header + <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L14" title="http/modules/ngx_http_mp4_module.c:14">NGX_HTTP_MP4_MDIA_ATOM</a>].buf = atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L856" title="http/modules/ngx_http_mp4_module.c:856">ngx_http_mp4_read_atom</a>(mp4, <a href="#L390" title="http/modules/ngx_http_mp4_module.c:390">ngx_http_mp4_mdia_atoms</a>, atom_data_size);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1583">&#x200c;</a></span><span class="linkable">ngx_http_mp4_update_mdia_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;size += <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>);<br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;mdia_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(atom-&gt;pos, trak-&gt;size);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; version[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; flags[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; creation_time[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; modification_time[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; timescale[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; duration[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; language[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; quality[<span class="Constant">2</span>];<br/></li>
<li><a id="L1605">&#x200c;</a>} <span class="linkable">ngx_mp4_mdhd_atom_t</span>;<br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; version[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; flags[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; creation_time[<span class="Constant">8</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; modification_time[<span class="Constant">8</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; timescale[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; duration[<span class="Constant">8</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; language[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; quality[<span class="Constant">2</span>];<br/></li>
<li><a id="L1618">&#x200c;</a>} <span class="linkable">ngx_mp4_mdhd64_atom_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1622">&#x200c;</a><span class="linkable">ngx_http_mp4_read_mdhd_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom_header;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timescale;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; duration, start_time, length_time;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; &nbsp; *trak;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1605" title="http/modules/ngx_http_mp4_module.c:1605">ngx_mp4_mdhd_atom_t</a>&nbsp; &nbsp; *mdhd_atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1618" title="http/modules/ngx_http_mp4_module.c:1618">ngx_mp4_mdhd64_atom_t</a>&nbsp; *mdhd64_atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 mdhd atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; mdhd_atom = (<a href="#L1605" title="http/modules/ngx_http_mp4_module.c:1605">ngx_mp4_mdhd_atom_t</a> *) atom_header;<br/></li>
<li>&nbsp; &nbsp; mdhd64_atom = (<a href="#L1618" title="http/modules/ngx_http_mp4_module.c:1618">ngx_mp4_mdhd64_atom_t</a> *) atom_header;<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(mdhd_atom, <span class="Constant">'m'</span>, <span class="Constant">'d'</span>, <span class="Constant">'h'</span>, <span class="Constant">'d'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L1605" title="http/modules/ngx_http_mp4_module.c:1605">ngx_mp4_mdhd_atom_t</a>) &gt; atom_data_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 mdhd atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mdhd_atom-&gt;version[<span class="Constant">0</span>] == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* version 0: everything is 32-bit */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; timescale = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(mdhd_atom-&gt;timescale);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; duration = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(mdhd_atom-&gt;duration);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* version 1: 64-bit duration and 32-bit timescale */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L1618" title="http/modules/ngx_http_mp4_module.c:1618">ngx_mp4_mdhd64_atom_t</a>) &gt; atom_data_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 mdhd atom too small&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timescale = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(mdhd64_atom-&gt;timescale);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; duration = <a href="#L194" title="http/modules/ngx_http_mp4_module.c:194">ngx_mp4_get_64value</a>(mdhd64_atom-&gt;duration);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L141" title="core/ngx_log.h:141">ngx_log_debug3</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mdhd timescale:</span><span class="Special">%u</span><span class="Constant">D, duration:</span><span class="Special">%u</span><span class="Constant">L, time:</span><span class="Special">%.3f</span><span class="Constant">s&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; timescale, duration, (<span class="Type">double</span>) duration / timescale);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; start_time = (<span class="Type">uint64_t</span>) mp4-&gt;start * timescale / <span class="Constant">1000</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (duration &lt;= start_time) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mdhd duration is less than start time&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; duration -= start_time;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; length_time = (<span class="Type">uint64_t</span>) mp4-&gt;length * timescale / <span class="Constant">1000</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (duration &gt; length_time) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; duration = length_time;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mdhd new duration:</span><span class="Special">%u</span><span class="Constant">L, time:</span><span class="Special">%.3f</span><span class="Constant">s&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; duration, (<span class="Type">double</span>) duration / timescale);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>) + (<span class="Type">size_t</span>) atom_data_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;mdhd_size = atom_size;<br/></li>
<li>&nbsp; &nbsp; trak-&gt;timescale = timescale;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(mdhd_atom-&gt;size, atom_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mdhd_atom-&gt;version[<span class="Constant">0</span>] == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(mdhd_atom-&gt;duration, duration);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L204" title="http/modules/ngx_http_mp4_module.c:204">ngx_mp4_set_64value</a>(mdhd64_atom-&gt;duration, duration);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;mdhd_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_header + atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L15" title="http/modules/ngx_http_mp4_module.c:15">NGX_HTTP_MP4_MDHD_ATOM</a>].buf = atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1720">&#x200c;</a><span class="linkable">ngx_http_mp4_read_hdlr_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom_header;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; *trak;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 hdlr atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>) + (<span class="Type">size_t</span>) atom_data_size;<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(atom_header, atom_size);<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(atom_header, <span class="Constant">'h'</span>, <span class="Constant">'d'</span>, <span class="Constant">'l'</span>, <span class="Constant">'r'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;hdlr_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_header + atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;hdlr_size = atom_size;<br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L16" title="http/modules/ngx_http_mp4_module.c:16">NGX_HTTP_MP4_HDLR_ATOM</a>].buf = atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1751">&#x200c;</a><span class="linkable">ngx_http_mp4_read_minf_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom_header;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; *trak;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;process minf atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(atom_header, <span class="Constant">'m'</span>, <span class="Constant">'i'</span>, <span class="Constant">'n'</span>, <span class="Constant">'f'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;minf_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_header + <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L17" title="http/modules/ngx_http_mp4_module.c:17">NGX_HTTP_MP4_MINF_ATOM</a>].buf = atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L856" title="http/modules/ngx_http_mp4_module.c:856">ngx_http_mp4_read_atom</a>(mp4, <a href="#L397" title="http/modules/ngx_http_mp4_module.c:397">ngx_http_mp4_minf_atoms</a>, atom_data_size);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1776">&#x200c;</a></span><span class="linkable">ngx_http_mp4_update_minf_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;size += <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + trak-&gt;vmhd_size<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + trak-&gt;smhd_size<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + trak-&gt;dinf_size;<br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;minf_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(atom-&gt;pos, trak-&gt;size);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1791">&#x200c;</a><span class="linkable">ngx_http_mp4_read_vmhd_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom_header;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; *trak;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 vmhd atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>) + (<span class="Type">size_t</span>) atom_data_size;<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(atom_header, atom_size);<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(atom_header, <span class="Constant">'v'</span>, <span class="Constant">'m'</span>, <span class="Constant">'h'</span>, <span class="Constant">'d'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;vmhd_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_header + atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;vmhd_size += atom_size;<br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L18" title="http/modules/ngx_http_mp4_module.c:18">NGX_HTTP_MP4_VMHD_ATOM</a>].buf = atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1822">&#x200c;</a><span class="linkable">ngx_http_mp4_read_smhd_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom_header;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; *trak;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 smhd atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>) + (<span class="Type">size_t</span>) atom_data_size;<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(atom_header, atom_size);<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(atom_header, <span class="Constant">'s'</span>, <span class="Constant">'m'</span>, <span class="Constant">'h'</span>, <span class="Constant">'d'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;smhd_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_header + atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;smhd_size += atom_size;<br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L19" title="http/modules/ngx_http_mp4_module.c:19">NGX_HTTP_MP4_SMHD_ATOM</a>].buf = atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1853">&#x200c;</a><span class="linkable">ngx_http_mp4_read_dinf_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom_header;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; *trak;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 dinf atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>) + (<span class="Type">size_t</span>) atom_data_size;<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(atom_header, atom_size);<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(atom_header, <span class="Constant">'d'</span>, <span class="Constant">'i'</span>, <span class="Constant">'n'</span>, <span class="Constant">'f'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;dinf_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_header + atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;dinf_size += atom_size;<br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L20" title="http/modules/ngx_http_mp4_module.c:20">NGX_HTTP_MP4_DINF_ATOM</a>].buf = atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1884">&#x200c;</a><span class="linkable">ngx_http_mp4_read_stbl_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom_header;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; *trak;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;process stbl atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(atom_header, <span class="Constant">'s'</span>, <span class="Constant">'t'</span>, <span class="Constant">'b'</span>, <span class="Constant">'l'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;stbl_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_header + <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L21" title="http/modules/ngx_http_mp4_module.c:21">NGX_HTTP_MP4_STBL_ATOM</a>].buf = atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L856" title="http/modules/ngx_http_mp4_module.c:856">ngx_http_mp4_read_atom</a>(mp4, <a href="#L405" title="http/modules/ngx_http_mp4_module.c:405">ngx_http_mp4_stbl_atoms</a>, atom_data_size);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1909">&#x200c;</a></span><span class="linkable">ngx_http_mp4_update_stbl_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;size += <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>);<br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;stbl_atom_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(atom-&gt;pos, trak-&gt;size);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; version[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; flags[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; entries[<span class="Constant">4</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; media_size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; media_name[<span class="Constant">4</span>];<br/></li>
<li><a id="L1929">&#x200c;</a>} <span class="linkable">ngx_mp4_stsd_atom_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1933">&#x200c;</a><span class="linkable">ngx_http_mp4_read_stsd_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom_header, *atom_table;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1929" title="http/modules/ngx_http_mp4_module.c:1929">ngx_mp4_stsd_atom_t</a>&nbsp; *stsd_atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; *trak;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* sample description atom */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 stsd atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; stsd_atom = (<a href="#L1929" title="http/modules/ngx_http_mp4_module.c:1929">ngx_mp4_stsd_atom_t</a> *) atom_header;<br/></li>
<li>&nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>) + (<span class="Type">size_t</span>) atom_data_size;<br/></li>
<li>&nbsp; &nbsp; atom_table = atom_header + atom_size;<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(stsd_atom-&gt;size, atom_size);<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(stsd_atom, <span class="Constant">'s'</span>, <span class="Constant">'t'</span>, <span class="Constant">'s'</span>, <span class="Constant">'d'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L1929" title="http/modules/ngx_http_mp4_module.c:1929">ngx_mp4_stsd_atom_t</a>) &gt; atom_data_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 stsd atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L141" title="core/ngx_log.h:141">ngx_log_debug3</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;stsd entries:</span><span class="Special">%u</span><span class="Constant">D, media:</span><span class="Special">%*s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(stsd_atom-&gt;entries),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">4</span>, stsd_atom-&gt;media_name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;stsd_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_table;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L22" title="http/modules/ngx_http_mp4_module.c:22">NGX_HTTP_MP4_STSD_ATOM</a>].buf = atom;<br/></li>
<li>&nbsp; &nbsp; trak-&gt;size += atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; version[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; flags[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; entries[<span class="Constant">4</span>];<br/></li>
<li><a id="L1985">&#x200c;</a>} <span class="linkable">ngx_mp4_stts_atom_t</span>;<br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; count[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; duration[<span class="Constant">4</span>];<br/></li>
<li><a id="L1990">&#x200c;</a>} <span class="linkable">ngx_mp4_stts_entry_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1994">&#x200c;</a><span class="linkable">ngx_http_mp4_read_stts_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom_header, *atom_table, *atom_end;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entries;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom, *data;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1985" title="http/modules/ngx_http_mp4_module.c:1985">ngx_mp4_stts_atom_t</a>&nbsp; *stts_atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; *trak;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* time-to-sample atom */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 stts atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; stts_atom = (<a href="#L1985" title="http/modules/ngx_http_mp4_module.c:1985">ngx_mp4_stts_atom_t</a> *) atom_header;<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(stts_atom, <span class="Constant">'s'</span>, <span class="Constant">'t'</span>, <span class="Constant">'t'</span>, <span class="Constant">'s'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L1985" title="http/modules/ngx_http_mp4_module.c:1985">ngx_mp4_stts_atom_t</a>) &gt; atom_data_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 stts atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entries = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(stts_atom-&gt;entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 time-to-sample entries:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>, entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L1985" title="http/modules/ngx_http_mp4_module.c:1985">ngx_mp4_stts_atom_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; + entries * <span class="Statement">sizeof</span>(<a href="#L1990" title="http/modules/ngx_http_mp4_module.c:1990">ngx_mp4_stts_entry_t</a>) &gt; atom_data_size)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 stts atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_table = atom_header + <span class="Statement">sizeof</span>(<a href="#L1985" title="http/modules/ngx_http_mp4_module.c:1985">ngx_mp4_stts_atom_t</a>);<br/></li>
<li>&nbsp; &nbsp; atom_end = atom_table + entries * <span class="Statement">sizeof</span>(<a href="#L1990" title="http/modules/ngx_http_mp4_module.c:1990">ngx_mp4_stts_entry_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;time_to_sample_entries = entries;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;stts_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_table;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = &amp;trak-&gt;stts_data_buf;<br/></li>
<li>&nbsp; &nbsp; data-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; data-&gt;pos = atom_table;<br/></li>
<li>&nbsp; &nbsp; data-&gt;last = atom_end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L23" title="http/modules/ngx_http_mp4_module.c:23">NGX_HTTP_MP4_STTS_ATOM</a>].buf = atom;<br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L24" title="http/modules/ngx_http_mp4_module.c:24">NGX_HTTP_MP4_STTS_DATA</a>].buf = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2055">&#x200c;</a><span class="linkable">ngx_http_mp4_update_stts_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom, *data;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1985" title="http/modules/ngx_http_mp4_module.c:1985">ngx_mp4_stts_atom_t</a>&nbsp; *stts_atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * mdia.minf.stbl.stts updating requires trak-&gt;timescale<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * from mdia.mdhd atom which may reside after mdia.minf<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 stts atom update&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = trak-&gt;out[<a href="#L24" title="http/modules/ngx_http_mp4_module.c:24">NGX_HTTP_MP4_STTS_DATA</a>].buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no mp4 stts atoms were found in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2103" title="http/modules/ngx_http_mp4_module.c:2103">ngx_http_mp4_crop_stts_data</a>(mp4, trak, <span class="Constant">1</span>) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2103" title="http/modules/ngx_http_mp4_module.c:2103">ngx_http_mp4_crop_stts_data</a>(mp4, trak, <span class="Constant">0</span>) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;time-to-sample entries:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>, trak-&gt;time_to_sample_entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L1985" title="http/modules/ngx_http_mp4_module.c:1985">ngx_mp4_stts_atom_t</a>) + (data-&gt;last - data-&gt;pos);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;size += atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = trak-&gt;out[<a href="#L23" title="http/modules/ngx_http_mp4_module.c:23">NGX_HTTP_MP4_STTS_ATOM</a>].buf;<br/></li>
<li>&nbsp; &nbsp; stts_atom = (<a href="#L1985" title="http/modules/ngx_http_mp4_module.c:1985">ngx_mp4_stts_atom_t</a> *) atom-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(stts_atom-&gt;size, atom_size);<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(stts_atom-&gt;entries, trak-&gt;time_to_sample_entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2103">&#x200c;</a><span class="linkable">ngx_http_mp4_crop_stts_data</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> start)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; count, duration, rest;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; start_time;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *data;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; start_sample, entries, start_sec;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1990" title="http/modules/ngx_http_mp4_module.c:1990">ngx_mp4_stts_entry_t</a>&nbsp; *entry, *end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start_sec = mp4-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 stts crop start_time:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>, start_sec);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (mp4-&gt;length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start_sec = mp4-&gt;length;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 stts crop end_time:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>, start_sec);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = trak-&gt;out[<a href="#L24" title="http/modules/ngx_http_mp4_module.c:24">NGX_HTTP_MP4_STTS_DATA</a>].buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; start_time = (<span class="Type">uint64_t</span>) start_sec * trak-&gt;timescale / <span class="Constant">1000</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entries = trak-&gt;time_to_sample_entries;<br/></li>
<li>&nbsp; &nbsp; start_sample = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; entry = (<a href="#L1990" title="http/modules/ngx_http_mp4_module.c:1990">ngx_mp4_stts_entry_t</a> *) data-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; end = (<a href="#L1990" title="http/modules/ngx_http_mp4_module.c:1990">ngx_mp4_stts_entry_t</a> *) data-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (entry &lt; end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; count = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(entry-&gt;count);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; duration = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(entry-&gt;duration);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L141" title="core/ngx_log.h:141">ngx_log_debug3</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;time:</span><span class="Special">%u</span><span class="Constant">L, count:</span><span class="Special">%u</span><span class="Constant">D, duration:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; start_time, count, duration);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (start_time &lt; (<span class="Type">uint64_t</span>) count * duration) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start_sample += (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) (start_time / duration);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rest = (<span class="Type">uint32_t</span>) (start_time / duration);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start_sample += count;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start_time -= count * duration;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entries--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entry++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;start time is out mp4 stts samples in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_sample = trak-&gt;start_sample + start_sample;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;end_sample:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>, trak-&gt;end_sample);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(entry-&gt;count, count - rest);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;pos = (u_char *) entry;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;time_to_sample_entries = entries;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;start_sample = start_sample;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;start_sample:</span><span class="Special">%u</span><span class="Constant">i, new count:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; trak-&gt;start_sample, count - rest);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(entry-&gt;count, rest);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;last = (u_char *) (entry + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;time_to_sample_entries -= entries - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_sample = trak-&gt;start_sample + start_sample;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;end_sample:</span><span class="Special">%u</span><span class="Constant">i, new count:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; trak-&gt;end_sample, rest);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; version[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; flags[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; entries[<span class="Constant">4</span>];<br/></li>
<li><a id="L2206">&#x200c;</a>} <span class="linkable">ngx_http_mp4_stss_atom_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2210">&#x200c;</a><span class="linkable">ngx_http_mp4_read_stss_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom_header, *atom_table, *atom_end;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; entries;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom, *data;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *trak;<br/></li>
<li>&nbsp; &nbsp; <a href="#L2206" title="http/modules/ngx_http_mp4_module.c:2206">ngx_http_mp4_stss_atom_t</a>&nbsp; *stss_atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* sync samples atom */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 stss atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; stss_atom = (<a href="#L2206" title="http/modules/ngx_http_mp4_module.c:2206">ngx_http_mp4_stss_atom_t</a> *) atom_header;<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(stss_atom, <span class="Constant">'s'</span>, <span class="Constant">'t'</span>, <span class="Constant">'s'</span>, <span class="Constant">'s'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L2206" title="http/modules/ngx_http_mp4_module.c:2206">ngx_http_mp4_stss_atom_t</a>) &gt; atom_data_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 stss atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entries = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(stss_atom-&gt;entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;sync sample entries:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>, entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;sync_samples_entries = entries;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_table = atom_header + <span class="Statement">sizeof</span>(<a href="#L2206" title="http/modules/ngx_http_mp4_module.c:2206">ngx_http_mp4_stss_atom_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;stss_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_table;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L2206" title="http/modules/ngx_http_mp4_module.c:2206">ngx_http_mp4_stss_atom_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; + entries * <span class="Statement">sizeof</span>(<span class="Type">uint32_t</span>) &gt; atom_data_size)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 stss atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_end = atom_table + entries * <span class="Statement">sizeof</span>(<span class="Type">uint32_t</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = &amp;trak-&gt;stss_data_buf;<br/></li>
<li>&nbsp; &nbsp; data-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; data-&gt;pos = atom_table;<br/></li>
<li>&nbsp; &nbsp; data-&gt;last = atom_end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L25" title="http/modules/ngx_http_mp4_module.c:25">NGX_HTTP_MP4_STSS_ATOM</a>].buf = atom;<br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L26" title="http/modules/ngx_http_mp4_module.c:26">NGX_HTTP_MP4_STSS_DATA</a>].buf = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2272">&#x200c;</a><span class="linkable">ngx_http_mp4_update_stss_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; sample, start_sample, *entry, *end;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom, *data;<br/></li>
<li>&nbsp; &nbsp; <a href="#L2206" title="http/modules/ngx_http_mp4_module.c:2206">ngx_http_mp4_stss_atom_t</a>&nbsp; *stss_atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * mdia.minf.stbl.stss updating requires trak-&gt;start_sample<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * from mdia.minf.stbl.stts which depends on value from mdia.mdhd<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * atom which may reside after mdia.minf<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 stss atom update&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = trak-&gt;out[<a href="#L26" title="http/modules/ngx_http_mp4_module.c:26">NGX_HTTP_MP4_STSS_DATA</a>].buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2332" title="http/modules/ngx_http_mp4_module.c:2332">ngx_http_mp4_crop_stss_data</a>(mp4, trak, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L2332" title="http/modules/ngx_http_mp4_module.c:2332">ngx_http_mp4_crop_stss_data</a>(mp4, trak, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;sync sample entries:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>, trak-&gt;sync_samples_entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (trak-&gt;sync_samples_entries) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entry = (<span class="Type">uint32_t</span> *) data-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; end = (<span class="Type">uint32_t</span> *) data-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start_sample = trak-&gt;start_sample;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (entry &lt; end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sample = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(entry);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sample -= start_sample;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(entry, sample);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entry++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;out[<a href="#L26" title="http/modules/ngx_http_mp4_module.c:26">NGX_HTTP_MP4_STSS_DATA</a>].buf = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L2206" title="http/modules/ngx_http_mp4_module.c:2206">ngx_http_mp4_stss_atom_t</a>) + (data-&gt;last - data-&gt;pos);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;size += atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = trak-&gt;out[<a href="#L25" title="http/modules/ngx_http_mp4_module.c:25">NGX_HTTP_MP4_STSS_ATOM</a>].buf;<br/></li>
<li>&nbsp; &nbsp; stss_atom = (<a href="#L2206" title="http/modules/ngx_http_mp4_module.c:2206">ngx_http_mp4_stss_atom_t</a> *) atom-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(stss_atom-&gt;size, atom_size);<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(stss_atom-&gt;entries, trak-&gt;sync_samples_entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2332">&#x200c;</a></span><span class="linkable">ngx_http_mp4_crop_stss_data</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> start)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp;&nbsp; sample, start_sample, *entry, *end;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp;&nbsp; *data;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp;&nbsp; entries;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* sync samples starts from 1 */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start_sample = trak-&gt;start_sample + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 stss crop start_sample:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>, start_sample);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (mp4-&gt;length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start_sample = trak-&gt;end_sample + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 stss crop end_sample:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>, start_sample);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = trak-&gt;out[<a href="#L26" title="http/modules/ngx_http_mp4_module.c:26">NGX_HTTP_MP4_STSS_DATA</a>].buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entries = trak-&gt;sync_samples_entries;<br/></li>
<li>&nbsp; &nbsp; entry = (<span class="Type">uint32_t</span> *) data-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; end = (<span class="Type">uint32_t</span> *) data-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (entry &lt; end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sample = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(entry);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;sync:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>, sample);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sample &gt;= start_sample) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entries--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entry++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;sample is out of mp4 stss atom&quot;</span>);<br/></li>
<li><br/></li>
<li><span class="Statement">found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;pos = (u_char *) entry;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;sync_samples_entries = entries;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;last = (u_char *) entry;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;sync_samples_entries -= entries;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; version[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; flags[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; entries[<span class="Constant">4</span>];<br/></li>
<li><a id="L2399">&#x200c;</a>} <span class="linkable">ngx_mp4_ctts_atom_t</span>;<br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; count[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; offset[<span class="Constant">4</span>];<br/></li>
<li><a id="L2404">&#x200c;</a>} <span class="linkable">ngx_mp4_ctts_entry_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2408">&#x200c;</a><span class="linkable">ngx_http_mp4_read_ctts_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom_header, *atom_table, *atom_end;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entries;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom, *data;<br/></li>
<li>&nbsp; &nbsp; <a href="#L2399" title="http/modules/ngx_http_mp4_module.c:2399">ngx_mp4_ctts_atom_t</a>&nbsp; *ctts_atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; *trak;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* composition offsets atom */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 ctts atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; ctts_atom = (<a href="#L2399" title="http/modules/ngx_http_mp4_module.c:2399">ngx_mp4_ctts_atom_t</a> *) atom_header;<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(ctts_atom, <span class="Constant">'c'</span>, <span class="Constant">'t'</span>, <span class="Constant">'t'</span>, <span class="Constant">'s'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L2399" title="http/modules/ngx_http_mp4_module.c:2399">ngx_mp4_ctts_atom_t</a>) &gt; atom_data_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 ctts atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entries = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(ctts_atom-&gt;entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;composition offset entries:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>, entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;composition_offset_entries = entries;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_table = atom_header + <span class="Statement">sizeof</span>(<a href="#L2399" title="http/modules/ngx_http_mp4_module.c:2399">ngx_mp4_ctts_atom_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;ctts_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_table;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L2399" title="http/modules/ngx_http_mp4_module.c:2399">ngx_mp4_ctts_atom_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; + entries * <span class="Statement">sizeof</span>(<a href="#L2404" title="http/modules/ngx_http_mp4_module.c:2404">ngx_mp4_ctts_entry_t</a>) &gt; atom_data_size)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 ctts atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_end = atom_table + entries * <span class="Statement">sizeof</span>(<a href="#L2404" title="http/modules/ngx_http_mp4_module.c:2404">ngx_mp4_ctts_entry_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = &amp;trak-&gt;ctts_data_buf;<br/></li>
<li>&nbsp; &nbsp; data-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; data-&gt;pos = atom_table;<br/></li>
<li>&nbsp; &nbsp; data-&gt;last = atom_end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L27" title="http/modules/ngx_http_mp4_module.c:27">NGX_HTTP_MP4_CTTS_ATOM</a>].buf = atom;<br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L28" title="http/modules/ngx_http_mp4_module.c:28">NGX_HTTP_MP4_CTTS_DATA</a>].buf = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2470">&#x200c;</a></span><span class="linkable">ngx_http_mp4_update_ctts_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom, *data;<br/></li>
<li>&nbsp; &nbsp; <a href="#L2399" title="http/modules/ngx_http_mp4_module.c:2399">ngx_mp4_ctts_atom_t</a>&nbsp; *ctts_atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * mdia.minf.stbl.ctts updating requires trak-&gt;start_sample<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * from mdia.minf.stbl.stts which depends on value from mdia.mdhd<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * atom which may reside after mdia.minf<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 ctts atom update&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = trak-&gt;out[<a href="#L28" title="http/modules/ngx_http_mp4_module.c:28">NGX_HTTP_MP4_CTTS_DATA</a>].buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2519" title="http/modules/ngx_http_mp4_module.c:2519">ngx_http_mp4_crop_ctts_data</a>(mp4, trak, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L2519" title="http/modules/ngx_http_mp4_module.c:2519">ngx_http_mp4_crop_ctts_data</a>(mp4, trak, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;composition offset entries:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; trak-&gt;composition_offset_entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (trak-&gt;composition_offset_entries == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;out[<a href="#L27" title="http/modules/ngx_http_mp4_module.c:27">NGX_HTTP_MP4_CTTS_ATOM</a>].buf = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;out[<a href="#L28" title="http/modules/ngx_http_mp4_module.c:28">NGX_HTTP_MP4_CTTS_DATA</a>].buf = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L2399" title="http/modules/ngx_http_mp4_module.c:2399">ngx_mp4_ctts_atom_t</a>) + (data-&gt;last - data-&gt;pos);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;size += atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = trak-&gt;out[<a href="#L27" title="http/modules/ngx_http_mp4_module.c:27">NGX_HTTP_MP4_CTTS_ATOM</a>].buf;<br/></li>
<li>&nbsp; &nbsp; ctts_atom = (<a href="#L2399" title="http/modules/ngx_http_mp4_module.c:2399">ngx_mp4_ctts_atom_t</a> *) atom-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(ctts_atom-&gt;size, atom_size);<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(ctts_atom-&gt;entries, trak-&gt;composition_offset_entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2519">&#x200c;</a></span><span class="linkable">ngx_http_mp4_crop_ctts_data</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> start)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; count, start_sample, rest;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *data;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; entries;<br/></li>
<li>&nbsp; &nbsp; <a href="#L2404" title="http/modules/ngx_http_mp4_module.c:2404">ngx_mp4_ctts_entry_t</a>&nbsp; *entry, *end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* sync samples starts from 1 */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start_sample = trak-&gt;start_sample + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 ctts crop start_sample:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>, start_sample);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (mp4-&gt;length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start_sample = trak-&gt;end_sample - trak-&gt;start_sample + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 ctts crop end_sample:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>, start_sample);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = trak-&gt;out[<a href="#L28" title="http/modules/ngx_http_mp4_module.c:28">NGX_HTTP_MP4_CTTS_DATA</a>].buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entries = trak-&gt;composition_offset_entries;<br/></li>
<li>&nbsp; &nbsp; entry = (<a href="#L2404" title="http/modules/ngx_http_mp4_module.c:2404">ngx_mp4_ctts_entry_t</a> *) data-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; end = (<a href="#L2404" title="http/modules/ngx_http_mp4_module.c:2404">ngx_mp4_ctts_entry_t</a> *) data-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (entry &lt; end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; count = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(entry-&gt;count);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L141" title="core/ngx_log.h:141">ngx_log_debug3</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;sample:</span><span class="Special">%u</span><span class="Constant">D, count:</span><span class="Special">%u</span><span class="Constant">D, offset:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; start_sample, count, <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(entry-&gt;offset));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">if</span> (start_sample &lt;= count) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rest = start_sample - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; start_sample -= count;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; entries--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; entry++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;pos = (u_char *) end;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;composition_offset_entries = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(entry-&gt;count, count - rest);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;pos = (u_char *) entry;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;composition_offset_entries = entries;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(entry-&gt;count, rest);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;last = (u_char *) (entry + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;composition_offset_entries -= entries - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; version[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; flags[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; entries[<span class="Constant">4</span>];<br/></li>
<li><a id="L2596">&#x200c;</a>} <span class="linkable">ngx_mp4_stsc_atom_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2600">&#x200c;</a><span class="linkable">ngx_http_mp4_read_stsc_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom_header, *atom_table, *atom_end;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entries;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom, *data;<br/></li>
<li>&nbsp; &nbsp; <a href="#L2596" title="http/modules/ngx_http_mp4_module.c:2596">ngx_mp4_stsc_atom_t</a>&nbsp; *stsc_atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; *trak;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* sample-to-chunk atom */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 stsc atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; stsc_atom = (<a href="#L2596" title="http/modules/ngx_http_mp4_module.c:2596">ngx_mp4_stsc_atom_t</a> *) atom_header;<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(stsc_atom, <span class="Constant">'s'</span>, <span class="Constant">'t'</span>, <span class="Constant">'s'</span>, <span class="Constant">'c'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L2596" title="http/modules/ngx_http_mp4_module.c:2596">ngx_mp4_stsc_atom_t</a>) &gt; atom_data_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 stsc atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entries = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(stsc_atom-&gt;entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;sample-to-chunk entries:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>, entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L2596" title="http/modules/ngx_http_mp4_module.c:2596">ngx_mp4_stsc_atom_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; + entries * <span class="Statement">sizeof</span>(<a href="#L53" title="http/modules/ngx_http_mp4_module.c:53">ngx_mp4_stsc_entry_t</a>) &gt; atom_data_size)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 stsc atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_table = atom_header + <span class="Statement">sizeof</span>(<a href="#L2596" title="http/modules/ngx_http_mp4_module.c:2596">ngx_mp4_stsc_atom_t</a>);<br/></li>
<li>&nbsp; &nbsp; atom_end = atom_table + entries * <span class="Statement">sizeof</span>(<a href="#L53" title="http/modules/ngx_http_mp4_module.c:53">ngx_mp4_stsc_entry_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;sample_to_chunk_entries = entries;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;stsc_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_table;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = &amp;trak-&gt;stsc_data_buf;<br/></li>
<li>&nbsp; &nbsp; data-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; data-&gt;pos = atom_table;<br/></li>
<li>&nbsp; &nbsp; data-&gt;last = atom_end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L29" title="http/modules/ngx_http_mp4_module.c:29">NGX_HTTP_MP4_STSC_ATOM</a>].buf = atom;<br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L31" title="http/modules/ngx_http_mp4_module.c:31">NGX_HTTP_MP4_STSC_DATA</a>].buf = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2661">&#x200c;</a><span class="linkable">ngx_http_mp4_update_stsc_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; chunk;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom, *data;<br/></li>
<li>&nbsp; &nbsp; <a href="#L2596" title="http/modules/ngx_http_mp4_module.c:2596">ngx_mp4_stsc_atom_t</a>&nbsp;&nbsp; *stsc_atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L53" title="http/modules/ngx_http_mp4_module.c:53">ngx_mp4_stsc_entry_t</a>&nbsp; *entry, *end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * mdia.minf.stbl.stsc updating requires trak-&gt;start_sample<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * from mdia.minf.stbl.stts which depends on value from mdia.mdhd<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * atom which may reside after mdia.minf<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 stsc atom update&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = trak-&gt;out[<a href="#L31" title="http/modules/ngx_http_mp4_module.c:31">NGX_HTTP_MP4_STSC_DATA</a>].buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no mp4 stsc atoms were found in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (trak-&gt;sample_to_chunk_entries == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;zero number of entries in stsc atom in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2733" title="http/modules/ngx_http_mp4_module.c:2733">ngx_http_mp4_crop_stsc_data</a>(mp4, trak, <span class="Constant">1</span>) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2733" title="http/modules/ngx_http_mp4_module.c:2733">ngx_http_mp4_crop_stsc_data</a>(mp4, trak, <span class="Constant">0</span>) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;sample-to-chunk entries:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; trak-&gt;sample_to_chunk_entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entry = (<a href="#L53" title="http/modules/ngx_http_mp4_module.c:53">ngx_mp4_stsc_entry_t</a> *) data-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; end = (<a href="#L53" title="http/modules/ngx_http_mp4_module.c:53">ngx_mp4_stsc_entry_t</a> *) data-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (entry &lt; end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; chunk = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(entry-&gt;chunk);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; chunk -= trak-&gt;start_chunk;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(entry-&gt;chunk, chunk);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entry++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L2596" title="http/modules/ngx_http_mp4_module.c:2596">ngx_mp4_stsc_atom_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + trak-&gt;sample_to_chunk_entries * <span class="Statement">sizeof</span>(<a href="#L53" title="http/modules/ngx_http_mp4_module.c:53">ngx_mp4_stsc_entry_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;size += atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = trak-&gt;out[<a href="#L29" title="http/modules/ngx_http_mp4_module.c:29">NGX_HTTP_MP4_STSC_ATOM</a>].buf;<br/></li>
<li>&nbsp; &nbsp; stsc_atom = (<a href="#L2596" title="http/modules/ngx_http_mp4_module.c:2596">ngx_mp4_stsc_atom_t</a> *) atom-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(stsc_atom-&gt;size, atom_size);<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(stsc_atom-&gt;entries, trak-&gt;sample_to_chunk_entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2733">&#x200c;</a><span class="linkable">ngx_http_mp4_crop_stsc_data</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak, <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> start)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; start_sample, chunk, samples, id, next_chunk, n,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; prev_samples;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *data, *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; entries, target_chunk, chunk_samples;<br/></li>
<li>&nbsp; &nbsp; <a href="#L53" title="http/modules/ngx_http_mp4_module.c:53">ngx_mp4_stsc_entry_t</a>&nbsp; *entry, *end, *first;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entries = trak-&gt;sample_to_chunk_entries - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start_sample = (<span class="Type">uint32_t</span>) trak-&gt;start_sample;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 stsc crop start_sample:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>, start_sample);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (mp4-&gt;length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start_sample = (<span class="Type">uint32_t</span>) (trak-&gt;end_sample - trak-&gt;start_sample);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; samples = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data = trak-&gt;out[<a href="#L30" title="http/modules/ngx_http_mp4_module.c:30">NGX_HTTP_MP4_STSC_START</a>].buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entry = (<a href="#L53" title="http/modules/ngx_http_mp4_module.c:53">ngx_mp4_stsc_entry_t</a> *) data-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; samples = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(entry-&gt;samples);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entries--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (samples &gt; start_sample) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; samples = start_sample;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(entry-&gt;samples, samples);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start_sample -= samples;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 stsc crop end_sample:</span><span class="Special">%u</span><span class="Constant">D, ext_samples:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; start_sample, samples);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = trak-&gt;out[<a href="#L31" title="http/modules/ngx_http_mp4_module.c:31">NGX_HTTP_MP4_STSC_DATA</a>].buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entry = (<a href="#L53" title="http/modules/ngx_http_mp4_module.c:53">ngx_mp4_stsc_entry_t</a> *) data-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; end = (<a href="#L53" title="http/modules/ngx_http_mp4_module.c:53">ngx_mp4_stsc_entry_t</a> *) data-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; chunk = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(entry-&gt;chunk);<br/></li>
<li>&nbsp; &nbsp; samples = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(entry-&gt;samples);<br/></li>
<li>&nbsp; &nbsp; id = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(entry-&gt;id);<br/></li>
<li>&nbsp; &nbsp; prev_samples = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; entry++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (entry &lt; end) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; next_chunk = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(entry-&gt;chunk);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L147" title="core/ngx_log.h:147">ngx_log_debug5</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;sample:</span><span class="Special">%u</span><span class="Constant">D, chunk:</span><span class="Special">%u</span><span class="Constant">D, chunks:</span><span class="Special">%u</span><span class="Constant">D, &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;samples:</span><span class="Special">%u</span><span class="Constant">D, id:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; start_sample, chunk, next_chunk - chunk, samples, id);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = (next_chunk - chunk) * samples;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (start_sample &lt; n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start_sample -= n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; prev_samples = samples;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; chunk = next_chunk;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; samples = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(entry-&gt;samples);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; id = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(entry-&gt;id);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entries--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entry++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; next_chunk = trak-&gt;chunks + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L144" title="core/ngx_log.h:144">ngx_log_debug4</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;sample:</span><span class="Special">%u</span><span class="Constant">D, chunk:</span><span class="Special">%u</span><span class="Constant">D, chunks:</span><span class="Special">%u</span><span class="Constant">D, samples:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; start_sample, chunk, next_chunk - chunk, samples);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = (next_chunk - chunk) * samples;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (start_sample &gt; n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant"> time is out mp4 stsc chunks in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start ? <span class="Constant">&quot;start&quot;</span> : <span class="Constant">&quot;end&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; entries++;<br/></li>
<li>&nbsp; &nbsp; entry--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (samples == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;zero number of samples in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; target_chunk = chunk - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; target_chunk += start_sample / samples;<br/></li>
<li>&nbsp; &nbsp; chunk_samples = start_sample % samples;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;pos = (u_char *) entry;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;sample_to_chunk_entries = entries;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;start_chunk = target_chunk;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;start_chunk_samples = chunk_samples;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(entry-&gt;chunk, trak-&gt;start_chunk + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; samples -= chunk_samples;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;start_chunk:</span><span class="Special">%u</span><span class="Constant">i, start_chunk_samples:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; trak-&gt;start_chunk, trak-&gt;start_chunk_samples);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (start_sample) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data-&gt;last = (u_char *) (entry + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;sample_to_chunk_entries -= entries - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_chunk_samples = samples;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data-&gt;last = (u_char *) entry;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;sample_to_chunk_entries -= entries;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_chunk_samples = prev_samples;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (chunk_samples) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_chunk = target_chunk + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_chunk_samples = chunk_samples;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_chunk = target_chunk;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; samples = chunk_samples;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; next_chunk = chunk + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;end_chunk:</span><span class="Special">%u</span><span class="Constant">i, end_chunk_samples:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; trak-&gt;end_chunk, trak-&gt;end_chunk_samples);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (chunk_samples &amp;&amp; next_chunk - target_chunk == <span class="Constant">2</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(entry-&gt;samples, samples);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (chunk_samples &amp;&amp; start) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; first = &amp;trak-&gt;stsc_start_chunk_entry;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(first-&gt;chunk, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(first-&gt;samples, samples);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(first-&gt;id, id);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf = &amp;trak-&gt;stsc_start_chunk_buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;pos = (u_char *) first;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last = (u_char *) first + <span class="Statement">sizeof</span>(<a href="#L53" title="http/modules/ngx_http_mp4_module.c:53">ngx_mp4_stsc_entry_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;out[<a href="#L30" title="http/modules/ngx_http_mp4_module.c:30">NGX_HTTP_MP4_STSC_START</a>].buf = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(entry-&gt;chunk, trak-&gt;start_chunk + <span class="Constant">2</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;sample_to_chunk_entries++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (chunk_samples) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; first = &amp;trak-&gt;stsc_end_chunk_entry;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(first-&gt;chunk, trak-&gt;end_chunk - trak-&gt;start_chunk);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(first-&gt;samples, samples);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(first-&gt;id, id);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf = &amp;trak-&gt;stsc_end_chunk_buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;pos = (u_char *) first;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last = (u_char *) first + <span class="Statement">sizeof</span>(<a href="#L53" title="http/modules/ngx_http_mp4_module.c:53">ngx_mp4_stsc_entry_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;out[<a href="#L32" title="http/modules/ngx_http_mp4_module.c:32">NGX_HTTP_MP4_STSC_END</a>].buf = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;sample_to_chunk_entries++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; version[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; flags[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; uniform_size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; entries[<span class="Constant">4</span>];<br/></li>
<li><a id="L2937">&#x200c;</a>} <span class="linkable">ngx_mp4_stsz_atom_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2941">&#x200c;</a><span class="linkable">ngx_http_mp4_read_stsz_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom_header, *atom_table, *atom_end;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entries, size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom, *data;<br/></li>
<li>&nbsp; &nbsp; <a href="#L2937" title="http/modules/ngx_http_mp4_module.c:2937">ngx_mp4_stsz_atom_t</a>&nbsp; *stsz_atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; *trak;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* sample sizes atom */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 stsz atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; stsz_atom = (<a href="#L2937" title="http/modules/ngx_http_mp4_module.c:2937">ngx_mp4_stsz_atom_t</a> *) atom_header;<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(stsz_atom, <span class="Constant">'s'</span>, <span class="Constant">'t'</span>, <span class="Constant">'s'</span>, <span class="Constant">'z'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L2937" title="http/modules/ngx_http_mp4_module.c:2937">ngx_mp4_stsz_atom_t</a>) &gt; atom_data_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 stsz atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(stsz_atom-&gt;uniform_size);<br/></li>
<li>&nbsp; &nbsp; entries = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(stsz_atom-&gt;entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;sample uniform size:</span><span class="Special">%u</span><span class="Constant">D, entries:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>, size, entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;sample_sizes_entries = entries;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_table = atom_header + <span class="Statement">sizeof</span>(<a href="#L2937" title="http/modules/ngx_http_mp4_module.c:2937">ngx_mp4_stsz_atom_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;stsz_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_table;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L33" title="http/modules/ngx_http_mp4_module.c:33">NGX_HTTP_MP4_STSZ_ATOM</a>].buf = atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L2937" title="http/modules/ngx_http_mp4_module.c:2937">ngx_mp4_stsz_atom_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + entries * <span class="Statement">sizeof</span>(<span class="Type">uint32_t</span>) &gt; atom_data_size)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 stsz atom too small&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; atom_end = atom_table + entries * <span class="Statement">sizeof</span>(<span class="Type">uint32_t</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data = &amp;trak-&gt;stsz_data_buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;pos = atom_table;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;last = atom_end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;out[<a href="#L34" title="http/modules/ngx_http_mp4_module.c:34">NGX_HTTP_MP4_STSZ_DATA</a>].buf = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* if size != 0 then all samples are the same size */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment"> : chunk samples */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L846" title="http/modules/ngx_http_mp4_module.c:846">ngx_mp4_atom_header_t</a>) + (<span class="Type">size_t</span>) atom_data_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(atom_header, atom_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;size += atom_size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3016">&#x200c;</a><span class="linkable">ngx_http_mp4_update_stsz_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *pos, *end, entries;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom, *data;<br/></li>
<li>&nbsp; &nbsp; <a href="#L2937" title="http/modules/ngx_http_mp4_module.c:2937">ngx_mp4_stsz_atom_t</a>&nbsp; *stsz_atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * mdia.minf.stbl.stsz updating requires trak-&gt;start_sample<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * from mdia.minf.stbl.stts which depends on value from mdia.mdhd<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * atom which may reside after mdia.minf<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 stsz atom update&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = trak-&gt;out[<a href="#L34" title="http/modules/ngx_http_mp4_module.c:34">NGX_HTTP_MP4_STSZ_DATA</a>].buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entries = trak-&gt;sample_sizes_entries;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (trak-&gt;start_sample &gt; entries) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;start time is out mp4 stsz samples in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entries -= trak-&gt;start_sample;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;pos += trak-&gt;start_sample * <span class="Statement">sizeof</span>(<span class="Type">uint32_t</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; end = (<span class="Type">uint32_t</span> *) data-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (pos = end - trak-&gt;start_chunk_samples; pos &lt; end; pos++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;start_chunk_samples_size += <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(pos);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;chunk samples sizes:</span><span class="Special">%u</span><span class="Constant">L&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; trak-&gt;start_chunk_samples_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (trak-&gt;end_sample - trak-&gt;start_sample &gt; entries) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;end time is out mp4 stsz samples in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entries = trak-&gt;end_sample - trak-&gt;start_sample;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data-&gt;last = data-&gt;pos + entries * <span class="Statement">sizeof</span>(<span class="Type">uint32_t</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end = (<span class="Type">uint32_t</span> *) data-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (pos = end - trak-&gt;end_chunk_samples; pos &lt; end; pos++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_chunk_samples_size += <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(pos);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 stsz end_chunk_samples_size:</span><span class="Special">%u</span><span class="Constant">L&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; trak-&gt;end_chunk_samples_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L2937" title="http/modules/ngx_http_mp4_module.c:2937">ngx_mp4_stsz_atom_t</a>) + (data-&gt;last - data-&gt;pos);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;size += atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; atom = trak-&gt;out[<a href="#L33" title="http/modules/ngx_http_mp4_module.c:33">NGX_HTTP_MP4_STSZ_ATOM</a>].buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stsz_atom = (<a href="#L2937" title="http/modules/ngx_http_mp4_module.c:2937">ngx_mp4_stsz_atom_t</a> *) atom-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(stsz_atom-&gt;size, atom_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(stsz_atom-&gt;entries, entries);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; version[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; flags[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; entries[<span class="Constant">4</span>];<br/></li>
<li><a id="L3098">&#x200c;</a>} <span class="linkable">ngx_mp4_stco_atom_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3102">&#x200c;</a><span class="linkable">ngx_http_mp4_read_stco_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom_header, *atom_table, *atom_end;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entries;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom, *data;<br/></li>
<li>&nbsp; &nbsp; <a href="#L3098" title="http/modules/ngx_http_mp4_module.c:3098">ngx_mp4_stco_atom_t</a>&nbsp; *stco_atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; *trak;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* chunk offsets atom */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 stco atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; stco_atom = (<a href="#L3098" title="http/modules/ngx_http_mp4_module.c:3098">ngx_mp4_stco_atom_t</a> *) atom_header;<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(stco_atom, <span class="Constant">'s'</span>, <span class="Constant">'t'</span>, <span class="Constant">'c'</span>, <span class="Constant">'o'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L3098" title="http/modules/ngx_http_mp4_module.c:3098">ngx_mp4_stco_atom_t</a>) &gt; atom_data_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 stco atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entries = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(stco_atom-&gt;entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;chunks:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>, entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L3098" title="http/modules/ngx_http_mp4_module.c:3098">ngx_mp4_stco_atom_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; + entries * <span class="Statement">sizeof</span>(<span class="Type">uint32_t</span>) &gt; atom_data_size)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 stco atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_table = atom_header + <span class="Statement">sizeof</span>(<a href="#L3098" title="http/modules/ngx_http_mp4_module.c:3098">ngx_mp4_stco_atom_t</a>);<br/></li>
<li>&nbsp; &nbsp; atom_end = atom_table + entries * <span class="Statement">sizeof</span>(<span class="Type">uint32_t</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;chunks = entries;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;stco_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_table;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = &amp;trak-&gt;stco_data_buf;<br/></li>
<li>&nbsp; &nbsp; data-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; data-&gt;pos = atom_table;<br/></li>
<li>&nbsp; &nbsp; data-&gt;last = atom_end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L35" title="http/modules/ngx_http_mp4_module.c:35">NGX_HTTP_MP4_STCO_ATOM</a>].buf = atom;<br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L36" title="http/modules/ngx_http_mp4_module.c:36">NGX_HTTP_MP4_STCO_DATA</a>].buf = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3162">&#x200c;</a><span class="linkable">ngx_http_mp4_update_stco_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entries;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom, *data;<br/></li>
<li>&nbsp; &nbsp; <a href="#L3098" title="http/modules/ngx_http_mp4_module.c:3098">ngx_mp4_stco_atom_t</a>&nbsp; *stco_atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * mdia.minf.stbl.stco updating requires trak-&gt;start_chunk<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * from mdia.minf.stbl.stsc which depends on value from mdia.mdhd<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * atom which may reside after mdia.minf<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 stco atom update&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = trak-&gt;out[<a href="#L36" title="http/modules/ngx_http_mp4_module.c:36">NGX_HTTP_MP4_STCO_DATA</a>].buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no mp4 stco atoms were found in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (trak-&gt;start_chunk &gt; trak-&gt;chunks) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;start time is out mp4 stco chunks in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data-&gt;pos += trak-&gt;start_chunk * <span class="Statement">sizeof</span>(<span class="Type">uint32_t</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;start_offset = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(data-&gt;pos);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;start_offset += trak-&gt;start_chunk_samples_size;<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(data-&gt;pos, trak-&gt;start_offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;start chunk offset:</span><span class="Special">%O</span><span class="Constant">&quot;</span>, trak-&gt;start_offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;length) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (trak-&gt;end_chunk &gt; trak-&gt;chunks) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;end time is out mp4 stco chunks in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entries = trak-&gt;end_chunk - trak-&gt;start_chunk;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;last = data-&gt;pos + entries * <span class="Statement">sizeof</span>(<span class="Type">uint32_t</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (entries) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_offset =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(data-&gt;last - <span class="Statement">sizeof</span>(<span class="Type">uint32_t</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_offset += trak-&gt;end_chunk_samples_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;end chunk offset:</span><span class="Special">%O</span><span class="Constant">&quot;</span>, trak-&gt;end_offset);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entries = trak-&gt;chunks - trak-&gt;start_chunk;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_offset = mp4-&gt;mdat_data.buf-&gt;file_last;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (entries == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;start_offset = mp4-&gt;end;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_offset = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L3098" title="http/modules/ngx_http_mp4_module.c:3098">ngx_mp4_stco_atom_t</a>) + (data-&gt;last - data-&gt;pos);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;size += atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = trak-&gt;out[<a href="#L35" title="http/modules/ngx_http_mp4_module.c:35">NGX_HTTP_MP4_STCO_ATOM</a>].buf;<br/></li>
<li>&nbsp; &nbsp; stco_atom = (<a href="#L3098" title="http/modules/ngx_http_mp4_module.c:3098">ngx_mp4_stco_atom_t</a> *) atom-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(stco_atom-&gt;size, atom_size);<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(stco_atom-&gt;entries, entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3249">&#x200c;</a></span><span class="linkable">ngx_http_mp4_adjust_stco_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak, <span class="Type">int32_t</span> adjustment)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; offset, *entry, *end;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * moov.trak.mdia.minf.stbl.stco adjustment requires<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * minimal start offset of all traks and new moov atom size<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 stco atom adjustment&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = trak-&gt;out[<a href="#L36" title="http/modules/ngx_http_mp4_module.c:36">NGX_HTTP_MP4_STCO_DATA</a>].buf;<br/></li>
<li>&nbsp; &nbsp; entry = (<span class="Type">uint32_t</span> *) data-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; end = (<span class="Type">uint32_t</span> *) data-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (entry &lt; end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; offset = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(entry);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; offset += adjustment;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(entry, offset);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entry++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; size[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; name[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; version[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; flags[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; entries[<span class="Constant">4</span>];<br/></li>
<li><a id="L3282">&#x200c;</a>} <span class="linkable">ngx_mp4_co64_atom_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3286">&#x200c;</a><span class="linkable">ngx_http_mp4_read_co64_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4, <span class="Type">uint64_t</span> atom_data_size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *atom_header, *atom_table, *atom_end;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entries;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom, *data;<br/></li>
<li>&nbsp; &nbsp; <a href="#L3282" title="http/modules/ngx_http_mp4_module.c:3282">ngx_mp4_co64_atom_t</a>&nbsp; *co64_atom;<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a>&nbsp; *trak;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* chunk offsets atom */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;mp4 co64 atom&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_header = <a href="#L166" title="http/modules/ngx_http_mp4_module.c:166">ngx_mp4_atom_header</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; co64_atom = (<a href="#L3282" title="http/modules/ngx_http_mp4_module.c:3282">ngx_mp4_co64_atom_t</a> *) atom_header;<br/></li>
<li>&nbsp; &nbsp; <a href="#L176" title="http/modules/ngx_http_mp4_module.c:176">ngx_mp4_set_atom_name</a>(co64_atom, <span class="Constant">'c'</span>, <span class="Constant">'o'</span>, <span class="Constant">'6'</span>, <span class="Constant">'4'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L3282" title="http/modules/ngx_http_mp4_module.c:3282">ngx_mp4_co64_atom_t</a>) &gt; atom_data_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 co64 atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entries = <a href="#L182" title="http/modules/ngx_http_mp4_module.c:182">ngx_mp4_get_32value</a>(co64_atom-&gt;entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>, <span class="Constant">&quot;chunks:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>, entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L168" title="http/modules/ngx_http_mp4_module.c:168">ngx_mp4_atom_data_size</a>(<a href="#L3282" title="http/modules/ngx_http_mp4_module.c:3282">ngx_mp4_co64_atom_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; + entries * <span class="Statement">sizeof</span>(<span class="Type">uint64_t</span>) &gt; atom_data_size)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> mp4 co64 atom too small&quot;</span>, mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_table = atom_header + <span class="Statement">sizeof</span>(<a href="#L3282" title="http/modules/ngx_http_mp4_module.c:3282">ngx_mp4_co64_atom_t</a>);<br/></li>
<li>&nbsp; &nbsp; atom_end = atom_table + entries * <span class="Statement">sizeof</span>(<span class="Type">uint64_t</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak = <a href="#L214" title="http/modules/ngx_http_mp4_module.c:214">ngx_mp4_last_trak</a>(mp4);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;chunks = entries;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = &amp;trak-&gt;co64_atom_buf;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;pos = atom_header;<br/></li>
<li>&nbsp; &nbsp; atom-&gt;last = atom_table;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = &amp;trak-&gt;co64_data_buf;<br/></li>
<li>&nbsp; &nbsp; data-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; data-&gt;pos = atom_table;<br/></li>
<li>&nbsp; &nbsp; data-&gt;last = atom_end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L37" title="http/modules/ngx_http_mp4_module.c:37">NGX_HTTP_MP4_CO64_ATOM</a>].buf = atom;<br/></li>
<li>&nbsp; &nbsp; trak-&gt;out[<a href="#L38" title="http/modules/ngx_http_mp4_module.c:38">NGX_HTTP_MP4_CO64_DATA</a>].buf = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L171" title="http/modules/ngx_http_mp4_module.c:171">ngx_mp4_atom_next</a>(mp4, atom_data_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3346">&#x200c;</a><span class="linkable">ngx_http_mp4_update_co64_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; atom_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entries;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *atom, *data;<br/></li>
<li>&nbsp; &nbsp; <a href="#L3282" title="http/modules/ngx_http_mp4_module.c:3282">ngx_mp4_co64_atom_t</a>&nbsp; *co64_atom;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * mdia.minf.stbl.co64 updating requires trak-&gt;start_chunk<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * from mdia.minf.stbl.stsc which depends on value from mdia.mdhd<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * atom which may reside after mdia.minf<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 co64 atom update&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = trak-&gt;out[<a href="#L38" title="http/modules/ngx_http_mp4_module.c:38">NGX_HTTP_MP4_CO64_DATA</a>].buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no mp4 co64 atoms were found in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (trak-&gt;start_chunk &gt; trak-&gt;chunks) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;start time is out mp4 co64 chunks in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data-&gt;pos += trak-&gt;start_chunk * <span class="Statement">sizeof</span>(<span class="Type">uint64_t</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; trak-&gt;start_offset = <a href="#L194" title="http/modules/ngx_http_mp4_module.c:194">ngx_mp4_get_64value</a>(data-&gt;pos);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;start_offset += trak-&gt;start_chunk_samples_size;<br/></li>
<li>&nbsp; &nbsp; <a href="#L204" title="http/modules/ngx_http_mp4_module.c:204">ngx_mp4_set_64value</a>(data-&gt;pos, trak-&gt;start_offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;start chunk offset:</span><span class="Special">%O</span><span class="Constant">&quot;</span>, trak-&gt;start_offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mp4-&gt;length) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (trak-&gt;end_chunk &gt; trak-&gt;chunks) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;end time is out mp4 co64 chunks in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mp4-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entries = trak-&gt;end_chunk - trak-&gt;start_chunk;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;last = data-&gt;pos + entries * <span class="Statement">sizeof</span>(<span class="Type">uint64_t</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (entries) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_offset =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="http/modules/ngx_http_mp4_module.c:194">ngx_mp4_get_64value</a>(data-&gt;last - <span class="Statement">sizeof</span>(<span class="Type">uint64_t</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_offset += trak-&gt;end_chunk_samples_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;end chunk offset:</span><span class="Special">%O</span><span class="Constant">&quot;</span>, trak-&gt;end_offset);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entries = trak-&gt;chunks - trak-&gt;start_chunk;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_offset = mp4-&gt;mdat_data.buf-&gt;file_last;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (entries == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;start_offset = mp4-&gt;end;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; trak-&gt;end_offset = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom_size = <span class="Statement">sizeof</span>(<a href="#L3282" title="http/modules/ngx_http_mp4_module.c:3282">ngx_mp4_co64_atom_t</a>) + (data-&gt;last - data-&gt;pos);<br/></li>
<li>&nbsp; &nbsp; trak-&gt;size += atom_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; atom = trak-&gt;out[<a href="#L37" title="http/modules/ngx_http_mp4_module.c:37">NGX_HTTP_MP4_CO64_ATOM</a>].buf;<br/></li>
<li>&nbsp; &nbsp; co64_atom = (<a href="#L3282" title="http/modules/ngx_http_mp4_module.c:3282">ngx_mp4_co64_atom_t</a> *) atom-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(co64_atom-&gt;size, atom_size);<br/></li>
<li>&nbsp; &nbsp; <a href="#L188" title="http/modules/ngx_http_mp4_module.c:188">ngx_mp4_set_32value</a>(co64_atom-&gt;entries, entries);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3433">&#x200c;</a></span><span class="linkable">ngx_http_mp4_adjust_co64_atom</span>(<a href="#L156" title="http/modules/ngx_http_mp4_module.c:156">ngx_http_mp4_file_t</a> *mp4,<br/></li>
<li>&nbsp; &nbsp; <a href="#L116" title="http/modules/ngx_http_mp4_module.c:116">ngx_http_mp4_trak_t</a> *trak, <span class="Type">off_t</span> adjustment)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint64_t</span>&nbsp; &nbsp; offset, *entry, *end;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * moov.trak.mdia.minf.stbl.co64 adjustment requires<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * minimal start offset of all traks and new moov atom size<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, mp4-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;mp4 co64 atom adjustment&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; data = trak-&gt;out[<a href="#L38" title="http/modules/ngx_http_mp4_module.c:38">NGX_HTTP_MP4_CO64_DATA</a>].buf;<br/></li>
<li>&nbsp; &nbsp; entry = (<span class="Type">uint64_t</span> *) data-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; end = (<span class="Type">uint64_t</span> *) data-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (entry &lt; end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; offset = <a href="#L194" title="http/modules/ngx_http_mp4_module.c:194">ngx_mp4_get_64value</a>(entry);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; offset += adjustment;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L204" title="http/modules/ngx_http_mp4_module.c:204">ngx_mp4_set_64value</a>(entry, offset);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entry++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L3461">&#x200c;</a><span class="linkable">ngx_http_mp4</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="../ngx_http_config.h.html#L65" title="http/ngx_http_config.h:65">ngx_http_conf_get_module_loc_conf</a>(cf, <a href="../ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li>&nbsp; &nbsp; clcf-&gt;handler = <a href="#L419" title="http/modules/ngx_http_mp4_module.c:419">ngx_http_mp4_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L3473">&#x200c;</a><span class="linkable">ngx_http_mp4_create_conf</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L46" title="http/modules/ngx_http_mp4_module.c:46">ngx_http_mp4_conf_t</a>&nbsp; *conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; conf = <a href="../../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L46" title="http/modules/ngx_http_mp4_module.c:46">ngx_http_mp4_conf_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; conf-&gt;buffer_size = <a href="../../core/ngx_conf_file.h.html#L60" title="core/ngx_conf_file.h:60">NGX_CONF_UNSET_SIZE</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;max_buffer_size = <a href="../../core/ngx_conf_file.h.html#L60" title="core/ngx_conf_file.h:60">NGX_CONF_UNSET_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> conf;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L3490">&#x200c;</a><span class="linkable">ngx_http_mp4_merge_conf</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <span class="Type">void</span> *parent, <span class="Type">void</span> *child)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L46" title="http/modules/ngx_http_mp4_module.c:46">ngx_http_mp4_conf_t</a> *prev = parent;<br/></li>
<li>&nbsp; &nbsp; <a href="#L46" title="http/modules/ngx_http_mp4_module.c:46">ngx_http_mp4_conf_t</a> *conf = child;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L271" title="core/ngx_conf_file.h:271">ngx_conf_merge_size_value</a>(conf-&gt;buffer_size, prev-&gt;buffer_size, <span class="Constant">512</span> * <span class="Constant">1024</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L271" title="core/ngx_conf_file.h:271">ngx_conf_merge_size_value</a>(conf-&gt;max_buffer_size, prev-&gt;max_buffer_size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">10</span> * <span class="Constant">1024</span> * <span class="Constant">1024</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
