<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>http/modules/ngx_http_limit_conn_module.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>http/modules/ngx_http_limit_conn_module.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L75">ngx_http_limit_conn_commands</a></li>
<li><a href="#L61">ngx_http_limit_conn_log_levels</a></li>
<li><a href="#L124">ngx_http_limit_conn_module</a></li>
<li><a href="#L109">ngx_http_limit_conn_module_ctx</a></li>
<li><a href="#L70">ngx_http_limit_conn_status_bounds</a></li>
</ul>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L24">ngx_http_limit_conn_cleanup_t</a></li>
<li><a href="#L43">ngx_http_limit_conn_conf_t</a></li>
<li><a href="#L30">ngx_http_limit_conn_ctx_t</a></li>
<li><a href="#L36">ngx_http_limit_conn_limit_t</a></li>
<li><a href="#L18">ngx_http_limit_conn_node_t</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L594">ngx_http_limit_conn</a></li>
<li><a href="#L337">ngx_http_limit_conn_cleanup</a></li>
<li><a href="#L368">ngx_http_limit_conn_cleanup_all</a></li>
<li><a href="#L452">ngx_http_limit_conn_create_conf</a></li>
<li><a href="#L141">ngx_http_limit_conn_handler</a></li>
<li><a href="#L655">ngx_http_limit_conn_init</a></li>
<li><a href="#L384">ngx_http_limit_conn_init_zone</a></li>
<li><a href="#L298">ngx_http_limit_conn_lookup</a></li>
<li><a href="#L475">ngx_http_limit_conn_merge_conf</a></li>
<li><a href="#L257">ngx_http_limit_conn_rbtree_insert_value</a></li>
<li><a href="#L493">ngx_http_limit_conn_zone</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; color;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; u_short&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conn;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; data[<span class="Constant">1</span>];<br/></li>
<li><a id="L18">&#x200c;</a>} <span class="linkable">ngx_http_limit_conn_node_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_cycle.h.html#L25" title="core/ngx_cycle.h:25">ngx_shm_zone_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *shm_zone;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *node;<br/></li>
<li><a id="L24">&#x200c;</a>} <span class="linkable">ngx_http_limit_conn_cleanup_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L32" title="core/ngx_rbtree.h:32">ngx_rbtree_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *rbtree;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L71" title="http/ngx_http_script.h:71">ngx_http_complex_value_t</a>&nbsp;&nbsp; key;<br/></li>
<li><a id="L30">&#x200c;</a>} <span class="linkable">ngx_http_limit_conn_ctx_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_cycle.h.html#L25" title="core/ngx_cycle.h:25">ngx_shm_zone_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *shm_zone;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; conn;<br/></li>
<li><a id="L36">&#x200c;</a>} <span class="linkable">ngx_http_limit_conn_limit_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; limits;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; log_level;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; status_code;<br/></li>
<li><a id="L43">&#x200c;</a>} <span class="linkable">ngx_http_limit_conn_conf_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *<a href="#L298" title="http/modules/ngx_http_limit_conn_module.c:298">ngx_http_limit_conn_lookup</a>(<a href="../../core/ngx_rbtree.h.html#L32" title="core/ngx_rbtree.h:32">ngx_rbtree_t</a> *rbtree,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *key, <span class="Type">uint32_t</span> hash);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L337" title="http/modules/ngx_http_limit_conn_module.c:337">ngx_http_limit_conn_cleanup</a>(<span class="Type">void</span> *data);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L111" title="core/ngx_config.h:111">ngx_inline</a> <span class="Type">void</span> <a href="#L368" title="http/modules/ngx_http_limit_conn_module.c:368">ngx_http_limit_conn_cleanup_all</a>(<a href="../../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L452" title="http/modules/ngx_http_limit_conn_module.c:452">ngx_http_limit_conn_create_conf</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L475" title="http/modules/ngx_http_limit_conn_module.c:475">ngx_http_limit_conn_merge_conf</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <span class="Type">void</span> *parent,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *child);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L493" title="http/modules/ngx_http_limit_conn_module.c:493">ngx_http_limit_conn_zone</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L594" title="http/modules/ngx_http_limit_conn_module.c:594">ngx_http_limit_conn</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L655" title="http/modules/ngx_http_limit_conn_module.c:655">ngx_http_limit_conn_init</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L61">&#x200c;</a><span class="Type">static</span> <a href="../../core/ngx_conf_file.h.html#L201" title="core/ngx_conf_file.h:201">ngx_conf_enum_t</a>&nbsp; <span class="linkable">ngx_http_limit_conn_log_levels</span>[] = {<br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;info&quot;</span>), <a href="../../core/ngx_log.h.html#L23" title="core/ngx_log.h:23">NGX_LOG_INFO</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;notice&quot;</span>), <a href="../../core/ngx_log.h.html#L22" title="core/ngx_log.h:22">NGX_LOG_NOTICE</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;warn&quot;</span>), <a href="../../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;error&quot;</span>), <a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L41" title="core/ngx_string.h:41">ngx_null_string</a>, <span class="Constant">0</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L70">&#x200c;</a><span class="Type">static</span> <a href="../../core/ngx_conf_file.h.html#L195" title="core/ngx_conf_file.h:195">ngx_conf_num_bounds_t</a>&nbsp; <span class="linkable">ngx_http_limit_conn_status_bounds</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L1377" title="core/ngx_conf_file.c:1377">ngx_conf_check_num_bounds</a>, <span class="Constant">400</span>, <span class="Constant">599<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L75">&#x200c;</a><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a>&nbsp; <span class="linkable">ngx_http_limit_conn_commands</span>[] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;limit_conn_zone&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L24" title="core/ngx_conf_file.h:24">NGX_CONF_TAKE2</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L493" title="http/modules/ngx_http_limit_conn_module.c:493">ngx_http_limit_conn_zone</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;limit_conn&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L24" title="core/ngx_conf_file.h:24">NGX_CONF_TAKE2</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L594" title="http/modules/ngx_http_limit_conn_module.c:594">ngx_http_limit_conn</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;limit_conn_log_level&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L23" title="core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L1269" title="core/ngx_conf_file.c:1269">ngx_conf_set_enum_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L43" title="http/modules/ngx_http_limit_conn_module.c:43">ngx_http_limit_conn_conf_t</a>, log_level),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &amp;<a href="#L61" title="http/modules/ngx_http_limit_conn_module.c:61">ngx_http_limit_conn_log_levels</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;limit_conn_status&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L23" title="core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L1084" title="core/ngx_conf_file.c:1084">ngx_conf_set_num_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L43" title="http/modules/ngx_http_limit_conn_module.c:43">ngx_http_limit_conn_conf_t</a>, status_code),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &amp;<a href="#L70" title="http/modules/ngx_http_limit_conn_module.c:70">ngx_http_limit_conn_status_bounds</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L87" title="core/ngx_conf_file.h:87">ngx_null_command</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L109">&#x200c;</a><span class="Type">static</span> <a href="../ngx_http_config.h.html#L36" title="http/ngx_http_config.h:36">ngx_http_module_t</a>&nbsp; <span class="linkable">ngx_http_limit_conn_module_ctx</span> = {<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* preconfiguration */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L655" title="http/modules/ngx_http_limit_conn_module.c:655">ngx_http_limit_conn_init</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* postconfiguration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create <a href="../../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init <a href="../../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create server configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge server configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L452" title="http/modules/ngx_http_limit_conn_module.c:452">ngx_http_limit_conn_create_conf</a>,&nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* create location configuration */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L475" title="http/modules/ngx_http_limit_conn_module.c:475">ngx_http_limit_conn_merge_conf</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* merge location configuration */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L124">&#x200c;</a><a href="../../core/ngx_core.h.html#L12" title="core/ngx_core.h:12">ngx_module_t</a>&nbsp; <span class="linkable">ngx_http_limit_conn_module</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L99" title="core/ngx_conf_file.h:99">NGX_MODULE_V1</a>,<br/></li>
<li>&nbsp; &nbsp; &amp;<a href="#L109" title="http/modules/ngx_http_limit_conn_module.c:109">ngx_http_limit_conn_module_ctx</a>,&nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module context */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L75" title="http/modules/ngx_http_limit_conn_module.c:75">ngx_http_limit_conn_commands</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* module directives */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../ngx_http_config.h.html#L39" title="http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module type */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init master */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init module */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit master */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L100" title="core/ngx_conf_file.h:100">NGX_MODULE_V1_PADDING</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L141">&#x200c;</a><span class="linkable">ngx_http_limit_conn_handler</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; key;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *shpool;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *node;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_palloc.h.html#L32" title="core/ngx_palloc.h:32">ngx_pool_cleanup_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="#L30" title="http/modules/ngx_http_limit_conn_module.c:30">ngx_http_limit_conn_ctx_t</a>&nbsp; &nbsp; &nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="#L18" title="http/modules/ngx_http_limit_conn_module.c:18">ngx_http_limit_conn_node_t</a>&nbsp; &nbsp;&nbsp; *lc;<br/></li>
<li>&nbsp; &nbsp; <a href="#L43" title="http/modules/ngx_http_limit_conn_module.c:43">ngx_http_limit_conn_conf_t</a>&nbsp; &nbsp;&nbsp; *lccf;<br/></li>
<li>&nbsp; &nbsp; <a href="#L36" title="http/modules/ngx_http_limit_conn_module.c:36">ngx_http_limit_conn_limit_t</a>&nbsp; &nbsp; *limits;<br/></li>
<li>&nbsp; &nbsp; <a href="#L24" title="http/modules/ngx_http_limit_conn_module.c:24">ngx_http_limit_conn_cleanup_t</a>&nbsp; *lccln;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;<a href="../../core/nginx.c.html#L202" title="core/nginx.c:202">main</a>-&gt;limit_conn_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lccf = <a href="../ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="#L124" title="http/modules/ngx_http_limit_conn_module.c:124">ngx_http_limit_conn_module</a>);<br/></li>
<li>&nbsp; &nbsp; limits = lccf-&gt;limits.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; lccf-&gt;limits.nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = limits[i].shm_zone-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_script.c.html#L58" title="http/ngx_http_script.c:58">ngx_http_complex_value</a>(r, &amp;ctx-&gt;key, &amp;key) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (key.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (key.len &gt; <span class="Constant">255</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;the value of the </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> key &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;is more than 255 bytes: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;ctx-&gt;key.value, &amp;key);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;<a href="../../core/nginx.c.html#L202" title="core/nginx.c:202">main</a>-&gt;limit_conn_set = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash = <a href="../../core/ngx_crc32.h.html#L21" title="core/ngx_crc32.h:21">ngx_crc32_short</a>(key.data, key.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; shpool = (<a href="../../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *) limits[i].shm_zone-&gt;shm.addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_shmtx.c.html#L70" title="core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = <a href="#L298" title="http/modules/ngx_http_limit_conn_module.c:298">ngx_http_limit_conn_lookup</a>(ctx-&gt;rbtree, &amp;key, hash);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = offsetof(<a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>, color)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + offsetof(<a href="#L18" title="http/modules/ngx_http_limit_conn_module.c:18">ngx_http_limit_conn_node_t</a>, data)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + key.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = <a href="../../core/ngx_slab.c.html#L156" title="core/ngx_slab.c:156">ngx_slab_alloc_locked</a>(shpool, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_shmtx.c.html#L136" title="core/ngx_shmtx.c:136">ngx_shmtx_unlock</a>(&amp;shpool-&gt;mutex);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L368" title="http/modules/ngx_http_limit_conn_module.c:368">ngx_http_limit_conn_cleanup_all</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> lccf-&gt;status_code;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lc = (<a href="#L18" title="http/modules/ngx_http_limit_conn_module.c:18">ngx_http_limit_conn_node_t</a> *) &amp;node-&gt;color;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node-&gt;key = hash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lc-&gt;len = (u_char) key.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lc-&gt;conn = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(lc-&gt;data, key.data, key.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_rbtree.c.html#L25" title="core/ngx_rbtree.c:25">ngx_rbtree_insert</a>(ctx-&gt;rbtree, node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lc = (<a href="#L18" title="http/modules/ngx_http_limit_conn_module.c:18">ngx_http_limit_conn_node_t</a> *) &amp;node-&gt;color;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) lc-&gt;conn &gt;= limits[i].conn) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_shmtx.c.html#L136" title="core/ngx_shmtx.c:136">ngx_shmtx_unlock</a>(&amp;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(lccf-&gt;log_level, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;limiting connections by zone </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;limits[i].shm_zone-&gt;shm.name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L368" title="http/modules/ngx_http_limit_conn_module.c:368">ngx_http_limit_conn_cleanup_all</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> lccf-&gt;status_code;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lc-&gt;conn++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;limit conn: </span><span class="Special">%08X</span><span class="Constant">D </span><span class="Special">%d</span><span class="Constant">&quot;</span>, node-&gt;key, lc-&gt;conn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_shmtx.c.html#L136" title="core/ngx_shmtx.c:136">ngx_shmtx_unlock</a>(&amp;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cln = <a href="../../core/ngx_palloc.c.html#L314" title="core/ngx_palloc.c:314">ngx_pool_cleanup_add</a>(r-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="#L24" title="http/modules/ngx_http_limit_conn_module.c:24">ngx_http_limit_conn_cleanup_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cln-&gt;handler = <a href="#L337" title="http/modules/ngx_http_limit_conn_module.c:337">ngx_http_limit_conn_cleanup</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lccln = cln-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lccln-&gt;shm_zone = limits[i].shm_zone;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lccln-&gt;node = node;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L257">&#x200c;</a></span><span class="linkable">ngx_http_limit_conn_rbtree_insert_value</span>(<a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; **p;<br/></li>
<li>&nbsp; &nbsp; <a href="#L18" title="http/modules/ngx_http_limit_conn_module.c:18">ngx_http_limit_conn_node_t</a>&nbsp;&nbsp; *lcn, *lcnt;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;key &lt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;left;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (node-&gt;key &gt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;right;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* node-&gt;key == temp-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lcn = (<a href="#L18" title="http/modules/ngx_http_limit_conn_module.c:18">ngx_http_limit_conn_node_t</a> *) &amp;node-&gt;color;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lcnt = (<a href="#L18" title="http/modules/ngx_http_limit_conn_module.c:18">ngx_http_limit_conn_node_t</a> *) &amp;temp-&gt;color;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (<a href="../../core/ngx_string.c.html#L802" title="core/ngx_string.c:802">ngx_memn2cmp</a>(lcn-&gt;data, lcnt-&gt;data, lcn-&gt;len, lcnt-&gt;len) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ? &amp;temp-&gt;left : &amp;temp-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == sentinel) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; temp = *p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p = node;<br/></li>
<li>&nbsp; &nbsp; node-&gt;parent = temp;<br/></li>
<li>&nbsp; &nbsp; node-&gt;left = sentinel;<br/></li>
<li>&nbsp; &nbsp; node-&gt;right = sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L59" title="core/ngx_rbtree.h:59">ngx_rbt_red</a>(node);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *<br/></li>
<li><a id="L298">&#x200c;</a><span class="linkable">ngx_http_limit_conn_lookup</span>(<a href="../../core/ngx_rbtree.h.html#L32" title="core/ngx_rbtree.h:32">ngx_rbtree_t</a> *rbtree, <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *key, <span class="Type">uint32_t</span> hash)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *node, *sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="#L18" title="http/modules/ngx_http_limit_conn_module.c:18">ngx_http_limit_conn_node_t</a>&nbsp; *lcn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = rbtree-&gt;root;<br/></li>
<li>&nbsp; &nbsp; sentinel = rbtree-&gt;sentinel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (node != sentinel) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &lt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;left;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &gt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* hash == node-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lcn = (<a href="#L18" title="http/modules/ngx_http_limit_conn_module.c:18">ngx_http_limit_conn_node_t</a> *) &amp;node-&gt;color;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../../core/ngx_string.c.html#L802" title="core/ngx_string.c:802">ngx_memn2cmp</a>(key-&gt;data, lcn-&gt;data, key-&gt;len, (<span class="Type">size_t</span>) lcn-&gt;len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> node;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = (rc &lt; <span class="Constant">0</span>) ? node-&gt;left : node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L337">&#x200c;</a></span><span class="linkable">ngx_http_limit_conn_cleanup</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L24" title="http/modules/ngx_http_limit_conn_module.c:24">ngx_http_limit_conn_cleanup_t</a>&nbsp; *lccln = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *shpool;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *node;<br/></li>
<li>&nbsp; &nbsp; <a href="#L30" title="http/modules/ngx_http_limit_conn_module.c:30">ngx_http_limit_conn_ctx_t</a>&nbsp;&nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="#L18" title="http/modules/ngx_http_limit_conn_module.c:18">ngx_http_limit_conn_node_t</a>&nbsp; *lc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = lccln-&gt;shm_zone-&gt;data;<br/></li>
<li>&nbsp; &nbsp; shpool = (<a href="../../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *) lccln-&gt;shm_zone-&gt;shm.addr;<br/></li>
<li>&nbsp; &nbsp; node = lccln-&gt;node;<br/></li>
<li>&nbsp; &nbsp; lc = (<a href="#L18" title="http/modules/ngx_http_limit_conn_module.c:18">ngx_http_limit_conn_node_t</a> *) &amp;node-&gt;color;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_shmtx.c.html#L70" title="core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, lccln-&gt;shm_zone-&gt;shm.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;limit conn cleanup: </span><span class="Special">%08X</span><span class="Constant">D </span><span class="Special">%d</span><span class="Constant">&quot;</span>, node-&gt;key, lc-&gt;conn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lc-&gt;conn--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (lc-&gt;conn == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(ctx-&gt;rbtree, node);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_slab.c.html#L442" title="core/ngx_slab.c:442">ngx_slab_free_locked</a>(shpool, node);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_shmtx.c.html#L136" title="core/ngx_shmtx.c:136">ngx_shmtx_unlock</a>(&amp;shpool-&gt;mutex);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L111" title="core/ngx_config.h:111">ngx_inline</a> <span class="Type">void<br/></li>
<li><a id="L368">&#x200c;</a></span><span class="linkable">ngx_http_limit_conn_cleanup_all</span>(<a href="../../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_palloc.h.html#L32" title="core/ngx_palloc.h:32">ngx_pool_cleanup_t</a>&nbsp; *cln;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = pool-&gt;cleanup;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (cln &amp;&amp; cln-&gt;handler == <a href="#L337" title="http/modules/ngx_http_limit_conn_module.c:337">ngx_http_limit_conn_cleanup</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L337" title="http/modules/ngx_http_limit_conn_module.c:337">ngx_http_limit_conn_cleanup</a>(cln-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cln = cln-&gt;next;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pool-&gt;cleanup = cln;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L384">&#x200c;</a><span class="linkable">ngx_http_limit_conn_init_zone</span>(<a href="../../core/ngx_cycle.h.html#L25" title="core/ngx_cycle.h:25">ngx_shm_zone_t</a> *shm_zone, <span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L30" title="http/modules/ngx_http_limit_conn_module.c:30">ngx_http_limit_conn_ctx_t</a>&nbsp; *octx = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *shpool;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="#L30" title="http/modules/ngx_http_limit_conn_module.c:30">ngx_http_limit_conn_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = shm_zone-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (octx) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;key.value.len != octx-&gt;key.value.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || <a href="../../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(ctx-&gt;key.value.data, octx-&gt;key.value.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ctx-&gt;key.value.len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, shm_zone-&gt;shm.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;limit_conn_zone </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> uses the </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> key &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;while previously it used the </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> key&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;shm_zone-&gt;shm.name, &amp;ctx-&gt;key.value,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;octx-&gt;key.value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;rbtree = octx-&gt;rbtree;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shpool = (<a href="../../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *) shm_zone-&gt;shm.addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shm_zone-&gt;shm.exists) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;rbtree = shpool-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;rbtree = <a href="../../core/ngx_slab.c.html#L141" title="core/ngx_slab.c:141">ngx_slab_alloc</a>(shpool, <span class="Statement">sizeof</span>(<a href="../../core/ngx_rbtree.h.html#L32" title="core/ngx_rbtree.h:32">ngx_rbtree_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;rbtree == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shpool-&gt;data = ctx-&gt;rbtree;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sentinel = <a href="../../core/ngx_slab.c.html#L141" title="core/ngx_slab.c:141">ngx_slab_alloc</a>(shpool, <span class="Statement">sizeof</span>(<a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sentinel == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L44" title="core/ngx_rbtree.h:44">ngx_rbtree_init</a>(ctx-&gt;rbtree, sentinel,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L257" title="http/modules/ngx_http_limit_conn_module.c:257">ngx_http_limit_conn_rbtree_insert_value</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<span class="Constant">&quot; in limit_conn_zone </span><span class="Special">\&quot;\&quot;</span><span class="Constant">&quot;</span>) + shm_zone-&gt;shm.name.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shpool-&gt;log_ctx = <a href="../../core/ngx_slab.c.html#L141" title="core/ngx_slab.c:141">ngx_slab_alloc</a>(shpool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shpool-&gt;log_ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(shpool-&gt;log_ctx, <span class="Constant">&quot; in limit_conn_zone </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">%Z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;shm_zone-&gt;shm.name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L452">&#x200c;</a><span class="linkable">ngx_http_limit_conn_create_conf</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L43" title="http/modules/ngx_http_limit_conn_module.c:43">ngx_http_limit_conn_conf_t</a>&nbsp; *conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; conf = <a href="../../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L43" title="http/modules/ngx_http_limit_conn_module.c:43">ngx_http_limit_conn_conf_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> by <a href="../../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>():<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;limits.elts = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; conf-&gt;log_level = <a href="../../core/ngx_conf_file.h.html#L58" title="core/ngx_conf_file.h:58">NGX_CONF_UNSET_UINT</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;status_code = <a href="../../core/ngx_conf_file.h.html#L58" title="core/ngx_conf_file.h:58">NGX_CONF_UNSET_UINT</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> conf;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L475">&#x200c;</a><span class="linkable">ngx_http_limit_conn_merge_conf</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <span class="Type">void</span> *parent, <span class="Type">void</span> *child)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L43" title="http/modules/ngx_http_limit_conn_module.c:43">ngx_http_limit_conn_conf_t</a> *prev = parent;<br/></li>
<li>&nbsp; &nbsp; <a href="#L43" title="http/modules/ngx_http_limit_conn_module.c:43">ngx_http_limit_conn_conf_t</a> *conf = child;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;limits.elts == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;limits = prev-&gt;limits;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L256" title="core/ngx_conf_file.h:256">ngx_conf_merge_uint_value</a>(conf-&gt;log_level, prev-&gt;log_level, <a href="../../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L256" title="core/ngx_conf_file.h:256">ngx_conf_merge_uint_value</a>(conf-&gt;status_code, prev-&gt;status_code,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.h.html#L131" title="http/ngx_http_request.h:131">NGX_HTTP_SERVICE_UNAVAILABLE</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L493">&#x200c;</a><span class="linkable">ngx_http_limit_conn_zone</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *value, name, s;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_cycle.h.html#L25" title="core/ngx_cycle.h:25">ngx_shm_zone_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *shm_zone;<br/></li>
<li>&nbsp; &nbsp; <a href="#L30" title="http/modules/ngx_http_limit_conn_module.c:30">ngx_http_limit_conn_ctx_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L82" title="http/ngx_http_script.h:82">ngx_http_compile_complex_value_t</a>&nbsp;&nbsp; ccv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="../../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L30" title="http/modules/ngx_http_limit_conn_module.c:30">ngx_http_limit_conn_ctx_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;ccv, <span class="Statement">sizeof</span>(<a href="../ngx_http_script.h.html#L82" title="http/ngx_http_script.h:82">ngx_http_compile_complex_value_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ccv.cf = cf;<br/></li>
<li>&nbsp; &nbsp; ccv.value = &amp;value[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; ccv.complex_value = &amp;ctx-&gt;key;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_script.c.html#L108" title="http/ngx_http_script.c:108">ngx_http_compile_complex_value</a>(&amp;ccv) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; name.len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">2</span>; i &lt; cf-&gt;args-&gt;nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;zone=&quot;</span>, <span class="Constant">5</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name.data = value[i].data + <span class="Constant">5</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (u_char *) <a href="../../core/ngx_string.h.html#L63" title="core/ngx_string.h:63">ngx_strchr</a>(name.data, <span class="Constant">':'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid zone size </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name.len = p - name.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.data = p + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.len = value[i].data + value[i].len - s.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = <a href="../../core/ngx_parse.c.html#L13" title="core/ngx_parse.c:13">ngx_parse_size</a>(&amp;s);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size == <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid zone size </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &lt; (<span class="Type">ssize_t</span>) (<span class="Constant">8</span> * <a href="../../os/unix/ngx_alloc.c.html#L12" title="os/unix/ngx_alloc.c:12">ngx_pagesize</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;zone </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> is too small&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid parameter </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> must have </span><span class="Special">\&quot;</span><span class="Constant">zone</span><span class="Special">\&quot;</span><span class="Constant"> parameter&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;cmd-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shm_zone = <a href="../../core/ngx_cycle.c.html#L1175" title="core/ngx_cycle.c:1175">ngx_shared_memory_add</a>(cf, &amp;name, size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;<a href="#L124" title="http/modules/ngx_http_limit_conn_module.c:124">ngx_http_limit_conn_module</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shm_zone == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shm_zone-&gt;data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = shm_zone-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;%V </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> is already bound to key </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;cmd-&gt;name, &amp;name, &amp;ctx-&gt;key.value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shm_zone-&gt;init = <a href="#L384" title="http/modules/ngx_http_limit_conn_module.c:384">ngx_http_limit_conn_init_zone</a>;<br/></li>
<li>&nbsp; &nbsp; shm_zone-&gt;data = ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L594">&#x200c;</a><span class="linkable">ngx_http_limit_conn</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_cycle.h.html#L25" title="core/ngx_cycle.h:25">ngx_shm_zone_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *shm_zone;<br/></li>
<li>&nbsp; &nbsp; <a href="#L43" title="http/modules/ngx_http_limit_conn_module.c:43">ngx_http_limit_conn_conf_t</a>&nbsp;&nbsp; *lccf = conf;<br/></li>
<li>&nbsp; &nbsp; <a href="#L36" title="http/modules/ngx_http_limit_conn_module.c:36">ngx_http_limit_conn_limit_t</a>&nbsp; *limit, *limits;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shm_zone = <a href="../../core/ngx_cycle.c.html#L1175" title="core/ngx_cycle.c:1175">ngx_shared_memory_add</a>(cf, &amp;value[<span class="Constant">1</span>], <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;<a href="#L124" title="http/modules/ngx_http_limit_conn_module.c:124">ngx_http_limit_conn_module</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shm_zone == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; limits = lccf-&gt;limits.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (limits == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;lccf-&gt;limits, cf-&gt;pool, <span class="Constant">1</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="#L36" title="http/modules/ngx_http_limit_conn_module.c:36">ngx_http_limit_conn_limit_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; lccf-&gt;limits.nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (shm_zone == limits[i].shm_zone) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;is duplicate&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = <a href="../../core/ngx_string.c.html#L898" title="core/ngx_string.c:898">ngx_atoi</a>(value[<span class="Constant">2</span>].data, value[<span class="Constant">2</span>].len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid number of connections </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">2</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">65535</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;connection limit must be less 65536&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; limit = <a href="../../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(&amp;lccf-&gt;limits);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (limit == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; limit-&gt;conn = n;<br/></li>
<li>&nbsp; &nbsp; limit-&gt;shm_zone = shm_zone;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L655">&#x200c;</a><span class="linkable">ngx_http_limit_conn_init</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_request.h.html#L355" title="http/ngx_http_request.h:355">ngx_http_handler_pt</a>&nbsp; &nbsp; &nbsp; &nbsp; *h;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L182" title="http/ngx_http_core_module.h:182">ngx_http_core_main_conf_t</a>&nbsp; *cmcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cmcf = <a href="../ngx_http_config.h.html#L61" title="http/ngx_http_config.h:61">ngx_http_conf_get_module_main_conf</a>(cf, <a href="../ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h = <a href="../../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(&amp;cmcf-&gt;phases[NGX_HTTP_PREACCESS_PHASE].handlers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *h = <a href="#L141" title="http/modules/ngx_http_limit_conn_module.c:141">ngx_http_limit_conn_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
