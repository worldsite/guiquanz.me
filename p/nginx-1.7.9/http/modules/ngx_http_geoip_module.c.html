<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>http/modules/ngx_http_geoip_module.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>http/modules/ngx_http_geoip_module.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L97">ngx_http_geoip_commands</a></li>
<li><a href="#L45">ngx_http_geoip_country_functions</a></li>
<li><a href="#L58">ngx_http_geoip_country_v6_functions</a></li>
<li><a href="#L153">ngx_http_geoip_module</a></li>
<li><a href="#L138">ngx_http_geoip_module_ctx</a></li>
<li><a href="#L169">ngx_http_geoip_vars</a></li>
</ul>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L32">ngx_http_geoip_conf_t</a></li>
<li><a href="#L38">ngx_http_geoip_var_t</a></li>
<li><a href="#L41">ngx_http_geoip_variable_handler_pt</a></li>
<li><a href="#L54">ngx_http_geoip_variable_handler_v6_pt</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L622">ngx_http_geoip_add_variables</a></li>
<li><a href="#L240">ngx_http_geoip_addr</a></li>
<li><a href="#L292">ngx_http_geoip_addr_v6</a></li>
<li><a href="#L881">ngx_http_geoip_cidr_value</a></li>
<li><a href="#L793">ngx_http_geoip_city</a></li>
<li><a href="#L535">ngx_http_geoip_city_float_variable</a></li>
<li><a href="#L567">ngx_http_geoip_city_int_variable</a></li>
<li><a href="#L443">ngx_http_geoip_city_variable</a></li>
<li><a href="#L910">ngx_http_geoip_cleanup</a></li>
<li><a href="#L677">ngx_http_geoip_country</a></li>
<li><a href="#L341">ngx_http_geoip_country_variable</a></li>
<li><a href="#L641">ngx_http_geoip_create_conf</a></li>
<li><a href="#L599">ngx_http_geoip_get_city_record</a></li>
<li><a href="#L666">ngx_http_geoip_init_conf</a></li>
<li><a href="#L732">ngx_http_geoip_org</a></li>
<li><a href="#L389">ngx_http_geoip_org_variable</a></li>
<li><a href="#L850">ngx_http_geoip_proxy</a></li>
<li><a href="#L491">ngx_http_geoip_region_name_variable</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L16">NGX_GEOIP_COUNTRY_CODE</a></li>
<li><a href="#L17">NGX_GEOIP_COUNTRY_CODE3</a></li>
<li><a href="#L18">NGX_GEOIP_COUNTRY_NAME</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;GeoIP.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;GeoIPCity.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L16">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_GEOIP_COUNTRY_CODE</span>&nbsp;&nbsp; </span><span class="Constant">0<br/></li>
<li><a id="L17">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_GEOIP_COUNTRY_CODE3</span>&nbsp; </span><span class="Constant">1<br/></li>
<li><a id="L18">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_GEOIP_COUNTRY_NAME</span>&nbsp;&nbsp; </span><span class="Constant">2<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; GeoIP&nbsp; &nbsp; &nbsp; &nbsp; *country;<br/></li>
<li>&nbsp; &nbsp; GeoIP&nbsp; &nbsp; &nbsp; &nbsp; *org;<br/></li>
<li>&nbsp; &nbsp; GeoIP&nbsp; &nbsp; &nbsp; &nbsp; *city;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; *proxies;&nbsp; &nbsp; <span class="Comment">/* array of <a href="../../core/ngx_inet.h.html#L67" title="core/ngx_inet.h:67">ngx_cidr_t</a> */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L80" title="core/ngx_config.h:80">ngx_flag_t</a>&nbsp; &nbsp; proxy_recursive;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_GEOIP_V6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; country_v6:<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; org_v6:<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; city_v6:<span class="Constant">1</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li><a id="L32">&#x200c;</a></span>} <span class="linkable">ngx_http_geoip_conf_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; *name;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uintptr_t</span>&nbsp; &nbsp;&nbsp; data;<br/></li>
<li><a id="L38">&#x200c;</a>} <span class="linkable">ngx_http_geoip_var_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L41">&#x200c;</a><span class="Type">typedef</span> <span class="Type">const</span> <span class="Type">char</span> *(*<span class="linkable">ngx_http_geoip_variable_handler_pt</span>)(GeoIP *,<br/></li>
<li>&nbsp; &nbsp; u_long addr);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L45">&#x200c;</a><a href="#L41" title="http/modules/ngx_http_geoip_module.c:41">ngx_http_geoip_variable_handler_pt</a> <span class="linkable">ngx_http_geoip_country_functions</span>[] = {<br/></li>
<li>&nbsp; &nbsp; GeoIP_country_code_by_ipnum,<br/></li>
<li>&nbsp; &nbsp; GeoIP_country_code3_by_ipnum,<br/></li>
<li>&nbsp; &nbsp; GeoIP_country_name_by_ipnum,<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_GEOIP_V6)<br/></li>
<li></span><br/></li>
<li><a id="L54">&#x200c;</a><span class="Type">typedef</span> <span class="Type">const</span> <span class="Type">char</span> *(*<span class="linkable">ngx_http_geoip_variable_handler_v6_pt</span>)(GeoIP *,<br/></li>
<li>&nbsp; &nbsp; geoipv6_t addr);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L58">&#x200c;</a><a href="#L54" title="http/modules/ngx_http_geoip_module.c:54">ngx_http_geoip_variable_handler_v6_pt</a> <span class="linkable">ngx_http_geoip_country_v6_functions</span>[] = {<br/></li>
<li>&nbsp; &nbsp; GeoIP_country_code_by_ipnum_v6,<br/></li>
<li>&nbsp; &nbsp; GeoIP_country_code3_by_ipnum_v6,<br/></li>
<li>&nbsp; &nbsp; GeoIP_country_name_by_ipnum_v6,<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L341" title="http/modules/ngx_http_geoip_module.c:341">ngx_http_geoip_country_variable</a>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L389" title="http/modules/ngx_http_geoip_module.c:389">ngx_http_geoip_org_variable</a>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L443" title="http/modules/ngx_http_geoip_module.c:443">ngx_http_geoip_city_variable</a>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L491" title="http/modules/ngx_http_geoip_module.c:491">ngx_http_geoip_region_name_variable</a>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L535" title="http/modules/ngx_http_geoip_module.c:535">ngx_http_geoip_city_float_variable</a>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L567" title="http/modules/ngx_http_geoip_module.c:567">ngx_http_geoip_city_int_variable</a>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data);<br/></li>
<li><span class="Type">static</span> GeoIPRecord *<a href="#L599" title="http/modules/ngx_http_geoip_module.c:599">ngx_http_geoip_get_city_record</a>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L622" title="http/modules/ngx_http_geoip_module.c:622">ngx_http_geoip_add_variables</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L641" title="http/modules/ngx_http_geoip_module.c:641">ngx_http_geoip_create_conf</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L666" title="http/modules/ngx_http_geoip_module.c:666">ngx_http_geoip_init_conf</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L677" title="http/modules/ngx_http_geoip_module.c:677">ngx_http_geoip_country</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L732" title="http/modules/ngx_http_geoip_module.c:732">ngx_http_geoip_org</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L793" title="http/modules/ngx_http_geoip_module.c:793">ngx_http_geoip_city</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L850" title="http/modules/ngx_http_geoip_module.c:850">ngx_http_geoip_proxy</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L881" title="http/modules/ngx_http_geoip_module.c:881">ngx_http_geoip_cidr_value</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *net,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_inet.h.html#L67" title="core/ngx_inet.h:67">ngx_cidr_t</a> *cidr);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L910" title="http/modules/ngx_http_geoip_module.c:910">ngx_http_geoip_cleanup</a>(<span class="Type">void</span> *data);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L97">&#x200c;</a><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a>&nbsp; <span class="linkable">ngx_http_geoip_commands</span>[] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_country&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L33" title="core/ngx_conf_file.h:33">NGX_CONF_TAKE12</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L677" title="http/modules/ngx_http_geoip_module.c:677">ngx_http_geoip_country</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L50" title="http/ngx_http_config.h:50">NGX_HTTP_MAIN_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_org&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L33" title="core/ngx_conf_file.h:33">NGX_CONF_TAKE12</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L732" title="http/modules/ngx_http_geoip_module.c:732">ngx_http_geoip_org</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L50" title="http/ngx_http_config.h:50">NGX_HTTP_MAIN_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_city&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L33" title="core/ngx_conf_file.h:33">NGX_CONF_TAKE12</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L793" title="http/modules/ngx_http_geoip_module.c:793">ngx_http_geoip_city</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L50" title="http/ngx_http_config.h:50">NGX_HTTP_MAIN_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_proxy&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L23" title="core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L850" title="http/modules/ngx_http_geoip_module.c:850">ngx_http_geoip_proxy</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L50" title="http/ngx_http_config.h:50">NGX_HTTP_MAIN_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_proxy_recursive&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L44" title="core/ngx_conf_file.h:44">NGX_CONF_FLAG</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L943" title="core/ngx_conf_file.c:943">ngx_conf_set_flag_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L50" title="http/ngx_http_config.h:50">NGX_HTTP_MAIN_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L32" title="http/modules/ngx_http_geoip_module.c:32">ngx_http_geoip_conf_t</a>, proxy_recursive),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L87" title="core/ngx_conf_file.h:87">ngx_null_command</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L138">&#x200c;</a><span class="Type">static</span> <a href="../ngx_http_config.h.html#L36" title="http/ngx_http_config.h:36">ngx_http_module_t</a>&nbsp; <span class="linkable">ngx_http_geoip_module_ctx</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="#L622" title="http/modules/ngx_http_geoip_module.c:622">ngx_http_geoip_add_variables</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* preconfiguration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* postconfiguration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L641" title="http/modules/ngx_http_geoip_module.c:641">ngx_http_geoip_create_conf</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create <a href="../../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> configuration */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L666" title="http/modules/ngx_http_geoip_module.c:666">ngx_http_geoip_init_conf</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init <a href="../../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create server configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge server configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create location configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* merge location configuration */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L153">&#x200c;</a><a href="../../core/ngx_core.h.html#L12" title="core/ngx_core.h:12">ngx_module_t</a>&nbsp; <span class="linkable">ngx_http_geoip_module</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L99" title="core/ngx_conf_file.h:99">NGX_MODULE_V1</a>,<br/></li>
<li>&nbsp; &nbsp; &amp;<a href="#L138" title="http/modules/ngx_http_geoip_module.c:138">ngx_http_geoip_module_ctx</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* module context */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L97" title="http/modules/ngx_http_geoip_module.c:97">ngx_http_geoip_commands</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module directives */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../ngx_http_config.h.html#L39" title="http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module type */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init master */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init module */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit master */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L100" title="core/ngx_conf_file.h:100">NGX_MODULE_V1_PADDING</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L169">&#x200c;</a><span class="Type">static</span> <a href="../ngx_http_variables.h.html#L21" title="http/ngx_http_variables.h:21">ngx_http_variable_t</a>&nbsp; <span class="linkable">ngx_http_geoip_vars</span>[] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_country_code&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L341" title="http/modules/ngx_http_geoip_module.c:341">ngx_http_geoip_country_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L16" title="http/modules/ngx_http_geoip_module.c:16">NGX_GEOIP_COUNTRY_CODE</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_country_code3&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L341" title="http/modules/ngx_http_geoip_module.c:341">ngx_http_geoip_country_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L17" title="http/modules/ngx_http_geoip_module.c:17">NGX_GEOIP_COUNTRY_CODE3</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_country_name&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L341" title="http/modules/ngx_http_geoip_module.c:341">ngx_http_geoip_country_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L18" title="http/modules/ngx_http_geoip_module.c:18">NGX_GEOIP_COUNTRY_NAME</a>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_org&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L389" title="http/modules/ngx_http_geoip_module.c:389">ngx_http_geoip_org_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_city_continent_code&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L443" title="http/modules/ngx_http_geoip_module.c:443">ngx_http_geoip_city_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(GeoIPRecord, continent_code), <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_city_country_code&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L443" title="http/modules/ngx_http_geoip_module.c:443">ngx_http_geoip_city_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(GeoIPRecord, country_code), <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_city_country_code3&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L443" title="http/modules/ngx_http_geoip_module.c:443">ngx_http_geoip_city_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(GeoIPRecord, country_code3), <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_city_country_name&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L443" title="http/modules/ngx_http_geoip_module.c:443">ngx_http_geoip_city_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(GeoIPRecord, country_name), <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_region&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L443" title="http/modules/ngx_http_geoip_module.c:443">ngx_http_geoip_city_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(GeoIPRecord, region), <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_region_name&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L491" title="http/modules/ngx_http_geoip_module.c:491">ngx_http_geoip_region_name_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_city&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L443" title="http/modules/ngx_http_geoip_module.c:443">ngx_http_geoip_city_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(GeoIPRecord, city), <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_postal_code&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L443" title="http/modules/ngx_http_geoip_module.c:443">ngx_http_geoip_city_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(GeoIPRecord, postal_code), <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_latitude&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L535" title="http/modules/ngx_http_geoip_module.c:535">ngx_http_geoip_city_float_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(GeoIPRecord, latitude), <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_longitude&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L535" title="http/modules/ngx_http_geoip_module.c:535">ngx_http_geoip_city_float_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(GeoIPRecord, longitude), <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_dma_code&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L567" title="http/modules/ngx_http_geoip_module.c:567">ngx_http_geoip_city_int_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(GeoIPRecord, dma_code), <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geoip_area_code&quot;</span>), <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L567" title="http/modules/ngx_http_geoip_module.c:567">ngx_http_geoip_city_int_variable</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(GeoIPRecord, area_code), <span class="Constant">0</span>, <span class="Constant">0</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L41" title="core/ngx_string.h:41">ngx_null_string</a>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_long<br/></li>
<li><a id="L240">&#x200c;</a><span class="linkable">ngx_http_geoip_addr</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="#L32" title="http/modules/ngx_http_geoip_module.c:32">ngx_http_geoip_conf_t</a> *gcf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; addr;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *xfwd;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp; *sin;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; addr.sockaddr = r-&gt;connection-&gt;sockaddr;<br/></li>
<li>&nbsp; &nbsp; addr.socklen = r-&gt;connection-&gt;socklen;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* addr.name = r-&gt;connection-&gt;addr_text; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; xfwd = &amp;r-&gt;headers_in.x_forwarded_for;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (xfwd-&gt;nelts &gt; <span class="Constant">0</span> &amp;&amp; gcf-&gt;proxies != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../ngx_http_core_module.c.html#L2813" title="http/ngx_http_core_module.c:2813">ngx_http_get_forwarded_addr</a>(r, &amp;addr, xfwd, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; gcf-&gt;proxies, gcf-&gt;proxy_recursive);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (addr.sockaddr-&gt;sa_family == AF_INET6) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; in_addr_t&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; inaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> in6_addr&nbsp; *inaddr6;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inaddr6 = &amp;((<span class="Type">struct</span> sockaddr_in6 *) addr.sockaddr)-&gt;sin6_addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (IN6_IS_ADDR_V4MAPPED(inaddr6)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = inaddr6-&gt;s6_addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr = p[<span class="Constant">12</span>] &lt;&lt; <span class="Constant">24</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr += p[<span class="Constant">13</span>] &lt;&lt; <span class="Constant">16</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr += p[<span class="Constant">14</span>] &lt;&lt; <span class="Constant">8</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr += p[<span class="Constant">15</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> inaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (addr.sockaddr-&gt;sa_family != AF_INET) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_config.h.html#L115" title="core/ngx_config.h:115">INADDR_NONE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sin = (<span class="Type">struct</span> sockaddr_in *) addr.sockaddr;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> ntohl(sin-&gt;sin_addr.s_addr);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_GEOIP_V6)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> geoipv6_t<br/></li>
<li><a id="L292">&#x200c;</a><span class="linkable">ngx_http_geoip_addr_v6</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="#L32" title="http/modules/ngx_http_geoip_module.c:32">ngx_http_geoip_conf_t</a> *gcf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *xfwd;<br/></li>
<li>&nbsp; &nbsp; in_addr_t&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; addr4;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> in6_addr&nbsp; &nbsp; &nbsp;&nbsp; addr6;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp;&nbsp; *sin;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in6&nbsp; *sin6;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; addr.sockaddr = r-&gt;connection-&gt;sockaddr;<br/></li>
<li>&nbsp; &nbsp; addr.socklen = r-&gt;connection-&gt;socklen;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* addr.name = r-&gt;connection-&gt;addr_text; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; xfwd = &amp;r-&gt;headers_in.x_forwarded_for;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (xfwd-&gt;nelts &gt; <span class="Constant">0</span> &amp;&amp; gcf-&gt;proxies != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../ngx_http_core_module.c.html#L2813" title="http/ngx_http_core_module.c:2813">ngx_http_get_forwarded_addr</a>(r, &amp;addr, xfwd, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; gcf-&gt;proxies, gcf-&gt;proxy_recursive);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (addr.sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> AF_INET:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Produce IPv4-mapped IPv6 address. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; sin = (<span class="Type">struct</span> sockaddr_in *) addr.sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr4 = ntohl(sin-&gt;sin_addr.s_addr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;addr6, <span class="Statement">sizeof</span>(<span class="Type">struct</span> in6_addr));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr6.s6_addr[<span class="Constant">10</span>] = <span class="Constant">0xff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr6.s6_addr[<span class="Constant">11</span>] = <span class="Constant">0xff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr6.s6_addr[<span class="Constant">12</span>] = addr4 &gt;&gt; <span class="Constant">24</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr6.s6_addr[<span class="Constant">13</span>] = addr4 &gt;&gt; <span class="Constant">16</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr6.s6_addr[<span class="Constant">14</span>] = addr4 &gt;&gt; <span class="Constant">8</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr6.s6_addr[<span class="Constant">15</span>] = addr4;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> addr6;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sin6 = (<span class="Type">struct</span> sockaddr_in6 *) addr.sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> sin6-&gt;sin6_addr;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> in6addr_any;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L341">&#x200c;</a><span class="linkable">ngx_http_geoip_country_variable</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L41" title="http/modules/ngx_http_geoip_module.c:41">ngx_http_geoip_variable_handler_pt</a>&nbsp; &nbsp;&nbsp; handler =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L45" title="http/modules/ngx_http_geoip_module.c:45">ngx_http_geoip_country_functions</a>[data];<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_GEOIP_V6)<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L54" title="http/modules/ngx_http_geoip_module.c:54">ngx_http_geoip_variable_handler_v6_pt</a>&nbsp; handler_v6 =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L58" title="http/modules/ngx_http_geoip_module.c:58">ngx_http_geoip_country_v6_functions</a>[data];<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *val;<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="http/modules/ngx_http_geoip_module.c:32">ngx_http_geoip_conf_t</a>&nbsp; *gcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gcf = <a href="../ngx_http_config.h.html#L55" title="http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(r, <a href="#L153" title="http/modules/ngx_http_geoip_module.c:153">ngx_http_geoip_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gcf-&gt;country == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> not_found;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_GEOIP_V6)<br/></li>
<li></span>&nbsp; &nbsp; val = gcf-&gt;country_v6<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ? handler_v6(gcf-&gt;country, <a href="#L292" title="http/modules/ngx_http_geoip_module.c:292">ngx_http_geoip_addr_v6</a>(r, gcf))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : handler(gcf-&gt;country, <a href="#L240" title="http/modules/ngx_http_geoip_module.c:240">ngx_http_geoip_addr</a>(r, gcf));<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; val = handler(gcf-&gt;country, <a href="#L240" title="http/modules/ngx_http_geoip_module.c:240">ngx_http_geoip_addr</a>(r, gcf));<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (val == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> not_found;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;len = <a href="../../core/ngx_string.h.html#L61" title="core/ngx_string.h:61">ngx_strlen</a>(val);<br/></li>
<li>&nbsp; &nbsp; v-&gt;valid = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;no_cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;data = (u_char *) val;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">not_found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L389">&#x200c;</a><span class="linkable">ngx_http_geoip_org_variable</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *val;<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="http/modules/ngx_http_geoip_module.c:32">ngx_http_geoip_conf_t</a>&nbsp; *gcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gcf = <a href="../ngx_http_config.h.html#L55" title="http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(r, <a href="#L153" title="http/modules/ngx_http_geoip_module.c:153">ngx_http_geoip_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gcf-&gt;org == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> not_found;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_GEOIP_V6)<br/></li>
<li></span>&nbsp; &nbsp; val = gcf-&gt;org_v6<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ? GeoIP_name_by_ipnum_v6(gcf-&gt;org,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L292" title="http/modules/ngx_http_geoip_module.c:292">ngx_http_geoip_addr_v6</a>(r, gcf))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : GeoIP_name_by_ipnum(gcf-&gt;org,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L240" title="http/modules/ngx_http_geoip_module.c:240">ngx_http_geoip_addr</a>(r, gcf));<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; val = GeoIP_name_by_ipnum(gcf-&gt;org, <a href="#L240" title="http/modules/ngx_http_geoip_module.c:240">ngx_http_geoip_addr</a>(r, gcf));<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (val == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> not_found;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <a href="../../core/ngx_string.h.html#L61" title="core/ngx_string.h:61">ngx_strlen</a>(val);<br/></li>
<li>&nbsp; &nbsp; v-&gt;data = <a href="../../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(r-&gt;pool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (v-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(v-&gt;data, val, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;len = len;<br/></li>
<li>&nbsp; &nbsp; v-&gt;valid = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;no_cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(val);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">not_found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L443">&#x200c;</a><span class="linkable">ngx_http_geoip_city_variable</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *val;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; GeoIPRecord&nbsp; *gr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gr = <a href="#L599" title="http/modules/ngx_http_geoip_module.c:599">ngx_http_geoip_get_city_record</a>(r);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> not_found;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; val = *(<span class="Type">char</span> **) ((<span class="Type">char</span> *) gr + data);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (val == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> no_value;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <a href="../../core/ngx_string.h.html#L61" title="core/ngx_string.h:61">ngx_strlen</a>(val);<br/></li>
<li>&nbsp; &nbsp; v-&gt;data = <a href="../../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(r-&gt;pool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (v-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; GeoIPRecord_delete(gr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(v-&gt;data, val, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;len = len;<br/></li>
<li>&nbsp; &nbsp; v-&gt;valid = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;no_cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; GeoIPRecord_delete(gr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">no_value</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; GeoIPRecord_delete(gr);<br/></li>
<li><br/></li>
<li><span class="Statement">not_found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L491">&#x200c;</a><span class="linkable">ngx_http_geoip_region_name_variable</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>&nbsp;&nbsp; *val;<br/></li>
<li>&nbsp; &nbsp; GeoIPRecord&nbsp; *gr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gr = <a href="#L599" title="http/modules/ngx_http_geoip_module.c:599">ngx_http_geoip_get_city_record</a>(r);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> not_found;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; val = GeoIP_region_name_by_code(gr-&gt;country_code, gr-&gt;region);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; GeoIPRecord_delete(gr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (val == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> not_found;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <a href="../../core/ngx_string.h.html#L61" title="core/ngx_string.h:61">ngx_strlen</a>(val);<br/></li>
<li>&nbsp; &nbsp; v-&gt;data = <a href="../../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(r-&gt;pool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (v-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(v-&gt;data, val, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;len = len;<br/></li>
<li>&nbsp; &nbsp; v-&gt;valid = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;no_cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">not_found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L535">&#x200c;</a><span class="linkable">ngx_http_geoip_city_float_variable</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; val;<br/></li>
<li>&nbsp; &nbsp; GeoIPRecord&nbsp; *gr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gr = <a href="#L599" title="http/modules/ngx_http_geoip_module.c:599">ngx_http_geoip_get_city_record</a>(r);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;data = <a href="../../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(r-&gt;pool, <a href="../../core/ngx_config.h.html#L84" title="core/ngx_config.h:84">NGX_INT64_LEN</a> + <span class="Constant">5</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (v-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; GeoIPRecord_delete(gr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; val = *(<span class="Type">float</span> *) ((<span class="Type">char</span> *) gr + data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;len = <a href="../../core/ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(v-&gt;data, <span class="Constant">&quot;</span><span class="Special">%.4f</span><span class="Constant">&quot;</span>, val) - v-&gt;data;<br/></li>
<li>&nbsp; &nbsp; v-&gt;valid = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;no_cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; GeoIPRecord_delete(gr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L567">&#x200c;</a><span class="linkable">ngx_http_geoip_city_int_variable</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v, <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; val;<br/></li>
<li>&nbsp; &nbsp; GeoIPRecord&nbsp; *gr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gr = <a href="#L599" title="http/modules/ngx_http_geoip_module.c:599">ngx_http_geoip_get_city_record</a>(r);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v-&gt;not_found = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;data = <a href="../../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(r-&gt;pool, <a href="../../core/ngx_config.h.html#L84" title="core/ngx_config.h:84">NGX_INT64_LEN</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (v-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; GeoIPRecord_delete(gr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; val = *(<span class="Type">int</span> *) ((<span class="Type">char</span> *) gr + data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v-&gt;len = <a href="../../core/ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(v-&gt;data, <span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant">&quot;</span>, val) - v-&gt;data;<br/></li>
<li>&nbsp; &nbsp; v-&gt;valid = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;no_cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; v-&gt;not_found = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; GeoIPRecord_delete(gr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> GeoIPRecord *<br/></li>
<li><a id="L599">&#x200c;</a><span class="linkable">ngx_http_geoip_get_city_record</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="http/modules/ngx_http_geoip_module.c:32">ngx_http_geoip_conf_t</a>&nbsp; *gcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gcf = <a href="../ngx_http_config.h.html#L55" title="http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(r, <a href="#L153" title="http/modules/ngx_http_geoip_module.c:153">ngx_http_geoip_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gcf-&gt;city) {<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_GEOIP_V6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> gcf-&gt;city_v6<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ? GeoIP_record_by_ipnum_v6(gcf-&gt;city,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L292" title="http/modules/ngx_http_geoip_module.c:292">ngx_http_geoip_addr_v6</a>(r, gcf))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; : GeoIP_record_by_ipnum(gcf-&gt;city,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L240" title="http/modules/ngx_http_geoip_module.c:240">ngx_http_geoip_addr</a>(r, gcf));<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> GeoIP_record_by_ipnum(gcf-&gt;city, <a href="#L240" title="http/modules/ngx_http_geoip_module.c:240">ngx_http_geoip_addr</a>(r, gcf));<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L622">&#x200c;</a><span class="linkable">ngx_http_geoip_add_variables</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L21" title="http/ngx_http_variables.h:21">ngx_http_variable_t</a>&nbsp; *var, *v;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (v = <a href="#L169" title="http/modules/ngx_http_geoip_module.c:169">ngx_http_geoip_vars</a>; v-&gt;name.len; v++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; var = <a href="../ngx_http_variables.c.html#L359" title="http/ngx_http_variables.c:359">ngx_http_add_variable</a>(cf, &amp;v-&gt;name, v-&gt;flags);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (var == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; var-&gt;get_handler = v-&gt;get_handler;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; var-&gt;data = v-&gt;data;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L641">&#x200c;</a><span class="linkable">ngx_http_geoip_create_conf</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_palloc.h.html#L32" title="core/ngx_palloc.h:32">ngx_pool_cleanup_t</a>&nbsp; &nbsp;&nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="http/modules/ngx_http_geoip_module.c:32">ngx_http_geoip_conf_t</a>&nbsp; *conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; conf = <a href="../../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L32" title="http/modules/ngx_http_geoip_module.c:32">ngx_http_geoip_conf_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; conf-&gt;proxy_recursive = <a href="../../core/ngx_conf_file.h.html#L57" title="core/ngx_conf_file.h:57">NGX_CONF_UNSET</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = <a href="../../core/ngx_palloc.c.html#L314" title="core/ngx_palloc.c:314">ngx_pool_cleanup_add</a>(cf-&gt;pool, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln-&gt;handler = <a href="#L910" title="http/modules/ngx_http_geoip_module.c:910">ngx_http_geoip_cleanup</a>;<br/></li>
<li>&nbsp; &nbsp; cln-&gt;data = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> conf;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L666">&#x200c;</a><span class="linkable">ngx_http_geoip_init_conf</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="http/modules/ngx_http_geoip_module.c:32">ngx_http_geoip_conf_t</a>&nbsp; *gcf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L221" title="core/ngx_conf_file.h:221">ngx_conf_init_value</a>(gcf-&gt;proxy_recursive, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L677">&#x200c;</a><span class="linkable">ngx_http_geoip_country</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="http/modules/ngx_http_geoip_module.c:32">ngx_http_geoip_conf_t</a>&nbsp; *gcf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; *value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gcf-&gt;country) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;is duplicate&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gcf-&gt;country = GeoIP_open((<span class="Type">char</span> *) value[<span class="Constant">1</span>].data, GEOIP_MEMORY_CACHE);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gcf-&gt;country == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;GeoIP_open(</span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">) failed&quot;</span>, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cf-&gt;args-&gt;nelts == <span class="Constant">3</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">2</span>].data, <span class="Constant">&quot;utf8&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GeoIP_set_charset(gcf-&gt;country, GEOIP_CHARSET_UTF8);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid parameter </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">2</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (gcf-&gt;country-&gt;databaseType) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> GEOIP_COUNTRY_EDITION:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_GEOIP_V6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> GEOIP_COUNTRY_EDITION_V6:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; gcf-&gt;country_v6 = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid GeoIP database </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> type:</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;value[<span class="Constant">1</span>], gcf-&gt;country-&gt;databaseType);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L732">&#x200c;</a><span class="linkable">ngx_http_geoip_org</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="http/modules/ngx_http_geoip_module.c:32">ngx_http_geoip_conf_t</a>&nbsp; *gcf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; *value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gcf-&gt;org) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;is duplicate&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gcf-&gt;org = GeoIP_open((<span class="Type">char</span> *) value[<span class="Constant">1</span>].data, GEOIP_MEMORY_CACHE);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gcf-&gt;org == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;GeoIP_open(</span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">) failed&quot;</span>, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cf-&gt;args-&gt;nelts == <span class="Constant">3</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">2</span>].data, <span class="Constant">&quot;utf8&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GeoIP_set_charset(gcf-&gt;org, GEOIP_CHARSET_UTF8);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid parameter </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">2</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (gcf-&gt;org-&gt;databaseType) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> GEOIP_ISP_EDITION:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> GEOIP_ORG_EDITION:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> GEOIP_DOMAIN_EDITION:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> GEOIP_ASNUM_EDITION:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_GEOIP_V6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> GEOIP_ISP_EDITION_V6:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> GEOIP_ORG_EDITION_V6:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> GEOIP_DOMAIN_EDITION_V6:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> GEOIP_ASNUM_EDITION_V6:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; gcf-&gt;org_v6 = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid GeoIP database </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> type:</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;value[<span class="Constant">1</span>], gcf-&gt;org-&gt;databaseType);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L793">&#x200c;</a><span class="linkable">ngx_http_geoip_city</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="http/modules/ngx_http_geoip_module.c:32">ngx_http_geoip_conf_t</a>&nbsp; *gcf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; *value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gcf-&gt;city) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;is duplicate&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gcf-&gt;city = GeoIP_open((<span class="Type">char</span> *) value[<span class="Constant">1</span>].data, GEOIP_MEMORY_CACHE);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gcf-&gt;city == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;GeoIP_open(</span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">) failed&quot;</span>, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cf-&gt;args-&gt;nelts == <span class="Constant">3</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">2</span>].data, <span class="Constant">&quot;utf8&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GeoIP_set_charset(gcf-&gt;city, GEOIP_CHARSET_UTF8);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid parameter </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">2</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (gcf-&gt;city-&gt;databaseType) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> GEOIP_CITY_EDITION_REV0:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> GEOIP_CITY_EDITION_REV1:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_GEOIP_V6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> GEOIP_CITY_EDITION_REV0_V6:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> GEOIP_CITY_EDITION_REV1_V6:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; gcf-&gt;city_v6 = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid GeoIP City database </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> type:</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;value[<span class="Constant">1</span>], gcf-&gt;city-&gt;databaseType);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L850">&#x200c;</a><span class="linkable">ngx_http_geoip_proxy</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="http/modules/ngx_http_geoip_module.c:32">ngx_http_geoip_conf_t</a>&nbsp; *gcf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp;&nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_inet.h.html#L67" title="core/ngx_inet.h:67">ngx_cidr_t</a>&nbsp; cidr, *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L881" title="http/modules/ngx_http_geoip_module.c:881">ngx_http_geoip_cidr_value</a>(cf, &amp;value[<span class="Constant">1</span>], &amp;cidr) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gcf-&gt;proxies == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; gcf-&gt;proxies = <a href="../../core/ngx_array.c.html#L13" title="core/ngx_array.c:13">ngx_array_create</a>(cf-&gt;pool, <span class="Constant">4</span>, <span class="Statement">sizeof</span>(<a href="../../core/ngx_inet.h.html#L67" title="core/ngx_inet.h:67">ngx_cidr_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (gcf-&gt;proxies == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = <a href="../../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(gcf-&gt;proxies);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *c = cidr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L881">&#x200c;</a><span class="linkable">ngx_http_geoip_cidr_value</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *net, <a href="../../core/ngx_inet.h.html#L67" title="core/ngx_inet.h:67">ngx_cidr_t</a> *cidr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(net-&gt;data, <span class="Constant">&quot;255.255.255.255&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cidr-&gt;family = AF_INET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cidr-&gt;u.in.addr = <span class="Constant">0xffffffff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cidr-&gt;u.in.mask = <span class="Constant">0xffffffff</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../../core/ngx_inet.c.html#L365" title="core/ngx_inet.c:365">ngx_ptocidr</a>(net, cidr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>, <span class="Constant">&quot;invalid network </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, net);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;low address bits of %V are meaningless&quot;</span>, net);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L910">&#x200c;</a></span><span class="linkable">ngx_http_geoip_cleanup</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="http/modules/ngx_http_geoip_module.c:32">ngx_http_geoip_conf_t</a>&nbsp; *gcf = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gcf-&gt;country) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; GeoIP_delete(gcf-&gt;country);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gcf-&gt;org) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; GeoIP_delete(gcf-&gt;org);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gcf-&gt;city) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; GeoIP_delete(gcf-&gt;city);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
