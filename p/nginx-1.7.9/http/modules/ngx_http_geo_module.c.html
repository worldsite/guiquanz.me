<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>http/modules/ngx_http_geo_module.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>http/modules/ngx_http_geo_module.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L113">ngx_http_geo_commands</a></li>
<li><a href="#L166">ngx_http_geo_header</a></li>
<li><a href="#L141">ngx_http_geo_module</a></li>
<li><a href="#L126">ngx_http_geo_module_ctx</a></li>
</ul>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L66">ngx_http_geo_conf_ctx_t</a></li>
<li><a href="#L79">ngx_http_geo_ctx_t</a></li>
<li><a href="#L163">ngx_http_geo_header_t</a></li>
<li><a href="#L31">ngx_http_geo_high_ranges_t</a></li>
<li><a href="#L17">ngx_http_geo_range_t</a></li>
<li><a href="#L25">ngx_http_geo_trees_t</a></li>
<li><a href="#L38">ngx_http_geo_variable_value_node_t</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L560">ngx_http_geo</a></li>
<li><a href="#L1263">ngx_http_geo_add_proxy</a></li>
<li><a href="#L757">ngx_http_geo_add_range</a></li>
<li><a href="#L314">ngx_http_geo_addr</a></li>
<li><a href="#L372">ngx_http_geo_block</a></li>
<li><a href="#L1015">ngx_http_geo_cidr</a></li>
<li><a href="#L1112">ngx_http_geo_cidr_add</a></li>
<li><a href="#L1287">ngx_http_geo_cidr_value</a></li>
<li><a href="#L174">ngx_http_geo_cidr_variable</a></li>
<li><a href="#L1619">ngx_http_geo_copy_values</a></li>
<li><a href="#L1541">ngx_http_geo_create_binary_base</a></li>
<li><a href="#L952">ngx_http_geo_delete_range</a></li>
<li><a href="#L1316">ngx_http_geo_include</a></li>
<li><a href="#L1368">ngx_http_geo_include_binary_base</a></li>
<li><a href="#L646">ngx_http_geo_range</a></li>
<li><a href="#L240">ngx_http_geo_range_variable</a></li>
<li><a href="#L335">ngx_http_geo_real_addr</a></li>
<li><a href="#L1210">ngx_http_geo_value</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; u_short&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start;<br/></li>
<li>&nbsp; &nbsp; u_short&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end;<br/></li>
<li><a id="L17">&#x200c;</a>} <span class="linkable">ngx_http_geo_range_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_radix_tree.h.html#L34" title="core/ngx_radix_tree.h:34">ngx_radix_tree_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *tree;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_radix_tree.h.html#L34" title="core/ngx_radix_tree.h:34">ngx_radix_tree_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *tree6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li><a id="L25">&#x200c;</a></span>} <span class="linkable">ngx_http_geo_trees_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; **low;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *default_value;<br/></li>
<li><a id="L31">&#x200c;</a>} <span class="linkable">ngx_http_geo_high_ranges_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L216" title="core/ngx_string.h:216">ngx_str_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; sn;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offset;<br/></li>
<li><a id="L38">&#x200c;</a>} <span class="linkable">ngx_http_geo_variable_value_node_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *net;<br/></li>
<li>&nbsp; &nbsp; <a href="#L31" title="http/modules/ngx_http_geo_module.c:31">ngx_http_geo_high_ranges_t</a>&nbsp; &nbsp; &nbsp;&nbsp; high;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_radix_tree.h.html#L34" title="core/ngx_radix_tree.h:34">ngx_radix_tree_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *tree;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_radix_tree.h.html#L34" title="core/ngx_radix_tree.h:34">ngx_radix_tree_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *tree6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L32" title="core/ngx_rbtree.h:32">ngx_rbtree_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rbtree;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *proxies;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *pool;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *temp_pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; data_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; include_name;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; includes;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; entries;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ranges:<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; outside_entries:<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; allow_binary_include:<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; binary_include:<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; proxy_recursive:<span class="Constant">1</span>;<br/></li>
<li><a id="L66">&#x200c;</a>} <span class="linkable">ngx_http_geo_conf_ctx_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">union</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L25" title="http/modules/ngx_http_geo_module.c:25">ngx_http_geo_trees_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; trees;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L31" title="http/modules/ngx_http_geo_module.c:31">ngx_http_geo_high_ranges_t</a>&nbsp;&nbsp; high;<br/></li>
<li>&nbsp; &nbsp; } u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *proxies;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; proxy_recursive:<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; index;<br/></li>
<li><a id="L79">&#x200c;</a>} <span class="linkable">ngx_http_geo_ctx_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L314" title="http/modules/ngx_http_geo_module.c:314">ngx_http_geo_addr</a>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="#L79" title="http/modules/ngx_http_geo_module.c:79">ngx_http_geo_ctx_t</a> *ctx, <a href="../../core/ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a> *addr);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L335" title="http/modules/ngx_http_geo_module.c:335">ngx_http_geo_real_addr</a>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="#L79" title="http/modules/ngx_http_geo_module.c:79">ngx_http_geo_ctx_t</a> *ctx, <a href="../../core/ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a> *addr);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L372" title="http/modules/ngx_http_geo_module.c:372">ngx_http_geo_block</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L560" title="http/modules/ngx_http_geo_module.c:560">ngx_http_geo</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *dummy, <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L646" title="http/modules/ngx_http_geo_module.c:646">ngx_http_geo_range</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *value);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L757" title="http/modules/ngx_http_geo_module.c:757">ngx_http_geo_add_range</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx, in_addr_t start, in_addr_t end);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> <a href="#L952" title="http/modules/ngx_http_geo_module.c:952">ngx_http_geo_delete_range</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx, in_addr_t start, in_addr_t end);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L1015" title="http/modules/ngx_http_geo_module.c:1015">ngx_http_geo_cidr</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *value);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L1112" title="http/modules/ngx_http_geo_module.c:1112">ngx_http_geo_cidr_add</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_inet.h.html#L67" title="core/ngx_inet.h:67">ngx_cidr_t</a> *cidr, <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *value, <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *net);<br/></li>
<li><span class="Type">static</span> <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *<a href="#L1210" title="http/modules/ngx_http_geo_module.c:1210">ngx_http_geo_value</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx, <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *value);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L1263" title="http/modules/ngx_http_geo_module.c:1263">ngx_http_geo_add_proxy</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx, <a href="../../core/ngx_inet.h.html#L67" title="core/ngx_inet.h:67">ngx_cidr_t</a> *cidr);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1287" title="http/modules/ngx_http_geo_module.c:1287">ngx_http_geo_cidr_value</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *net,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_inet.h.html#L67" title="core/ngx_inet.h:67">ngx_cidr_t</a> *cidr);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L1316" title="http/modules/ngx_http_geo_module.c:1316">ngx_http_geo_include</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1368" title="http/modules/ngx_http_geo_module.c:1368">ngx_http_geo_include_binary_base</a>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx, <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1541" title="http/modules/ngx_http_geo_module.c:1541">ngx_http_geo_create_binary_base</a>(<a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1619" title="http/modules/ngx_http_geo_module.c:1619">ngx_http_geo_copy_values</a>(u_char *base, u_char *p,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L113">&#x200c;</a><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a>&nbsp; <span class="linkable">ngx_http_geo_commands</span>[] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;geo&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L43" title="core/ngx_conf_file.h:43">NGX_CONF_BLOCK</a>|<a href="../../core/ngx_conf_file.h.html#L33" title="core/ngx_conf_file.h:33">NGX_CONF_TAKE12</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L372" title="http/modules/ngx_http_geo_module.c:372">ngx_http_geo_block</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L50" title="http/ngx_http_config.h:50">NGX_HTTP_MAIN_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L87" title="core/ngx_conf_file.h:87">ngx_null_command</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L126">&#x200c;</a><span class="Type">static</span> <a href="../ngx_http_config.h.html#L36" title="http/ngx_http_config.h:36">ngx_http_module_t</a>&nbsp; <span class="linkable">ngx_http_geo_module_ctx</span> = {<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* preconfiguration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* postconfiguration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create <a href="../../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init <a href="../../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create server configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge server configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create location configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* merge location configuration */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L141">&#x200c;</a><a href="../../core/ngx_core.h.html#L12" title="core/ngx_core.h:12">ngx_module_t</a>&nbsp; <span class="linkable">ngx_http_geo_module</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L99" title="core/ngx_conf_file.h:99">NGX_MODULE_V1</a>,<br/></li>
<li>&nbsp; &nbsp; &amp;<a href="#L126" title="http/modules/ngx_http_geo_module.c:126">ngx_http_geo_module_ctx</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* module context */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L113" title="http/modules/ngx_http_geo_module.c:113">ngx_http_geo_commands</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module directives */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../ngx_http_config.h.html#L39" title="http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module type */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init master */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init module */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit master */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L100" title="core/ngx_conf_file.h:100">NGX_MODULE_V1_PADDING</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; GEORNG[<span class="Constant">6</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; version;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; ptr_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; endianness;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; crc32;<br/></li>
<li><a id="L163">&#x200c;</a>} <span class="linkable">ngx_http_geo_header_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L166">&#x200c;</a><span class="Type">static</span> <a href="#L163" title="http/modules/ngx_http_geo_module.c:163">ngx_http_geo_header_t</a>&nbsp; <span class="linkable">ngx_http_geo_header</span> = {<br/></li>
<li>&nbsp; &nbsp; { <span class="Constant">'<a href="../../core/ngx_md5.c.html#L127" title="core/ngx_md5.c:127">G</a>'</span>, <span class="Constant">'E'</span>, <span class="Constant">'O'</span>, <span class="Constant">'R'</span>, <span class="Constant">'N'</span>, <span class="Constant">'<a href="../../core/ngx_md5.c.html#L127" title="core/ngx_md5.c:127">G</a>'</span> }, <span class="Constant">0</span>, <span class="Statement">sizeof</span>(<span class="Type">void</span> *), <span class="Constant">0x12345678</span>, <span class="Constant">0<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* geo range is AF_INET only */<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L174">&#x200c;</a><span class="linkable">ngx_http_geo_cidr_variable</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L79" title="http/modules/ngx_http_geo_module.c:79">ngx_http_geo_ctx_t</a> *ctx = (<a href="#L79" title="http/modules/ngx_http_geo_module.c:79">ngx_http_geo_ctx_t</a> *) data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; in_addr_t&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; inaddr;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *sin;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>&nbsp; *vv;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> in6_addr&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *inaddr6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L314" title="http/modules/ngx_http_geo_module.c:314">ngx_http_geo_addr</a>(r, ctx, &amp;addr) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; vv = (<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_radix_tree.c.html#L237" title="core/ngx_radix_tree.c:237">ngx_radix32tree_find</a>(ctx-&gt;u.trees.tree, <a href="../../core/ngx_config.h.html#L115" title="core/ngx_config.h:115">INADDR_NONE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (addr.sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inaddr6 = &amp;((<span class="Type">struct</span> sockaddr_in6 *) addr.sockaddr)-&gt;sin6_addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = inaddr6-&gt;s6_addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (IN6_IS_ADDR_V4MAPPED(inaddr6)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr = p[<span class="Constant">12</span>] &lt;&lt; <span class="Constant">24</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr += p[<span class="Constant">13</span>] &lt;&lt; <span class="Constant">16</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr += p[<span class="Constant">14</span>] &lt;&lt; <span class="Constant">8</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr += p[<span class="Constant">15</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vv = (<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_radix_tree.c.html#L237" title="core/ngx_radix_tree.c:237">ngx_radix32tree_find</a>(ctx-&gt;u.trees.tree, inaddr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vv = (<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_radix_tree.c.html#L425" title="core/ngx_radix_tree.c:425">ngx_radix128tree_find</a>(ctx-&gt;u.trees.tree6, p);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; sin = (<span class="Type">struct</span> sockaddr_in *) addr.sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inaddr = ntohl(sin-&gt;sin_addr.s_addr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; vv = (<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_radix_tree.c.html#L237" title="core/ngx_radix_tree.c:237">ngx_radix32tree_find</a>(ctx-&gt;u.trees.tree, inaddr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; *v = *vv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http geo: %v&quot;</span>, v);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L240">&#x200c;</a><span class="linkable">ngx_http_geo_range_variable</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *v,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uintptr_t</span> data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L79" title="http/modules/ngx_http_geo_module.c:79">ngx_http_geo_ctx_t</a> *ctx = (<a href="#L79" title="http/modules/ngx_http_geo_module.c:79">ngx_http_geo_ctx_t</a> *) data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; in_addr_t&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; addr;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp; &nbsp; *sin;<br/></li>
<li>&nbsp; &nbsp; <a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a>&nbsp; *range;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> in6_addr&nbsp; &nbsp; &nbsp;&nbsp; *inaddr6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; *v = *ctx-&gt;u.high.default_value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L314" title="http/modules/ngx_http_geo_module.c:314">ngx_http_geo_addr</a>(r, ctx, &amp;addr) == <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (addr.sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr6 = &amp;((<span class="Type">struct</span> sockaddr_in6 *) addr.sockaddr)-&gt;sin6_addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (IN6_IS_ADDR_V4MAPPED(inaddr6)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = inaddr6-&gt;s6_addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr = p[<span class="Constant">12</span>] &lt;&lt; <span class="Constant">24</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr += p[<span class="Constant">13</span>] &lt;&lt; <span class="Constant">16</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr += p[<span class="Constant">14</span>] &lt;&lt; <span class="Constant">8</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr += p[<span class="Constant">15</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr = <a href="../../core/ngx_config.h.html#L115" title="core/ngx_config.h:115">INADDR_NONE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin = (<span class="Type">struct</span> sockaddr_in *) addr.sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inaddr = ntohl(sin-&gt;sin_addr.s_addr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inaddr = <a href="../../core/ngx_config.h.html#L115" title="core/ngx_config.h:115">INADDR_NONE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;u.high.low) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; range = ctx-&gt;u.high.low[inaddr &gt;&gt; <span class="Constant">16</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (range) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = inaddr &amp; <span class="Constant">0xffff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt;= (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range-&gt;start<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; n &lt;= (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range-&gt;end)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *v = *range-&gt;value;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> ((++range)-&gt;value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http geo: %v&quot;</span>, v);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L314">&#x200c;</a><span class="linkable">ngx_http_geo_addr</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="#L79" title="http/modules/ngx_http_geo_module.c:79">ngx_http_geo_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a> *addr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; *xfwd;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L335" title="http/modules/ngx_http_geo_module.c:335">ngx_http_geo_real_addr</a>(r, ctx, addr) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; xfwd = &amp;r-&gt;headers_in.x_forwarded_for;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (xfwd-&gt;nelts &gt; <span class="Constant">0</span> &amp;&amp; ctx-&gt;proxies != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../ngx_http_core_module.c.html#L2813" title="http/ngx_http_core_module.c:2813">ngx_http_get_forwarded_addr</a>(r, addr, xfwd, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ctx-&gt;proxies, ctx-&gt;proxy_recursive);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L335">&#x200c;</a><span class="linkable">ngx_http_geo_real_addr</span>(<a href="../ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="#L79" title="http/modules/ngx_http_geo_module.c:79">ngx_http_geo_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a> *addr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>&nbsp; *v;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;index == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http geo started: %V&quot;</span>, &amp;r-&gt;connection-&gt;addr_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr-&gt;sockaddr = r-&gt;connection-&gt;sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr-&gt;socklen = r-&gt;connection-&gt;socklen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* addr-&gt;name = r-&gt;connection-&gt;addr_text; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; v = <a href="../ngx_http_variables.c.html#L527" title="http/ngx_http_variables.c:527">ngx_http_get_flushed_variable</a>(r, ctx-&gt;index);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (v == <span class="Constant">NULL</span> || v-&gt;not_found) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http geo not found&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http geo started: %v&quot;</span>, v);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_inet.c.html#L465" title="core/ngx_inet.c:465">ngx_parse_addr</a>(r-&gt;pool, addr, v-&gt;data, v-&gt;len) == <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L372">&#x200c;</a><span class="linkable">ngx_http_geo_block</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *rv;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *value, name;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; save;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *pool;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *a;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L21" title="http/ngx_http_variables.h:21">ngx_http_variable_t</a>&nbsp; &nbsp; &nbsp; *var;<br/></li>
<li>&nbsp; &nbsp; <a href="#L79" title="http/modules/ngx_http_geo_module.c:79">ngx_http_geo_ctx_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *geo;<br/></li>
<li>&nbsp; &nbsp; <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a>&nbsp;&nbsp; ctx;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">struct</span> in6_addr&nbsp; &nbsp; zero;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; geo = <a href="../../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L79" title="http/modules/ngx_http_geo_module.c:79">ngx_http_geo_ctx_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (geo == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name = value[<span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name.data[<span class="Constant">0</span>] != <span class="Constant">'$'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid variable name </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name.len--;<br/></li>
<li>&nbsp; &nbsp; name.data++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cf-&gt;args-&gt;nelts == <span class="Constant">3</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; geo-&gt;index = <a href="../ngx_http_variables.c.html#L430" title="http/ngx_http_variables.c:430">ngx_http_get_variable_index</a>(cf, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (geo-&gt;index == <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name = value[<span class="Constant">2</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (name.data[<span class="Constant">0</span>] != <span class="Constant">'$'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid variable name </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name.len--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name.data++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; geo-&gt;index = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; var = <a href="../ngx_http_variables.c.html#L359" title="http/ngx_http_variables.c:359">ngx_http_add_variable</a>(cf, &amp;name, <a href="../ngx_http_variables.h.html#L29" title="http/ngx_http_variables.h:29">NGX_HTTP_VAR_CHANGEABLE</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (var == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pool = <a href="../../core/ngx_palloc.c.html#L17" title="core/ngx_palloc.c:17">ngx_create_pool</a>(<a href="../../core/ngx_palloc.h.html#L22" title="core/ngx_palloc.h:22">NGX_DEFAULT_POOL_SIZE</a>, cf-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pool == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;ctx, <span class="Statement">sizeof</span>(<a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx.temp_pool = <a href="../../core/ngx_palloc.c.html#L17" title="core/ngx_palloc.c:17">ngx_create_pool</a>(<a href="../../core/ngx_palloc.h.html#L22" title="core/ngx_palloc.h:22">NGX_DEFAULT_POOL_SIZE</a>, cf-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx.temp_pool == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L44" title="core/ngx_rbtree.h:44">ngx_rbtree_init</a>(&amp;ctx.rbtree, &amp;ctx.sentinel, <a href="../../core/ngx_string.c.html#L1829" title="core/ngx_string.c:1829">ngx_str_rbtree_insert_value</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx.pool = cf-&gt;pool;<br/></li>
<li>&nbsp; &nbsp; ctx.data_size = <span class="Statement">sizeof</span>(<a href="#L163" title="http/modules/ngx_http_geo_module.c:163">ngx_http_geo_header_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <span class="Statement">sizeof</span>(<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <span class="Constant">0x10000</span> * <span class="Statement">sizeof</span>(<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a> *);<br/></li>
<li>&nbsp; &nbsp; ctx.allow_binary_include = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; save = *cf;<br/></li>
<li>&nbsp; &nbsp; cf-&gt;pool = pool;<br/></li>
<li>&nbsp; &nbsp; cf-&gt;ctx = &amp;ctx;<br/></li>
<li>&nbsp; &nbsp; cf-&gt;handler = <a href="#L560" title="http/modules/ngx_http_geo_module.c:560">ngx_http_geo</a>;<br/></li>
<li>&nbsp; &nbsp; cf-&gt;handler_conf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rv = <a href="../../core/ngx_conf_file.c.html#L101" title="core/ngx_conf_file.c:101">ngx_conf_parse</a>(cf, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *cf = save;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; geo-&gt;proxies = ctx.proxies;<br/></li>
<li>&nbsp; &nbsp; geo-&gt;proxy_recursive = ctx.proxy_recursive;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx.ranges) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx.high.low &amp;&amp; !ctx.binary_include) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <span class="Constant">0x10000</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; a = (<a href="../../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> *) ctx.high.low[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (a == <span class="Constant">NULL</span> || a-&gt;nelts == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = a-&gt;nelts * <span class="Statement">sizeof</span>(<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx.high.low[i] = <a href="../../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(cf-&gt;pool, len + <span class="Statement">sizeof</span>(<span class="Type">void</span> *));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx.high.low[i] == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(ctx.high.low[i], a-&gt;elts, len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx.high.low[i][a-&gt;nelts].value = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx.data_size += len + <span class="Statement">sizeof</span>(<span class="Type">void</span> *);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx.allow_binary_include<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; !ctx.outside_entries<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; ctx.entries &gt; <span class="Constant">100000<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; ctx.includes == <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1541" title="http/modules/ngx_http_geo_module.c:1541">ngx_http_geo_create_binary_base</a>(&amp;ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx.high.default_value == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx.high.default_value = &amp;<a href="../ngx_http_variables.c.html#L352" title="http/ngx_http_variables.c:352">ngx_http_variable_null_value</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; geo-&gt;u.high = ctx.high;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; var-&gt;get_handler = <a href="#L240" title="http/modules/ngx_http_geo_module.c:240">ngx_http_geo_range_variable</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; var-&gt;data = (<span class="Type">uintptr_t</span>) geo;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L45" title="core/ngx_palloc.c:45">ngx_destroy_pool</a>(ctx.temp_pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L45" title="core/ngx_palloc.c:45">ngx_destroy_pool</a>(pool);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx.tree == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx.tree = <a href="../../core/ngx_radix_tree.c.html#L16" title="core/ngx_radix_tree.c:16">ngx_radix_tree_create</a>(cf-&gt;pool, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx.tree == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; geo-&gt;u.trees.tree = ctx.tree;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx.tree6 == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx.tree6 = <a href="../../core/ngx_radix_tree.c.html#L16" title="core/ngx_radix_tree.c:16">ngx_radix_tree_create</a>(cf-&gt;pool, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx.tree6 == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; geo-&gt;u.trees.tree6 = ctx.tree6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; var-&gt;get_handler = <a href="#L174" title="http/modules/ngx_http_geo_module.c:174">ngx_http_geo_cidr_variable</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; var-&gt;data = (<span class="Type">uintptr_t</span>) geo;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L45" title="core/ngx_palloc.c:45">ngx_destroy_pool</a>(ctx.temp_pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L45" title="core/ngx_palloc.c:45">ngx_destroy_pool</a>(pool);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_radix_tree.c.html#L109" title="core/ngx_radix_tree.c:109">ngx_radix32tree_insert</a>(ctx.tree, <span class="Constant">0</span>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<span class="Type">uintptr_t</span>) &amp;<a href="../ngx_http_variables.c.html#L352" title="http/ngx_http_variables.c:352">ngx_http_variable_null_value</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../../core/ngx_core.h.html#L32" title="core/ngx_core.h:32">NGX_BUSY</a> is okay (default was <a href="../../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> explicitly) */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_radix_tree.c.html#L269" title="core/ngx_radix_tree.c:269">ngx_radix128tree_insert</a>(ctx.tree6, zero.s6_addr, zero.s6_addr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">uintptr_t</span>) &amp;<a href="../ngx_http_variables.c.html#L352" title="http/ngx_http_variables.c:352">ngx_http_variable_null_value</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rv;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L560">&#x200c;</a><span class="linkable">ngx_http_geo</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *dummy, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *rv;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_inet.h.html#L67" title="core/ngx_inet.h:67">ngx_cidr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cidr;<br/></li>
<li>&nbsp; &nbsp; <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = cf-&gt;ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cf-&gt;args-&gt;nelts == <span class="Constant">1</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">0</span>].data, <span class="Constant">&quot;ranges&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;tree<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || ctx-&gt;tree6<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; )<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;the </span><span class="Special">\&quot;</span><span class="Constant">ranges</span><span class="Special">\&quot;</span><span class="Constant"> directive must be &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;the first directive inside </span><span class="Special">\&quot;</span><span class="Constant">geo</span><span class="Special">\&quot;</span><span class="Constant"> block&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;ranges = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">0</span>].data, <span class="Constant">&quot;proxy_recursive&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;proxy_recursive = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cf-&gt;args-&gt;nelts != <span class="Constant">2</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid number of the geo parameters&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">0</span>].data, <span class="Constant">&quot;include&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="#L1316" title="http/modules/ngx_http_geo_module.c:1316">ngx_http_geo_include</a>(cf, ctx, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">0</span>].data, <span class="Constant">&quot;proxy&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1287" title="http/modules/ngx_http_geo_module.c:1287">ngx_http_geo_cidr_value</a>(cf, &amp;value[<span class="Constant">1</span>], &amp;cidr) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="#L1263" title="http/modules/ngx_http_geo_module.c:1263">ngx_http_geo_add_proxy</a>(cf, ctx, &amp;cidr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;ranges) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="#L646" title="http/modules/ngx_http_geo_module.c:646">ngx_http_geo_range</a>(cf, ctx, value);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="#L1015" title="http/modules/ngx_http_geo_module.c:1015">ngx_http_geo_cidr</a>(cf, ctx, value);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L97" title="core/ngx_palloc.c:97">ngx_reset_pool</a>(cf-&gt;pool);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rv;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L97" title="core/ngx_palloc.c:97">ngx_reset_pool</a>(cf-&gt;pool);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L646">&#x200c;</a><span class="linkable">ngx_http_geo_range</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *value)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; *p, *last;<br/></li>
<li>&nbsp; &nbsp; in_addr_t&nbsp; &nbsp; start, end;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp;&nbsp; *net;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp;&nbsp; del;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">0</span>].data, <span class="Constant">&quot;default&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;high.default_value) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;duplicate default geo range value: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">, old value: </span><span class="Special">\&quot;</span><span class="Constant">%v</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;value[<span class="Constant">1</span>], ctx-&gt;high.default_value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;high.default_value = <a href="#L1210" title="http/modules/ngx_http_geo_module.c:1210">ngx_http_geo_value</a>(cf, ctx, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;high.default_value == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;binary_include) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;binary geo range base </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> cannot be mixed with <a href="../ngx_http_parse.c.html#L13" title="http/ngx_http_parse.c:13">usual</a> entries&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;include_name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;high.low == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;high.low = <a href="../../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(ctx-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x10000</span> * <span class="Statement">sizeof</span>(<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a> *));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;high.low == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;entries++;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;outside_entries = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">0</span>].data, <span class="Constant">&quot;delete&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; net = &amp;value[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; del = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; net = &amp;value[<span class="Constant">0</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; del = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; last = net-&gt;data + net-&gt;len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../../core/ngx_string.h.html#L66" title="core/ngx_string.h:66">ngx_strlchr</a>(net-&gt;data, last, <span class="Constant">'-'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; start = <a href="../../core/ngx_inet.c.html#L18" title="core/ngx_inet.c:18">ngx_inet_addr</a>(net-&gt;data, p - net-&gt;data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (start == <a href="../../core/ngx_config.h.html#L115" title="core/ngx_config.h:115">INADDR_NONE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; start = ntohl(start);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; end = <a href="../../core/ngx_inet.c.html#L18" title="core/ngx_inet.c:18">ngx_inet_addr</a>(p, last - p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (end == <a href="../../core/ngx_config.h.html#L115" title="core/ngx_config.h:115">INADDR_NONE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; end = ntohl(end);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (start &gt; end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (del) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L952" title="http/modules/ngx_http_geo_module.c:952">ngx_http_geo_delete_range</a>(cf, ctx, start, end)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;no address range </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> to delete&quot;</span>, net);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;value = <a href="#L1210" title="http/modules/ngx_http_geo_module.c:1210">ngx_http_geo_value</a>(cf, ctx, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;value == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;net = net;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L757" title="http/modules/ngx_http_geo_module.c:757">ngx_http_geo_add_range</a>(cf, ctx, start, end);<br/></li>
<li><br/></li>
<li><span class="Statement">invalid</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>, <span class="Constant">&quot;invalid range </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, net);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* the add procedure is optimized to add a growing up sequence */<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L757">&#x200c;</a><span class="linkable">ngx_http_geo_add_range</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; in_addr_t start, in_addr_t end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; in_addr_t&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h, i, s, e;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *a;<br/></li>
<li>&nbsp; &nbsp; <a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a>&nbsp; *range;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (n = start; n &lt;= end; n = (n + <span class="Constant">0x10000</span>) &amp; <span class="Constant">0xffff0000</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h = n &gt;&gt; <span class="Constant">16</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = n &amp; <span class="Constant">0xffff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((n | <span class="Constant">0xffff</span>) &gt; end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e = end &amp; <span class="Constant">0xffff</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e = <span class="Constant">0xffff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; a = (<a href="../../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> *) ctx-&gt;high.low[h];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (a == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; a = <a href="../../core/ngx_array.c.html#L13" title="core/ngx_array.c:13">ngx_array_create</a>(ctx-&gt;temp_pool, <span class="Constant">64</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (a == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;high.low[h] = (<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a> *) a;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i = a-&gt;nelts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; range = a-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (i) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (e &lt; (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s &gt; (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].end) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* add after the range */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range = <a href="../../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(a);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (range == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range = a-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L139" title="core/ngx_string.h:139">ngx_memmove</a>(&amp;range[i + <span class="Constant">2</span>], &amp;range[i + <span class="Constant">1</span>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (a-&gt;nelts - <span class="Constant">2</span> - i) * <span class="Statement">sizeof</span>(<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i + <span class="Constant">1</span>].start = (u_short) s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i + <span class="Constant">1</span>].end = (u_short) e;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i + <span class="Constant">1</span>].value = ctx-&gt;value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s == (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].start<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; e == (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].end)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;duplicate range </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">, value: </span><span class="Special">\&quot;</span><span class="Constant">%v</span><span class="Special">\&quot;</span><span class="Constant">, old value: </span><span class="Special">\&quot;</span><span class="Constant">%v</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;net, ctx-&gt;value, range[i].value);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i].value = ctx-&gt;value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s &gt; (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].start<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; e &lt; (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].end)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* split the range and insert the new one */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range = <a href="../../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(a);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (range == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range = <a href="../../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(a);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (range == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range = a-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L139" title="core/ngx_string.h:139">ngx_memmove</a>(&amp;range[i + <span class="Constant">3</span>], &amp;range[i + <span class="Constant">1</span>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (a-&gt;nelts - <span class="Constant">3</span> - i) * <span class="Statement">sizeof</span>(<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i + <span class="Constant">2</span>].start = (u_short) (e + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i + <span class="Constant">2</span>].end = range[i].end;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i + <span class="Constant">2</span>].value = range[i].value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i + <span class="Constant">1</span>].start = (u_short) s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i + <span class="Constant">1</span>].end = (u_short) e;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i + <span class="Constant">1</span>].value = ctx-&gt;value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i].end = (u_short) (s - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s == (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].start<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; e &lt; (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].end)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* shift the range start and insert the new range */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range = <a href="../../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(a);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (range == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range = a-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L139" title="core/ngx_string.h:139">ngx_memmove</a>(&amp;range[i + <span class="Constant">1</span>], &amp;range[i],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (a-&gt;nelts - <span class="Constant">1</span> - i) * <span class="Statement">sizeof</span>(<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i + <span class="Constant">1</span>].start = (u_short) (e + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i].start = (u_short) s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i].end = (u_short) e;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i].value = ctx-&gt;value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s &gt; (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].start<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; e == (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].end)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* shift the range end and insert the new range */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range = <a href="../../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(a);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (range == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range = a-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L139" title="core/ngx_string.h:139">ngx_memmove</a>(&amp;range[i + <span class="Constant">2</span>], &amp;range[i + <span class="Constant">1</span>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (a-&gt;nelts - <span class="Constant">2</span> - i) * <span class="Statement">sizeof</span>(<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i + <span class="Constant">1</span>].start = (u_short) s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i + <span class="Constant">1</span>].end = (u_short) e;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i + <span class="Constant">1</span>].value = ctx-&gt;value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range[i].end = (u_short) (s - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e = (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;range </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> overlaps </span><span class="Special">\&quot;%d</span><span class="Constant">.</span><span class="Special">%d</span><span class="Constant">.</span><span class="Special">%d</span><span class="Constant">.</span><span class="Special">%d</span><span class="Constant">-</span><span class="Special">%d</span><span class="Constant">.</span><span class="Special">%d</span><span class="Constant">.</span><span class="Special">%d</span><span class="Constant">.</span><span class="Special">%d\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ctx-&gt;net,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h &gt;&gt; <span class="Constant">8</span>, h &amp; <span class="Constant">0xff</span>, s &gt;&gt; <span class="Constant">8</span>, s &amp; <span class="Constant">0xff</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h &gt;&gt; <span class="Constant">8</span>, h &amp; <span class="Constant">0xff</span>, e &gt;&gt; <span class="Constant">8</span>, e &amp; <span class="Constant">0xff</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* add the first range */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; range = <a href="../../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(a);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (range == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; range-&gt;start = (u_short) s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; range-&gt;end = (u_short) e;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; range-&gt;value = ctx-&gt;value;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">next</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a><br/></li>
<li><a id="L952">&#x200c;</a><span class="linkable">ngx_http_geo_delete_range</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; in_addr_t start, in_addr_t end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; in_addr_t&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h, i, s, e, warn;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *a;<br/></li>
<li>&nbsp; &nbsp; <a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a>&nbsp; *range;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; warn = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (n = start; n &lt;= end; n += <span class="Constant">0x10000</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h = n &gt;&gt; <span class="Constant">16</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = n &amp; <span class="Constant">0xffff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((n | <span class="Constant">0xffff</span>) &gt; end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e = end &amp; <span class="Constant">0xffff</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e = <span class="Constant">0xffff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; a = (<a href="../../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> *) ctx-&gt;high.low[h];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (a == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; warn = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; range = a-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; a-&gt;nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s == (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].start<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; e == (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].end)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L139" title="core/ngx_string.h:139">ngx_memmove</a>(&amp;range[i], &amp;range[i + <span class="Constant">1</span>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (a-&gt;nelts - <span class="Constant">1</span> - i) * <span class="Statement">sizeof</span>(<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; a-&gt;nelts--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s != (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].start<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; e != (<a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) range[i].end)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; warn = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> warn;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1015">&#x200c;</a><span class="linkable">ngx_http_geo_cidr</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *value)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; *rv;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; rc, del;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp;&nbsp; *net;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_inet.h.html#L67" title="core/ngx_inet.h:67">ngx_cidr_t</a>&nbsp;&nbsp; cidr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;tree == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;tree = <a href="../../core/ngx_radix_tree.c.html#L16" title="core/ngx_radix_tree.c:16">ngx_radix_tree_create</a>(ctx-&gt;pool, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;tree == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;tree6 == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;tree6 = <a href="../../core/ngx_radix_tree.c.html#L16" title="core/ngx_radix_tree.c:16">ngx_radix_tree_create</a>(ctx-&gt;pool, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;tree6 == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">0</span>].data, <span class="Constant">&quot;default&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cidr.family = AF_INET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cidr.u.in.addr = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cidr.u.in.mask = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="#L1112" title="http/modules/ngx_http_geo_module.c:1112">ngx_http_geo_cidr_add</a>(cf, ctx, &amp;cidr, &amp;value[<span class="Constant">1</span>], &amp;value[<span class="Constant">0</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rv != <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rv;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; cidr.family = AF_INET6;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;cidr.u.in6, <span class="Statement">sizeof</span>(<a href="../../core/ngx_inet.h.html#L54" title="core/ngx_inet.h:54">ngx_in6_cidr_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="#L1112" title="http/modules/ngx_http_geo_module.c:1112">ngx_http_geo_cidr_add</a>(cf, ctx, &amp;cidr, &amp;value[<span class="Constant">1</span>], &amp;value[<span class="Constant">0</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rv != <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rv;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">0</span>].data, <span class="Constant">&quot;delete&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; net = &amp;value[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; del = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; net = &amp;value[<span class="Constant">0</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; del = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1287" title="http/modules/ngx_http_geo_module.c:1287">ngx_http_geo_cidr_value</a>(cf, net, &amp;cidr) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cidr.family == AF_INET) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cidr.u.in.addr = ntohl(cidr.u.in.addr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cidr.u.in.mask = ntohl(cidr.u.in.mask);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (del) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (cidr.family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../../core/ngx_radix_tree.c.html#L352" title="core/ngx_radix_tree.c:352">ngx_radix128tree_delete</a>(ctx-&gt;tree6,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cidr.u.in6.addr.s6_addr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cidr.u.in6.mask.s6_addr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../../core/ngx_radix_tree.c.html#L174" title="core/ngx_radix_tree.c:174">ngx_radix32tree_delete</a>(ctx-&gt;tree, cidr.u.in.addr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cidr.u.in.mask);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;no network </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> to delete&quot;</span>, net);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1112" title="http/modules/ngx_http_geo_module.c:1112">ngx_http_geo_cidr_add</a>(cf, ctx, &amp;cidr, &amp;value[<span class="Constant">1</span>], net);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1112">&#x200c;</a><span class="linkable">ngx_http_geo_cidr_add</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_inet.h.html#L67" title="core/ngx_inet.h:67">ngx_cidr_t</a> *cidr, <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *value, <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *net)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>&nbsp; *val, *old;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; val = <a href="#L1210" title="http/modules/ngx_http_geo_module.c:1210">ngx_http_geo_value</a>(cf, ctx, value);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (val == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (cidr-&gt;family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../../core/ngx_radix_tree.c.html#L269" title="core/ngx_radix_tree.c:269">ngx_radix128tree_insert</a>(ctx-&gt;tree6, cidr-&gt;u.in6.addr.s6_addr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cidr-&gt;u.in6.mask.s6_addr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<span class="Type">uintptr_t</span>) val);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* rc == <a href="../../core/ngx_core.h.html#L32" title="core/ngx_core.h:32">NGX_BUSY</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; old = (<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../core/ngx_radix_tree.c.html#L425" title="core/ngx_radix_tree.c:425">ngx_radix128tree_find</a>(ctx-&gt;tree6,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cidr-&gt;u.in6.addr.s6_addr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;duplicate network </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">, value: </span><span class="Special">\&quot;</span><span class="Constant">%v</span><span class="Special">\&quot;</span><span class="Constant">, old value: </span><span class="Special">\&quot;</span><span class="Constant">%v</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; net, val, old);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../../core/ngx_radix_tree.c.html#L352" title="core/ngx_radix_tree.c:352">ngx_radix128tree_delete</a>(ctx-&gt;tree6,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cidr-&gt;u.in6.addr.s6_addr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cidr-&gt;u.in6.mask.s6_addr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>, <span class="Constant">&quot;invalid radix tree&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../../core/ngx_radix_tree.c.html#L269" title="core/ngx_radix_tree.c:269">ngx_radix128tree_insert</a>(ctx-&gt;tree6, cidr-&gt;u.in6.addr.s6_addr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cidr-&gt;u.in6.mask.s6_addr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<span class="Type">uintptr_t</span>) val);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../../core/ngx_radix_tree.c.html#L109" title="core/ngx_radix_tree.c:109">ngx_radix32tree_insert</a>(ctx-&gt;tree, cidr-&gt;u.in.addr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cidr-&gt;u.in.mask, (<span class="Type">uintptr_t</span>) val);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* rc == <a href="../../core/ngx_core.h.html#L32" title="core/ngx_core.h:32">NGX_BUSY</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; old = (<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../core/ngx_radix_tree.c.html#L237" title="core/ngx_radix_tree.c:237">ngx_radix32tree_find</a>(ctx-&gt;tree, cidr-&gt;u.in.addr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;duplicate network </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">, value: </span><span class="Special">\&quot;</span><span class="Constant">%v</span><span class="Special">\&quot;</span><span class="Constant">, old value: </span><span class="Special">\&quot;</span><span class="Constant">%v</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; net, val, old);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../../core/ngx_radix_tree.c.html#L174" title="core/ngx_radix_tree.c:174">ngx_radix32tree_delete</a>(ctx-&gt;tree,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cidr-&gt;u.in.addr, cidr-&gt;u.in.mask);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>, <span class="Constant">&quot;invalid radix tree&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../../core/ngx_radix_tree.c.html#L109" title="core/ngx_radix_tree.c:109">ngx_radix32tree_insert</a>(ctx-&gt;tree, cidr-&gt;u.in.addr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cidr-&gt;u.in.mask, (<span class="Type">uintptr_t</span>) val);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *<br/></li>
<li><a id="L1210">&#x200c;</a><span class="linkable">ngx_http_geo_value</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *value)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *val;<br/></li>
<li>&nbsp; &nbsp; <a href="#L38" title="http/modules/ngx_http_geo_module.c:38">ngx_http_geo_variable_value_node_t</a>&nbsp; *gvvn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hash = <a href="../../core/ngx_crc32.h.html#L39" title="core/ngx_crc32.h:39">ngx_crc32_long</a>(value-&gt;data, value-&gt;len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gvvn = (<a href="#L38" title="http/modules/ngx_http_geo_module.c:38">ngx_http_geo_variable_value_node_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../core/ngx_string.c.html#L1869" title="core/ngx_string.c:1869">ngx_str_rbtree_lookup</a>(&amp;ctx-&gt;rbtree, value, hash);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gvvn) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> gvvn-&gt;value;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; val = <a href="../../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(ctx-&gt;pool, <span class="Statement">sizeof</span>(<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (val == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; val-&gt;len = value-&gt;len;<br/></li>
<li>&nbsp; &nbsp; val-&gt;data = <a href="../../core/ngx_string.c.html#L57" title="core/ngx_string.c:57">ngx_pstrdup</a>(ctx-&gt;pool, value);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (val-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; val-&gt;valid = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; val-&gt;no_cacheable = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; val-&gt;not_found = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gvvn = <a href="../../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(ctx-&gt;temp_pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="#L38" title="http/modules/ngx_http_geo_module.c:38">ngx_http_geo_variable_value_node_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gvvn == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gvvn-&gt;sn.node.key = hash;<br/></li>
<li>&nbsp; &nbsp; gvvn-&gt;sn.str.len = val-&gt;len;<br/></li>
<li>&nbsp; &nbsp; gvvn-&gt;sn.str.data = val-&gt;data;<br/></li>
<li>&nbsp; &nbsp; gvvn-&gt;value = val;<br/></li>
<li>&nbsp; &nbsp; gvvn-&gt;offset = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.c.html#L25" title="core/ngx_rbtree.c:25">ngx_rbtree_insert</a>(&amp;ctx-&gt;rbtree, &amp;gvvn-&gt;sn.node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;data_size += <a href="../../core/ngx_config.h.html#L97" title="core/ngx_config.h:97">ngx_align</a>(<span class="Statement">sizeof</span>(<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>) + value-&gt;len,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<span class="Type">void</span> *));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> val;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1263">&#x200c;</a><span class="linkable">ngx_http_geo_add_proxy</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_inet.h.html#L67" title="core/ngx_inet.h:67">ngx_cidr_t</a> *cidr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_inet.h.html#L67" title="core/ngx_inet.h:67">ngx_cidr_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;proxies == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;proxies = <a href="../../core/ngx_array.c.html#L13" title="core/ngx_array.c:13">ngx_array_create</a>(ctx-&gt;pool, <span class="Constant">4</span>, <span class="Statement">sizeof</span>(<a href="../../core/ngx_inet.h.html#L67" title="core/ngx_inet.h:67">ngx_cidr_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;proxies == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = <a href="../../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(ctx-&gt;proxies);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *c = *cidr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1287">&#x200c;</a><span class="linkable">ngx_http_geo_cidr_value</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *net, <a href="../../core/ngx_inet.h.html#L67" title="core/ngx_inet.h:67">ngx_cidr_t</a> *cidr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(net-&gt;data, <span class="Constant">&quot;255.255.255.255&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cidr-&gt;family = AF_INET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cidr-&gt;u.in.addr = <span class="Constant">0xffffffff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cidr-&gt;u.in.mask = <span class="Constant">0xffffffff</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../../core/ngx_inet.c.html#L365" title="core/ngx_inet.c:365">ngx_ptocidr</a>(net, cidr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>, <span class="Constant">&quot;invalid network </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, net);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;low address bits of %V are meaningless&quot;</span>, net);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1316">&#x200c;</a><span class="linkable">ngx_http_geo_include</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *rv;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp;&nbsp; file;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file.len = name-&gt;len + <span class="Constant">4</span>;<br/></li>
<li>&nbsp; &nbsp; file.data = <a href="../../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(ctx-&gt;temp_pool, name-&gt;len + <span class="Constant">5</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (file.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(file.data, <span class="Constant">&quot;%V.bin%Z&quot;</span>, name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_conf_file.c.html#L804" title="core/ngx_conf_file.c:804">ngx_conf_full_name</a>(cf-&gt;cycle, &amp;file, <span class="Constant">1</span>) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;ranges) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, cf-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;include </span><span class="Special">%s</span><span class="Constant">&quot;</span>, file.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (<a href="#L1368" title="http/modules/ngx_http_geo_module.c:1368">ngx_http_geo_include_binary_base</a>(cf, ctx, &amp;file)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file.len -= <span class="Constant">4</span>;<br/></li>
<li>&nbsp; &nbsp; file.data[file.len] = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;include_name = file;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;outside_entries) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;allow_binary_include = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, cf-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;include </span><span class="Special">%s</span><span class="Constant">&quot;</span>, file.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rv = <a href="../../core/ngx_conf_file.c.html#L101" title="core/ngx_conf_file.c:101">ngx_conf_parse</a>(cf, &amp;file);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;includes++;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;outside_entries = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rv;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1368">&#x200c;</a><span class="linkable">ngx_http_geo_include_binary_base</span>(<a href="../../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *base, ch;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mtime;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size, len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; crc32;<br/></li>
<li>&nbsp; &nbsp; <a href="../../os/unix/ngx_errno.h.html#L16" title="os/unix/ngx_errno.h:16">ngx_err_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; err;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L20" title="core/ngx_core.h:20">ngx_file_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file;<br/></li>
<li>&nbsp; &nbsp; <a href="../../os/unix/ngx_files.h.html#L17" title="os/unix/ngx_files.h:17">ngx_file_info_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; fi;<br/></li>
<li>&nbsp; &nbsp; <a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *range, **ranges;<br/></li>
<li>&nbsp; &nbsp; <a href="#L163" title="http/modules/ngx_http_geo_module.c:163">ngx_http_geo_header_t</a>&nbsp; &nbsp; &nbsp; *header;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>&nbsp; *vv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;file, <span class="Statement">sizeof</span>(<a href="../../core/ngx_core.h.html#L20" title="core/ngx_core.h:20">ngx_file_t</a>));<br/></li>
<li>&nbsp; &nbsp; file.name = *name;<br/></li>
<li>&nbsp; &nbsp; file.log = cf-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file.fd = <a href="../../os/unix/ngx_files.h.html#L60" title="os/unix/ngx_files.h:60">ngx_open_file</a>(name-&gt;data, <a href="../../os/unix/ngx_files.h.html#L72" title="os/unix/ngx_files.h:72">NGX_FILE_RDONLY</a>, <span class="Constant">0</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (file.fd == <a href="../../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <a href="../../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (err != <a href="../../os/unix/ngx_errno.h.html#L19" title="os/unix/ngx_errno.h:19">NGX_ENOENT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>, cf, err,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../os/unix/ngx_files.h.html#L70" title="os/unix/ngx_files.h:70">ngx_open_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, name-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;outside_entries) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;binary geo range base </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> cannot be mixed with <a href="../ngx_http_parse.c.html#L13" title="http/ngx_http_parse.c:13">usual</a> entries&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;binary_include) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;second binary geo range base </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> cannot be mixed with </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name-&gt;data, ctx-&gt;include_name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../os/unix/ngx_files.h.html#L176" title="os/unix/ngx_files.h:176">ngx_fd_info</a>(file.fd, &amp;fi) == <a href="../../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>, cf, <a href="../../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../os/unix/ngx_files.h.html#L177" title="os/unix/ngx_files.h:177">ngx_fd_info_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, name-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = (<span class="Type">size_t</span>) <a href="../../os/unix/ngx_files.h.html#L187" title="os/unix/ngx_files.h:187">ngx_file_size</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; mtime = <a href="../../os/unix/ngx_files.h.html#L189" title="os/unix/ngx_files.h:189">ngx_file_mtime</a>(&amp;fi);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ch = name-&gt;data[name-&gt;len - <span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; name-&gt;data[name-&gt;len - <span class="Constant">4</span>] = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../os/unix/ngx_files.h.html#L173" title="os/unix/ngx_files.h:173">ngx_file_info</a>(name-&gt;data, &amp;fi) == <a href="../../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>, cf, <a href="../../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../os/unix/ngx_files.h.html#L174" title="os/unix/ngx_files.h:174">ngx_file_info_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, name-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name-&gt;data[name-&gt;len - <span class="Constant">4</span>] = ch;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mtime &lt; <a href="../../os/unix/ngx_files.h.html#L189" title="os/unix/ngx_files.h:189">ngx_file_mtime</a>(&amp;fi)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;stale binary geo range base </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, name-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; base = <a href="../../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(ctx-&gt;pool, size);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (base == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = <a href="../../os/unix/ngx_files.c.html#L20" title="os/unix/ngx_files.c:20">ngx_read_file</a>(&amp;file, base, size, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>, cf, <a href="../../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../os/unix/ngx_files.h.html#L124" title="os/unix/ngx_files.h:124">ngx_read_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, name-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) n != size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../os/unix/ngx_files.h.html#L124" title="os/unix/ngx_files.h:124">ngx_read_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> returned only %z bytes instead of %z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name-&gt;data, n, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; header = (<a href="#L163" title="http/modules/ngx_http_geo_module.c:163">ngx_http_geo_header_t</a> *) base;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &lt; <span class="Constant">16</span> || <a href="../../core/ngx_string.h.html#L144" title="core/ngx_string.h:144">ngx_memcmp</a>(&amp;<a href="#L166" title="http/modules/ngx_http_geo_module.c:166">ngx_http_geo_header</a>, header, <span class="Constant">12</span>) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;incompatible binary geo range base </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, name-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_crc32.h.html#L53" title="core/ngx_crc32.h:53">ngx_crc32_init</a>(crc32);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; vv = (<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *) (base + <span class="Statement">sizeof</span>(<a href="#L163" title="http/modules/ngx_http_geo_module.c:163">ngx_http_geo_header_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (vv-&gt;data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <a href="../../core/ngx_config.h.html#L97" title="core/ngx_config.h:97">ngx_align</a>(<span class="Statement">sizeof</span>(<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>) + vv-&gt;len,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<span class="Type">void</span> *));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_crc32.h.html#L58" title="core/ngx_crc32.h:58">ngx_crc32_update</a>(&amp;crc32, (u_char *) vv, len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; vv-&gt;data += (<span class="Type">size_t</span>) base;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; vv = (<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *) ((u_char *) vv + len);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_crc32.h.html#L58" title="core/ngx_crc32.h:58">ngx_crc32_update</a>(&amp;crc32, (u_char *) vv, <span class="Statement">sizeof</span>(<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>));<br/></li>
<li>&nbsp; &nbsp; vv++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ranges = (<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a> **) vv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <span class="Constant">0x10000</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_crc32.h.html#L58" title="core/ngx_crc32.h:58">ngx_crc32_update</a>(&amp;crc32, (u_char *) &amp;ranges[i], <span class="Statement">sizeof</span>(<span class="Type">void</span> *));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ranges[i]) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ranges[i] = (<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((u_char *) ranges[i] + (<span class="Type">size_t</span>) base);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; range = (<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a> *) &amp;ranges[<span class="Constant">0x10000</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> ((u_char *) range &lt; base + size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (range-&gt;value) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_crc32.h.html#L58" title="core/ngx_crc32.h:58">ngx_crc32_update</a>(&amp;crc32, (u_char *) range,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range-&gt;value = (<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((u_char *) range-&gt;value + (<span class="Type">size_t</span>) base);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_crc32.h.html#L58" title="core/ngx_crc32.h:58">ngx_crc32_update</a>(&amp;crc32, (u_char *) range, <span class="Statement">sizeof</span>(<span class="Type">void</span> *));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; range = (<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a> *) ((u_char *) range + <span class="Statement">sizeof</span>(<span class="Type">void</span> *));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_crc32.h.html#L72" title="core/ngx_crc32.h:72">ngx_crc32_final</a>(crc32);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (crc32 != header-&gt;crc32) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;CRC32 mismatch in binary geo range base </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, name-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L22" title="core/ngx_log.h:22">NGX_LOG_NOTICE</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;using binary geo range base </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, name-&gt;data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;include_name = *name;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;binary_include = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;high.low = ranges;<br/></li>
<li>&nbsp; &nbsp; rc = <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../os/unix/ngx_files.h.html#L109" title="os/unix/ngx_files.h:109">ngx_close_file</a>(file.fd) == <a href="../../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, cf-&gt;log, <a href="../../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../os/unix/ngx_files.h.html#L110" title="os/unix/ngx_files.h:110">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, name-&gt;data);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1541">&#x200c;</a></span><span class="linkable">ngx_http_geo_create_binary_base</span>(<a href="#L66" title="http/modules/ngx_http_geo_module.c:66">ngx_http_geo_conf_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../../os/unix/ngx_files.h.html#L27" title="os/unix/ngx_files.h:27">ngx_file_mapping_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; fm;<br/></li>
<li>&nbsp; &nbsp; <a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *r, *range, **ranges;<br/></li>
<li>&nbsp; &nbsp; <a href="#L163" title="http/modules/ngx_http_geo_module.c:163">ngx_http_geo_header_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *header;<br/></li>
<li>&nbsp; &nbsp; <a href="#L38" title="http/modules/ngx_http_geo_module.c:38">ngx_http_geo_variable_value_node_t</a>&nbsp; *gvvn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fm.name = <a href="../../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(ctx-&gt;temp_pool, ctx-&gt;include_name.len + <span class="Constant">5</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fm.name == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(fm.name, <span class="Constant">&quot;%V.bin%Z&quot;</span>, &amp;ctx-&gt;include_name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fm.size = ctx-&gt;data_size;<br/></li>
<li>&nbsp; &nbsp; fm.log = ctx-&gt;pool-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L22" title="core/ngx_log.h:22">NGX_LOG_NOTICE</a>, fm.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;creating binary geo range base </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, fm.name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../os/unix/ngx_files.c.html#L277" title="os/unix/ngx_files.c:277">ngx_create_file_mapping</a>(&amp;fm) != <a href="../../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../../core/ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(fm.addr, &amp;<a href="#L166" title="http/modules/ngx_http_geo_module.c:166">ngx_http_geo_header</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="#L163" title="http/modules/ngx_http_geo_module.c:163">ngx_http_geo_header_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="#L1619" title="http/modules/ngx_http_geo_module.c:1619">ngx_http_geo_copy_values</a>(fm.addr, p, ctx-&gt;rbtree.root,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ctx-&gt;rbtree.sentinel);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p += <span class="Statement">sizeof</span>(<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ranges = (<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a> **) p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p += <span class="Constant">0x10000</span> * <span class="Statement">sizeof</span>(<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a> *);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <span class="Constant">0x10000</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r = ctx-&gt;high.low[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; range = (<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a> *) p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ranges[i] = (<a href="#L17" title="http/modules/ngx_http_geo_module.c:17">ngx_http_geo_range_t</a> *) (p - (u_char *) fm.addr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.len = r-&gt;value-&gt;len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.data = r-&gt;value-&gt;data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash = <a href="../../core/ngx_crc32.h.html#L39" title="core/ngx_crc32.h:39">ngx_crc32_long</a>(s.data, s.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gvvn = (<a href="#L38" title="http/modules/ngx_http_geo_module.c:38">ngx_http_geo_variable_value_node_t</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1869" title="core/ngx_string.c:1869">ngx_str_rbtree_lookup</a>(&amp;ctx-&gt;rbtree, &amp;s, hash);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range-&gt;value = (<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *) gvvn-&gt;offset;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range-&gt;start = r-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range-&gt;end = r-&gt;end;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> ((++r)-&gt;value);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; range-&gt;value = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = (u_char *) range + <span class="Statement">sizeof</span>(<span class="Type">void</span> *);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; header = fm.addr;<br/></li>
<li>&nbsp; &nbsp; header-&gt;crc32 = <a href="../../core/ngx_crc32.h.html#L39" title="core/ngx_crc32.h:39">ngx_crc32_long</a>((u_char *) fm.addr<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + <span class="Statement">sizeof</span>(<a href="#L163" title="http/modules/ngx_http_geo_module.c:163">ngx_http_geo_header_t</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; fm.size - <span class="Statement">sizeof</span>(<a href="#L163" title="http/modules/ngx_http_geo_module.c:163">ngx_http_geo_header_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../os/unix/ngx_files.c.html#L314" title="os/unix/ngx_files.c:314">ngx_close_file_mapping</a>(&amp;fm);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1619">&#x200c;</a><span class="linkable">ngx_http_geo_copy_values</span>(u_char *base, u_char *p, <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *vv;<br/></li>
<li>&nbsp; &nbsp; <a href="#L38" title="http/modules/ngx_http_geo_module.c:38">ngx_http_geo_variable_value_node_t</a>&nbsp; *gvvn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (node == sentinel) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gvvn = (<a href="#L38" title="http/modules/ngx_http_geo_module.c:38">ngx_http_geo_variable_value_node_t</a> *) node;<br/></li>
<li>&nbsp; &nbsp; gvvn-&gt;offset = p - base;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; vv = (<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a> *) p;<br/></li>
<li>&nbsp; &nbsp; *vv = *gvvn-&gt;value;<br/></li>
<li>&nbsp; &nbsp; p += <span class="Statement">sizeof</span>(<a href="../ngx_http_variables.h.html#L17" title="http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>);<br/></li>
<li>&nbsp; &nbsp; vv-&gt;data = (u_char *) (p - base);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../../core/ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(p, gvvn-&gt;sn.str.data, gvvn-&gt;sn.str.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../../core/ngx_config.h.html#L98" title="core/ngx_config.h:98">ngx_align_ptr</a>(p, <span class="Statement">sizeof</span>(<span class="Type">void</span> *));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="#L1619" title="http/modules/ngx_http_geo_module.c:1619">ngx_http_geo_copy_values</a>(base, p, node-&gt;left, sentinel);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1619" title="http/modules/ngx_http_geo_module.c:1619">ngx_http_geo_copy_values</a>(base, p, node-&gt;right, sentinel);<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
